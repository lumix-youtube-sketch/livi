<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* --- BASE STYLES --- */
:root {
    --primary: #8B9A9C;
    --accent: #9CB3B5;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #1a1a1a;
    --glass: rgba(255,255,255,0.05);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#050505 100%);color:white;max-width:428px;margin:0 auto;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:100px;min-height:100vh}

/* --- ANIMATIONS --- */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes shine{0%{background-position:-100%}100%{background-position:200%}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.hidden{display:none!important}

/* --- LOADING --- */
.loading-screen{position:fixed;inset:0;background:#1a1a1a;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

/* --- HEADER --- */
.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(20,20,20,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px}
.stat-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid rgba(255,255,255,0.05)}

/* --- LIVI & ITEMS V2 (HIGH DETAIL) --- */
.livi-container{display:flex;flex-direction:column;align-items:center;padding:30px 0;position:relative}
.livi-body{
    width:130px;height:130px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #2a2a2a, #111);
    border:3px solid var(--primary);
    position:relative;
    box-shadow:0 10px 40px rgba(0,0,0,0.5);
    animation:float 6s ease-in-out infinite;
    z-index:5;
}
.livi-antenna{position:absolute;width:4px;height:35px;background:var(--primary);border-radius:4px;z-index:1}
.livi-antenna::after{content:'';position:absolute;top:-8px;left:-3px;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--primary)}
.ant-l{top:-25px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-25px;right:25px;transform:rotate(20deg)}

.livi-face{position:absolute;inset:0;z-index:10}
.eye{position:absolute;top:45%;width:14px;height:18px;background:white;border-radius:50%;animation:blink 4s infinite}
.eye-l{left:35px} .eye-r{right:35px}
.mouth{position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:24px;height:12px;border-bottom:3px solid white;border-radius:0 0 15px 15px}

/* ITEMS CSS DRAWING */
/* 1. Cap: Detailed stitching, fabric texture */
.item-cap {position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:90px;height:35px;background:linear-gradient(to bottom, #D4AF7A, #C09555);border-radius:20px 20px 0 0;z-index:20;box-shadow:inset 0 2px 5px rgba(255,255,255,0.2)}
.item-cap::before {content:'';position:absolute;top:-4px;left:50%;transform:translateX(-50%);width:12px;height:6px;background:#C09555;border-radius:50%}
.item-cap::after {content:'';position:absolute;bottom:0;right:-15px;width:40px;height:10px;background:#b08545;border-radius:0 50px 50px 0;transform:rotate(5deg)}

/* 2. Crown: Gold gradient, gems */
.item-crown {position:absolute;top:-45px;left:50%;transform:translateX(-50%);width:70px;height:50px;z-index:20;
    background: linear-gradient(to bottom, #FFD700, #DAA520);
    clip-path: polygon(0% 100%, 20% 40%, 40% 100%, 60% 20%, 80% 100%, 100% 40%, 100% 100%);
    filter: drop-shadow(0 0 5px rgba(255,215,0,0.5));
}
.item-crown::after {content:'';position:absolute;bottom:5px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:radial-gradient(circle, #ff0000, #800000);border-radius:50%;box-shadow:20px 0 0 #800000, -20px 0 0 #800000}

/* 3. Glasses: Gradient lens, reflection */
.item-glasses {position:absolute;top:55px;left:50%;transform:translateX(-50%);width:80px;height:24px;z-index:30;display:flex;justify-content:space-between}
.g-lens {width:36px;height:24px;background:rgba(0,0,0,0.85);border-radius:6px;border:2px solid #555;position:relative;overflow:hidden}
.g-lens::after {content:'';position:absolute;top:0;left:0;width:150%;height:40%;background:rgba(255,255,255,0.15);transform:rotate(25deg) translateY(-5px)}
.g-bridge {position:absolute;top:10px;left:50%;transform:translateX(-50%);width:10px;height:3px;background:#555}

/* 4. Scarf: Striped pattern */
.item-scarf {position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);width:100px;height:35px;z-index:25;
    background: repeating-linear-gradient(45deg, #D45D79, #D45D79 10px, #C04560 10px, #C04560 20px);
    border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

/* 5. Monocle: Gold rim, chain */
.item-monocle {position:absolute;top:55px;right:38px;width:28px;height:28px;border:2px solid #FFD700;border-radius:50%;background:rgba(255,255,255,0.1);z-index:30}
.item-monocle::before {content:'';position:absolute;bottom:-30px;right:-10px;width:30px;height:30px;border-right:1px solid #FFD700;border-radius:50%}

/* --- CHESTS (VISUALS) --- */
.chest-wrapper {display:grid;gap:15px;margin-bottom:30px}
.chest-card {position:relative;border-radius:16px;padding:20px;overflow:hidden;cursor:pointer;transition:transform .2s}
.chest-card:active {transform:scale(0.98)}

/* Common: Wood & Iron */
.chest-common {background:linear-gradient(135deg, #5D4037, #3E2723);border:2px solid #8D6E63}
.chest-common::before {content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(0,0,0,0.2) 20px);opacity:0.3}

/* Rare: Tech Case */
.chest-rare {background:linear-gradient(135deg, #1e2424, #0f1212);border:2px solid var(--gold);box-shadow:inset 0 0 20px rgba(212,175,122,0.1)}
.chest-rare::after {content:'';position:absolute;top:0;right:0;width:60px;height:60px;background:linear-gradient(135deg, transparent 50%, var(--gold) 50%);opacity:0.2}

/* Legendary: Magic Cube */
.chest-legendary {background:linear-gradient(135deg, #2b0a16, #1a050d);border:2px solid var(--epic);animation:pulse-glow 3s infinite}
.chest-legendary::before {content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%, rgba(212,93,121,0.2), transparent);z-index:1}

/* --- ROULETTE --- */
.roulette-modal {position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.roulette-window {width:100%;height:140px;background:#050505;border-block:2px solid #333;position:relative;overflow:hidden;margin:30px 0}
.roulette-strip {display:flex;height:100%;align-items:center;position:absolute;left:0;will-change:transform}
.r-item {width:120px;height:110px;margin:0 4px;background:#151515;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #333;flex-shrink:0;position:relative}
.r-item.legendary {border-color:var(--epic);box-shadow:inset 0 0 15px rgba(212,93,121,0.2)}
.r-item.rare {border-color:var(--gold)}
.r-marker {position:absolute;top:0;bottom:0;left:50%;width:4px;background:white;z-index:10;transform:translateX(-50%);box-shadow:0 0 10px white}

/* --- UI ELEMENTS --- */
.content{padding:20px}
.section{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:20px;padding:20px;margin-bottom:15px;backdrop-filter:blur(10px)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.btn{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:white}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888}

/* Fixed Add Button - Improved Position */
.add-btn {
    position: fixed;
    bottom: 90px; /* –í—ã—à–µ –Ω–∞–≤–±–∞—Ä–∞ */
    right: 20px;
    width: 60px; height: 60px;
    border-radius: 30px;
    background: var(--primary);
    color: white;
    font-size: 32px;
    border: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 90; /* –ù–∏–∂–µ –º–æ–¥–∞–ª–æ–∫, –≤—ã—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    display: flex; align-items: center; justify-content: center;
    transform: translateZ(0); /* Force hardware accel */
}

/* Nav */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(15,15,15,0.98);backdrop-filter:blur(20px);border-top:1px solid #2a2a2a;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;border:none;background:none;color:#555;transition:color .2s}
.nav-item.active{color:var(--primary)}

/* Chart & Analysis */
.chart-container {width:100%;height:180px;position:relative;margin-top:20px}
.chart-tooltip {position:absolute;top:0;right:0;background:#333;padding:4px 8px;border-radius:4px;font-size:10px;display:none}
.period-switch {display:flex;background:#111;padding:4px;border-radius:12px;margin-bottom:15px}
.p-btn {flex:1;padding:8px;text-align:center;font-size:12px;border-radius:8px;color:#666;cursor:pointer}
.p-btn.active {background:#333;color:white;font-weight:bold}
.heatmap {display:flex;flex-wrap:wrap;gap:4px;margin-top:10px}
.heat-cell {width:10px;height:10px;border-radius:2px;background:#333}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:10px; color:#fff; font-weight:800; letter-spacing:1px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div class="roulette-window">
        <div class="roulette-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .5s">
        <div style="font-size:14px; color:#888; text-transform:uppercase; letter-spacing:1px">–í—ã –ø–æ–ª—É—á–∏–ª–∏</div>
        <div id="winItemName" style="font-size:32px; font-weight:800; color:var(--gold); margin:10px 0; text-shadow:0 0 20px rgba(212,175,122,0.3)">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" style="width:200px; margin:0 auto" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="app"></div>

<script>
// --- CORE CONFIG ---
const tg = window.Telegram?.WebApp;
if(tg) { tg.expand(); tg.ready(); tg.setHeaderColor('#141414'); tg.setBackgroundColor('#141414'); }

// --- ICONS & ASSETS ---
const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>'
};
const getIcon = (n) => `<svg>${icons[n]}</svg>`;

// --- DATABASE ---
const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' }
];

// --- STATE MANAGEMENT ---
// –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è statsHistory –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
const defaultState = {
    activeTab: 'home',
    streak: 1,
    totalPoints: 200, 
    lastVisitDate: new Date().toISOString().split('T')[0],
    
    // Stats History: –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {date: '2023-10-01', points: 50, tasks: 2}
    statsHistory: [], 
    
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10 },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5 }
    ],
    inventory: [],
    equipped: { head: null, face: null, body: null },
    dailyChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–°–¥–µ–ª–∞—Ç—å 20 —à–∞–≥–æ–≤', target: 20, completed: false, reward: 50
    },
    analysisPeriod: 'week' // 'week', 'month', 'year'
};

let state = { ...defaultState };

// Helper –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏–∏
function updateHistory(pointsDelta, taskDelta = 0) {
    const today = new Date().toISOString().split('T')[0];
    let entry = state.statsHistory.find(e => e.date === today);
    if (!entry) {
        entry = { date: today, points: 0, tasks: 0 };
        state.statsHistory.push(entry);
    }
    entry.points += pointsDelta;
    entry.tasks += taskDelta;
    saveState();
}

function saveState() {
    try { localStorage.setItem('livi_v4_pro', JSON.stringify(state)); } catch (e) {}
}

function loadState() {
    try {
        const saved = localStorage.getItem('livi_v4_pro');
        if (saved) {
            state = { ...defaultState, ...JSON.parse(saved) };
            
            // New Day Logic
            const today = new Date().toISOString().split('T')[0];
            if (state.lastVisitDate !== today) {
                state.streak += 1;
                state.lastVisitDate = today;
                state.dailyChallenge = {
                    date: today, title: '–ù–æ–≤–∞—è —Ü–µ–ª—å!', target: 15, completed: false, reward: 50
                };
                state.tasks.forEach(t => { if(t.type === 'habit') t.completed = false; });
                saveState();
            }
            // Ensure today exists in history
            if(!state.statsHistory.find(e => e.date === today)) {
                state.statsHistory.push({ date: today, points: 0, tasks: 0 });
            }
        } else {
            // First Launch Init
            const today = new Date().toISOString().split('T')[0];
            state.statsHistory.push({ date: today, points: 0, tasks: 0 });
        }
    } catch (e) {}
}

// --- ACTIONS ---
const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.completed = !task.completed;
            const multiplier = task.completed ? 1 : -1;
            state.totalPoints += (task.points * multiplier);
            updateHistory(task.points * multiplier, 1 * multiplier);
            if(task.completed) tg?.HapticFeedback?.notificationOccurred('success');
            saveState(); render();
        }
    },
    addTask: () => {
        const title = prompt("–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?");
        if (title) {
            state.tasks.push({ id: Date.now(), title, completed: false, type: 'task', points: 15 });
            saveState(); render();
        }
    },
    deleteTask: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveState(); render();
        }
    },
    completeChallenge: () => {
        if(!state.dailyChallenge.completed) {
            state.dailyChallenge.completed = true;
            state.totalPoints += state.dailyChallenge.reward;
            updateHistory(state.dailyChallenge.reward);
            tg?.HapticFeedback?.notificationOccurred('success');
            saveState(); render();
        }
    },
    equip: (id) => {
        const item = ITEMS.find(i => i.id === id);
        if(!item) return;
        state.equipped[item.type] = state.equipped[item.type] === id ? null : id;
        saveState(); render();
    },
    openChest: (type, cost) => {
        if (state.totalPoints < cost) return alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
        state.totalPoints -= cost;
        updateHistory(0); // –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—á–∫–∏
        startRoulette(type);
    },
    setPeriod: (p) => {
        state.analysisPeriod = p;
        render();
    },
    sendStars: () => {
        tg?.HapticFeedback?.notificationOccurred('warning');
        tg?.showPopup({ title: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞', message: '–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!', buttons: [{type:'ok'}] });
    }
};

// --- ROULETTE LOGIC ---
function startRoulette(type) {
    const modal = document.getElementById('rouletteModal');
    const strip = document.getElementById('rouletteStrip');
    const winMsg = document.getElementById('winMessage');
    
    modal.classList.remove('hidden');
    winMsg.style.opacity = '0';
    strip.innerHTML = '';
    strip.style.transition = 'none';
    strip.style.transform = 'translateX(0)';

    // Logic
    let pool = type === 'common' ? ITEMS.filter(i=>i.rarity!=='legendary') : ITEMS;
    // Simple weight logic
    let winner = pool[Math.floor(Math.random() * pool.length)];
    if(type === 'legendary' && Math.random() > 0.5) winner = ITEMS.find(i => i.rarity === 'legendary') || winner;

    // Build Strip (Longer for suspense)
    const count = 60; 
    const winIdx = 50;
    const itemW = 128; // 120 + 8 margin
    
    for(let i=0; i<count; i++) {
        const item = i === winIdx ? winner : pool[Math.floor(Math.random()*pool.length)];
        const el = document.createElement('div');
        el.className = `r-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:40px">${item.icon}</div>`;
        strip.appendChild(el);
    }

    setTimeout(() => {
        const offset = (window.innerWidth/2) - (120/2);
        const pos = -(winIdx * itemW) + offset;
        strip.style.transition = 'transform 6s cubic-bezier(0.1, 0.9, 0.2, 1)'; // 6 sec spin
        strip.style.transform = `translateX(${pos}px)`;
        tg?.HapticFeedback?.selectionChanged();
        
        setTimeout(() => {
            tg?.HapticFeedback?.notificationOccurred('success');
            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winItemName').style.color = winner.rarity === 'legendary' ? '#D45D79' : '#fff';
            winMsg.style.opacity = '1';
            if(!state.inventory.includes(winner.id)) state.inventory.push(winner.id);
            saveState();
        }, 6000);
    }, 100);
}

function closeRoulette() {
    document.getElementById('rouletteModal').classList.add('hidden');
    render();
}

// --- ANALYTICS ENGINE ---
function getChartData(period) {
    const days = period === 'week' ? 7 : period === 'month' ? 30 : 365;
    const now = new Date();
    const data = [];
    
    for (let i = days - 1; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const entry = state.statsHistory.find(e => e.date === dateStr);
        data.push({
            date: dateStr,
            val: entry ? entry.points : 0,
            tasks: entry ? entry.tasks : 0
        });
    }
    return data;
}

function renderChart(data) {
    if (data.length === 0) return '<div style="text-align:center;padding:40px;color:#555">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    const w = 100; const h = 50;
    const max = Math.max(...data.map(d => d.val), 10);
    const step = w / (data.length - 1 || 1);
    
    const points = data.map((d, i) => {
        const x = i * step;
        const y = h - ((d.val / max) * h);
        return `${x},${y}`;
    }).join(' ');

    const fillPath = `0,${h} ${points} ${w},${h}`;

    return `
    <svg viewBox="0 0 100 50" style="width:100%;height:100%;overflow:visible">
        <defs>
            <linearGradient id="grad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#8B9A9C" stop-opacity="0.5"/>
                <stop offset="100%" stop-color="#8B9A9C" stop-opacity="0"/>
            </linearGradient>
        </defs>
        <path d="M${points}" fill="none" stroke="#8B9A9C" stroke-width="1.5" vector-effect="non-scaling-stroke"/>
        <polygon points="${fillPath}" fill="url(#grad)" opacity="0.5"/>
        <circle cx="${w}" cy="${h - ((data[data.length-1].val/max)*h)}" r="2" fill="white"/>
    </svg>`;
}

function getAIAdvice(data) {
    const total = data.reduce((a,b) => a + b.val, 0);
    const avg = Math.round(total / data.length);
    const last = data[data.length-1].val;
    
    if (total === 0) return "–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –º–∞–ª–æ. –í—ã–ø–æ–ª–Ω–∏ –ø–∞—Ä—É –∑–∞–¥–∞—á, —á—Ç–æ–±—ã —è –º–æ–≥ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é! ü§ñ";
    if (last > avg * 1.5) return "–§–µ–Ω–æ–º–µ–Ω–∞–ª—å–Ω–æ! –°–µ–≥–æ–¥–Ω—è —Ç—ã –ø—Ä–µ–≤–∑–æ—à–µ–ª —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏. –ì–ª–∞–≤–Ω–æ–µ –Ω–µ –≤—ã–≥–æ—Ä–µ—Ç—å, —Å–¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä—ã–≤. üöÄ";
    if (last < avg * 0.5) return "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∏–∂–µ –æ–±—ã—á–Ω–æ–≥–æ. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç –Ω–∞—á–∞—Ç—å —Å –º–∞–ª–µ–Ω—å–∫–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ 5 –º–∏–Ω—É—Ç? üëÄ";
    return `–¢—ã –¥–µ—Ä–∂–∏—à—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–µ–º–ø (${avg} pts/–¥–µ–Ω—å). –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.`;
}

// --- RENDERERS ---

function renderHome() {
    const done = state.tasks.filter(t=>t.completed).length;
    const all = state.tasks.length;
    
    // –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è Livi
    const h = ITEMS.find(i=>i.id===state.equipped.head);
    const f = ITEMS.find(i=>i.id===state.equipped.face);
    const b = ITEMS.find(i=>i.id===state.equipped.body);

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="livi-container">
                <div class="livi-body">
                    ${h ? `<div class="${h.css}" style="${h.style||''}"></div>` : ''}
                    <div class="livi-antenna ant-l"></div>
                    <div class="livi-antenna ant-r"></div>
                    <div class="livi-face">
                        <div class="eye eye-l"></div>
                        <div class="eye eye-r"></div>
                        ${f ? `<div class="${f.css}"></div>` : ''}
                        <div class="mouth"></div>
                    </div>
                </div>
                ${b ? `<div style="position:relative;width:0;height:0;top:-10px"><div class="${b.css}"></div></div>` : ''}
                <div style="margin-top:20px;font-weight:700;letter-spacing:0.5px">–ü—Ä–∏–≤–µ—Ç, User!</div>
            </div>

            <div class="grid-2">
                <div class="section" style="margin:0;text-align:center">
                    <div style="font-size:24px;font-weight:800;color:var(--primary)">${done}/${all}</div>
                    <div style="font-size:12px;color:#888">–ó–∞–¥–∞—á–∏</div>
                </div>
                <div class="section" style="margin:0;text-align:center">
                    <div style="font-size:24px;font-weight:800;color:var(--gold)">${state.streak}</div>
                    <div style="font-size:12px;color:#888">–°—Ç—Ä–∏–∫</div>
                </div>
            </div>

            <div class="section" style="margin-top:15px; border-color:var(--gold)" onclick="actions.setPeriod('week');state.activeTab='analysis';render()">
                 <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-weight:bold;margin-bottom:4px">–¶–µ–ª—å –¥–Ω—è</div>
                        <div style="font-size:12px;color:#aaa">${state.dailyChallenge.title}</div>
                    </div>
                    <div class="stat-badge" style="background:rgba(212,175,122,0.2);color:var(--gold)">+${state.dailyChallenge.reward}</div>
                 </div>
            </div>

            <button class="btn btn-ghost" style="margin-top:30px" onclick="actions.sendStars()">
                ${getIcon('star')} –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å (Stars)
            </button>
        </div>
    </div>`;
}

function renderAnalysis() {
    const p = state.analysisPeriod;
    const data = getChartData(p);
    const totalPts = data.reduce((a,b)=>a+b.val,0);
    const advice = getAIAdvice(data);
    
    // Heatmap dots
    const heatMap = data.map(d => {
        const op = Math.min(d.val / 50, 1); // 50 pts = full bright
        return `<div class="heat-cell" style="background:rgba(139,154,156,${op || 0.1})"></div>`;
    }).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800">–ê–ù–ê–õ–ò–¢–ò–ö–ê</h2>
            
            <div class="period-switch">
                <div class="p-btn ${p==='week'?'active':''}" onclick="actions.setPeriod('week')">–ù–µ–¥–µ–ª—è</div>
                <div class="p-btn ${p==='month'?'active':''}" onclick="actions.setPeriod('month')">–ú–µ—Å—è—Ü</div>
                <div class="p-btn ${p==='year'?'active':''}" onclick="actions.setPeriod('year')">–ì–æ–¥</div>
            </div>

            <div class="section">
                <div style="font-size:12px;color:#888;margin-bottom:10px;text-transform:uppercase">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–û—á–∫–∏)</div>
                <div style="font-size:28px;font-weight:800;margin-bottom:10px">${totalPts} <span style="font-size:14px;font-weight:400;color:#666">–∑–∞ –ø–µ—Ä–∏–æ–¥</span></div>
                <div class="chart-container">
                    ${renderChart(data)}
                </div>
            </div>

            <div class="section">
                <div style="font-size:12px;color:#888;margin-bottom:10px;text-transform:uppercase">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</div>
                <div class="heatmap">${heatMap}</div>
            </div>

            <div class="section" style="background:linear-gradient(135deg, rgba(40,40,40,0.5), rgba(20,20,20,0.5)); border-color:var(--accent)">
                <div style="display:flex;gap:10px">
                    <div style="font-size:24px">üß†</div>
                    <div>
                        <div style="font-weight:bold;color:white;margin-bottom:5px">Livi AI Report</div>
                        <div style="font-size:13px;line-height:1.5;color:#ccc">${advice}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function renderShop() {
    const inv = state.inventory.map(id => {
        const i = ITEMS.find(x=>x.id===id);
        const eq = Object.values(state.equipped).includes(id);
        return `<div class="section" style="padding:10px;margin:0;display:flex;flex-direction:column;align-items:center;border-color:${eq?'var(--primary)':'transparent'}" onclick="actions.equip('${id}')">
            <div style="font-size:30px;margin-bottom:5px">${i.icon}</div>
            <div style="font-size:10px;color:#888">${i.name}</div>
            ${eq?'<div style="width:6px;height:6px;background:var(--primary);border-radius:50%;margin-top:4px"></div>':''}
        </div>`;
    }).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:12px;color:#888">–ë–ê–õ–ê–ù–°</div>
                <div style="font-size:36px;font-weight:900;color:var(--gold);text-shadow:0 0 20px rgba(212,175,122,0.2)">${state.totalPoints}</div>
            </div>

            <div class="chest-wrapper">
                <div class="chest-card chest-common" onclick="actions.openChest('common', 150)">
                    <div style="font-weight:800;font-size:18px;margin-bottom:4px">–ë–∞–∑–æ–≤—ã–π –ù–∞–±–æ—Ä</div>
                    <div style="font-size:12px;opacity:0.7;margin-bottom:10px">–ö–µ–ø–∫–∏ –∏ –±–∞–±–æ—á–∫–∏</div>
                    <div style="background:rgba(0,0,0,0.3);display:inline-block;padding:4px 10px;border-radius:8px;font-weight:bold">150 pts</div>
                </div>
                <div class="chest-card chest-rare" onclick="actions.openChest('rare', 300)">
                    <div style="font-weight:800;font-size:18px;margin-bottom:4px;color:var(--gold)">–ö–µ–π—Å –ê–≥–µ–Ω—Ç–∞</div>
                    <div style="font-size:12px;opacity:0.7;margin-bottom:10px">–û—á–∫–∏, —Ü–µ–ø–∏, —Å—Ç–∏–ª—å</div>
                    <div style="background:rgba(212,175,122,0.2);color:var(--gold);display:inline-block;padding:4px 10px;border-radius:8px;font-weight:bold">300 pts</div>
                </div>
                <div class="chest-card chest-legendary" onclick="actions.openChest('legendary', 1000)">
                    <div style="font-weight:800;font-size:18px;margin-bottom:4px;color:var(--epic)">–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ö—É–±</div>
                    <div style="font-size:12px;opacity:0.7;margin-bottom:10px">–ö–æ—Ä–æ–Ω—ã –∏ —Ä–µ–ª–∏–∫–≤–∏–∏</div>
                    <div style="background:rgba(212,93,121,0.2);color:var(--epic);display:inline-block;padding:4px 10px;border-radius:8px;font-weight:bold">1000 pts</div>
                </div>
            </div>

            <h3 style="margin-bottom:10px;font-weight:700">–ò–ù–í–ï–ù–¢–ê–†–¨</h3>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
                ${inv || '<div style="grid-column:1/-1;text-align:center;color:#444;padding:20px">–ü—É—Å—Ç–æ</div>'}
            </div>
        </div>
    </div>`;
}

function renderTasks() {
    const list = state.tasks.map(t => `
        <div class="section" style="display:flex;align-items:center;padding:15px;margin-bottom:10px;opacity:${t.completed?.5:1}">
            <div style="width:24px;height:24px;border:2px solid var(--primary);border-radius:6px;margin-right:12px;display:flex;align-items:center;justify-content:center;background:${t.completed?'var(--primary)':'transparent'}" onclick="actions.toggleTask(${t.id})">
                ${t.completed?'<svg width="14" height="14" stroke="white"><polyline points="20 6 9 17 4 12"/></svg>':''}
            </div>
            <div style="flex:1">
                <div style="font-weight:500;text-decoration:${t.completed?'line-through':''}">${t.title}</div>
                <div style="font-size:11px;color:#666">${t.points} pts</div>
            </div>
            <div onclick="actions.deleteTask(${t.id})" style="color:#666">${getIcon('trash')}</div>
        </div>
    `).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:20px;font-weight:800">–ó–ê–î–ê–ß–ò</h2>
            ${list}
        </div>
        <button class="add-btn" onclick="actions.addTask()">+</button>
    </div>`;
}

function renderChallenges() {
    const c = state.dailyChallenge;
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="section" style="text-align:center;padding:40px 20px;border:2px solid var(--gold);box-shadow:0 0 20px rgba(212,175,122,0.1)">
                <div style="font-size:50px;margin-bottom:15px">üéØ</div>
                <h2 style="font-weight:900;font-size:26px;margin-bottom:10px">${c.title}</h2>
                <div style="color:#888;margin-bottom:25px">–¶–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</div>
                
                ${c.completed 
                ? '<div class="btn" style="background:var(--glass);color:var(--accent)">–í–´–ü–û–õ–ù–ï–ù–û</div>' 
                : `<button class="btn btn-primary" onclick="actions.completeChallenge()">–ó–ê–í–ï–†–®–ò–¢–¨ (+${c.reward})</button>`}
            </div>
        </div>
    </div>`;
}

function renderHeader() {
    return `<div class="header">
        <div class="header-title">livi</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:var(--gold)">${getIcon('star')} ${state.totalPoints}</div>
        </div>
    </div>`;
}

function render() {
    const app = document.getElementById('app');
    const nav = [
        {id:'home',icon:'home',l:'Home'},
        {id:'challenges',icon:'target',l:'Goals'},
        {id:'tasks',icon:'check',l:'Tasks'},
        {id:'shop',icon:'shop',l:'Shop'},
        {id:'analysis',icon:'chart',l:'Data'}
    ];
    
    let html = '';
    if(state.activeTab === 'home') html = renderHome();
    else if(state.activeTab === 'challenges') html = renderChallenges();
    else if(state.activeTab === 'tasks') html = renderTasks();
    else if(state.activeTab === 'shop') html = renderShop();
    else if(state.activeTab === 'analysis') html = renderAnalysis();

    app.innerHTML = html + `
    <div class="bottom-nav">
        ${nav.map(n=>`<button class="nav-item ${state.activeTab===n.id?'active':''}" onclick="state.activeTab='${n.id}';render()">${getIcon(n.icon)}<span style="font-size:10px">${n.l}</span></button>`).join('')}
    </div>`;
}

// --- INIT ---
window.onload = () => {
    loadState();
    render();
    setTimeout(() => document.getElementById('loadingScreen').classList.add('fade-out'), 1000);
};
</script>
</body>
</html>
