<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>livi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: white;
            max-width: 428px;
            margin: 0 auto;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ================= ANIMATIONS ================= */

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes gentleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .fade-in { animation: fadeIn 0.2s ease-out; }
        .slide-up { animation: slideUp 0.2s ease-out; }

        .card-hover {
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.1s ease;
        }

        .card-hover:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .hidden { display: none !important; }

        /* ================= LOADING SCREEN ================= */

        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-screen.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; visibility: hidden; }
        }

        .loading-logo {
            font-size: 64px;
            font-weight: bold;
            color: #8B9A9C;
            margin-bottom: 24px;
        }

        /* ================= UI COMPONENTS ================= */

        .onboarding-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .onboarding-box {
            width: 100%;
            max-width: 400px;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo-title {
            font-size: 48px;
            font-weight: bold;
            color: #8B9A9C;
            margin-bottom: 12px;
        }

        .logo-subtitle {
            font-size: 18px;
            color: #999;
        }

        .card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 32px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #999;
            margin-bottom: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 16px;
            background-color: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus {
            border-color: #8B9A9C;
        }

        textarea {
            min-height: 128px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 18px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.1s, transform 0.2s;
        }

        .btn:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B9A9C 0%, #9CB3B5 100%);
            color: white;
        }

        .btn-secondary {
            background-color: #0a0a0a;
            color: #8B9A9C;
            border: 1px solid #2a2a2a;
        }

        .btn:disabled {
            background-color: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        .progress-bar-container {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-bar {
            height: 4px;
            flex: 1;
            border-radius: 2px;
            background-color: #2a2a2a;
            transition: background-color 0.3s;
        }

        .progress-bar.active {
            background-color: #8B9A9C;
        }

        .goal-button {
            width: 100%;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .goal-button.selected {
            background-color: rgba(139, 154, 156, 0.2);
            border-color: rgba(139, 154, 156, 0.4);
        }

        .goal-button:active {
            transform: scale(0.98);
        }

        .goal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background-color: rgba(139, 154, 156, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .goal-content {
            flex: 1;
        }

        .goal-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: white;
        }

        .goal-desc {
            font-size: 14px;
            color: #666;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #2a2a2a;
            padding: 16px 20px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.1s;
        }

        .stat-badge:active {
            opacity: 0.7;
            transform: scale(0.95);
        }

        .tabs {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab.active {
            color: white;
            border-bottom-color: #8B9A9C;
        }

        .content {
            padding: 24px 20px;
            padding-bottom: 100px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.1s;
        }

        .stat-card:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .section {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .habit-card {
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.1s;
        }

        .habit-card:active {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .habit-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: #0a0a0a;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox.checked {
            background-color: #8B9A9C;
            border-color: #8B9A9C;
        }

        .checkbox:active {
            transform: scale(0.9);
        }

        .task-title {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .task-points {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 8px;
            background-color: rgba(139, 154, 156, 0.25);
            color: #8B9A9C;
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            width: 100%;
            max-width: 428px;
            background-color: #0f0f0f;
            border-top: 1px solid #2a2a2a;
            border-radius: 24px 24px 0 0;
            padding: 32px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-handle {
            width: 48px;
            height: 4px;
            background-color: #2a2a2a;
            border-radius: 2px;
            margin: 0 auto 24px;
        }

        /* ================= LIVI CHARACTER ================= */

        .livi-compact {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 154, 156, 0.1) 0%, rgba(156, 179, 181, 0.05) 100%);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .livi-character {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            animation: gentleFloat 4s ease-in-out infinite;
        }

        .livi-body {
            width: 100%;
            height: 100%;
            background-color: #8B9A9C;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .livi-face-bg {
            position: absolute;
            width: 70%;
            height: 70%;
            background-color: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .livi-antenna {
            position: absolute;
            width: 3px;
            height: 15px;
            background-color: #8B9A9C;
            border-radius: 2px;
        }

        .livi-antenna.left {
            top: -12px;
            left: 25%;
        }

        .livi-antenna.right {
            top: -12px;
            right: 25%;
        }

        .livi-antenna-ball {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #8B9A9C;
            border-radius: 50%;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .livi-ear {
            position: absolute;
            width: 20px;
            height: 25px;
            background-color: #7A8A8C;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }

        .livi-ear.left {
            left: -8px;
        }

        .livi-ear.right {
            right: -8px;
        }

        .livi-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 15px;
            z-index: 2;
        }

        .livi-eye {
            width: 8px;
            height: 10px;
            background-color: #8B9A9C;
            border-radius: 50%;
            animation: blink 5s infinite;
        }

        .livi-mouth {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            border: 2px solid #8B9A9C;
            border-top: none;
            border-radius: 0 0 20px 20px;
            z-index: 2;
        }

        .livi-mouth.neutral {
            width: 15px;
            height: 2px;
            border: none;
            background-color: #8B9A9C;
            border-radius: 2px;
        }

        .livi-mouth.sad {
            border: 2px solid #8B9A9C;
            border-bottom: none;
            border-radius: 20px 20px 0 0;
        }

        .livi-info {
            flex: 1;
        }

        .livi-status {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .livi-message {
            font-size: 13px;
            color: #999;
            line-height: 1.4;
        }

        /* ================= CHARTS ================= */

        .chart-container {
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 500;
            color: #999;
            margin-bottom: 12px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            gap: 8px;
        }

        .bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .bar-wrapper:hover {
            transform: translateY(-2px);
        }

        .bar {
            width: 100%;
            background: linear-gradient(180deg, #8B9A9C 0%, #9CB3B5 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #8B9A9C;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .bar-wrapper:hover .bar-value {
            opacity: 1;
        }

        .bar-label {
            margin-top: 8px;
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }

        /* ================= CIRCULAR PROGRESS ================= */

        .circular-progress-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 24px;
            gap: 16px;
        }

        .circular-progress {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .circular-progress-bg {
            fill: none;
            stroke: #2a2a2a;
            stroke-width: 8;
        }

        .circular-progress-bar {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .circular-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .circular-progress-value {
            font-size: 20px;
            font-weight: bold;
            display: block;
        }

        .circular-progress-label {
            font-size: 10px;
            color: #666;
            display: block;
            margin-top: 2px;
        }

        /* ================= CHALLENGE CARD ================= */

        .challenge-card {
            background: linear-gradient(135deg, rgba(139, 154, 156, 0.2) 0%, rgba(156, 179, 181, 0.1) 100%);
            border: 1px solid rgba(139, 154, 156, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: bold;
        }

        .challenge-badge {
            padding: 4px 12px;
            background-color: rgba(212, 175, 122, 0.3);
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: #D4AF7A;
        }

        .challenge-description {
            font-size: 14px;
            color: #999;
            margin-bottom: 16px;
        }

        .challenge-progress {
            margin-bottom: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        .progress-track {
            height: 8px;
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D4AF7A 0%, #FFD700 100%);
            border-radius: 4px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .delete-btn {
            padding: 8px;
            background-color: rgba(255, 68, 68, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.1s, transform 0.2s;
        }

        .delete-btn:active {
            opacity: 0.7;
            transform: scale(0.95);
        }

        svg {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .insight-card {
            padding: 16px;
            border-radius: 12px;
            background-color: #0a0a0a;
            margin-bottom: 12px;
            border-left: 3px solid #8B9A9C;
        }

        .insight-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-text {
            font-size: 13px;
            color: #999;
            line-height: 1.5;
        }

        .recommendation-card {
            padding: 14px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(165, 189, 161, 0.15) 0%, rgba(165, 189, 161, 0.05) 100%);
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .recommendation-number {
            min-width: 24px;
            height: 24px;
            background-color: #A5BDA1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .recommendation-text {
            font-size: 13px;
            line-height: 1.5;
        }

        .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: rgba(139, 154, 156, 0.2);
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            color: #8B9A9C;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">livi</div>
    </div>

    <div id="app"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const colors = {
            primary: '#8B9A9C',
            secondary: '#B8A8C7',
            accent1: '#9CB3B5',
            accent2: '#A8B5C7',
            accent3: '#A5BDA1',
            warning: '#D4AF7A',
        };

        // –ß–µ–ª–ª–µ–Ω–¥–∂–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (30 —Ä–∞–∑–Ω—ã—Ö)
        const dailyChallenges = [
            { title: '10 –æ—Ç–∂–∏–º–∞–Ω–∏–π', description: '–°–¥–µ–ª–∞–π 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π', target: 10, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç' },
            { title: '20 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π', description: '–í—ã–ø–æ–ª–Ω–∏ 20 –≥–ª—É–±–æ–∫–∏—Ö –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π', target: 20, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç' },
            { title: '–ü–ª–∞–Ω–∫–∞ 60 —Å–µ–∫—É–Ω–¥', description: '–î–µ—Ä–∂–∏ –ø–ª–∞–Ω–∫—É —Ä–æ–≤–Ω–æ –º–∏–Ω—É—Ç—É', target: 60, unit: '—Å–µ–∫', category: '–°–ø–æ—Ä—Ç' },
            { title: '–í—ã–ø–∏—Ç—å 8 —Å—Ç–∞–∫–∞–Ω–æ–≤ –≤–æ–¥—ã', description: '–ü–æ–¥–¥–µ—Ä–∂–∏ –≤–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ—Ä–≥–∞–Ω–∏–∑–º–∞', target: 8, unit: '—Å—Ç–∞–∫–∞–Ω–æ–≤', category: '–ó–¥–æ—Ä–æ–≤—å–µ' },
            { title: '–ü—Ä–æ—á–∏—Ç–∞—Ç—å 10 —Å—Ç—Ä–∞–Ω–∏—Ü', description: '–£–¥–µ–ª–∏—Ç–µ –≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—é –∫–Ω–∏–≥–∏', target: 10, unit: '—Å—Ç—Ä–∞–Ω–∏—Ü', category: '–û–±—É—á–µ–Ω–∏–µ' },
            { title: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è 10 –º–∏–Ω—É—Ç', description: '–ü—Ä–∞–∫—Ç–∏–∫–∞ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–ª–∞–∫—Å–∞', target: 10, unit: '–º–∏–Ω—É—Ç', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
            { title: '30 –º–∏–Ω—É—Ç –ø—Ä–æ–≥—É–ª–∫–∏', description: '–ü—Ä–æ–π–¥–∏—Å—å –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ', target: 30, unit: '–º–∏–Ω—É—Ç', category: '–°–ø–æ—Ä—Ç' },
            { title: '–ù–∞–ø–∏—Å–∞—Ç—å 3 –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏', description: '–ó–∞ —á—Ç–æ —Ç—ã –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω —Å–µ–≥–æ–¥–Ω—è?', target: 3, unit: '–∑–∞–ø–∏—Å–∏', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
            { title: '50 –ø—Ä—ã–∂–∫–æ–≤ –Ω–∞ —Å–∫–∞–∫–∞–ª–∫–µ', description: '–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—Ä–¥–∏–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', target: 50, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç' },
            { title: '–†–∞—Å—Ç—è–∂–∫–∞ 15 –º–∏–Ω—É—Ç', description: '–£–ª—É—á—à–∏ –≥–∏–±–∫–æ—Å—Ç—å —Ç–µ–ª–∞', target: 15, unit: '–º–∏–Ω—É—Ç', category: '–°–ø–æ—Ä—Ç' },
            { title: '–í—ã—É—á–∏—Ç—å 10 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤', description: '–ù–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ', target: 10, unit: '—Å–ª–æ–≤', category: '–û–±—É—á–µ–Ω–∏–µ' },
            { title: '–ë–µ–∑ —Å–æ—Ü—Å–µ—Ç–µ–π 2 —á–∞—Å–∞', description: '–¶–∏—Ñ—Ä–æ–≤–æ–π –¥–µ—Ç–æ–∫—Å', target: 120, unit: '–º–∏–Ω—É—Ç', category: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
            { title: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É', description: '–ü–æ–¥–¥–µ—Ä–∂–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏', target: 1, unit: '–∑–≤–æ–Ω–æ–∫', category: '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ' },
            { title: '–°—ä–µ—Å—Ç—å 5 –ø–æ—Ä—Ü–∏–π –æ–≤–æ—â–µ–π', description: '–ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', target: 5, unit: '–ø–æ—Ä—Ü–∏–π', category: '–ó–¥–æ—Ä–æ–≤—å–µ' },
            { title: '–õ–µ—á—å —Å–ø–∞—Ç—å –¥–æ 23:00', description: '–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω –≤–∞–∂–µ–Ω', target: 1, unit: '', category: '–ó–¥–æ—Ä–æ–≤—å–µ' },
            { title: '–£–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ', description: '–ü–æ—Ä—è–¥–æ–∫ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ', target: 1, unit: '', category: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
            { title: '15 –º–∏–Ω—É—Ç –π–æ–≥–∏', description: '–ü—Ä–∞–∫—Ç–∏–∫–∞ –∞—Å–∞–Ω', target: 15, unit: '–º–∏–Ω—É—Ç', category: '–°–ø–æ—Ä—Ç' },
            { title: '–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –≥–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏', description: '–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤–∞–∂–Ω–æ–º', target: 3, unit: '–∑–∞–¥–∞—á–∏', category: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
            { title: '–ü–æ—Å–ª—É—à–∞—Ç—å –ø–æ–¥–∫–∞—Å—Ç', description: '–û–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞—É–¥–∏–æ', target: 1, unit: '—ç–ø–∏–∑–æ–¥', category: '–û–±—É—á–µ–Ω–∏–µ' },
            { title: '–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∑–¥–æ—Ä–æ–≤—ã–π –∑–∞–≤—Ç—Ä–∞–∫', description: '–ù–∞—á–Ω–∏ –¥–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ', target: 1, unit: '', category: '–ó–¥–æ—Ä–æ–≤—å–µ' },
            { title: '–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ 5 –º–∏–Ω—É—Ç', description: '–£—Å–ø–æ–∫–æ–π –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É', target: 5, unit: '–º–∏–Ω—É—Ç', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
            { title: '–ù–∞–ø–∏—Å–∞—Ç—å —Ü–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å', description: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ç—Ä–æ–º', target: 1, unit: '', category: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å' },
            { title: '100 –ø—Ä—ã–∂–∫–æ–≤', description: '–≠–Ω–µ—Ä–≥–∏—á–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', target: 100, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç' },
            { title: '–ß–∞—Å –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞', description: '–û—Å–æ–∑–Ω–∞–Ω–Ω—ã–π –æ—Ç–¥—ã—Ö', target: 60, unit: '–º–∏–Ω—É—Ç', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
            { title: '–í—ã—Ä–∞–∑–∏—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å', description: '–°–∫–∞–∂–∏ —Å–ø–∞—Å–∏–±–æ –∫–æ–º—É-—Ç–æ', target: 1, unit: '', category: '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ' },
            { title: '20 –≤—ã–ø–∞–¥–æ–≤', description: '–ù–∞ –∫–∞–∂–¥—É—é –Ω–æ–≥—É', target: 20, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç' },
            { title: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—É—á–∞—é—â–µ–µ –≤–∏–¥–µ–æ', description: '–£–∑–Ω–∞–π —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ', target: 1, unit: '–≤–∏–¥–µ–æ', category: '–û–±—É—á–µ–Ω–∏–µ' },
            { title: '–ó–¥–æ—Ä–æ–≤—ã–π –ø–µ—Ä–µ–∫—É—Å', description: '–§—Ä—É–∫—Ç—ã –∏–ª–∏ –æ—Ä–µ—Ö–∏', target: 1, unit: '', category: '–ó–¥–æ—Ä–æ–≤—å–µ' },
            { title: '–ù–∞–ø–∏—Å–∞—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫', description: '–†–µ—Ñ–ª–µ–∫—Å–∏—è –¥–Ω—è', target: 1, unit: '–∑–∞–ø–∏—Å—å', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
            { title: '–ü–æ–º–æ—á—å –∫–æ–º—É-—Ç–æ', description: '–î–æ–±—Ä–æ–µ –¥–µ–ª–æ', target: 1, unit: '', category: '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ' }
        ];

        const getInitialState = () => ({
            hasCompletedOnboarding: false,
            onboardingStep: 0,
            activeTab: 'home',
            showRankModal: false,
            selectedHabit: null,
            newTask: '',
            userGoals: {
                health: false,
                learning: false,
                productivity: false,
                mindfulness: false,
                sleep: false,
                social: false
            },
            userInfo: {
                name: '',
                wakeUpTime: '07:00',
                sleepTime: '23:00',
                mainGoal: ''
            },
            tasks: [],
            habits: [],
            streak: 0,
            totalPoints: 0,
            lastActiveDate: new Date().toDateString(),
            dailyChallenge: null,
            challengeProgress: 0,
            challengeStartTime: null,
            weeklyStats: [75, 60, 85, 70, 90, 80, 65]
        });

        let state = getInitialState();
        let countdownInterval = null;
        const tg = window.Telegram?.WebApp || { expand: () => {}, ready: () => {}, CloudStorage: null };
        tg.expand();
        tg.ready();

        async function loadState() {
            try {
                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.getItem('livi_state', (error, value) => {
                            if (!error && value) {
                                try {
                                    const loaded = JSON.parse(value);
                                    state = { ...getInitialState(), ...loaded };
                                } catch (e) {}
                            }
                            resolve();
                        });
                    });
                }
            } catch (e) {}
        }

        async function saveState() {
            try {
                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.setItem('livi_state', JSON.stringify(state), () => resolve());
                    });
                }
            } catch (e) {}
        }

        function getDailyChallenge() {
            const now = new Date();
            const today = now.toDateString();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
            if (!state.dailyChallenge || state.dailyChallenge.date !== today) {
                const dayIndex = Math.floor(Date.now() / 86400000) % dailyChallenges.length;
                const challengeStartTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

                state.dailyChallenge = {
                    ...dailyChallenges[dayIndex],
                    date: today,
                    completed: false
                };
                state.challengeProgress = 0;
                state.challengeStartTime = challengeStartTime;
                saveState();
            }
            return state.dailyChallenge;
        }

        function getTimeUntilNextChallenge() {
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const diff = tomorrow - now;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            return { hours, minutes, seconds };
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const timeLeft = getTimeUntilNextChallenge();
                const timerElement = document.getElementById('challengeTimer');

                if (timerElement) {
                    timerElement.textContent = `${String(timeLeft.hours).padStart(2, '0')}:${String(timeLeft.minutes).padStart(2, '0')}:${String(timeLeft.seconds).padStart(2, '0')}`;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Ä–∞ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂
                if (timeLeft.hours === 0 && timeLeft.minutes === 0 && timeLeft.seconds === 0) {
                    getDailyChallenge();
                    render();
                }
            }, 1000);
        }

        function updateStreak() {
            const today = new Date().toDateString();
            if (state.lastActiveDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (state.lastActiveDate === yesterday.toDateString()) {
                    state.streak++;
                } else {
                    state.streak = 1;
                }
                state.lastActiveDate = today;
                saveState();
            }
        }

        function createSvg(name, color = 'currentColor') {
            const icons = {
                arrowRight: '<line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>',
                heart: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
                book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
                target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
                brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/>',
                moon: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
                coffee: '<path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>',
                sunrise: '<path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                sparkles: '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>',
                flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
                star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
                clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                award: '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>',
                trendingUp: '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                lightbulb: '<line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>',
                activity: '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
            };
            return `<svg width="24" height="24" viewBox="0 0 24 24" style="color: ${color}">${icons[name]}</svg>`;
        }

        function getLiviState(energy, completion, habits) {
            const avgScore = (energy + completion + (habits / 4 * 100)) / 3;

            if (avgScore >= 85) return {
                size: 80,
                color: colors.primary,
                innerSize: 55,
                label: '–ü—Ä–æ—Ü–≤–µ—Ç–∞—é—â–∏–π',
                mood: 'happy',
                phrase: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ!'
            };
            if (avgScore >= 70) return {
                size: 75,
                color: colors.primary,
                innerSize: 52,
                label: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π',
                mood: 'happy',
                phrase: '–•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å! –ü—Ä–æ–¥–æ–ª–∂–∞–π!'
            };
            if (avgScore >= 50) return {
                size: 70,
                color: colors.primary,
                innerSize: 48,
                label: '–§–æ—Ä–º–∏—Ä—É—é—â–∏–π—Å—è',
                mood: 'neutral',
                phrase: '–¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏!'
            };
            return {
                size: 65,
                color: '#666',
                innerSize: 45,
                label: '–ó–∞—Ä–æ–∂–¥–∞—é—â–∏–π—Å—è',
                mood: 'sad',
                phrase: '–ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ, –≤—Å–µ –ø–æ–ª—É—á–∏—Ç—Å—è!'
            };
        }

        function getRank(streakDays) {
            if (streakDays >= 100) return { title: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', level: 6, color: '#FFD700', min: 100 };
            if (streakDays >= 50) return { title: '–ú–∞—Å—Ç–µ—Ä', icon: '‚≠ê', level: 5, color: colors.warning, min: 50 };
            if (streakDays >= 30) return { title: '–ü—Ä–æ—Ñ–∏', icon: 'üî•', level: 4, color: colors.accent3, min: 30 };
            if (streakDays >= 14) return { title: '–≠–Ω—Ç—É–∑–∏–∞—Å—Ç', icon: 'üí™', level: 3, color: colors.primary, min: 14 };
            if (streakDays >= 7) return { title: '–°—Ç–∞—Ä—Ç–µ—Ä', icon: 'üå±', level: 2, color: colors.accent2, min: 7 };
            return { title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü', level: 1, color: colors.secondary, min: 0 };
        }

        function generateAIAnalysis() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const totalTasks = state.tasks.length || 1;
            const completionRate = (completedTasks / totalTasks) * 100;
            const activeHabits = state.habits.filter(h => h.completed).length;
            const totalHabits = state.habits.length || 1;
            const habitRate = (activeHabits / totalHabits) * 100;
            const avgEnergy = (completionRate + habitRate) / 2;

            let insights = [];
            let recommendations = [];
            let patterns = [];

            // –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–µ–¥–µ–ª–∏
            const weekAvg = state.weeklyStats.reduce((a, b) => a + b, 0) / 7;
            const trend = state.weeklyStats[6] - state.weeklyStats[0];
            const consistency = state.weeklyStats.filter(v => v >= 60).length;

            // –ü–∞—Ç—Ç–µ—Ä–Ω—ã
            if (trend > 15) {
                patterns.push({
                    title: '–í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥',
                    text: `–¢–≤–æ—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ ${Math.round(trend)}% –∑–∞ –Ω–µ–¥–µ–ª—é. –û—Ç–ª–∏—á–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞!`
                });
            } else if (trend < -15) {
                patterns.push({
                    title: '–°–Ω–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
                    text: `–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞ –Ω–∞ ${Math.abs(Math.round(trend))}%. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É.`
                });
            } else {
                patterns.push({
                    title: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    text: `–¢—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–µ–º–ø. –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${Math.round(weekAvg)}%`
                });
            }

            if (consistency >= 5) {
                patterns.push({
                    title: '–í—ã—Å–æ–∫–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å',
                    text: `${consistency} –∏–∑ 7 –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º–∏ (>60%). –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!`
                });
            } else if (consistency >= 3) {
                patterns.push({
                    title: '–°—Ä–µ–¥–Ω—è—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å',
                    text: `${consistency} –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π. –ü–æ–ø—Ä–æ–±—É–π —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é.`
                });
            } else {
                patterns.push({
                    title: '–ù–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø',
                    text: `–í—Å–µ–≥–æ ${consistency} –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π. –ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ - 3 –¥–Ω—è –≤ –Ω–µ–¥–µ–ª—é.`
                });
            }

            // –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
            if (completionRate >= 80) {
                insights.push({
                    title: '–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    text: `–¢—ã –≤—ã–ø–æ–ª–Ω—è–µ—à—å ${Math.round(completionRate)}% –∑–∞–¥–∞—á. –≠—Ç–æ —Ç–æ–ø-10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!`
                });
                recommendations.push('–ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã–µ —Ü–µ–ª–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–æ—Å—Ç–∞');
            } else if (completionRate >= 60) {
                insights.push({
                    title: '–•–æ—Ä–æ—à–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    text: `${Math.round(completionRate)}% –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á - —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ä–µ–∑–µ—Ä–≤–æ–º –¥–ª—è —Ä–æ—Å—Ç–∞.`
                });
                recommendations.push('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π, —á—Ç–æ –º–µ—à–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏');
                recommendations.push('–ü–æ–ø—Ä–æ–±—É–π –º–µ—Ç–æ–¥ "–°—ä–µ—à—å –ª—è–≥—É—à–∫—É" - –¥–µ–ª–∞–π —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ —É—Ç—Ä–æ–º');
            } else if (completionRate >= 40) {
                insights.push({
                    title: '–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    text: `${Math.round(completionRate)}% - –µ—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.`
                });
                recommendations.push('–ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–æ–¥ "–ü–æ–º–æ–¥–æ—Ä–æ" –¥–ª—è –ª—É—á—à–µ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏');
                recommendations.push('–†–∞–∑–±–∏–≤–∞–π –±–æ–ª—å—à–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏');
                recommendations.push('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–¥–ª–∞–π–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏');
            } else {
                insights.push({
                    title: '–ù–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø',
                    text: `${Math.round(completionRate)}% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è - –Ω–∞—á–Ω–∏ —Å –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á.`
                });
                recommendations.push('–î–æ–±–∞–≤–ª—è–π –Ω–µ –±–æ–ª–µ–µ 3 –∑–∞–¥–∞—á –≤ –¥–µ–Ω—å –Ω–∞ –Ω–∞—á–∞–ª—å–Ω–æ–º —ç—Ç–∞–ø–µ');
                recommendations.push('–í—ã–±–∏—Ä–∞–π —Å–∞–º—É—é –≤–∞–∂–Ω—É—é –∑–∞–¥–∞—á—É –∏ –¥–µ–ª–∞–π –µ—ë –ø–µ—Ä–≤–æ–π');
                recommendations.push('–ü—Ä–∞–∑–¥–Ω—É–π –∫–∞–∂–¥—É—é –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏');
            }

            // –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–≤—ã—á–µ–∫
            if (habitRate >= 75) {
                insights.push({
                    title: '–û—Ç–ª–∏—á–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏',
                    text: `${activeHabits} –∏–∑ ${state.habits.length} –ø—Ä–∏–≤—ã—á–µ–∫ –∞–∫—Ç–∏–≤–Ω—ã (${Math.round(habitRate)}%). –¢—ã —Ñ–æ—Ä–º–∏—Ä—É–µ—à—å —Å–∏–ª—å–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç!`
                });
            } else if (habitRate >= 50) {
                insights.push({
                    title: '–•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏',
                    text: `${Math.round(habitRate)}% –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!`
                });
                recommendations.push('–í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –ø—Ä–∏–≤—ã—á–∫—É –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –Ω–µ–π –Ω–µ–¥–µ–ª—é');
            } else if (habitRate > 0) {
                insights.push({
                    title: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫',
                    text: `–ü—Ä–∏–≤—ã—á–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—é—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è (${Math.round(habitRate)}%).`
                });
                recommendations.push('–ü—Ä–∏–≤—è–∑—ã–≤–∞–π –Ω–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º');
                recommendations.push('–ù–∞—á–Ω–∏ —Å —Å–∞–º–æ–π –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–≤—ã—á–∫–∏ –∏–∑ —Å–ø–∏—Å–∫–∞');
            } else {
                insights.push({
                    title: '–í—Ä–µ–º—è –Ω–∞—á–∞—Ç—å',
                    text: '–ü–æ—Ä–∞ –Ω–∞—á–∞—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏.'
                });
                recommendations.push('–î–æ–±–∞–≤—å –æ–¥–Ω—É –ø—Ä–æ—Å—Ç—É—é –ø—Ä–∏–≤—ã—á–∫—É –∏ –¥–µ–ª–∞–π –µ—ë –∫–∞–∂–¥—ã–π –¥–µ–Ω—å');
                recommendations.push('–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª–æ 2 –º–∏–Ω—É—Ç - –Ω–∞—á–∏–Ω–∞–π —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏');
            }

            // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∏–∫–∞
            if (state.streak >= 30) {
                insights.push({
                    title: '–í–ø–µ—á–∞—Ç–ª—è—é—â–∏–π —Å—Ç—Ä–∏–∫',
                    text: `${state.streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥! –¢—ã –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—à—å –Ω–∞—Å—Ç–æ—è—â—É—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ —Å–∏–ª—É –≤–æ–ª–∏.`
                });
            } else if (state.streak >= 7) {
                insights.push({
                    title: '–û—Ç–ª–∏—á–Ω—ã–π —Å—Ç—Ä–∏–∫',
                    text: `${state.streak} –¥–Ω–µ–π! –ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è - —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è, —Ç—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è.`
                });
                recommendations.push('–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–≤–∏–≤–∞—Ç—å momentum - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–π —Ü–µ–ø–æ—á–∫—É');
            } else if (state.streak >= 3) {
                insights.push({
                    title: '–•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ',
                    text: `${state.streak} –¥–Ω—è –ø–æ–¥—Ä—è–¥. –ü–µ—Ä–≤—ã–µ –¥–Ω–∏ –∑–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç.`
                });
                recommendations.push('–ü–æ—Å—Ç–∞—Ä–∞–π—Å—è –¥–æ–π—Ç–∏ –¥–æ 7 –¥–Ω–µ–π - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥');
            } else {
                recommendations.push('–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä–∏–∫–∞ —Ö–æ—Ç—è –±—ã –≤ 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥');
            }

            // –ê–Ω–∞–ª–∏–∑ —á–µ–ª–ª–µ–Ω–¥–∂–∞
            if (state.dailyChallenge?.completed) {
                insights.push({
                    title: '–ß–µ–ª–ª–µ–Ω–¥–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω',
                    text: '–¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂! –≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É.'
                });
            } else {
                recommendations.push('–ù–µ –∑–∞–±—É–¥—å –ø—Ä–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂ - —ç—Ç–æ –±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏');
            }

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12 && completionRate < 30) {
                recommendations.push('–£—Ç—Ä–æ - –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∑–∞–¥–∞—á. –ù–∞—á–Ω–∏ —Å –≥–ª–∞–≤–Ω–æ–≥–æ!');
            } else if (hour >= 18 && completionRate < 50) {
                recommendations.push('–î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É. –í—ã–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–¥–∞—á—É —Å–µ–≥–æ–¥–Ω—è.');
            } else if (hour >= 22) {
                recommendations.push('–ü–æ–∑–¥–Ω–∏–π –≤–µ—á–µ—Ä - –≤—Ä–µ–º—è –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è');
            }

            // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–ª–µ–π
            const goalKeys = Object.entries(state.userGoals).filter(([_, v]) => v).map(([k]) => k);
            if (goalKeys.includes('health') && activeHabits < 2) {
                recommendations.push('–î–æ–±–∞–≤—å –ø—Ä–∏–≤—ã—á–∫—É "–ü—Ä–æ–≥—É–ª–∫–∞ 30 –º–∏–Ω" –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è');
            }
            if (goalKeys.includes('learning') && state.tasks.length < 3) {
                recommendations.push('–°–æ–∑–¥–∞–π –∑–∞–¥–∞—á—É –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è');
            }
            if (goalKeys.includes('productivity') && completionRate < 60) {
                recommendations.push('–ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ç—Ä–∏—Ü—É –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä–∞ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á');
            }

            // –ê–Ω–∞–ª–∏–∑ —ç–Ω–µ—Ä–≥–∏–∏
            let energyInsight = '';
            if (avgEnergy >= 80) {
                energyInsight = '–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏ –≤—ã—Å–æ–∫–∏–π! –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á.';
            } else if (avgEnergy >= 60) {
                energyInsight = '–•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –±–∞–ª–∞–Ω—Å —Ä–∞–±–æ—Ç—ã –∏ –æ—Ç–¥—ã—Ö–∞.';
            } else if (avgEnergy >= 40) {
                energyInsight = '–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –±–æ–ª—å—à–µ –æ—Ç–¥—ã—Ö–∞—Ç—å.';
            } else {
                energyInsight = '–ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏. –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏–ª.';
            }

            return {
                insights,
                recommendations: recommendations.slice(0, 5),
                patterns,
                completionRate: Math.round(completionRate),
                avgEnergy: Math.round(avgEnergy),
                activeHabits,
                habitRate: Math.round(habitRate),
                weekAvg: Math.round(weekAvg),
                energyInsight,
                consistency
            };
        }

        function renderWeeklyChart(stats) {
            const days = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë', '–í–°'];
            const maxValue = Math.max(...stats);

            return `
                <div class="chart-container">
                    <div class="chart-title">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div class="bar-chart">
                        ${stats.map((value, i) => {
                            const height = (value / 100) * 100;
                            return `
                                <div class="bar-wrapper" data-day="${i}">
                                    <div class="bar" style="height: ${height}%;">
                                        <div class="bar-value">${value}%</div>
                                    </div>
                                    <div class="bar-label">${days[i]}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCircularProgress(value, label, color) {
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (value / 100) * circumference;

            return `
                <div class="circular-progress">
                    <svg width="100" height="100">
                        <circle class="circular-progress-bg" cx="50" cy="50" r="${radius}"/>
                        <circle class="circular-progress-bar" cx="50" cy="50" r="${radius}"
                            style="stroke: ${color}; stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"/>
                    </svg>
                    <div class="circular-progress-text">
                        <span class="circular-progress-value" style="color: ${color};">${value}%</span>
                        <span class="circular-progress-label">${label}</span>
                    </div>
                </div>
            `;
        }

        function renderLiviCompact(liviState) {
            const mouthClass = liviState.mood === 'happy' ? '' :
                              liviState.mood === 'sad' ? 'sad' : 'neutral';

            return `
                <div class="livi-compact">
                    <div class="livi-character">
                        <div class="livi-body" style="background-color: ${liviState.color};">
                            <div class="livi-antenna left">
                                <div class="livi-antenna-ball"></div>
                            </div>
                            <div class="livi-antenna right">
                                <div class="livi-antenna-ball"></div>
                            </div>
                            <div class="livi-ear left"></div>
                            <div class="livi-ear right"></div>
                            <div class="livi-face-bg"></div>
                            <div class="livi-eyes">
                                <div class="livi-eye"></div>
                                <div class="livi-eye"></div>
                            </div>
                            <div class="livi-mouth ${mouthClass}"></div>
                        </div>
                    </div>
                    <div class="livi-info">
                        <div class="livi-status" style="color: ${liviState.color};">${liviState.label}</div>
                        <div class="livi-message">${liviState.phrase}</div>
                    </div>
                </div>
            `;
        }

        function renderDailyChallenge() {
            const challenge = getDailyChallenge();
            const progress = (state.challengeProgress / challenge.target) * 100;
            const timeLeft = getTimeUntilNextChallenge();

            return `
                <div class="challenge-card">
                    <div class="challenge-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="challenge-title">–ß–µ–ª–ª–µ–Ω–¥–∂ –¥–Ω—è</div>
                        </div>
                        <div class="countdown-timer">
                            ${createSvg('clock', colors.primary)}
                            <span id="challengeTimer">${String(timeLeft.hours).padStart(2, '0')}:${String(timeLeft.minutes).padStart(2, '0')}:${String(timeLeft.seconds).padStart(2, '0')}</span>
                        </div>
                    </div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${challenge.title}</div>
                    <div class="challenge-description">${challenge.description}</div>
                    <div style="display: inline-block; padding: 4px 12px; background-color: rgba(139, 154, 156, 0.2); border-radius: 8px; font-size: 12px; color: #999; margin-bottom: 16px;">
                        ${challenge.category}
                    </div>
                    <div class="challenge-progress">
                        <div class="progress-label">
                            <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                            <span><strong>${state.challengeProgress}</strong> / ${challenge.target} ${challenge.unit}</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                        </div>
                    </div>
                    ${!challenge.completed ? `
                        <button class="btn btn-primary" id="completeChallenge" style="margin-top: 12px;">
                            ${progress >= 100 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂' : '–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å'}
                        </button>
                    ` : `
                        <div style="text-align: center; padding: 12px; background-color: rgba(165, 189, 161, 0.2); border-radius: 12px; margin-top: 12px;">
                            <strong style="color: ${colors.accent3};">‚úì –ß–µ–ª–ª–µ–Ω–¥–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω! +50 –±–∞–ª–ª–æ–≤</strong>
                        </div>
                    `}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');

            if (!state.hasCompletedOnboarding) {
                app.innerHTML = renderOnboarding();
                attachOnboardingListeners();
                return;
            }

            updateStreak();
            app.innerHTML = renderMain();
            attachMainListeners();
            startCountdown();
        }

        function renderOnboarding() {
            const steps = [
                {
                    title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ livi',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏',
                    content: `
                        <div style="text-align: center;">
                            <p style="font-size: 18px; color: #999; margin-bottom: 24px;">
                                –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ–ø—ã—Ç
                            </p>
                            <button class="btn btn-primary" id="startOnboarding">
                                –ù–∞—á–∞—Ç—å ${createSvg('arrowRight', 'white')}
                            </button>
                        </div>
                    `
                },
                {
                    title: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è',
                    content: `
                        <div>
                            <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="${state.userInfo.name}" style="margin-bottom: 24px;">
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à–∏ —Ü–µ–ª–∏',
                    subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞–¥ —á–µ–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å',
                    content: `
                        <div>
                            ${[
                                { key: 'health', icon: 'heart', label: '–ó–¥–æ—Ä–æ–≤—å–µ', desc: '–°–ø–æ—Ä—Ç, –ø–∏—Ç–∞–Ω–∏–µ, —Å–æ–Ω' },
                                { key: 'learning', icon: 'book', label: '–û–±—É—á–µ–Ω–∏–µ', desc: '–ß—Ç–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, –Ω–∞–≤—ã–∫–∏' },
                                { key: 'productivity', icon: 'target', label: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', desc: '–ó–∞–¥–∞—á–∏, –ø—Ä–æ–µ–∫—Ç—ã, —Ä–∞–±–æ—Ç–∞' },
                                { key: 'mindfulness', icon: 'brain', label: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å', desc: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è, –¥—ã—Ö–∞–Ω–∏–µ' },
                                { key: 'sleep', icon: 'moon', label: '–°–æ–Ω', desc: '–†–µ–∂–∏–º, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞' },
                                { key: 'social', icon: 'coffee', label: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å', desc: '–î—Ä—É–∑—å—è, —Ö–æ–±–±–∏' }
                            ].map(goal => `
                                <button class="goal-button ${state.userGoals[goal.key] ? 'selected' : ''}" data-goal="${goal.key}">
                                    <div class="goal-icon">${createSvg(goal.icon, colors.primary)}</div>
                                    <div class="goal-content">
                                        <div class="goal-title">${goal.label}</div>
                                        <div class="goal-desc">${goal.desc}</div>
                                    </div>
                                    ${state.userGoals[goal.key] ? createSvg('check', colors.primary) : ''}
                                </button>
                            `).join('')}
                            <button class="btn btn-primary" id="nextStep" style="margin-top: 24px;" ${!Object.values(state.userGoals).some(v => v) ? 'disabled' : ''}>
                                –î–∞–ª–µ–µ
                            </button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à —Ä–µ–∂–∏–º',
                    subtitle: '–ö–æ–≥–¥–∞ –≤—ã –æ–±—ã—á–Ω–æ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å –∏ –ª–æ–∂–∏—Ç–µ—Å—å —Å–ø–∞—Ç—å?',
                    content: `
                        <div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('sunrise', colors.warning)} –í—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
                                </label>
                                <input type="time" id="wakeUpTime" value="${state.userInfo.wakeUpTime}">
                            </div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('moon', colors.secondary)} –í—Ä–µ–º—è —Å–Ω–∞
                                </label>
                                <input type="time" id="sleepTime" value="${state.userInfo.sleepTime}">
                            </div>
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥',
                    subtitle: '–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü?',
                    content: `
                        <div>
                            <textarea id="mainGoal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∏—Ç–∞—Ç—å 30 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –ø—Ä–æ–±–µ–∂–∞—Ç—å 5–∫–º, –≤—ã—É—á–∏—Ç—å 500 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤...">${state.userInfo.mainGoal}</textarea>
                            <button class="btn btn-primary" id="completeOnboarding" style="margin-top: 24px;">
                                –ù–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ ${createSvg('sparkles', 'white')}
                            </button>
                        </div>
                    `
                }
            ];

            const currentStep = steps[state.onboardingStep];

            return `
                <div class="onboarding-container slide-up">
                    <div class="onboarding-box">
                        ${state.onboardingStep === 0 ? `
                            <div class="logo-section">
                                <h1 class="logo-title">livi</h1>
                                <p class="logo-subtitle">–í–∞—à –ø—É—Ç—å –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è</p>
                            </div>
                        ` : `
                            <div class="progress-bar-container">
                                ${steps.slice(1).map((_, i) => `
                                    <div class="progress-bar ${i < state.onboardingStep ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                        `}
                        <div class="card">
                            <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 8px; color: white;">${currentStep.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 32px;">${currentStep.subtitle}</p>
                            ${currentStep.content}
                        </div>
                        ${state.onboardingStep > 0 ? `
                            <button id="prevStep" style="margin-top: 16px; width: 100%; padding: 12px; background: none; border: none; color: #666; cursor: pointer; font-weight: 500;">
                                –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function attachOnboardingListeners() {
            const startBtn = document.getElementById('startOnboarding');
            const nextBtn = document.getElementById('nextStep');
            const prevBtn = document.getElementById('prevStep');
            const completeBtn = document.getElementById('completeOnboarding');
            const goalButtons = document.querySelectorAll('[data-goal]');
            const userName = document.getElementById('userName');

            if (startBtn) startBtn.addEventListener('click', () => { state.onboardingStep = 1; render(); });
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (state.onboardingStep === 1 && userName) state.userInfo.name = userName.value.trim();
                    if (state.onboardingStep === 3) {
                        state.userInfo.wakeUpTime = document.getElementById('wakeUpTime').value;
                        state.userInfo.sleepTime = document.getElementById('sleepTime').value;
                    }
                    state.onboardingStep++;
                    render();
                });
            }
            if (prevBtn) prevBtn.addEventListener('click', () => { state.onboardingStep--; render(); });
            if (completeBtn) {
                completeBtn.addEventListener('click', async () => {
                    state.userInfo.mainGoal = document.getElementById('mainGoal').value.trim();
                    state.hasCompletedOnboarding = true;
                    state.streak = 1;
                    state.lastActiveDate = new Date().toDateString();

                    const habitsByGoal = {
                        health: { name: '–ó–∞—Ä—è–¥–∫–∞', color: colors.accent3 },
                        learning: { name: '–ß—Ç–µ–Ω–∏–µ', color: colors.accent2 },
                        productivity: { name: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: colors.primary },
                        mindfulness: { name: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', color: colors.secondary },
                        sleep: { name: '–°–æ–Ω 8 —á–∞—Å–æ–≤', color: colors.accent1 },
                        social: { name: '–û–±—â–µ–Ω–∏–µ', color: colors.warning }
                    };

                    state.habits = Object.entries(state.userGoals)
                        .filter(([_, selected]) => selected)
                        .map(([goal], index) => ({
                            id: Date.now() + index,
                            name: habitsByGoal[goal].name,
                            color: habitsByGoal[goal].color,
                            streak: 0,
                            completed: false,
                            lastCompletedDate: null
                        }));

                    await saveState();
                    render();
                });
            }
            goalButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const goal = btn.dataset.goal;
                    state.userGoals[goal] = !state.userGoals[goal];
                    render();
                });
            });
        }

        function renderMain() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const currentRank = getRank(state.streak);
            const aiAnalysis = generateAIAnalysis();

            return `
                <div class="header">
                    <div class="header-top">
                        <div class="header-title">livi</div>
                        <div class="header-stats">
                            <button class="stat-badge" style="background-color: rgba(212, 175, 122, 0.2);" id="showRank">
                                ${createSvg('flame', colors.warning)}
                                <span>${state.streak}</span>
                            </button>
                            <button class="stat-badge" style="background-color: rgba(139, 154, 156, 0.2);">
                                ${createSvg('star', colors.primary)}
                                <span>${state.totalPoints}</span>
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        ${['home', 'challenge', 'tasks', 'analysis'].map(tab => `
                            <div class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
                                ${tab === 'home' ? '–ì–ª–∞–≤–Ω–∞—è' : tab === 'challenge' ? '–ß–µ–ª–ª–µ–Ω–¥–∂' : tab === 'tasks' ? '–ó–∞–¥–∞—á–∏' : '–ê–Ω–∞–ª–∏–∑'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="content">
                    <div id="tabContent">${renderTabContent(completedTasks, currentRank, aiAnalysis)}</div>
                </div>
                ${state.showRankModal ? renderRankModal(currentRank) : ''}
            `;
        }

        function renderTabContent(completedTasks, currentRank, aiAnalysis) {
            if (state.activeTab === 'home') {
                const liviState = getLiviState(aiAnalysis.avgEnergy, aiAnalysis.completionRate, aiAnalysis.activeHabits);

                return `
                    ${renderLiviCompact(liviState)}

                    ${renderWeeklyChart(state.weeklyStats)}

                    <div class="grid-2">
                        <div class="stat-card card-hover">
                            ${createSvg('target', colors.primary)}
                            <div class="stat-value">${completedTasks}/${state.tasks.length}</div>
                            <div class="stat-label">–ó–∞–¥–∞—á–∏</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('clock', colors.accent3)}
                            <div class="stat-value">${state.habits.filter(h => h.completed).length}/${state.habits.length}</div>
                            <div class="stat-label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('zap', colors.warning)}
                            <div class="stat-value">${aiAnalysis.avgEnergy}%</div>
                            <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('award', currentRank.color)}
                            <div class="stat-value">${currentRank.icon}</div>
                            <div class="stat-label">${currentRank.title}</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
                        ${state.habits.length > 0 ? `
                            <div class="habit-grid">
                                ${state.habits.map(habit => `
                                    <div class="habit-card card-hover" data-habit="${habit.id}" style="background-color: ${habit.completed ? habit.color + '15' : '#0a0a0a'}; border-color: ${habit.completed ? habit.color + '40' : '#2a2a2a'};">
                                        <div class="habit-icon" style="background-color: ${habit.color}30;">
                                            <div style="font-size: 24px;">${habit.completed ? '‚úì' : '‚óã'}</div>
                                        </div>
                                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">${habit.name}</div>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            ${createSvg('flame', colors.warning)}
                                            <span style="font-size: 16px; font-weight: bold;">${habit.streak}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üå±</div>
                                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É</p>
                            </div>
                        `}
                    </div>

                    <div class="section">
                        <h2 class="section-title">–°–µ–≥–æ–¥–Ω—è</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.slice(0, 4).map(task => `
                                <div class="task-item">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">+${task.points}</div>
                                </div>
                            `).join('')}
                            ${state.tasks.length > 4 ? `
                                <button class="btn btn-secondary" id="goToTasks" style="margin-top: 16px;">–í—Å–µ –∑–∞–¥–∞—á–∏</button>
                            ` : ''}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ú®</div>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏</p>
                                <button class="btn btn-primary" id="goToTasks" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                            </div>
                        `}
                    </div>
                `;
            } else if (state.activeTab === 'challenge') {
                return `
                    <div class="section">
                        <h2 class="section-title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ß–µ–ª–ª–µ–Ω–¥–∂</h2>
                        <p style="font-size: 14px; color: #999; margin-bottom: 24px;">
                            –í—ã–ø–æ–ª–Ω—è–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å - –Ω–æ–≤–æ–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ!
                        </p>
                        ${renderDailyChallenge()}
                    </div>

                    <div class="section">
                        <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è —á–µ–ª–ª–µ–Ω–¥–∂–µ–π</h2>
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                            <p>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'tasks') {
                return `
                    <div class="section">
                        <h2 class="section-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="newTaskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" value="${state.newTask}" style="flex: 1; padding: 12px 16px;">
                            <button class="btn btn-primary" id="addTask" style="width: auto; padding: 12px 16px;">
                                ${createSvg('plus', 'white')}
                            </button>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–í—Å–µ –∑–∞–¥–∞—á–∏</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.map(task => `
                                <div class="task-item">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">${task.category || '–û–±—â–µ–µ'}</div>
                                    <button class="delete-btn" data-delete="${task.id}">
                                        ${createSvg('trash', '#ff4444')}
                                    </button>
                                </div>
                            `).join('')}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</p>
                            </div>
                        `}
                    </div>
                `;
            } else if (state.activeTab === 'analysis') {
                return `
                    <div class="section">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                            ${createSvg('brain', colors.primary)}
                            <div>
                                <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">–£–º–Ω—ã–π –ê–Ω–∞–ª–∏–∑</h2>
                                <p style="font-size: 14px; color: #999;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
                            </div>
                        </div>

                        <div class="circular-progress-container">
                            ${renderCircularProgress(aiAnalysis.completionRate, '–ó–∞–¥–∞—á–∏', colors.primary)}
                            ${renderCircularProgress(aiAnalysis.habitRate, '–ü—Ä–∏–≤—ã—á–∫–∏', colors.accent3)}
                            ${renderCircularProgress(aiAnalysis.avgEnergy, '–≠–Ω–µ—Ä–≥–∏—è', colors.warning)}
                        </div>

                        ${renderWeeklyChart(state.weeklyStats)}

                        <div style="padding: 16px; border-radius: 12px; background: linear-gradient(135deg, rgba(139, 154, 156, 0.2) 0%, rgba(139, 154, 156, 0.05) 100%); margin-bottom: 24px; border-left: 3px solid ${colors.primary};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                ${createSvg('activity', colors.primary)}
                                <strong style="font-size: 14px;">–£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏</strong>
                            </div>
                            <p style="font-size: 13px; color: #999;">${aiAnalysis.energyInsight}</p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                ${createSvg('trendingUp', colors.accent3)}
                                –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                            </h3>
                            ${aiAnalysis.patterns.map(pattern => `
                                <div class="insight-card">
                                    <div class="insight-title">${pattern.title}</div>
                                    <div class="insight-text">${pattern.text}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                ${createSvg('lightbulb', colors.primary)}
                                –ò–Ω—Å–∞–π—Ç—ã
                            </h3>
                            ${aiAnalysis.insights.map(insight => `
                                <div class="insight-card">
                                    <div class="insight-title">${insight.title}</div>
                                    <div class="insight-text">${insight.text}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                ${createSvg('target', colors.accent3)}
                                –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                            </h3>
                            ${aiAnalysis.recommendations.map((rec, i) => `
                                <div class="recommendation-card">
                                    <div class="recommendation-number">${i + 1}</div>
                                    <div class="recommendation-text">${rec}</div>
                                </div>
                            `).join('')}
                        </div>

                        ${state.userInfo.mainGoal ? `
                            <div style="padding: 16px; border-radius: 12px; background-color: rgba(212, 175, 122, 0.15); border: 1px solid rgba(212, 175, 122, 0.3);">
                                <p style="font-size: 12px; font-weight: bold; color: ${colors.warning}; margin-bottom: 8px;">–í–ê–®–ê –ì–õ–ê–í–ù–ê–Ø –¶–ï–õ–¨</p>
                                <p style="font-size: 14px;">${state.userInfo.mainGoal}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        function renderRankModal(currentRank) {
            const nextRank = getRank(currentRank.min + 1);
            const progressToNext = currentRank.min === 100 ? 100 : ((state.streak - currentRank.min) / (nextRank.min - currentRank.min)) * 100;

            return `
                <div class="modal fade-in" id="rankModal">
                    <div class="modal-content slide-up" onclick="event.stopPropagation();">
                        <div class="modal-handle"></div>
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">${currentRank.icon}</div>
                            <h2 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${currentRank.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 4px;">–£—Ä–æ–≤–µ–Ω—å ${currentRank.level}</p>
                            <p style="font-size: 14px; color: #666;">–¢–µ–∫—É—â–∏–π —Ä–∞–Ω–≥</p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span style="font-size: 14px; font-weight: bold; color: ${colors.primary};">
                                    ${currentRank.min === 100 ? '–ú–∞–∫—Å–∏–º—É–º' : Math.round(progressToNext) + '%'}
                                </span>
                            </div>
                            <div style="height: 12px; border-radius: 6px; background-color: #2a2a2a;">
                                <div style="height: 100%; border-radius: 6px; background-color: ${colors.primary}; width: ${progressToNext}%; transition: width 0.3s;"></div>
                            </div>
                            ${currentRank.min !== 100 ? `
                                <p style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                    –ï—â—ë ${nextRank.min - state.streak} –¥–Ω–µ–π –¥–æ "${nextRank.title}"
                                </p>
                            ` : ''}
                        </div>

                        ${[
                            { title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü', level: 1, days: '0-6' },
                            { title: '–°—Ç–∞—Ä—Ç–µ—Ä', icon: 'üå±', level: 2, days: '7-13' },
                            { title: '–≠–Ω—Ç—É–∑–∏–∞—Å—Ç', icon: 'üí™', level: 3, days: '14-29' },
                            { title: '–ü—Ä–æ—Ñ–∏', icon: 'üî•', level: 4, days: '30-49' },
                            { title: '–ú–∞—Å—Ç–µ—Ä', icon: '‚≠ê', level: 5, days: '50-99' },
                            { title: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', level: 6, days: '100+' }
                        ].map(rank => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 12px; background-color: ${rank.title === currentRank.title ? 'rgba(139, 154, 156, 0.2)' : '#0a0a0a'}; border: 1px solid ${rank.title === currentRank.title ? colors.primary : 'transparent'}; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(139, 154, 156, ${rank.title === currentRank.title ? '0.4' : '0.2'}); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                        ${rank.icon}
                                    </div>
                                    <div>
                                        <div style="font-size: 14px; font-weight: bold;">${rank.title}</div>
                                        <div style="font-size: 12px; color: #666;">–£—Ä–æ–≤–µ–Ω—å ${rank.level} ‚Ä¢ ${rank.days} –¥–Ω–µ–π</div>
                                    </div>
                                </div>
                                ${rank.title === currentRank.title ? createSvg('check', colors.primary) : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function attachMainListeners() {
            const tabs = document.querySelectorAll('[data-tab]');
            const showRankBtn = document.getElementById('showRank');
            const rankModal = document.getElementById('rankModal');
            const habitCards = document.querySelectorAll('[data-habit]');
            const taskChecks = document.querySelectorAll('[data-task-check]');
            const addTaskBtn = document.getElementById('addTask');
            const newTaskInput = document.getElementById('newTaskInput');
            const deleteButtons = document.querySelectorAll('[data-delete]');
            const goToTasksBtn = document.getElementById('goToTasks');
            const completeChallengeBtn = document.getElementById('completeChallenge');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                });
            });

            if (showRankBtn) {
                showRankBtn.addEventListener('click', () => {
                    state.showRankModal = true;
                    render();
                });
            }

            if (rankModal) {
                rankModal.addEventListener('click', (e) => {
                    if (e.target === rankModal) {
                        state.showRankModal = false;
                        render();
                    }
                });
            }

            habitCards.forEach(card => {
                card.addEventListener('click', async () => {
                    const habitId = parseInt(card.dataset.habit);
                    const habit = state.habits.find(h => h.id === habitId);

                    if (habit) {
                        const today = new Date().toDateString();

                        if (!habit.completed) {
                            habit.completed = true;
                            habit.lastCompletedDate = today;
                            habit.streak++;
                            state.totalPoints += 10;
                        } else {
                            habit.completed = false;
                            if (habit.streak > 0) habit.streak--;
                            state.totalPoints = Math.max(0, state.totalPoints - 10);
                        }

                        await saveState();
                        render();
                    }
                });
            });

            taskChecks.forEach(check => {
                check.addEventListener('click',            taskChecks.forEach(check => {
                check.addEventListener('click', async () => {
                    const taskId = parseInt(check.dataset.taskCheck);
                    const task = state.tasks.find(t => t.id === taskId);

                    if (task) {
                        task.completed = !task.completed;

                        if (task.completed) {
                            state.totalPoints += task.points || 5;
                        } else {
                            state.totalPoints = Math.max(0, state.totalPoints - (task.points || 5));
                        }

                        await saveState();
                        render();
                    }
                });
            });

            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', async () => {
                    const title = newTaskInput.value.trim();
                    if (!title) return;

                    state.tasks.push({
                        id: Date.now(),
                        title,
                        completed: false,
                        points: 5,
                        category: '–û–±—â–µ–µ'
                    });

                    newTaskInput.value = '';
                    await saveState();
                    render();
                });
            }

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = parseInt(btn.dataset.delete);
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    await saveState();
                    render();
                });
            });

            if (goToTasksBtn) {
                goToTasksBtn.addEventListener('click', () => {
                    state.activeTab = 'tasks';
                    render();
                });
            }

            if (completeChallengeBtn) {
                completeChallengeBtn.addEventListener('click', async () => {
                    const challenge = state.dailyChallenge;
                    if (!challenge || challenge.completed) return;

                    state.challengeProgress += 1;

                    if (state.challengeProgress >= challenge.target) {
                        challenge.completed = true;
                        state.totalPoints += 50;
                    }

                    await saveState();
                    render();
                });
            }
        }

        async function init() {
            await loadState();
            getDailyChallenge();
            render();

            const loading = document.getElementById('loadingScreen');
            if (loading) {
                setTimeout(() => {
                    loading.classList.add('fade-out');
                    setTimeout(() => loading.remove(), 300);
                }, 500);
            }
        }

        init();
    </script>
</body>
</html>

