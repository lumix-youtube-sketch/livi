<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>livi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: white;
            max-width: 428px;
            margin: 0 auto;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes gentlePulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.95; }
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        .slide-in { animation: slideIn 0.5s ease-out; }
        .gentle-pulse { animation: gentlePulse 3s ease-in-out infinite; }
        .card-hover:active { transform: scale(0.97); }
        .hidden { display: none !important; }

        .onboarding-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .onboarding-box {
            width: 100%;
            max-width: 400px;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo-title {
            font-size: 48px;
            font-weight: bold;
            color: #8B9A9C;
            margin-bottom: 12px;
        }

        .logo-subtitle {
            font-size: 18px;
            color: #999;
        }

        .card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 32px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #999;
            margin-bottom: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 16px;
            background-color: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            outline: none;
        }

        textarea {
            min-height: 128px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 18px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #8B9A9C;
            color: white;
        }

        .btn-secondary {
            background-color: #0a0a0a;
            color: #8B9A9C;
        }

        .btn:disabled {
            background-color: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        .progress-bar-container {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-bar {
            height: 4px;
            flex: 1;
            border-radius: 2px;
            background-color: #2a2a2a;
        }

        .progress-bar.active {
            background-color: #8B9A9C;
        }

        .goal-button {
            width: 100%;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .goal-button.selected {
            background-color: rgba(139, 154, 156, 0.2);
            border-color: rgba(139, 154, 156, 0.4);
        }

        .goal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background-color: rgba(139, 154, 156, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .goal-content {
            flex: 1;
        }

        .goal-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: white;
        }

        .goal-desc {
            font-size: 14px;
            color: #666;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #2a2a2a;
            padding: 16px 20px;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            cursor: pointer;
        }

        .tab.active {
            color: white;
            border-bottom-color: #8B9A9C;
        }

        .content {
            padding: 24px 20px;
            padding-bottom: 100px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
        }

        .stat-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .section {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .habit-card {
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: center;
            cursor: pointer;
        }

        .habit-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: #0a0a0a;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
        }

        .checkbox.checked {
            background-color: #8B9A9C;
            border-color: #8B9A9C;
        }

        .task-title {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .task-points {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 8px;
            background-color: rgba(139, 154, 156, 0.25);
            color: #8B9A9C;
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            width: 100%;
            max-width: 428px;
            background-color: #0f0f0f;
            border-top: 1px solid #2a2a2a;
            border-radius: 24px 24px 0 0;
            padding: 32px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-handle {
            width: 48px;
            height: 4px;
            background-color: #2a2a2a;
            border-radius: 2px;
            margin: 0 auto 24px;
        }

        .livi-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 0;
        }

        .livi-circle {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .livi-inner {
            border-radius: 50%;
        }

        .livi-label {
            margin-top: 24px;
            font-size: 18px;
            font-weight: bold;
        }

        .livi-desc {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }

        input[type="time"] {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .delete-btn {
            padding: 8px;
            background-color: rgba(255, 68, 68, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        svg {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const colors = {
            primary: '#8B9A9C',
            secondary: '#B8A8C7',
            accent1: '#9CB3B5',
            accent2: '#A8B5C7',
            accent3: '#A5BDA1',
            warning: '#D4AF7A',
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const getInitialState = () => ({
            hasCompletedOnboarding: false,
            onboardingStep: 0,
            activeTab: 'home',
            showRankModal: false,
            selectedHabit: null,
            newTask: '',
            userGoals: {
                health: false,
                learning: false,
                productivity: false,
                mindfulness: false,
                sleep: false,
                social: false
            },
            userInfo: {
                name: '',
                wakeUpTime: '07:00',
                sleepTime: '23:00',
                mainGoal: ''
            },
            tasks: [],
            habits: [],
            streak: 0,
            totalPoints: 0,
            lastActiveDate: new Date().toDateString()
        });

        let state = getInitialState();
        let isLoading = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ Telegram Cloud Storage
        async function loadState() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ CloudStorage
                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.getItem('livi_state', (error, value) => {
                            if (!error && value) {
                                try {
                                    const loaded = JSON.parse(value);
                                    state = { ...getInitialState(), ...loaded };
                                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Telegram Cloud');
                                } catch (e) {
                                    console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
                                }
                            } else {
                                console.log('üì¶ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                            }
                            isLoading = false;
                            resolve();
                        });
                    });
                } else {
                    // Fallback –Ω–∞ window.storage –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
                    if (typeof window.storage !== 'undefined') {
                        const result = await window.storage.get('livi-app-state', false);
                        if (result && result.value) {
                            const loaded = JSON.parse(result.value);
                            state = { ...getInitialState(), ...loaded };
                            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ window.storage');
                        }
                    }
                    isLoading = false;
                }
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e.message);
                isLoading = false;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ Telegram Cloud Storage
        async function saveState() {
            try {
                const stateString = JSON.stringify(state);
                
                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.setItem('livi_state', stateString, (error, saved) => {
                            if (!error) {
                                console.log('üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Telegram Cloud');
                            } else {
                                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                            }
                            resolve();
                        });
                    });
                } else {
                    // Fallback –Ω–∞ window.storage
                    if (typeof window.storage !== 'undefined') {
                        await window.storage.set('livi-app-state', stateString, false);
                        console.log('üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ window.storage');
                    }
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∏–∫–∞
        function updateStreak() {
            const today = new Date().toDateString();
            if (state.lastActiveDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (state.lastActiveDate === yesterday.toDateString()) {
                    state.streak++;
                } else {
                    state.streak = 1;
                }
                state.lastActiveDate = today;
                saveState();
            }
        }

        function createSvg(name, color = 'currentColor') {
            const icons = {
                arrowRight: '<line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>',
                heart: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
                book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
                target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
                brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>',
                moon: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
                coffee: '<path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>',
                sunrise: '<path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                sparkles: '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/>',
                flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
                star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
                clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                award: '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>',
                trendingUp: '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
                chevronRight: '<polyline points="9 18 15 12 9 6"/>',
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                circle: '<circle cx="12" cy="12" r="10"/>'
            };
            return `<svg width="24" height="24" viewBox="0 0 24 24" style="color: ${color}">${icons[name]}</svg>`;
        }

        function getLiviState(energy, completion, habits) {
            const avgScore = (energy + completion + (habits / 4 * 100)) / 3;
            
            if (avgScore >= 85) return {
                size: 140,
                opacity: 1,
                glow: '0 0 40px rgba(139, 154, 156, 0.6)',
                color: colors.primary,
                innerSize: 100,
                label: '–ü—Ä–æ—Ü–≤–µ—Ç–∞—é—â–∏–π'
            };
            if (avgScore >= 70) return {
                size: 120,
                opacity: 0.9,
                glow: '0 0 30px rgba(139, 154, 156, 0.4)',
                color: colors.primary,
                innerSize: 85,
                label: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π'
            };
            if (avgScore >= 50) return {
                size: 100,
                opacity: 0.75,
                glow: '0 0 20px rgba(139, 154, 156, 0.3)',
                color: colors.primary,
                innerSize: 70,
                label: '–§–æ—Ä–º–∏—Ä—É—é—â–∏–π—Å—è'
            };
            return {
                size: 80,
                opacity: 0.6,
                glow: '0 0 10px rgba(139, 154, 156, 0.2)',
                color: '#666',
                innerSize: 55,
                label: '–ó–∞—Ä–æ–∂–¥–∞—é—â–∏–π—Å—è'
            };
        }

        function getRank(streakDays) {
            if (streakDays >= 100) return { title: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', level: 6, color: '#FFD700', min: 100 };
            if (streakDays >= 50) return { title: '–ú–∞—Å—Ç–µ—Ä', icon: '‚≠ê', level: 5, color: colors.warning, min: 50 };
            if (streakDays >= 30) return { title: '–ü—Ä–æ—Ñ–∏', icon: 'üî•', level: 4, color: colors.accent3, min: 30 };
            if (streakDays >= 14) return { title: '–≠–Ω—Ç—É–∑–∏–∞—Å—Ç', icon: 'üí™', level: 3, color: colors.primary, min: 14 };
            if (streakDays >= 7) return { title: '–°—Ç–∞—Ä—Ç–µ—Ä', icon: 'üå±', level: 2, color: colors.accent2, min: 7 };
            return { title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü', level: 1, color: colors.secondary, min: 0 };
        }

        function generateAIAnalysis() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const totalTasks = state.tasks.length || 1;
            const completionRate = (completedTasks / totalTasks) * 100;
            const activeHabits = state.habits.filter(h => h.completed).length;
            
            const avgEnergy = completionRate >= 75 ? 90 : completionRate >= 50 ? 75 : 60;

            let insights = [];
            let recommendations = [];
            let reflections = [];

            reflections.push(`${Math.round(completionRate)}% –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`);
            reflections.push(`–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏: ${Math.round(avgEnergy)}%`);
            reflections.push(`${activeHabits} –∏–∑ ${state.habits.length} –ø—Ä–∏–≤—ã—á–µ–∫ –∞–∫—Ç–∏–≤–Ω—ã`);
            reflections.push(`–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è: ${state.streak} –¥–Ω–µ–π`);

            if (completionRate >= 75) {
                insights.push('–û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å! –í—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∑–∞–¥–∞—á.');
            } else if (completionRate >= 50) {
                insights.push('–•–æ—Ä–æ—à–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–æ –µ—Å—Ç—å –∫—É–¥–∞ —Ä–∞—Å—Ç–∏.');
                recommendations.push('–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–±–∏—Ç—å –∫—Ä—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±–æ–ª–µ–µ –º–µ–ª–∫–∏–µ');
            } else {
                insights.push('–ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ - –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.');
                recommendations.push('–ù–∞—á–Ω–∏—Ç–µ —Å 2-3 –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á –≤ –¥–µ–Ω—å');
            }

            if (activeHabits >= 3) {
                insights.push('–í—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏!');
            } else if (activeHabits > 0) {
                insights.push('–•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ —Å –ø—Ä–∏–≤—ã—á–∫–∞–º–∏!');
                recommendations.push('–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –æ–¥–Ω—É –ø—Ä–∏–≤—ã—á–∫—É –¥–ª—è –±–∞–ª–∞–Ω—Å–∞');
            } else {
                insights.push('–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.');
                recommendations.push('–ù–∞—á–Ω–∏—Ç–µ —Å –æ–¥–Ω–æ–π –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–≤—ã—á–∫–∏');
            }

            return {
                insights,
                recommendations,
                reflections,
                completionRate: Math.round(completionRate),
                avgEnergy: Math.round(avgEnergy),
                activeHabits
            };
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.hasCompletedOnboarding) {
                app.innerHTML = renderOnboarding();
                attachOnboardingListeners();
                return;
            }

            updateStreak();
            app.innerHTML = renderMain();
            attachMainListeners();
        }

        function renderOnboarding() {
            const steps = [
                {
                    title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ livi! üëã',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏',
                    content: `
                        <div style="text-align: center;">
                            <p style="font-size: 18px; color: #999; margin-bottom: 24px;">
                                –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ–ø—ã—Ç
                            </p>
                            <button class="btn btn-primary" id="startOnboarding">
                                –ù–∞—á–∞—Ç—å ${createSvg('arrowRight', 'white')}
                            </button>
                        </div>
                    `
                },
                {
                    title: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è',
                    content: `
                        <div>
                            <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="${state.userInfo.name}" style="margin-bottom: 24px;">
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à–∏ —Ü–µ–ª–∏',
                    subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞–¥ —á–µ–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å',
                    content: `
                        <div>
                            ${[
                                { key: 'health', icon: 'heart', label: '–ó–¥–æ—Ä–æ–≤—å–µ', desc: '–°–ø–æ—Ä—Ç, –ø–∏—Ç–∞–Ω–∏–µ, —Å–æ–Ω' },
                                { key: 'learning', icon: 'book', label: '–û–±—É—á–µ–Ω–∏–µ', desc: '–ß—Ç–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, –Ω–∞–≤—ã–∫–∏' },
                                { key: 'productivity', icon: 'target', label: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', desc: '–ó–∞–¥–∞—á–∏, –ø—Ä–æ–µ–∫—Ç—ã, —Ä–∞–±–æ—Ç–∞' },
                                { key: 'mindfulness', icon: 'brain', label: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å', desc: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è, –¥—ã—Ö–∞–Ω–∏–µ' },
                                { key: 'sleep', icon: 'moon', label: '–°–æ–Ω', desc: '–†–µ–∂–∏–º, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞' },
                                { key: 'social', icon: 'coffee', label: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å', desc: '–î—Ä—É–∑—å—è, —Ö–æ–±–±–∏' }
                            ].map(goal => `
                                <button class="goal-button ${state.userGoals[goal.key] ? 'selected' : ''}" data-goal="${goal.key}">
                                    <div class="goal-icon">${createSvg(goal.icon, colors.primary)}</div>
                                    <div class="goal-content">
                                        <div class="goal-title">${goal.label}</div>
                                        <div class="goal-desc">${goal.desc}</div>
                                    </div>
                                    ${state.userGoals[goal.key] ? createSvg('check', colors.primary) : ''}
                                </button>
                            `).join('')}
                            <button class="btn btn-primary" id="nextStep" style="margin-top: 24px;" ${!Object.values(state.userGoals).some(v => v) ? 'disabled' : ''}>
                                –î–∞–ª–µ–µ
                            </button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à —Ä–µ–∂–∏–º',
                    subtitle: '–ö–æ–≥–¥–∞ –≤—ã –æ–±—ã—á–Ω–æ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å –∏ –ª–æ–∂–∏—Ç–µ—Å—å —Å–ø–∞—Ç—å?',
                    content: `
                        <div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('sunrise', colors.warning)} –í—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
                                </label>
                                <input type="time" id="wakeUpTime" value="${state.userInfo.wakeUpTime}">
                            </div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('moon', colors.secondary)} –í—Ä–µ–º—è —Å–Ω–∞
                                </label>
                                <input type="time" id="sleepTime" value="${state.userInfo.sleepTime}">
                            </div>
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥!',
                    subtitle: '–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü?',
                    content: `
                        <div>
                            <textarea id="mainGoal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∏—Ç–∞—Ç—å 30 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –ø—Ä–æ–±–µ–∂–∞—Ç—å 5–∫–º, –≤—ã—É—á–∏—Ç—å 500 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤...">${state.userInfo.mainGoal}</textarea>
                            <button class="btn btn-primary" id="completeOnboarding" style="margin-top: 24px;">
                                –ù–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ ${createSvg('sparkles', 'white')}
                            </button>
                        </div>
                    `
                }
            ];

            const currentStep = steps[state.onboardingStep];

            return `
                <div class="onboarding-container slide-in">
                    <div class="onboarding-box">
                        ${state.onboardingStep === 0 ? `
                            <div class="logo-section">
                                <h1 class="logo-title">livi</h1>
                                <p class="logo-subtitle">–í–∞—à –ø—É—Ç—å –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è</p>
                            </div>
                        ` : `
                            <div class="progress-bar-container">
                                ${steps.slice(1).map((_, i) => `
                                    <div class="progress-bar ${i < state.onboardingStep ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                        `}
                        <div class="card">
                            <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 8px; color: white;">${currentStep.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 32px;">${currentStep.subtitle}</p>
                            ${currentStep.content}
                        </div>
                        ${state.onboardingStep > 0 ? `
                            <button id="prevStep" style="margin-top: 16px; width: 100%; padding: 12px; background: none; border: none; color: #666; cursor: pointer; font-weight: 500;">
                                –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderMain() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const currentRank = getRank(state.streak);
            const aiAnalysis = generateAIAnalysis();

            return `
                <div class="header">
                    <div class="header-top">
                        <div class="header-title">livi</div>
                        <div class="header-stats">
                            <button class="stat-badge gentle-pulse" style="background-color: rgba(212, 175, 122, 0.2);" id="showRank">
                                ${createSvg('flame', colors.warning)}
                                <span>${state.streak}</span>
                            </button>
                            <button class="stat-badge" style="background-color: rgba(139, 154, 156, 0.2);">
                                ${createSvg('star', colors.primary)}
                                <span>${state.totalPoints}</span>
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        ${['home', 'tasks', 'analysis', 'livi'].map(tab => `
                            <div class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
                                ${tab === 'home' ? '–ì–ª–∞–≤–Ω–∞—è' : tab === 'tasks' ? '–ó–∞–¥–∞—á–∏' : tab === 'analysis' ? '–ê–Ω–∞–ª–∏–∑' : 'Livi'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="content">
                    <div id="tabContent">${renderTabContent(completedTasks, currentRank, aiAnalysis)}</div>
                </div>
                ${state.showRankModal ? renderRankModal(currentRank) : ''}
                ${state.selectedHabit ? renderHabitModal() : ''}
            `;
        }

        function renderTabContent(completedTasks, currentRank, aiAnalysis) {
            if (state.activeTab === 'home') {
                return `
                    <div class="grid-2">
                        <div class="stat-card card-hover" style="background-color: #0f0f0f;">
                            ${createSvg('target', colors.primary)}
                            <div class="stat-value">${completedTasks}/${state.tasks.length}</div>
                            <div class="stat-label">–ó–∞–¥–∞—á–∏</div>
                        </div>
                        <div class="stat-card card-hover" style="background-color: #0f0f0f;">
                            ${createSvg('clock', colors.accent3)}
                            <div class="stat-value">${state.habits.filter(h => h.completed).length}/${state.habits.length}</div>
                            <div class="stat-label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
                        </div>
                        <div class="stat-card card-hover" style="background-color: #0f0f0f;">
                            ${createSvg('zap', colors.warning)}
                            <div class="stat-value">${aiAnalysis.avgEnergy}%</div>
                            <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                        </div>
                        <div class="stat-card card-hover" style="background-color: #0f0f0f;">
                            ${createSvg('award', currentRank.color)}
                            <div class="stat-value">${currentRank.icon}</div>
                            <div class="stat-label">${currentRank.title}</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
                        ${state.habits.length > 0 ? `
                            <div class="habit-grid">
                                ${state.habits.map(habit => `
                                    <div class="habit-card card-hover" data-habit="${habit.id}" style="background-color: ${habit.completed ? habit.color + '15' : '#0a0a0a'}; border-color: ${habit.completed ? habit.color + '40' : '#2a2a2a'};">
                                        <div class="habit-icon" style="background-color: ${habit.color}30;">
                                            <div style="font-size: 24px;">${habit.completed ? '‚úì' : '‚óã'}</div>
                                        </div>
                                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">${habit.name}</div>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            ${createSvg('flame', colors.warning)}
                                            <span style="font-size: 16px; font-weight: bold;">${habit.streak}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üå±</div>
                                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</p>
                                <button class="btn btn-primary" id="addFirstHabit" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
                            </div>
                        `}
                    </div>

                    <div class="section">
                        <h2 class="section-title">–°–µ–≥–æ–¥–Ω—è</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.slice(0, 4).map(task => `
                                <div class="task-item card-hover">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">+${task.points}</div>
                                </div>
                            `).join('')}
                            ${state.tasks.length > 4 ? `
                                <button class="btn btn-secondary" id="goToTasks" style="margin-top: 16px;">–í—Å–µ –∑–∞–¥–∞—á–∏ ‚Üí</button>
                            ` : ''}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ú®</div>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏!</p>
                                <button class="btn btn-primary" id="goToTasks" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                            </div>
                        `}
                    </div>

                    <div class="section">
                        <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h2>
                        
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º</h3>
                            <div style="display: flex; gap: 8px; align-items: flex-end; height: 120px;">
                                ${['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map((day, i) => {
                                    const height = Math.random() * 80 + 20;
                                    return `
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                            <div style="width: 100%; background: linear-gradient(to top, ${colors.primary}, ${colors.accent1}); border-radius: 8px 8px 0 0; height: ${height}px; position: relative;">
                                                <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; color: ${colors.primary};">${Math.round(height)}%</div>
                                            </div>
                                            <div style="font-size: 12px; color: #666; font-weight: 500;">${day}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á</h3>
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div style="position: relative; width: 120px; height: 120px;">
                                    <svg viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="#2a2a2a" stroke-width="20"/>
                                        <circle cx="60" cy="60" r="50" fill="none" stroke="${colors.primary}" stroke-width="20" 
                                                stroke-dasharray="${(state.tasks.filter(t => t.completed).length / (state.tasks.length || 1)) * 314} 314"
                                                stroke-linecap="round"/>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold;">${Math.round((state.tasks.filter(t => t.completed).length / (state.tasks.length || 1)) * 100)}%</div>
                                        <div style="font-size: 10px; color: #666;">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; border-radius: 3px; background-color: ${colors.primary};"></div>
                                            –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                        </span>
                                        <span style="font-size: 14px; font-weight: bold;">${state.tasks.filter(t => t.completed).length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; border-radius: 3px; background-color: #2a2a2a;"></div>
                                            –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                                        </span>
                                        <span style="font-size: 14px; font-weight: bold;">${state.tasks.filter(t => !t.completed).length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 12px; height: 12px; border-radius: 3px; background-color: ${colors.accent3};"></div>
                                            –í—Å–µ–≥–æ
                                        </span>
                                        <span style="font-size: 14px; font-weight: bold;">${state.tasks.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏–≤—ã—á–µ–∫</h3>
                            ${state.habits.slice(0, 4).map(habit => {
                                const progress = Math.min((habit.streak / 30) * 100, 100);
                                return `
                                    <div style="margin-bottom: 16px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="font-size: 14px; font-weight: 500;">${habit.name}</span>
                                            <span style="font-size: 14px; font-weight: bold; color: ${habit.color};">${habit.streak} –¥–Ω–µ–π</span>
                                        </div>
                                        <div style="height: 8px; background-color: #2a2a2a; border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; background: linear-gradient(to right, ${habit.color}, ${habit.color}80); width: ${progress}%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${state.habits.length === 0 ? `
                                <div class="empty-state" style="padding: 20px;">
                                    <p style="font-size: 14px;">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
                                </div>
                            ` : ''}
                        </div>

                        <div>
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                            <div class="grid-2">
                                <div style="padding: 16px; border-radius: 12px; background-color: rgba(139, 154, 156, 0.15); text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">üî•</div>
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">${state.streak}</div>
                                    <div style="font-size: 12px; color: #999;">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                                </div>
                                <div style="padding: 16px; border-radius: 12px; background-color: rgba(165, 189, 161, 0.15); text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">‚≠ê</div>
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">${state.totalPoints}</div>
                                    <div style="font-size: 12px; color: #999;">–í—Å–µ–≥–æ –æ—á–∫–æ–≤</div>
                                </div>
                                <div style="padding: 16px; border-radius: 12px; background-color: rgba(212, 175, 122, 0.15); text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">${state.tasks.filter(t => t.completed).length}</div>
                                    <div style="font-size: 12px; color: #999;">–ó–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                                </div>
                                <div style="padding: 16px; border-radius: 12px; background-color: rgba(168, 181, 199, 0.15); text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">üí™</div>
                                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 4px;">${state.habits.reduce((sum, h) => sum + h.streak, 0)}</div>
                                    <div style="font-size: 12px; color: #999;">–î–Ω–µ–π –ø—Ä–∏–≤—ã—á–µ–∫</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'tasks') {
                return `
                    <div class="section">
                        <h2 class="section-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="newTaskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" value="${state.newTask}" style="flex: 1; padding: 12px 16px;">
                            <button class="btn btn-primary" id="addTask" style="width: auto; padding: 12px 16px;">
                                ${createSvg('plus', 'white')}
                            </button>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–í—Å–µ –∑–∞–¥–∞—á–∏</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.map(task => `
                                <div class="task-item" style="margin-bottom: 12px;">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">${task.category || '–û–±—â–µ–µ'}</div>
                                    <button class="delete-btn" data-delete="${task.id}">
                                        ${createSvg('trash', '#ff4444')}
                                    </button>
                                </div>
                            `).join('')}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</p>
                            </div>
                        `}
                    </div>
                `;
            } else if (state.activeTab === 'analysis') {
                return `
                    <div class="section">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                            ${createSvg('brain', colors.primary)}
                            <div>
                                <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">–ò–ò –ê–Ω–∞–ª–∏–∑</h2>
                                <p style="font-size: 14px; color: #999;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
                            </div>
                        </div>

                        <div class="grid-2" style="margin-bottom: 24px;">
                            <div style="padding: 16px; border-radius: 12px; background-color: rgba(139, 154, 156, 0.15); text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 4px;">${aiAnalysis.completionRate}%</div>
                                <div style="font-size: 12px; font-weight: 500; color: #999;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
                            </div>
                            <div style="padding: 16px; border-radius: 12px; background-color: rgba(165, 189, 161, 0.15); text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; margin-bottom: 4px;">${aiAnalysis.avgEnergy}%</div>
                                <div style="font-size: 12px; font-weight: 500; color: #999;">–≠–Ω–µ—Ä–≥–∏—è</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                ${createSvg('sparkles', colors.primary)}
                                –ò–Ω—Å–∞–π—Ç—ã
                            </h3>
                            ${aiAnalysis.insights.map(insight => `
                                <div style="padding: 12px; border-radius: 12px; background-color: #0a0a0a; margin-bottom: 8px;">
                                    <p style="font-size: 14px;">${insight}</p>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                ${createSvg('trendingUp', colors.accent3)}
                                –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                            </h3>
                            ${aiAnalysis.recommendations.map(rec => `
                                <div style="padding: 12px; border-radius: 12px; background-color: rgba(165, 189, 161, 0.15); margin-bottom: 8px; display: flex; align-items: start; gap: 12px;">
                                    ${createSvg('chevronRight', colors.accent3)}
                                    <p style="font-size: 14px;">${rec}</p>
                                </div>
                            `).join('')}
                        </div>

                        ${state.userInfo.mainGoal ? `
                            <div style="padding: 16px; border-radius: 12px; background-color: rgba(212, 175, 122, 0.15);">
                                <p style="font-size: 12px; font-weight: bold; color: ${colors.warning}; margin-bottom: 8px;">–í–ê–®–ê –¶–ï–õ–¨</p>
                                <p style="font-size: 14px;">${state.userInfo.mainGoal}</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="section">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–ª–∏</h3>
                        ${Object.entries(state.userGoals).filter(([_, v]) => v).map(([key]) => {
                            const goalLabels = {
                                health: '–ó–¥–æ—Ä–æ–≤—å–µ',
                                learning: '–û–±—É—á–µ–Ω–∏–µ',
                                productivity: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                                mindfulness: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å',
                                sleep: '–°–æ–Ω',
                                social: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å'
                            };
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background-color: #0a0a0a; margin-bottom: 8px;">
                                    ${createSvg('check', colors.primary)}
                                    <span style="font-size: 14px; font-weight: 500;">${goalLabels[key]}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (state.activeTab === 'livi') {
                const liviState = getLiviState(aiAnalysis.avgEnergy, aiAnalysis.completionRate, aiAnalysis.activeHabits);
                
                return `
                    <div class="section">
                        <div class="livi-character">
                            <div class="livi-circle" style="width: ${liviState.size}px; height: ${liviState.size}px; background-color: ${liviState.color}20; border: 2px solid ${liviState.color}; opacity: ${liviState.opacity}; box-shadow: ${liviState.glow};">
                                <div class="livi-inner" style="width: ${liviState.innerSize}px; height: ${liviState.innerSize}px; background-color: ${liviState.color}40; border: 1px solid ${liviState.color};"></div>
                            </div>
                            <div class="livi-label" style="color: ${liviState.color};">${liviState.label}</div>
                            <div class="livi-desc">–û—Ç—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
                        ${aiAnalysis.reflections.map(reflection => `
                            <div style="padding: 16px; border-radius: 12px; background-color: #0a0a0a; margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${colors.primary}; flex-shrink: 0;"></div>
                                <p style="font-size: 14px;">${reflection}</p>
                            </div>
                        `).join('')}
                    </div>

                    ${state.userInfo.mainGoal ? `
                        <div class="section">
                            <p style="font-size: 12px; font-weight: bold; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">–ó–∞—è–≤–ª–µ–Ω–Ω–∞—è —Ü–µ–ª—å</p>
                            <p style="font-size: 16px;">${state.userInfo.mainGoal}</p>
                        </div>
                    ` : ''}

                    <div class="section">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                        ${Object.entries(state.userGoals).filter(([_, v]) => v).map(([key]) => {
                            const goalLabels = {
                                health: '–ó–¥–æ—Ä–æ–≤—å–µ',
                                learning: '–û–±—É—á–µ–Ω–∏–µ',
                                productivity: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                                mindfulness: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å',
                                sleep: '–°–æ–Ω',
                                social: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å'
                            };
                            return `
                                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background-color: #0a0a0a; margin-bottom: 8px;">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${colors.primary}; flex-shrink: 0;"></div>
                                    <span style="font-size: 14px; font-weight: 500;">${goalLabels[key]}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
        }

        function renderRankModal(currentRank) {
            const nextRank = getRank(currentRank.min + 1);
            const progressToNext = currentRank.min === 100 ? 100 : ((state.streak - currentRank.min) / (nextRank.min - currentRank.min)) * 100;

            return `
                <div class="modal" id="rankModal">
                    <div class="modal-content" onclick="event.stopPropagation();">
                        <div class="modal-handle"></div>
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">${currentRank.icon}</div>
                            <h2 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${currentRank.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 4px;">–£—Ä–æ–≤–µ–Ω—å ${currentRank.level}</p>
                            <p style="font-size: 14px; color: #666;">–¢–µ–∫—É—â–∏–π —Ä–∞–Ω–≥</p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span style="font-size: 14px; font-weight: bold; color: ${colors.primary};">
                                    ${currentRank.min === 100 ? '–ú–∞–∫—Å–∏–º—É–º' : Math.round(progressToNext) + '%'}
                                </span>
                            </div>
                            <div style="height: 12px; border-radius: 6px; background-color: #2a2a2a;">
                                <div style="height: 100%; border-radius: 6px; background-color: ${colors.primary}; width: ${progressToNext}%;"></div>
                            </div>
                            ${currentRank.min !== 100 ? `
                                <p style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                    –ï—â—ë ${nextRank.min - state.streak} –¥–Ω–µ–π –¥–æ "${nextRank.title}"
                                </p>
                            ` : ''}
                        </div>

                        ${[
                            { title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü', level: 1, days: '0-6' },
                            { title: '–°—Ç–∞—Ä—Ç–µ—Ä', icon: 'üå±', level: 2, days: '7-13' },
                            { title: '–≠–Ω—Ç—É–∑–∏–∞—Å—Ç', icon: 'üí™', level: 3, days: '14-29' },
                            { title: '–ü—Ä–æ—Ñ–∏', icon: 'üî•', level: 4, days: '30-49' },
                            { title: '–ú–∞—Å—Ç–µ—Ä', icon: '‚≠ê', level: 5, days: '50-99' },
                            { title: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', level: 6, days: '100+' }
                        ].map(rank => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 12px; background-color: ${rank.title === currentRank.title ? 'rgba(139, 154, 156, 0.2)' : '#0a0a0a'}; border: 1px solid ${rank.title === currentRank.title ? colors.primary : 'transparent'}; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(139, 154, 156, ${rank.title === currentRank.title ? '0.4' : '0.2'}); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                        ${rank.icon}
                                    </div>
                                    <div>
                                        <div style="font-size: 14px; font-weight: bold;">${rank.title}</div>
                                        <div style="font-size: 12px; color: #666;">–£—Ä–æ–≤–µ–Ω—å ${rank.level} ‚Ä¢ ${rank.days} –¥–Ω–µ–π</div>
                                    </div>
                                </div>
                                ${rank.title === currentRank.title ? createSvg('check', colors.primary) : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderHabitModal() {
            const habit = state.selectedHabit;
            return `
                <div class="modal" id="habitModal">
                    <div class="modal-content" onclick="event.stopPropagation();">
                        <div class="modal-handle"></div>
                        <div style="text-align: center;">
                            <div style="width: 80px; height: 80px; border-radius: 16px; background-color: ${habit.color}30; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px;">
                                ${habit.completed ? '‚úì' : '‚óã'}
                            </div>
                            <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">${habit.name}</h2>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 24px;">
                                ${createSvg('flame', colors.warning)}
                                <span style="font-size: 32px; font-weight: bold;">${habit.streak}</span>
                                <span style="font-size: 18px; color: #999;">–¥–Ω–µ–π</span>
                            </div>
                            <p style="font-size: 16px; color: #999; margin-bottom: 24px;">
                                ${habit.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è! üéâ' : '–ù–µ –∑–∞–±—É–¥—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å'}
                            </p>
                            <button class="btn" style="background-color: ${habit.color}; color: white;" id="closeHabitModal">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachOnboardingListeners() {
            const startBtn = document.getElementById('startOnboarding');
            const nextBtn = document.getElementById('nextStep');
            const prevBtn = document.getElementById('prevStep');
            const completeBtn = document.getElementById('completeOnboarding');
            const goalButtons = document.querySelectorAll('[data-goal]');
            const userName = document.getElementById('userName');

            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    state.onboardingStep = 1;
                    render();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (state.onboardingStep === 1 && userName) {
                        state.userInfo.name = userName.value.trim();
                    }
                    if (state.onboardingStep === 3) {
                        state.userInfo.wakeUpTime = document.getElementById('wakeUpTime').value;
                        state.userInfo.sleepTime = document.getElementById('sleepTime').value;
                    }
                    state.onboardingStep++;
                    render();
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    state.onboardingStep--;
                    render();
                });
            }

            if (completeBtn) {
                completeBtn.addEventListener('click', async () => {
                    state.userInfo.mainGoal = document.getElementById('mainGoal').value.trim();
                    state.hasCompletedOnboarding = true;
                    state.streak = 1;
                    state.lastActiveDate = new Date().toDateString();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
                    const habitsByGoal = {
                        health: { name: '–ó–∞—Ä—è–¥–∫–∞', color: colors.accent3, icon: 'üí™' },
                        learning: { name: '–ß—Ç–µ–Ω–∏–µ', color: colors.accent2, icon: 'üìö' },
                        productivity: { name: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: colors.primary, icon: 'üìã' },
                        mindfulness: { name: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', color: colors.secondary, icon: 'üßò' },
                        sleep: { name: '–°–æ–Ω 8 —á–∞—Å–æ–≤', color: colors.accent1, icon: 'üò¥' },
                        social: { name: '–û–±—â–µ–Ω–∏–µ', color: colors.warning, icon: '‚òï' }
                    };
                    
                    state.habits = Object.entries(state.userGoals)
                        .filter(([_, selected]) => selected)
                        .map(([goal], index) => ({
                            id: Date.now() + index,
                            name: habitsByGoal[goal].name,
                            color: habitsByGoal[goal].color,
                            streak: 0,
                            completed: false,
                            lastCompletedDate: null
                        }));
                    
                    await saveState();
                    render();
                });
            }

            goalButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const goal = btn.dataset.goal;
                    state.userGoals[goal] = !state.userGoals[goal];
                    render();
                });
            });
        }

        function attachMainListeners() {
            const tabs = document.querySelectorAll('[data-tab]');
            const showRankBtn = document.getElementById('showRank');
            const rankModal = document.getElementById('rankModal');
            const habitCards = document.querySelectorAll('[data-habit]');
            const habitModal = document.getElementById('habitModal');
            const closeHabitModalBtn = document.getElementById('closeHabitModal');
            const taskChecks = document.querySelectorAll('[data-task-check]');
            const addTaskBtn = document.getElementById('addTask');
            const newTaskInput = document.getElementById('newTaskInput');
            const deleteButtons = document.querySelectorAll('[data-delete]');
            const goToTasksBtn = document.getElementById('goToTasks');
            const addFirstHabitBtn = document.getElementById('addFirstHabit');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                });
            });

            if (showRankBtn) {
                showRankBtn.addEventListener('click', () => {
                    state.showRankModal = true;
                    render();
                });
            }

            if (rankModal) {
                rankModal.addEventListener('click', (e) => {
                    if (e.target === rankModal) {
                        state.showRankModal = false;
                        render();
                    }
                });
            }

            habitCards.forEach(card => {
                card.addEventListener('click', async () => {
                    const habitId = parseInt(card.dataset.habit);
                    const habit = state.habits.find(h => h.id === habitId);
                    
                    if (habit) {
                        const today = new Date().toDateString();
                        
                        if (!habit.completed) {
                            habit.completed = true;
                            habit.lastCompletedDate = today;
                            habit.streak++;
                            state.totalPoints += 10;
                        } else {
                            habit.completed = false;
                            if (habit.streak > 0) habit.streak--;
                            state.totalPoints = Math.max(0, state.totalPoints - 10);
                        }
                        
                        await saveState();
                        render();
                    }
                });
            });

            if (closeHabitModalBtn) {
                closeHabitModalBtn.addEventListener('click', () => {
                    state.selectedHabit = null;
                    render();
                });
            }

            if (habitModal) {
                habitModal.addEventListener('click', (e) => {
                    if (e.target === habitModal) {
                        state.selectedHabit = null;
                        render();
                    }
                });
            }

            taskChecks.forEach(check => {
                check.addEventListener('click', async () => {
                    const taskId = parseInt(check.dataset.taskCheck);
                    const task = state.tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        task.completed = !task.completed;
                        
                        if (task.completed) {
                            state.totalPoints += task.points;
                        } else {
                            state.totalPoints = Math.max(0, state.totalPoints - task.points);
                        }
                        
                        await saveState();
                        render();
                    }
                });
            });

            if (addTaskBtn && newTaskInput) {
                const addTask = async () => {
                    const title = newTaskInput.value.trim();
                    if (title) {
                        state.tasks.push({
                            id: Date.now(),
                            title,
                            completed: false,
                            points: 5,
                            category: '–û–±—â–µ–µ',
                            createdAt: new Date().toISOString()
                        });
                        state.newTask = '';
                        await saveState();
                        render();
                    }
                };

                addTaskBtn.addEventListener('click', addTask);
                newTaskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addTask();
                    }
                });
            }

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(btn.dataset.delete);
                    const task = state.tasks.find(t => t.id === taskId);
                    
                    if (task && task.completed) {
                        state.totalPoints = Math.max(0, state.totalPoints - task.points);
                    }
                    
                    state.tasks = state.tasks.filter(t => t.id !== taskId);
                    await saveState();
                    render();
                });
            });

            if (goToTasksBtn) {
                goToTasksBtn.addEventListener('click', () => {
                    state.activeTab = 'tasks';
                    render();
                });
            }

            if (addFirstHabitBtn) {
                addFirstHabitBtn.addEventListener('click', async () => {
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–∏–≤—ã—á–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞
                    state.habits.push({
                        id: Date.now(),
                        name: '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞',
                        color: colors.primary,
                        streak: 0,
                        completed: false,
                        lastCompletedDate: null
                    });
                    await saveState();
                    render();
                });
            }
        }

        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–≤—ã—á–µ–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
        async function resetDailyHabits() {
            const today = new Date().toDateString();
            
            state.habits.forEach(habit => {
                if (habit.lastCompletedDate !== today) {
                    habit.completed = false;
                }
            });
            
            await saveState();
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function init() {
            await loadState();
            await resetDailyHabits();
            render();
        }

        init();
    </script>

    <!-- === ADDITIONAL ENHANCEMENTS: SYNC, REMINDERS, AI IMPROVEMENTS === -->
    <script>
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤–µ—Ä—Ö —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è: sync (Cloud + local), reminders, —É–ª—É—á—à–µ–Ω–Ω—ã–π AI –∏ –∏—Å—Ç–æ—Ä–∏—è.
    (function(){
        const REMINDER_WEBHOOK_URL = null; // –ø–æ—Å—Ç–∞–≤–∏—Ç—å URL —Å–µ—Ä–≤–µ—Ä–∞ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω

        // tg —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ
        const tgApp = window.Telegram ? window.Telegram.WebApp : null;

        // –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ–º loadState –∏ saveState, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º —Å—Ç–∞—Ä—ã–µ –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞—Ç–∞
        const originalLoad = window.loadState;
        const originalSave = window.saveState;

        async function loadState() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram CloudStorage –µ—Å–ª–∏ –µ—Å—Ç—å
                if (tgApp && tgApp.CloudStorage) {
                    return new Promise((resolve) => {
                        tgApp.CloudStorage.getItem('livi_state', (err, value) => {
                            if (!err && value) {
                                try {
                                    const remote = JSON.parse(value);
                                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî —Å–¥–µ–ª–∞–µ–º merge –ø–æ lastUpdated
                                    const localRaw = localStorage.getItem('livi_state');
                                    if (localRaw) {
                                        try {
                                            const localParsed = JSON.parse(localRaw);
                                            // –ï—Å–ª–∏ remote –∏–º–µ–µ—Ç –ø–æ–ª–µ lastUpdated, —Å—Ä–∞–≤–Ω–∏—Ç—å
                                            if (remote.lastUpdated && localParsed.lastUpdated) {
                                                if (remote.lastUpdated > localParsed.lastUpdated) {
                                                    state = { ...getInitialState(), ...remote };
                                                } else {
                                                    state = { ...getInitialState(), ...localParsed };
                                                }
                                            } else {
                                                state = { ...getInitialState(), ...remote };
                                            }
                                        } catch (e) {
                                            state = { ...getInitialState(), ...remote };
                                        }
                                    } else {
                                        state = { ...getInitialState(), ...remote };
                                    }
                                    console.log('‚úÖ Loaded from Telegram.CloudStorage (enhanced)');
                                } catch (e) { console.warn('Cloud parse error (enhanced)', e); }
                            } else {
                                // fallback localStorage
                                const saved = localStorage.getItem('livi_state');
                                if (saved) {
                                    try { state = { ...getInitialState(), ...JSON.parse(saved) }; console.log('‚úÖ Loaded from localStorage (enhanced)'); }
                                    catch (e) { console.error('Parse localStorage failed (enhanced)', e); }
                                } else {
                                    console.log('üì¶ No saved state -> initial state (enhanced)');
                                }
                            }
                            resolve();
                        });
                    });
                } else {
                    const saved = localStorage.getItem('livi_state');
                    if (saved) {
                        try { state = { ...getInitialState(), ...JSON.parse(saved) }; console.log('‚úÖ Loaded from localStorage (enhanced)'); }
                        catch (e) { console.error('Parse localStorage failed (enhanced)', e); }
                    } else {
                        console.log('üì¶ No saved state -> initial state (enhanced)');
                    }
                }
            } catch (e) { console.error('loadState enhanced error', e); }
        }

        async function saveState() {
            try {
                // –æ—Ç–º–µ—Ç–∏–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
                state.lastUpdated = Date.now();
                const s = JSON.stringify(state);
                localStorage.setItem('livi_state', s);
                if (tgApp && tgApp.CloudStorage) {
                    return new Promise((resolve) => {
                        tgApp.CloudStorage.setItem('livi_state', s, (err)=>{
                            if (!err) console.log('üíæ Saved to Telegram.CloudStorage (enhanced)');
                            else console.warn('Cloud save error (enhanced)', err);
                            resolve();
                        });
                    });
                }
            } catch (e) { console.error('saveState enhanced error', e); }
        }

        // Sync loop
        let cloudSyncInterval = null;
        function startCloudSync() {
            if (!(tgApp && tgApp.CloudStorage)) return;
            if (cloudSyncInterval) clearInterval(cloudSyncInterval);
            cloudSyncInterval = setInterval(()=>{
                tgApp.CloudStorage.getItem('livi_state', async (err, value)=>{
                    if (!err && value) {
                        try {
                            const remote = JSON.parse(value);
                            if (remote.lastUpdated && remote.lastUpdated > (state.lastUpdated||0)) {
                                console.log('üîÅ Remote state newer ‚Äî merging (enhanced)');
                                // –ø—Ä–æ—Å—Ç–æ–µ –∑–∞–º–µ—â–µ–Ω–∏–µ ‚Äî –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –¥–∏—Ñ—Ñ–æ–º
                                state = { ...getInitialState(), ...remote };
                                await saveState();
                                render();
                                scheduleAllReminders();
                            }
                        } catch(e) { console.warn('cloud parse err enhanced', e); }
                    }
                });
            }, 30_000);
        }

        // Notifications & reminders
        async function ensureNotifications() {
            if (!('Notification' in window)) return false;
            if (Notification.permission === 'granted') return true;
            if (Notification.permission === 'denied') return false;
            const res = await Notification.requestPermission();
            return res === 'granted';
        }

        const reminderTimers = {};
        function scheduleAllReminders() {
            Object.keys(reminderTimers).forEach(k=>clearTimeout(reminderTimers[k]));
            const now = Date.now();
            (state.reminders || []).forEach(rem=>{
                if (!rem.enabled) return;
                const next = nextOccurrence(rem, now);
                if (!next) return;
                const ms = next - now;
                if (ms>0 && ms<=365*24*60*60*1000) {
                    reminderTimers[rem.id] = setTimeout(()=>{
                        triggerReminder(rem);
                        render();
                    }, ms);
                }
            });
        }

        function nextOccurrence(rem, after=Date.now()){
            try{
                const dt = new Date(rem.datetimeISO);
                if (dt.getTime()>after) return dt.getTime();
                if (rem.repeat==='none') return null;
                if (rem.repeat==='daily'){
                    const next = new Date(dt);
                    while(next.getTime()<=after) next.setDate(next.getDate()+1);
                    return next.getTime();
                }
                if (rem.repeat==='weekly'){
                    const next = new Date(dt);
                    while(next.getTime()<=after) next.setDate(next.getDate()+7);
                    return next.getTime();
                }
                return null;
            } catch(e){ return null; }
        }

        async function triggerReminder(rem){
            try{
                if (Notification.permission==='granted') new Notification('Livi', { body: rem.title });
            } catch(e){ console.warn('notification', e); }
            try{ if (tgApp && typeof tgApp.showPopup==='function') tgApp.showPopup({ title:'–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', message: rem.title }); else if (tgApp && typeof tgApp.showAlert==='function') tgApp.showAlert(rem.title); } catch(e){}
            if (REMINDER_WEBHOOK_URL) {
                try{ await fetch(REMINDER_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reminder: rem, user: state.userInfo }) }); } catch(e){ console.warn('webhook send failed', e); }
            }
        }

        // History & AI improvements
        function recordDailySnapshot(){
            const today = new Date().toDateString();
            const completedTasks = state.tasks.filter(t=>t.completed).length;
            const habitsCompleted = state.habits.filter(h=>h.completed).length;
            const idx = (state.history||[]).findIndex(h=>h.date===today);
            const snap = { date: today, completedTasks, habitsCompleted, totalPoints: state.totalPoints };
            if (idx>=0) state.history[idx]=snap; else { state.history = state.history||[]; state.history.push(snap); }
        }

        function generateAIAnalysis() {
            // –±–æ–ª–µ–µ —á–µ—Å—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const totalTasks = state.tasks.length || 1;
            const completionRate = Math.round((completedTasks / totalTasks) * 100);
            const activeHabits = state.habits.filter(h=>h.completed).length;

            const last7 = (state.history||[]).slice(-7);
            const avgTasks = last7.length ? Math.round(last7.reduce((s,x)=>s+x.completedTasks,0)/last7.length) : completedTasks;
            const trend = completedTasks >= avgTasks ? '‚Üó' : '‚Üò';

            const insights=[]; const recommendations=[];
            insights.push(`${completionRate}% –∑–∞–¥–∞—á —Å–µ–≥–æ–¥–Ω—è`);
            insights.push(`–ü—Ä–∏–≤—ã—á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ${activeHabits}/${state.habits.length}`);
            insights.push(`–¢—Ä–µ–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á: ${trend} (—Å—Ä–µ–¥–Ω–µ ${avgTasks}/–¥–µ–Ω—å)`);

            if (completionRate>=80) insights.push('–û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π —Ç–µ–º–ø!');
            else if (completionRate>=50) { insights.push('–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –º–æ–∂–Ω–æ –ª—É—á—à–µ'); recommendations.push('–†–∞–∑–±–µ–π –∫—Ä—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏'); }
            else { insights.push('–ù—É–∂–µ–Ω —Ç–æ–ª—á–æ–∫ –≤ –¥–µ–π—Å—Ç–≤–∏–∏'); recommendations.push('–°—Ç–∞–≤—å 2‚Äì3 –º–∞–ª–µ–Ω—å–∫–∏–µ —Ü–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å'); }

            if (activeHabits>=Math.min(3, state.habits.length)) insights.push('–•–æ—Ä–æ—à–∞—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –ø—Ä–∏–≤—ã—á–µ–∫');
            else if (activeHabits>0) { insights.push('–ù–∞—á–∞–ª–æ –ø–æ–ª–æ–∂–µ–Ω–æ'); recommendations.push('–î–æ–±–∞–≤—å –µ—â—ë –æ–¥–Ω—É –ø—Ä–æ—Å—Ç—É—é –ø—Ä–∏–≤—ã—á–∫—É'); }
            else { recommendations.push('–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –æ–¥–Ω–æ–π –ø—Ä–∏–≤—ã—á–∫–µ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏'); }

            // streak risk
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
            const mightLoseStreak = state.lastActiveDate !== new Date().toDateString() && state.lastActiveDate !== yesterday.toDateString();
            if (mightLoseStreak) recommendations.push('–ù–µ —Ç–µ—Ä—è–π —Å–µ—Ä–∏—é ‚Äî –≤—ã–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–¥–∞—á—É —Å–µ–≥–æ–¥–Ω—è');

            return { completionRate, activeHabits, insights, recommendations, trend, avgTasks };
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π —Ä–µ—Å–µ—Ç ‚Äî –æ–±–Ω—É–ª—è–µ—Ç streak –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ä–∞–∑—Ä—ã–≤–∞—Ö
        async function resetDailyHabitsEnhanced(){
            const today = new Date().toDateString();
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
            state.habits.forEach(h=>{
                if (h.lastCompletedDate !== today) h.completed = false;
                if (h.lastCompletedDate && h.lastCompletedDate !== today && h.lastCompletedDate !== yesterday.toDateString()) h.streak = 0;
            });
            // streak logic
            if (state.lastActiveDate !== today) {
                if (state.lastActiveDate === yesterday.toDateString()) {
                    // continue only when action occurs ‚Äî lastActiveDate should be updated on action
                } else {
                    state.streak = 0;
                }
            }
            recordDailySnapshot();
            await saveState();
        }

        // Enhanced init: –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ UI)
        async function enhancedInit(){
            if (tgApp) {
                try { tgApp.expand(); tgApp.ready(); } catch(e){}
            }
            await loadState();
            await ensureNotifications();
            await resetDailyHabitsEnhanced();
            render();
            scheduleAllReminders();
            startCloudSync();

            document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='hidden') saveState(); });
            window.addEventListener('beforeunload', ()=>{ saveState(); });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º enhanced init –ø–æ–≤–µ—Ä—Ö —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ init ‚Äî —ç—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è UI
        enhancedInit();

        // –≠–∫—Å–ø–æ—Ä—Ç–∏–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.livi_enhanced = { loadState, saveState, scheduleAllReminders, triggerReminder, generateAIAnalysis };

    })();
    </script>
</body>
</html>
