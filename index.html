<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi - AI OS</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #A8C4C6;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #0F0F0F;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.08);
    --glass-highlight: rgba(255,255,255,0.15);
    --danger: #ff4757;
    --success: #2ed573;
    --anim-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --anim-slow: 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#000;
    color:#e0e0e0;
    max-width:428px;
    margin:0 auto;
    overflow-x:hidden;
    -webkit-tap-highlight-color:transparent;
    padding-bottom:100px;
    min-height:100vh;
    position: relative;
}

/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-10px) rotate(2deg)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes pulse-red {0% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);} 70% {box-shadow: 0 0 0 20px rgba(255, 71, 87, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);}}
@keyframes wave {0%, 100% {height: 10px;} 50% {height: 35px;}}
@keyframes twinkle {0%, 100% {opacity: 0.2;} 50% {opacity: 0.7;}}
@keyframes drawPath { from { stroke-dashoffset: 300; } to { stroke-dashoffset: 0; } }

.fade-in{animation:fadeIn .5s ease-out}
.slide-up{animation:slideUp .5s var(--anim-slow) forwards}
.hidden{display:none!important}

/* UI Elements */
.loading-screen{position:fixed;inset:0;background:#050505;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(15,15,15,0.7);backdrop-filter:blur(25px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:22px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid var(--glass-border);box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);}
.profile-btn{width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid var(--primary);cursor:pointer}

/* Livi Character */
.livi-container{display:flex;flex-direction:column;align-items:center;padding:40px 0;position:relative; z-index: 5;}
.livi-bg-glow {position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 280px; background: radial-gradient(circle, rgba(139,154,156,0.1) 0%, rgba(0,0,0,0) 75%); pointer-events: none;}
.livi-body{
    width:130px;height:130px;
    border-radius:50%;
    background:radial-gradient(circle at 35% 35%, #444, #111);
    border:2px solid rgba(139,154,156,0.4);
    position:relative;
    box-shadow:0 20px 50px rgba(0,0,0,0.7);
    animation:float 5s ease-in-out infinite;
}
.livi-antenna{position:absolute;width:3px;height:35px;background:var(--primary);border-radius:4px;}
.livi-antenna::after{content:'';position:absolute;top:-6px;left:-2px;width:7px;height:7px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--primary)}
.ant-l{top:-25px;left:30px;transform:rotate(-25deg)}
.ant-r{top:-25px;right:30px;transform:rotate(25deg)}
.eye{position:absolute;top:45%;width:12px;height:18px;background:white;border-radius:50%;animation:blink 4s infinite;box-shadow: 0 0 15px rgba(255,255,255,0.4);}
.eye-l{left:35px} .eye-r{right:35px}
.mouth{position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:25px;height:12px;border-bottom:3px solid white;border-radius:0 0 20px 20px;opacity:0.8}

/* Items */
.item-cap {position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:90px;height:35px;background:linear-gradient(to bottom, #D4AF7A, #C09555);border-radius:25px 25px 0 0;z-index:20;box-shadow:inset 0 2px 5px rgba(255,255,255,0.3)}
.item-crown {position:absolute;top:-45px;left:50%;transform:translateX(-50%);width:70px;height:50px;z-index:20;background: linear-gradient(to bottom, #FFD700, #DAA520);clip-path: polygon(0% 100%, 20% 30%, 40% 100%, 50% 10%, 60% 100%, 80% 30%, 100% 100%);filter: drop-shadow(0 0 10px rgba(212,175,122,0.6));}
.item-glasses {position:absolute;top:52px;left:50%;transform:translateX(-50%);width:80px;height:22px;z-index:30;display:flex;justify-content:space-between}
.g-lens {width:35px;height:22px;background:rgba(0,0,0,0.9);border-radius:8px;border:1px solid #444}
.g-bridge {position:absolute;top:10px;left:50%;transform:translateX(-50%);width:12px;height:2px;background:#444}
.item-insurance {position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:55px;height:55px;z-index:20;background:radial-gradient(circle, #FFD700, #B8860B);border-radius:50%;border:2px solid #FFA500;box-shadow:0 0 25px rgba(255,215,0,0.6);display:flex;align-items:center;justify-content:center;font-size:28px;}

/* Dashboard Charts */
.dashboard-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;}
.chart-box {background: var(--glass); border-radius: 24px; padding: 15px; border: 1px solid var(--glass-border); position: relative; overflow: hidden;}
.activity-chart {height: 60px; width: 100%; display: flex; align-items: flex-end; gap: 4px;}
.activity-bar {flex: 1; background: var(--primary); opacity: 0.3; border-radius: 4px 4px 2px 2px; transition: height 1s var(--anim-slow), opacity 0.3s;}
.activity-bar.active {opacity: 1; background: linear-gradient(to top, var(--primary), var(--accent));}
.chart-svg {width: 100%; height: 100px; stroke-dasharray: 300; stroke-dashoffset: 300; animation: drawPath 2s ease-out forwards;}

.progress-circle {position: relative; width: 60px; height: 60px; transform: rotate(-90deg);}
.progress-circle circle {fill: none; stroke-width: 6; stroke-linecap: round;}
.circle-bg {stroke: rgba(255,255,255,0.05);}
.circle-val {stroke: var(--primary); transition: stroke-dashoffset 1s var(--anim-slow);}

/* Section */
.section {
    background: linear-gradient(160deg, rgba(30,30,30,0.5) 0%, rgba(10,10,10,0.8) 100%);
    border: 1px solid var(--glass-border);
    border-top: 1px solid var(--glass-highlight);
    border-radius: 28px;
    padding: 22px;
    margin-bottom: 18px;
    backdrop-filter: blur(20px);
}

/* Shop Detailed Boxes */
.chest-card {
    position: relative;
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    background-size: 200% 200%;
    transition: transform 0.3s, border-color 0.3s;
}
.chest-card:active {transform: scale(0.97);}
.chest-common {background: linear-gradient(135deg, #2c1e1a 0%, #111 100%);}
.chest-rare {
    background: linear-gradient(135deg, #1a2525 0%, #0a0e0e 100%);
    border-color: rgba(212, 175, 122, 0.4);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(212,175,122,0.05);
}
.chest-rare::after {
    content: 'BEST VALUE'; position: absolute; top: 12px; right: 12px;
    background: var(--gold); color: #000; font-size: 9px; font-weight: 900;
    padding: 2px 8px; border-radius: 10px;
}
.rarity-tag {font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block;}

/* Voice & Notes */
.mic-btn {width: 80px; height: 80px; border-radius: 50%; background: #111; border: 1px solid #333; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; transition: all 0.3s;}
.mic-btn.recording {border-color: var(--danger); animation: pulse-red 1.5s infinite; background: rgba(255,71,87,0.05);}
.voice-wave {display: flex; gap: 4px; align-items: center; height: 35px;}
.bar {width: 4px; background: var(--danger); border-radius: 2px; animation: wave 1s infinite ease-in-out;}

.note-modal {position: fixed; inset: 0; background: #080808; z-index: 3000; display: flex; flex-direction: column; padding: 25px; transition: transform 0.4s var(--anim-slow); transform: translateY(100%);}
.note-modal.open {transform: translateY(0);}
.note-textarea {flex: 1; background: transparent; border: none; color: #eee; font-size: 17px; line-height: 1.7; resize: none; outline: none;}

/* Navigation */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(10,10,10,0.9);backdrop-filter:blur(30px);border-top:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-around;padding:15px 0 calc(15px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;border:none;background:none;color:#444;transition:color 0.3s}
.nav-item.active{color:var(--primary)}

.roulette-modal {position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:4000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.roulette-strip {display:flex;align-items:center;position:absolute;left:0;will-change:transform}
.r-item {width:130px;height:130px;margin:0 5px;background:#111;border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #222;flex-shrink:0;}
.r-item.legendary {border-color:var(--epic);box-shadow:inset 0 0 20px rgba(212,93,121,0.2)}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:30px; color:#fff; font-weight:800; letter-spacing:2px">–û–¢–ö–†–´–¢–ò–ï –ö–ï–ô–°–ê</h2>
    <div style="width:100%;height:150px;background:#050505;border-block:1px solid #222;position:relative;overflow:hidden">
        <div style="position:absolute;top:0;bottom:0;left:50%;width:2px;background:var(--primary);z-index:10;transform:translateX(-50%);box-shadow:0 0 15px var(--primary)"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .8s; margin-top:40px">
        <div style="font-size:12px; color:#666; text-transform:uppercase; letter-spacing:2px">–ü–æ–ª—É—á–µ–Ω –ø—Ä–µ–¥–º–µ—Ç:</div>
        <div id="winItemName" style="font-size:36px; font-weight:900; color:var(--gold); margin:15px 0">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn-primary" style="padding:16px 40px; border-radius:30px; border:none; background:var(--gold); color:#000; font-weight:800" onclick="closeRoulette()">–í –ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </div>
</div>

<div id="noteModal" class="note-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:25px">
        <div style="font-weight:800; font-size:22px; color:var(--primary)" id="modalTitle">–ó–∞–º–µ—Ç–∫–∞</div>
        <div onclick="actions.closeNote()" style="font-size:24px">‚úï</div>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:20px; overflow-x:auto; padding-bottom:5px">
        <button onclick="actions.enhanceNote()" style="background:rgba(168,196,198,0.1); border:1px solid var(--accent); color:var(--accent); padding:8px 15px; border-radius:20px; font-size:12px; white-space:nowrap">‚ú® –£–º–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</button>
        <button onclick="actions.addSummary()" style="background:rgba(212,175,122,0.1); border:1px solid var(--gold); color:var(--gold); padding:8px 15px; border-radius:20px; font-size:12px; white-space:nowrap">üß† –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å</button>
        <button onclick="actions.extractTasks()" style="background:rgba(46,213,115,0.1); border:1px solid var(--success); color:var(--success); padding:8px 15px; border-radius:20px; font-size:12px; white-space:nowrap">‚úÖ –°–ø–∏—Å–æ–∫ –¥–µ–ª</button>
    </div>
    <textarea id="modalText" class="note-textarea" placeholder="–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å..."></textarea>
    <button onclick="actions.saveAndCloseNote()" style="background:var(--primary); color:white; border:none; padding:18px; border-radius:20px; font-weight:800; margin-top:20px">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div id="app"></div>

<script>
let tg = window.Telegram ? window.Telegram.WebApp : null;
if(tg) { tg.expand(); tg.ready(); }

const userId = tg?.initDataUnsafe?.user?.id || 'local_user';
const firstName = tg?.initDataUnsafe?.user?.first_name || '–î—Ä—É–≥';

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'insurance', name: '–©–∏—Ç —Å—Ç—Ä–∏–∫–∞', type: 'special', rarity: 'rare', icon: 'üõ°Ô∏è', css: 'item-insurance' }
];

let state = {
    activeTab: 'home',
    totalPoints: 200,
    streak: 1,
    lastVisit: new Date().toISOString().split('T')[0],
    inventory: [],
    equipped: {head: null, face: null, body: null, special: null},
    tasks: [
        {id: 1, title: '–ó–∞–π—Ç–∏ –≤ Livi', completed: true, points: 10},
        {id: 2, title: '–°–æ–∑–¥–∞—Ç—å AI –∑–∞–º–µ—Ç–∫—É', completed: false, points: 25}
    ],
    notes: [],
    history: [20, 45, 10, 65, 30, 80, 40] // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
};

// --- AI CORE ---
const AI = {
    process: (text) => {
        const clean = text.trim().replace(/\s+/g, ' ');
        if (clean.length < 5) return clean;
        
        // –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        let processed = clean
            .replace(/([.!?])\s+([–ê-–Ø])/g, '$1\n\n$2') // –ê–±–∑–∞—Ü—ã
            .replace(/(–≤–æ-–ø–µ—Ä–≤—ã—Ö|—Å–Ω–∞—á–∞–ª–∞|–ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ)/gi, '1Ô∏è‚É£ $1')
            .replace(/(–≤–æ-–≤—Ç–æ—Ä—ã—Ö|–∑–∞—Ç–µ–º|–ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ)/gi, '2Ô∏è‚É£ $1')
            .replace(/(–≤-—Ç—Ä–µ—Ç—å–∏—Ö|–Ω–∞–∫–æ–Ω–µ—Ü|–≤ –∏—Ç–æ–≥–µ)/gi, '3Ô∏è‚É£ $1');
            
        return processed;
    },
    
    getSummary: (text) => {
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
        if (sentences.length <= 1) return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
        
        // –ü–æ–∏—Å–∫ —Å–º—ã—Å–ª–æ–≤—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
        const weights = sentences.map(s => {
            let w = 0;
            if (s.match(/(–≤–∞–∂–Ω–æ|—Å—É—Ç—å|–≥–ª–∞–≤–Ω–æ–µ|–≤—ã–≤–æ–¥|–Ω—É–∂–Ω–æ|–∑–∞–ø–æ–º–Ω–∏—Ç—å)/gi)) w += 10;
            if (s.length > 40 && s.length < 100) w += 5;
            return w;
        });
        
        const bestIdx = weights.indexOf(Math.max(...weights));
        return "üí° –ì–õ–ê–í–ù–û–ï: " + sentences[bestIdx].trim();
    },
    
    extractTasks: (text) => {
        const verbs = ['—Å–¥–µ–ª–∞—Ç—å', '–Ω–∞–ø–∏—Å–∞—Ç—å', '–∫—É–ø–∏—Ç—å', '—Å—Ö–æ–¥–∏—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å', '–∏–∑—É—á–∏—Ç—å'];
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        const found = sentences
            .filter(s => verbs.some(v => s.toLowerCase().includes(v)))
            .map(s => "‚Ä¢ " + s.trim());
            
        return found.length ? "\n\nüìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô:\n" + found.join('\n') : "";
    }
};

const actions = {
    save: () => localStorage.setItem(`livi_data_${userId}`, JSON.stringify(state)),
    load: () => {
        const d = localStorage.getItem(`livi_data_${userId}`);
        if(d) state = JSON.parse(d);
    },
    
    toggleTask: (id) => {
        const t = state.tasks.find(x => x.id === id);
        if(t) {
            t.completed = !t.completed;
            state.totalPoints += t.completed ? t.points : -t.points;
            if(tg) tg.HapticFeedback.impactOccurred('medium');
            render(); actions.save();
        }
    },

    openChest: (type, cost) => {
        if(state.totalPoints < cost) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!");
        state.totalPoints -= cost;
        startRoulette(type);
    },

    startRecording: () => {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ru-RU';
        recognition.onstart = () => { window.isRec = true; render(); };
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            const note = {
                id: Date.now(),
                title: '–ó–∞–ø–∏—Å—å ' + new Date().toLocaleTimeString().slice(0,5),
                text: AI.process(text),
                date: new Date().toLocaleDateString()
            };
            state.notes.unshift(note);
            window.isRec = false;
            render(); actions.save();
        };
        recognition.start();
    },

    openNote: (id) => {
        const n = state.notes.find(x => x.id === id);
        window.editingId = id;
        document.getElementById('modalTitle').innerText = n.title;
        document.getElementById('modalText').value = n.text;
        document.getElementById('noteModal').classList.add('open');
    },

    enhanceNote: () => {
        const area = document.getElementById('modalText');
        area.value = AI.process(area.value);
    },

    addSummary: () => {
        const area = document.getElementById('modalText');
        area.value = AI.getSummary(area.value) + "\n\n" + area.value;
    },

    extractTasks: () => {
        const area = document.getElementById('modalText');
        area.value = area.value + AI.extractTasks(area.value);
    },

    saveAndCloseNote: () => {
        const n = state.notes.find(x => x.id === window.editingId);
        n.text = document.getElementById('modalText').value;
        actions.closeNote(); render(); actions.save();
    },

    closeNote: () => document.getElementById('noteModal').classList.remove('open'),
    
    equip: (id) => {
        const item = ITEMS.find(x => x.id === id);
        const slot = item.type === 'special' ? 'special' : item.type;
        state.equipped[slot] = state.equipped[slot] === id ? null : id;
        render(); actions.save();
    }
};

// --- RENDERERS ---
function renderHome() {
    const completedTasks = state.tasks.filter(t => t.completed).length;
    const progress = (completedTasks / state.tasks.length) * 188.4; // 2 * PI * 30
    
    const h = ITEMS.find(i => i.id === state.equipped.head);
    const f = ITEMS.find(i => i.id === state.equipped.face);
    const b = ITEMS.find(i => i.id === state.equipped.body);
    const s = ITEMS.find(i => i.id === state.equipped.special);

    return `
    <div class="fade-in">
        <div class="header">
            <div class="header-title">livi</div>
            <div class="header-stats">
                <div class="stat-badge" style="color:var(--gold)">‚≠ê ${state.totalPoints}</div>
                <div class="profile-btn" style="background:var(--primary)"></div>
            </div>
        </div>
        
        <div class="content" style="padding:20px">
            <div class="livi-container">
                <div class="livi-bg-glow"></div>
                <div class="livi-body">
                    ${h ? `<div class="${h.css}"></div>` : ''}
                    <div class="livi-antenna ant-l"></div>
                    <div class="livi-antenna ant-r"></div>
                    <div class="eye eye-l"></div>
                    <div class="eye eye-r"></div>
                    ${f ? `<div class="${f.css}"><div class="g-lens"></div><div class="g-lens"></div><div class="g-bridge"></div></div>` : ''}
                    <div class="mouth"></div>
                    ${s ? `<div class="${s.css}">${s.icon}</div>` : ''}
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-box">
                    <div style="font-size:10px; color:#888; margin-bottom:10px">–ê–ö–¢–ò–í–ù–û–°–¢–¨ (7–î)</div>
                    <div class="activity-chart">
                        ${state.history.map((v, i) => `<div class="activity-bar ${i===6?'active':''}" style="height:${v}%"></div>`).join('')}
                    </div>
                </div>
                <div class="chart-box" style="display:flex; align-items:center; gap:12px">
                    <div class="progress-circle">
                        <svg width="60" height="60">
                            <circle class="circle-bg" cx="30" cy="30" r="26"/>
                            <circle class="circle-val" cx="30" cy="30" r="26" style="stroke-dasharray:163; stroke-dashoffset:${163 - (completedTasks/state.tasks.length)*163}"/>
                        </svg>
                        <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; transform:rotate(90deg)">${Math.round((completedTasks/state.tasks.length)*100)}%</div>
                    </div>
                    <div>
                        <div style="font-size:18px; font-weight:800">${completedTasks}/${state.tasks.length}</div>
                        <div style="font-size:10px; color:#666">–ó–ê–î–ê–ß–ò</div>
                    </div>
                </div>
            </div>

            <div class="section" style="background:linear-gradient(135deg, rgba(139,154,156,0.1), transparent)">
                <div style="display:flex; gap:15px">
                    <div style="font-size:24px">üß†</div>
                    <div style="font-size:13px; color:#ccc; line-height:1.4">
                        <b>AI –°–æ–≤–µ—Ç:</b> –ü–æ—Ö–æ–∂–µ, —Ç—ã –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–µ–Ω –≤–µ—á–µ—Ä–æ–º. –û—Å—Ç–∞–≤—å –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è.
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function renderEducation() {
    return `
    <div class="fade-in" style="padding:20px">
        <h2 style="text-align:center; font-weight:900; margin-bottom:10px">AI –õ–ï–ö–¶–ò–Ø</h2>
        <div class="section" style="text-align:center">
            <div style="font-size:13px; color:#888; margin-bottom:20px">–ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏. –Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é –º—ã—Å–ª–∏ –∏ –≤—ã–¥–µ–ª—é –≥–ª–∞–≤–Ω–æ–µ.</div>
            <button class="mic-btn ${window.isRec ? 'recording' : ''}" onclick="actions.startRecording()">
                ${window.isRec ? '<div class="voice-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>' : 'üé§'}
            </button>
        </div>
        
        <div style="margin-top:30px">
            <div style="font-size:11px; color:#555; letter-spacing:1px; margin-bottom:15px">–ù–ï–î–ê–í–ù–ò–ï –ó–ê–ü–ò–°–ò</div>
            ${state.notes.map(n => `
                <div class="section" style="padding:15px; margin-bottom:10px" onclick="actions.openNote(${n.id})">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span style="font-weight:800">${n.title}</span>
                        <span style="font-size:10px; color:#555">${n.date}</span>
                    </div>
                    <div style="font-size:13px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${n.text}</div>
                </div>
            `).join('')}
        </div>
    </div>`;
}

function renderTasks() {
    return `
    <div class="fade-in" style="padding:20px">
        <h2 style="font-weight:900; margin-bottom:20px">–ó–ê–î–ê–ß–ò</h2>
        ${state.tasks.map(t => `
            <div class="section" style="display:flex; align-items:center; gap:15px; opacity:${t.completed?0.5:1}">
                <div onclick="actions.toggleTask(${t.id})" style="width:26px; height:26px; border:2px solid var(--primary); border-radius:8px; background:${t.completed?'var(--primary)':'transparent'}; display:flex; align-items:center; justify-content:center">
                    ${t.completed ? '‚úì' : ''}
                </div>
                <div style="flex:1">
                    <div style="font-weight:700; text-decoration:${t.completed?'line-through':''}">${t.title}</div>
                    <div style="font-size:11px; color:var(--gold)">+${t.points} PTS</div>
                </div>
            </div>
        `).join('')}
    </div>`;
}

function renderShop() {
    return `
    <div class="fade-in" style="padding:20px">
        <div style="text-align:center; margin-bottom:30px">
            <div style="font-size:12px; color:#666">–¢–í–û–ô –ë–ê–õ–ê–ù–°</div>
            <div style="font-size:48px; font-weight:900; color:var(--gold)">${state.totalPoints}</div>
        </div>

        <div class="chest-card chest-common" onclick="actions.openChest('common', 100)">
            <span class="rarity-tag" style="color:#888">–û–±—ã—á–Ω—ã–π</span>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <div style="font-size:20px; font-weight:800">–ë–ê–ó–û–í–´–ô –ö–ï–ô–°</div>
                    <div style="font-size:12px; color:#666">–®–∞–Ω—Å –Ω–∞ —Ä–µ–¥–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç: 15%</div>
                </div>
                <div style="font-weight:900; color:var(--primary)">100 ‚≠ê</div>
            </div>
        </div>

        <div class="chest-card chest-rare" onclick="actions.openChest('rare', 250)">
            <span class="rarity-tag" style="color:var(--gold)">–≠–ª–∏—Ç–Ω—ã–π</span>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <div style="font-size:20px; font-weight:800; color:var(--gold)">–ó–û–õ–û–¢–û–ô –ö–ï–ô–°</div>
                    <div style="font-size:12px; color:rgba(212,175,122,0.6)">–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ Rare+</div>
                </div>
                <div style="font-weight:900; color:var(--gold)">250 ‚≠ê</div>
            </div>
        </div>

        <div style="margin-top:30px; display:grid; grid-template-columns: repeat(3, 1fr); gap:10px">
            ${state.inventory.map(id => {
                const item = ITEMS.find(x => x.id === id);
                const isEq = Object.values(state.equipped).includes(id);
                return `
                    <div onclick="actions.equip('${id}')" class="section" style="padding:10px; text-align:center; border-color:${isEq?'var(--gold)':'rgba(255,255,255,0.05)'}">
                        <div style="font-size:32px; margin-bottom:5px">${item.icon}</div>
                        <div style="font-size:10px; color:#888">${item.name}</div>
                    </div>
                `;
            }).join('')}
        </div>
    </div>`;
}

function render() {
    const app = document.getElementById('app');
    let content = '';
    switch(state.activeTab) {
        case 'home': content = renderHome(); break;
        case 'education': content = renderEducation(); break;
        case 'tasks': content = renderTasks(); break;
        case 'shop': content = renderShop(); break;
    }
    
    app.innerHTML = content + `
        <div class="bottom-nav">
            <button class="nav-item ${state.activeTab==='home'?'active':''}" onclick="state.activeTab='home';render()">üè†</button>
            <button class="nav-item ${state.activeTab==='tasks'?'active':''}" onclick="state.activeTab='tasks';render()">‚úÖ</button>
            <button class="nav-item ${state.activeTab==='education'?'active':''}" onclick="state.activeTab='education';render()">üìö</button>
            <button class="nav-item ${state.activeTab==='shop'?'active':''}" onclick="state.activeTab='shop';render()">üíé</button>
        </div>
    `;
}

// --- ROULETTE LOGIC ---
function startRoulette(type) {
    const modal = document.getElementById('rouletteModal');
    modal.classList.remove('hidden');
    const strip = document.getElementById('rouletteStrip');
    strip.innerHTML = ''; strip.style.transition = 'none'; strip.style.transform = 'translateX(0px)';
    
    let pool = type === 'common' ? ITEMS.filter(i => i.rarity !== 'legendary') : ITEMS;
    const winner = pool[Math.floor(Math.random() * pool.length)];

    for (let i = 0; i < 40; i++) {
        const item = i === 35 ? winner : pool[Math.floor(Math.random() * pool.length)];
        const el = document.createElement('div');
        el.className = `r-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:40px">${item.icon}</div>`;
        strip.appendChild(el);
    }

    setTimeout(() => {
        strip.style.transition = 'transform 5s cubic-bezier(0.1, 0.9, 0.2, 1)';
        strip.style.transform = `translateX(-${(35 * 140) - 150}px)`;
        setTimeout(() => {
            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winMessage').style.opacity = '1';
            if(!state.inventory.includes(winner.id)) state.inventory.push(winner.id);
            actions.save();
        }, 5200);
    }, 100);
}

function closeRoulette() {
    document.getElementById('rouletteModal').classList.add('hidden');
    document.getElementById('winMessage').style.opacity = '0';
    render();
}

// Init
window.onload = () => {
    actions.load();
    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('fade-out');
        render();
    }, 1500);
};
</script>
</body>
</html>
