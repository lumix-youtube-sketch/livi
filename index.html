<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #A8C4C6;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #0F0F0F;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.08);
    --glass-highlight: rgba(255,255,255,0.15);
    --danger: #ff4757;
    --success: #2ed573;
    --warning: #ffa502;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#000;
    color:#e0e0e0;
    max-width:428px;
    margin:0 auto;
    overflow-x:hidden;
    -webkit-tap-highlight-color:transparent;
    padding-bottom:100px;
    min-height:100vh;
    position: relative;
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideInLeft{from{transform:translateX(-20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes pulse-red {0% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);} 70% {box-shadow: 0 0 0 20px rgba(255, 71, 87, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);}}
@keyframes wave {0%, 100% {height: 10px;} 50% {height: 30px;}}
@keyframes twinkle {0%, 100% {opacity: 0.2; transform: scale(1);} 50% {opacity: 0.8; transform: scale(1.5);}}
@keyframes shimmer {0% {background-position: -200% 0;} 100% {background-position: 200% 0;}}
@keyframes scaleIn {from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes shake {0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.slide-in-left{animation:slideInLeft .5s ease-out}
.scale-in{animation:scaleIn .3s ease-out}
.hidden{display:none!important}
.shake{animation:shake 0.3s ease-in-out}

.loading-screen{position:fixed;inset:0;background:#050505;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(15,15,15,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid var(--glass-border); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); transition:transform .2s}
.stat-badge:active{transform:scale(0.95)}
.profile-btn{width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid var(--primary);cursor:pointer;box-shadow:0 0 15px rgba(139,154,156,0.3);transition:transform .2s}
.profile-btn:active{transform:scale(0.95)}
.profile-btn img{width:100%;height:100%;object-fit:cover}

.livi-container{display:flex;flex-direction:column;align-items:center;padding:30px 0;position:relative; z-index: 5;}
.livi-bg-glow {position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 220px; background: radial-gradient(circle, rgba(139,154,156,0.15) 0%, rgba(0,0,0,0) 70%); z-index: 1; pointer-events: none;}
.livi-bg-glow.angry {background: radial-gradient(circle, rgba(255,71,87,0.2) 0%, rgba(0,0,0,0) 70%);}
.livi-bg-glow.sad {background: radial-gradient(circle, rgba(100,100,150,0.2) 0%, rgba(0,0,0,0) 70%);}
.livi-body{
    width:120px;height:120px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #3a3a3a, #1a1a1a);
    border:2px solid rgba(139,154,156,0.5);
    position:relative;
    box-shadow:0 15px 40px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.8);
    animation:float 6s ease-in-out infinite;
    z-index:5;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.livi-body.angry{border-color:rgba(255,71,87,0.6);box-shadow:0 15px 40px rgba(255,71,87,0.2), inset 0 0 20px rgba(0,0,0,0.8)}
.livi-body.sad{border-color:rgba(100,100,150,0.6)}
.livi-antenna{position:absolute;width:3px;height:30px;background:var(--primary);border-radius:4px;z-index:1; opacity: 0.8}
.livi-antenna::after{content:'';position:absolute;top:-6px;left:-2px;width:7px;height:7px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px var(--primary)}
.livi-antenna.angry{background:var(--danger)}
.livi-antenna.angry::after{background:var(--danger);box-shadow:0 0 8px var(--danger)}
.ant-l{top:-20px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-20px;right:25px;transform:rotate(20deg)}
.livi-face{position:absolute;inset:0;z-index:10}
.eye{position:absolute;top:45%;width:12px;height:16px;background:white;border-radius:50%;animation:blink 4s infinite; box-shadow: 0 0 10px rgba(255,255,255,0.5);transition:all 0.3s}
.eye.angry{background:#ff4757;height:10px;border-radius:2px;transform:rotate(-10deg)}
.eye.angry.eye-r{transform:rotate(10deg)}
.eye.sad{height:10px;background:#aaa}
.eye-l{left:32px} .eye-r{right:32px}
.mouth{position:absolute;bottom:32px;left:50%;transform:translateX(-50%);width:20px;height:10px;border-bottom:2px solid white;border-radius:0 0 15px 15px;transition:all 0.3s}
.mouth.angry{border-bottom:none;border-top:2px solid #ff4757;border-radius:15px 15px 0 0;height:8px}
.mouth.sad{border-bottom:2px solid #aaa;border-radius:0;height:2px;width:15px}

.item-cap {position:absolute;top:-16px;left:50%;transform:translateX(-50%);width:80px;height:30px;background:linear-gradient(to bottom, #D4AF7A, #C09555);border-radius:20px 20px 0 0;z-index:20;box-shadow:inset 0 2px 5px rgba(255,255,255,0.2)}
.item-crown {position:absolute;top:-40px;left:50%;transform:translateX(-50%);width:60px;height:45px;z-index:20;background: linear-gradient(to bottom, #FFD700, #DAA520);clip-path: polygon(0% 100%, 20% 40%, 40% 100%, 60% 20%, 80% 100%, 100% 40%, 100% 100%);filter: drop-shadow(0 0 5px rgba(255,215,0,0.5));}
.item-glasses {position:absolute;top:50px;left:50%;transform:translateX(-50%);width:70px;height:20px;z-index:30;display:flex;justify-content:space-between}
.g-lens {width:30px;height:20px;background:rgba(0,0,0,0.85);border-radius:6px;border:1px solid #555;position:relative;overflow:hidden}
.g-bridge {position:absolute;top:8px;left:50%;transform:translateX(-50%);width:10px;height:2px;background:#555}
.item-scarf {position:absolute;bottom:-12px;left:50%;transform:translateX(-50%);width:90px;height:30px;z-index:25;background: repeating-linear-gradient(45deg, #D45D79, #D45D79 10px, #C04560 10px, #C04560 20px);border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.item-monocle {position:absolute;top:50px;right:35px;width:24px;height:24px;border:1px solid #FFD700;border-radius:50%;background:rgba(255,255,255,0.1);z-index:30}
.item-bowtie {position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:36px;height:18px;z-index:25;background:#D45D79;clip-path:polygon(0 50%, 40% 0, 50% 50%, 40% 100%, 0 50%, 50% 50%, 60% 0, 100% 50%, 60% 100%, 50% 50%)}
.item-insurance {position:absolute;top:-25px;left:50%;transform:translateX(-50%);width:50px;height:50px;z-index:20;background:radial-gradient(circle, #FFD700, #B8860B);border-radius:50%;border:2px solid #FFA500;box-shadow:0 0 20px rgba(255,215,0,0.6);display:flex;align-items:center;justify-content:center;font-size:24px;}

.content{padding:20px}
.section {
    background: linear-gradient(160deg, rgba(30,30,30,0.6) 0%, rgba(10,10,10,0.8) 100%);
    border: 1px solid var(--glass-border);
    border-top: 1px solid var(--glass-highlight);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 15px;
    backdrop-filter: blur(15px);
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
}
.section:active { transform: scale(0.99); }
.section::before {
    content: ''; position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0; mix-blend-mode: overlay;
}
.section > * { position: relative; z-index: 1; }

.section-header {
    font-size: 12px;
    color: #888;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}

.btn{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:white; box-shadow: 0 4px 15px rgba(139,154,156,0.3)}
.btn-primary:active{transform:scale(0.97)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888}
.btn-small{padding:8px 12px;font-size:12px;border-radius:10px}
.add-btn {position: fixed;bottom: 90px;right: 20px;width: 60px;height: 60px;border-radius: 30px;background: linear-gradient(135deg, var(--primary), var(--accent));color: white;font-size: 32px;border: none;box-shadow: 0 4px 20px rgba(139,154,156,0.5);z-index: 80;display: flex;align-items: center;justify-content: center;cursor: pointer;transition: transform 0.2s;}
.add-btn:active {transform: scale(0.95);}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(10,10,10,0.95);backdrop-filter:blur(20px);border-top:1px solid #222;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;border:none;background:none;color:#555;transition:all .2s;cursor:pointer}
.nav-item.active{color:var(--primary)}
.nav-item.active svg {filter: drop-shadow(0 0 8px var(--primary));}
.nav-item:active{transform:scale(0.9)}

.chart-wrapper {
    position: relative;
    height: 200px;
    width: 100%;
}
.chart-wrapper-small {
    position: relative;
    height: 120px;
    width: 100%;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 15px;
}
.stat-card {
    background: linear-gradient(135deg, rgba(139,154,156,0.1) 0%, rgba(0,0,0,0.3) 100%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s;
}
.stat-card:active {
    transform: scale(0.97);
}
.stat-value {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 5px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-label {
    font-size: 11px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.progress-bar {
    width: 100%;
    height: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 8px;
    position: relative;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border-radius: 10px;
    transition: width 0.5s ease;
    box-shadow: 0 0 10px rgba(168,196,198,0.5);
}

.challenge-card {
    background: linear-gradient(135deg, rgba(212,175,122,0.1) 0%, rgba(0,0,0,0) 100%);
    border: 1px solid rgba(212,175,122,0.3);
}
.challenge-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

.chest-wrapper {display:grid;gap:15px;margin-bottom:30px}
.chest-card {position:relative;border-radius:16px;padding:20px;overflow:hidden;cursor:pointer;transition:transform .2s; border: 1px solid rgba(255,255,255,0.05);}
.chest-card:active {transform:scale(0.98)}
.chest-common {background:linear-gradient(135deg, #3e2723 0%, #1a100e 100%); border-color: #5D4037}
.chest-rare {background:linear-gradient(135deg, #1e2424 0%, #0f1212 100%);border-color: var(--gold); box-shadow: inset 0 0 30px rgba(212,175,122,0.05)}

.roulette-modal {position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.roulette-window {width:100%;height:140px;background:#050505;border-block:2px solid #333;position:relative;overflow:hidden;margin:30px 0}
.roulette-strip {display:flex;height:100%;align-items:center;position:absolute;left:0;will-change:transform}
.r-item {width:120px;height:110px;margin:0 4px;background:#151515;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #333;flex-shrink:0;position:relative}
.r-item.legendary {border-color:var(--epic);box-shadow:inset 0 0 15px rgba(212,93,121,0.2)}
.r-item.rare {border-color:var(--gold)}
.r-marker {position:absolute;top:0;bottom:0;left:50%;width:2px;background:var(--primary);z-index:10;transform:translateX(-50%);box-shadow:0 0 10px var(--primary)}

.mic-btn {width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(145deg, #222, #111); border: 1px solid #333; display: flex; align-items: center; justify-content: center; margin: 20px auto; cursor: pointer; transition: all 0.3s; position: relative; box-shadow: 5px 5px 15px #050505, -5px -5px 15px #222;}
.mic-btn:active {transform: scale(0.95);}
.mic-btn.recording {background: rgba(255, 71, 87, 0.1); border-color: var(--danger); animation: pulse-red 1.5s infinite;}
.voice-wave {display: flex; gap: 3px; align-items: center; height: 30px;}
.bar {width: 3px; background: var(--danger); border-radius: 2px; animation: wave 1s infinite ease-in-out;}
.bar:nth-child(2) {animation-delay: 0.1s; height: 15px}
.bar:nth-child(3) {animation-delay: 0.2s; height: 25px}
.bar:nth-child(4) {animation-delay: 0.3s; height: 15px}

.note-card {background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 12px; cursor: pointer; transition: all .2s;}
.note-card:active {background: rgba(255,255,255,0.05);transform:scale(0.98)}
.note-date {font-size: 11px; color: #777; margin-bottom: 5px; display: flex; justify-content: space-between;}
.note-title {font-weight: 700; margin-bottom: 5px; color: #eee; font-size: 16px;}
.note-preview {font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis}

.note-modal {position: fixed; inset: 0; background: #080808; z-index: 3000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateY(100%);}
.note-modal.open {transform: translateY(0);}
.note-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
.note-textarea {flex: 1; background: transparent; border: none; color: #eee; font-size: 16px; line-height: 1.6; resize: none; outline: none; font-family: inherit; padding-bottom: 100px;}
.ai-actions {display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;}
.ai-chip {background: rgba(139,154,156,0.1); padding: 8px 16px; border-radius: 20px; font-size: 12px; color: var(--accent); white-space: nowrap; border: 1px solid rgba(139,154,156,0.2); cursor: pointer;transition:all .2s}
.ai-chip:active{transform:scale(0.95);background:rgba(139,154,156,0.2)}

.priority-dot {width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;}
.p-high {background: var(--danger); box-shadow: 0 0 5px var(--danger);}
.p-med {background: var(--warning); box-shadow: 0 0 5px var(--warning);}
.p-low {background: var(--success);}

.particle-container {position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;}
.particle {position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; opacity: 0; animation: twinkle var(--duration) ease-in-out infinite; animation-delay: var(--delay);}

.ai-insights {
    background: linear-gradient(135deg, rgba(139,154,156,0.08) 0%, rgba(212,175,122,0.05) 100%);
    border: 1px solid rgba(139,154,156,0.2);
    border-radius: 20px;
    padding: 18px;
    margin-top: 15px;
}
.insight-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}
.insight-icon {
    font-size: 24px;
    flex-shrink: 0;
}
.insight-text {
    flex: 1;
    font-size: 13px;
    line-height: 1.5;
    color: #ccc;
}
.insight-title {
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 4px;
    font-size: 14px;
}

.task-modal {position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateY(100%); overflow-y: auto;}
.task-modal.open {transform: translateY(0);}
.task-input {background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; color: #fff; font-size: 16px; width: 100%; margin-bottom: 15px; outline: none; font-family: inherit;}
.task-input:focus {border-color: var(--primary);}
.task-input::placeholder {color: #666;}

.promise-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}
.promise-soft {background: rgba(46, 213, 115, 0.2); color: var(--success);}
.promise-normal {background: rgba(255, 165, 2, 0.2); color: var(--warning);}
.promise-strict {background: rgba(255, 71, 87, 0.2); color: var(--danger);}

.deadline-indicator {
    font-size: 10px;
    color: #888;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
}
.deadline-indicator.overdue {color: var(--danger); font-weight: 700;}
.deadline-indicator.soon {color: var(--warning);}

.livi-chat-section {
    background: linear-gradient(135deg, rgba(255,71,87,0.05) 0%, rgba(0,0,0,0.3) 100%);
    border: 1px solid rgba(255,71,87,0.2);
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 15px;
}
.livi-message {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    border-left: 3px solid var(--danger);
}
.livi-message.warning {border-left-color: var(--warning);}
.livi-message.cold {border-left-color: #6c7a89;}
.livi-message-time {font-size: 10px; color: #666; margin-bottom: 5px;}
.livi-message-text {font-size: 13px; color: #ccc; line-height: 1.4;}

.mood-indicator {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
}
.mood-bar {
    flex: 1;
    text-align: center;
}
.mood-bar-label {font-size: 10px; color: #666; margin-bottom: 5px;}
.mood-bar-fill {height: 4px; background: #333; border-radius: 2px; overflow: hidden;}
.mood-bar-value {height: 100%; transition: width 0.3s;}
.mood-trust .mood-bar-value {background: var(--success);}
.mood-patience .mood-bar-value {background: var(--warning);}
.mood-anger .mood-bar-value {background: var(--danger);}

.select-wrapper {position: relative; margin-bottom: 15px;}
.select-wrapper select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 12px 15px;
    color: #fff;
    font-size: 14px;
    outline: none;
    appearance: none;
    cursor: pointer;
    font-family: inherit;
}
.select-wrapper::after {
    content: '‚ñº';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    font-size: 10px;
    pointer-events: none;
}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div class="particle-container" id="stars"></div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:10px; color:#fff; font-weight:800; letter-spacing:1px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div class="roulette-window">
        <div class="r-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .5s">
        <div style="font-size:14px; color:#888; text-transform:uppercase; letter-spacing:1px">–í—ã –ø–æ–ª—É—á–∏–ª–∏</div>
        <div id="winItemName" style="font-size:32px; font-weight:800; color:var(--gold); margin:10px 0; text-shadow:0 0 20px rgba(212,175,122,0.3)">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" style="width:200px; margin:0 auto" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="noteModal" class="note-modal">
    <div class="note-header">
        <div style="font-weight: 800; font-size: 20px; color: var(--gold)" id="modalTitle">–ó–∞–º–µ—Ç–∫–∞</div>
        <div onclick="actions.closeNote()" style="padding: 10px; cursor: pointer;">‚úï</div>
    </div>
    <div class="ai-actions">
        <div class="ai-chip" onclick="actions.enhanceNote()">‚ö° AI –°—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
        <div class="ai-chip" onclick="actions.addSummary()">üß† –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å</div>
        <div class="ai-chip" onclick="actions.extractTasks()">‚úÖ –ù–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏</div>
        <div class="ai-chip" onclick="actions.fixGrammar()">üìù –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏</div>
        <div class="ai-chip" onclick="actions.addNotes()">üí° –î–æ–ø. –∑–∞–º–µ—Ç–∫–∏</div>
        <div class="ai-chip" onclick="actions.simplifyText()">üéØ –£–ø—Ä–æ—Å—Ç–∏—Ç—å</div>
        <div class="ai-chip" onclick="actions.expandText()">üìà –†–∞—Å—à–∏—Ä–∏—Ç—å</div>
    </div>
    <textarea id="modalText" class="note-textarea" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
    <button class="btn btn-primary" onclick="actions.saveAndCloseNote()" style="margin-top: auto;">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div id="taskModal" class="task-modal">
    <div class="note-header">
        <div style="font-weight: 800; font-size: 20px; color: var(--accent)" id="taskModalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</div>
        <div onclick="actions.closeTaskModal()" style="padding: 10px; cursor: pointer;">‚úï</div>
    </div>
    <input type="text" id="taskTitleInput" class="task-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...">
    
    <div class="select-wrapper">
        <select id="taskPrioritySelect">
            <option value="low">–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="med" selected>–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            <option value="high">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
        </select>
    </div>
    
    <div style="margin-bottom:15px">
        <label style="font-size:12px; color:#888; display:block; margin-bottom:8px">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ–±–µ—â–∞–Ω–∏–µ Livi)</label>
        <input type="datetime-local" id="taskDeadlineInput" class="task-input" style="margin-bottom:0">
    </div>
    
    <div class="select-wrapper">
        <select id="taskPromiseLevelSelect">
            <option value="">–ë–µ–∑ –æ–±–µ—â–∞–Ω–∏—è</option>
            <option value="soft">üü¢ –ú—è–≥–∫–æ–µ –æ–±–µ—â–∞–Ω–∏–µ</option>
            <option value="normal">üü° –û–±—ã—á–Ω–æ–µ –æ–±–µ—â–∞–Ω–∏–µ</option>
            <option value="strict">üî¥ –°—Ç—Ä–æ–≥–æ–µ –æ–±–µ—â–∞–Ω–∏–µ</option>
        </select>
    </div>
    
    <div id="promiseWarning" style="display:none; background:rgba(255,71,87,0.1); border:1px solid rgba(255,71,87,0.3); border-radius:12px; padding:12px; margin-bottom:15px">
        <div style="font-size:12px; color:var(--danger); font-weight:700; margin-bottom:5px">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</div>
        <div style="font-size:11px; color:#aaa; line-height:1.4">–ï—Å–ª–∏ —Ç—ã –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—à—å –∑–∞–¥–∞—á—É –≤ —Å—Ä–æ–∫, Livi –±—É–¥–µ—Ç —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω. –ß–µ–º —Å—Ç—Ä–æ–∂–µ –æ–±–µ—â–∞–Ω–∏–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Ä–µ–∞–∫—Ü–∏—è.</div>
    </div>
    
    <button class="btn btn-primary" onclick="actions.saveTask()" style="margin-top:auto">–°–û–ó–î–ê–¢–¨ –ó–ê–î–ê–ß–£</button>
</div>

<div id="app"></div>

<script>
let tg = null;
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.expand();
    tg.ready();
    tg.setHeaderColor('#000000');
    tg.setBackgroundColor('#000000');
    tg.enableClosingConfirmation();
}

const userId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'local_user_' + Math.random().toString(36).substr(2, 9);
const firstName = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.first_name || 'User') : '–î—Ä—É–≥';
const photoUrl = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.photo_url || '') : '';
const startParam = tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param ? tg.initDataUnsafe.start_param : null;

console.log('App started. UserId:', userId, 'StartParam:', startParam);

function appendWithoutDup(base, addition) {
    if (!addition) return base;
    const b = base.trim();
    const a = addition.trim();
    if (!b) return a + " ";
    if (b.includes(a)) return base;
    for (let i = a.length; i > 0; i--) {
        if (b.endsWith(a.slice(0, i))) {
            return b + a.slice(i) + " ";
        }
    }
    return b + " " + a + " ";
}

function initStars() {
    const container = document.getElementById('stars');
    const count = 50;
    for(let i=0; i<count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
        p.style.setProperty('--delay', (Math.random() * 5) + 's');
        p.style.opacity = Math.random() * 0.5 + 0.1;
        container.appendChild(p);
    }
}

const Storage = {
    save: async (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            console.log('Saved to localStorage:', key);
            if (tg && tg.CloudStorage) {
                await new Promise((resolve, reject) => {
                    tg.CloudStorage.setItem(key, JSON.stringify(data), (err, success) => {
                        if (err) {
                            console.error("Cloud save failed:", err);
                            reject(err);
                        } else {
                            console.log("‚úÖ Cloud saved:", key);
                            resolve(success);
                        }
                    });
                });
            }
        } catch (e) { 
            console.error("Save failed", e); 
        }
    },
    
    load: async (key) => {
        try {
            if (tg && tg.CloudStorage) {
                const cloudData = await new Promise((resolve) => {
                    tg.CloudStorage.getItem(key, (err, val) => {
                        if (err || !val) {
                            console.log("Cloud load failed or empty:", key);
                            resolve(null);
                        } else {
                            console.log("‚úÖ Cloud loaded:", key);
                            resolve(val);
                        }
                    });
                });
                
                if (cloudData) {
                    try {
                        const parsed = JSON.parse(cloudData);
                        localStorage.setItem(key, cloudData);
                        return parsed;
                    } catch (e) {
                        console.error("Parse error:", e);
                    }
                }
            }
            
            const local = localStorage.getItem(key);
            return local ? JSON.parse(local) : null;
        } catch (e) { 
            console.error("Load failed:", e);
            return null; 
        }
    }
};

const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
    spark: '<path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5z"/>',
    book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
    mic: '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
    clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
    message: '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>'
};
const getIcon = (n) => `<svg viewBox="0 0 24 24">${icons[n]}</svg>`;

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' },
    { id: 'insurance', name: '–©–∏—Ç —Å—Ç—Ä–∏–∫–∞', type: 'special', rarity: 'rare', icon: 'üõ°Ô∏è', css: 'item-insurance', special: true }
];

const defaultState = {
    activeTab: 'home',
    statsTab: 'overview',
    streak: 1,
    totalPoints: 200,
    lastVisitDate: new Date().toISOString().split('T')[0],
    statsHistory: [],
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10, priority: 'low', tag: '–†—É—Ç–∏–Ω–∞', deadline: null, promiseLevel: null, failedCount: 0, lastPromiseResult: null },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5, priority: 'high', tag: '–†–∞–∑–≤–∏—Ç–∏–µ', deadline: null, promiseLevel: null, failedCount: 0, lastPromiseResult: null }
    ],
    inventory: [],
    equipped: { head: null, face: null, body: null, special: null },
    dailyChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–°–¥–µ–ª–∞—Ç—å 20 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π',
        completed: false,
        reward: 50
    },
    notes: [],
    hasStreakInsurance: false,
    referralCount: 0,
    totalFire: 0,
    nick: firstName,
    avatar: photoUrl,
    weeklyGoals: {
        tasks: 20,
        points: 500,
        notes: 10
    },
    totalTasksCompleted: 0,
    totalNotesCreated: 0,
    totalTimeSpent: 0,
    isRegistered: false,
    liviMood: {
        anger: 0,
        trust: 1,
        patience: 1
    },
    liviChatHistory: [],
    consecutiveSuccesses: 0,
    referredBy: null
};

let state = { ...defaultState };
let recognition = null;
let isRecording = false;
let currentTranscript = "";
let editingNoteId = null;
let activityChart = null;
let taskChart = null;
let weeklyChart = null;
let priorityChart = null;
let categoryChart = null;
let lastFinalTranscript = "";
let lastUiUpdate = 0;

const LiviReactions = {
    disappointed: [
        "–¢—ã –æ–±–µ—â–∞–ª. –Ø –≤–µ—Ä–∏–ª —Ç–µ–±–µ.",
        "–≠—Ç–æ... –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ. –Ø –¥—É–º–∞–ª, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è.",
        "–•–º. –õ–∞–¥–Ω–æ. –ë—ã–≤–∞–µ—Ç.",
        "–Ø –Ω–∞–¥–µ—è–ª—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∏—Å—Ö–æ–¥.",
        "–¢—ã –ø–æ–¥–≤—ë–ª –Ω–µ —Ç–æ–ª—å–∫–æ —Å–µ–±—è."
    ],
    cold: [
        "–°–Ω–æ–≤–∞.",
        "–Ø —É–∂–µ –Ω–µ —É–¥–∏–≤–ª—ë–Ω.",
        "–ú–æ–ª—á—É.",
        "...",
        "–¢—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –¥–µ–ª–∞–µ—à—å."
    ],
    angry: [
        "–•–≤–∞—Ç–∏—Ç. –≠—Ç–æ —É–∂–µ –Ω–µ —Å–º–µ—à–Ω–æ.",
        "–¢—ã –≤–æ–æ–±—â–µ —Å–µ—Ä—å—ë–∑–Ω–æ –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ —Å–≤–æ–∏–º —Å–ª–æ–≤–∞–º?",
        "–ö–∞–∂–¥—ã–π —Ä–∞–∑ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ.",
        "–Ø —É—Å—Ç–∞–ª –æ—Ç –ø—É—Å—Ç—ã—Ö –æ–±–µ—â–∞–Ω–∏–π.",
        "–ú–æ–∂–µ—Ç, —Ö–≤–∞—Ç–∏—Ç –≤—Ä–∞—Ç—å —Å–µ–±–µ?"
    ],
    furious: [
        "–Ø –±–æ–ª—å—à–µ –Ω–µ –≤–µ—Ä—é —Ç–≤–æ–∏–º –æ–±–µ—â–∞–Ω–∏—è–º.",
        "–≠—Ç–æ –±—ã–ª–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.",
        "–¢—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ—à—å —Å–≤–æ–∏ —Å–ª–æ–≤–∞ –≤ –º—É—Å–æ—Ä.",
        "–ó–∞—á–µ–º —Ç—ã –≤–æ–æ–±—â–µ –æ–±–µ—â–∞–µ—à—å, –µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—à—å?",
        "–Ø —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω. –ü–æ–ª–Ω–æ—Å—Ç—å—é."
    ],
    forgiveness: [
        "–•–æ—Ä–æ—à–æ. –¢—ã —Å—Ç–∞—Ä–∞–µ—à—å—Å—è. –Ø –≤–∏–∂—É.",
        "–ú–æ–ª–æ–¥–µ—Ü. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.",
        "–í–æ–∑–º–æ–∂–Ω–æ, —è –±—ã–ª —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥.",
        "–¢—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å –º–æ—ë –¥–æ–≤–µ—Ä–∏–µ.",
        "–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å. –Ø –Ω–∞—á–∏–Ω–∞—é —Å–Ω–æ–≤–∞ –≤–µ—Ä–∏—Ç—å."
    ]
};

function getLiviReaction(failedCount, promiseLevel, mood) {
    let reactionType = 'disappointed';
    
    const severityMultiplier = promiseLevel === 'strict' ? 1.5 : (promiseLevel === 'normal' ? 1 : 0.5);
    const effectiveFailures = Math.ceil(failedCount * severityMultiplier);
    
    if (effectiveFailures >= 4 || mood.anger > 0.8) {
        reactionType = 'furious';
    } else if (effectiveFailures >= 3 || mood.anger > 0.6) {
        reactionType = 'angry';
    } else if (effectiveFailures >= 2 || mood.anger > 0.3) {
        reactionType = 'cold';
    }
    
    const reactions = LiviReactions[reactionType];
    return {
        text: reactions[Math.floor(Math.random() * reactions.length)],
        type: reactionType
    };
}

function updateLiviMood(isSuccess, promiseLevel) {
    if (!state.liviMood) {
        state.liviMood = { anger: 0, trust: 1, patience: 1 };
    }
    
    const impactMultiplier = promiseLevel === 'strict' ? 0.2 : (promiseLevel === 'normal' ? 0.12 : 0.06);
    
    if (isSuccess) {
        state.consecutiveSuccesses = (state.consecutiveSuccesses || 0) + 1;
        
        const recoveryRate = Math.min(0.15, 0.05 * state.consecutiveSuccesses);
        state.liviMood.anger = Math.max(0, state.liviMood.anger - recoveryRate);
        state.liviMood.trust = Math.min(1, state.liviMood.trust + recoveryRate * 0.8);
        state.liviMood.patience = Math.min(1, state.liviMood.patience + recoveryRate * 0.5);
        
        if (state.consecutiveSuccesses >= 3 && state.liviMood.anger < 0.3) {
            addLiviMessage(LiviReactions.forgiveness[Math.floor(Math.random() * LiviReactions.forgiveness.length)], 'forgiveness', null);
        }
    } else {
        state.consecutiveSuccesses = 0;
        
        state.liviMood.anger = Math.min(1, state.liviMood.anger + impactMultiplier);
        state.liviMood.trust = Math.max(0, state.liviMood.trust - impactMultiplier * 1.2);
        state.liviMood.patience = Math.max(0, state.liviMood.patience - impactMultiplier * 0.8);
    }
    
    saveAll();
}

function addLiviMessage(text, type, taskId) {
    if (!state.liviChatHistory) {
        state.liviChatHistory = [];
    }
    
    state.liviChatHistory.unshift({
        id: Date.now(),
        text: text,
        type: type,
        taskId: taskId,
        timestamp: new Date().toISOString()
    });
    
    if (state.liviChatHistory.length > 50) {
        state.liviChatHistory = state.liviChatHistory.slice(0, 50);
    }
    
    saveAll();
}

function checkDeadlines() {
    const now = new Date();
    let hasFailures = false;
    
    state.tasks.forEach(task => {
        if (task.deadline && !task.completed && task.promiseLevel) {
            const deadline = new Date(task.deadline);
            
            if (now > deadline && task.lastPromiseResult !== 'failed') {
                task.failedCount = (task.failedCount || 0) + 1;
                task.lastPromiseResult = 'failed';
                hasFailures = true;
                
                const reaction = getLiviReaction(task.failedCount, task.promiseLevel, state.liviMood);
                
                const deadlineStr = deadline.toLocaleString('ru-RU', { 
                    day: 'numeric', 
                    month: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const fullMessage = `${reaction.text}\n\nüìå "${task.title}"\n‚è∞ –°—Ä–æ–∫ –±—ã–ª: ${deadlineStr}`;
                addLiviMessage(fullMessage, reaction.type, task.id);
                
                updateLiviMood(false, task.promiseLevel);
                
                if (tg) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
    });
    
    if (hasFailures) {
        saveAll();
        render();
    }
}

function getDeadlineStatus(deadline) {
    if (!deadline) return null;
    
    const now = new Date();
    const dl = new Date(deadline);
    const diff = dl - now;
    const hours = diff / (1000 * 60 * 60);
    
    if (diff < 0) {
        return { status: 'overdue', text: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!', class: 'overdue' };
    } else if (hours < 2) {
        return { status: 'urgent', text: '–ú–µ–Ω–µ–µ 2 —á–∞—Å–æ–≤', class: 'soon' };
    } else if (hours < 24) {
        return { status: 'soon', text: `${Math.ceil(hours)} —á.`, class: 'soon' };
    } else {
        const days = Math.ceil(hours / 24);
        return { status: 'normal', text: `${days} –¥–Ω.`, class: '' };
    }
}

function getLiviMoodClass() {
    if (!state.liviMood) return '';
    if (state.liviMood.anger > 0.6) return 'angry';
    if (state.liviMood.anger > 0.3 || state.liviMood.trust < 0.4) return 'sad';
    return '';
}

async function processReferral() {
    console.log('Processing referral. StartParam:', startParam, 'IsRegistered:', state.isRegistered);
    
    if (!startParam || !startParam.startsWith('ref')) {
        console.log('No referral parameter');
        return;
    }
    
    if (state.isRegistered) {
        console.log('Already registered, skipping referral');
        return;
    }
    
    const referrerId = startParam.replace('ref', '');
    console.log('Referrer ID:', referrerId, 'Current User ID:', userId);
    
    if (referrerId === userId.toString()) {
        console.log('Cannot refer yourself');
        return;
    }
    
    const referrerKey = `livi_stats_${referrerId}`;
    console.log('Loading referrer stats from:', referrerKey);
    
    const referrerStats = await Storage.load(referrerKey);
    console.log('Referrer stats loaded:', referrerStats);
    
    if (referrerStats) {
        referrerStats.totalPoints = (referrerStats.totalPoints || 0) + 500;
        referrerStats.referralCount = (referrerStats.referralCount || 0) + 1;
        
        console.log('Updated referrer stats:', referrerStats);
        await Storage.save(referrerKey, referrerStats);
        
        state.isRegistered = true;
        state.referredBy = referrerId;
        
        await saveAll();
        console.log('‚úÖ Referral processed successfully!');
        
        if (tg) {
            tg.showAlert('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–∞—à –¥—Ä—É–≥ –ø–æ–ª—É—á–∏–ª 500 –æ—á–∫–æ–≤ –≤ –ø–æ–¥–∞—Ä–æ–∫!');
            tg.HapticFeedback.notificationOccurred('success');
        }
    } else {
        console.log('Referrer stats not found');
    }
}

async function loadState() {
    const statsData = await Storage.load(`livi_stats_${userId}`);
    console.log('Loaded stats:', statsData);
    
    if (statsData) {
        state = { ...defaultState, ...statsData };
    }

    const notesData = await Storage.load(`livi_notes_${userId}`);
    if (notesData && Array.isArray(notesData)) state.notes = notesData;

    if (!state.liviMood) {
        state.liviMood = { anger: 0, trust: 1, patience: 1 };
    }
    if (!state.liviChatHistory) {
        state.liviChatHistory = [];
    }
    if (state.consecutiveSuccesses === undefined) {
        state.consecutiveSuccesses = 0;
    }
    if (state.referralCount === undefined) {
        state.referralCount = 0;
    }

    state.tasks = state.tasks.map(t => ({
        ...t,
        deadline: t.deadline || null,
        promiseLevel: t.promiseLevel || null,
        failedCount: t.failedCount || 0,
        lastPromiseResult: t.lastPromiseResult || null
    }));

    if(state.statsHistory.length === 0) {
        for(let i=13; i>=0; i--) {
            const d = new Date(); 
            d.setDate(d.getDate() - i);
            state.statsHistory.push({
                date: d.toISOString().split('T')[0],
                points: Math.floor(Math.random() * 80) + 20,
                tasks_completed: Math.floor(Math.random() * 8),
                notes_created: Math.floor(Math.random() * 3),
                time_spent: Math.floor(Math.random() * 120) + 30
            });
        }
    }

    await processReferral();
    checkDailyReset();
    checkDeadlines();
}

function checkDailyReset() {
    const today = new Date().toISOString().split('T')[0];
    
    if (state.lastVisitDate !== today) {
        const hadActivity = hadActivityYesterday();
        
        if (!hadActivity && !state.hasStreakInsurance) {
            state.streak = 1;
        } else if (!hadActivity && state.hasStreakInsurance) {
            state.hasStreakInsurance = false;
            state.equipped.special = null;
            if (tg) {
                tg.showAlert('üõ°Ô∏è –©–∏—Ç —Å—Ç—Ä–∏–∫–∞ –∑–∞—â–∏—Ç–∏–ª —Ç–≤–æ—é —Å–µ—Ä–∏—é! –°—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –Ω–æ —â–∏—Ç –∏—Å—á–µ–∑.');
                tg.HapticFeedback.notificationOccurred('warning');
            }
        } else {
            state.streak++;
        }
        
        if (!state.statsHistory.find(e => e.date === today)) {
            state.statsHistory.push({
                date: today,
                points: 0,
                tasks_completed: 0,
                notes_created: 0,
                time_spent: 0
            });
        }
        
        state.lastVisitDate = today;
        
        const challenges = ['–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –∑–∞–¥–∞—á–∏','–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤','–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ª–µ–∫—Ü–∏—é','–°–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç','–ü—Ä–æ–π—Ç–∏ 5000 —à–∞–≥–æ–≤'];
        state.dailyChallenge = {
            date: today,
            title: challenges[Math.floor(Math.random() * challenges.length)],
            completed: false,
            reward: 50
        };
        
        state.tasks.forEach(t => { if (t.type === 'habit') t.completed = false; });
        
        checkDeadlines();
        saveAll();
    }
}

setInterval(() => {
    checkDailyReset();
    checkDeadlines();
}, 60000);

async function saveAll() {
    const statsToSave = { ...state };
    delete statsToSave.notes;
    await Storage.save(`livi_stats_${userId}`, statsToSave);
    await Storage.save(`livi_notes_${userId}`, state.notes);
    console.log('All data saved');
}

function hadActivityYesterday() {
    const d = new Date(); d.setDate(d.getDate() - 1);
    const y = d.toISOString().split('T')[0];
    const entry = state.statsHistory.find(e => e.date === y);
    return entry && (entry.points > 0 || entry.tasks_completed > 0 || entry.notes_created > 0);
}

function updateHistory(pointsDelta, taskCompleted = false, noteCreated = false) {
    const today = new Date().toISOString().split('T')[0];
    let entry = state.statsHistory.find(e => e.date === today);
    if (!entry) {
        entry = { date: today, points: 0, tasks_completed: 0, notes_created: 0, time_spent: 0 };
        state.statsHistory.push(entry);
    }
    entry.points += pointsDelta;
    if (taskCompleted) {
        entry.tasks_completed++;
        state.totalTasksCompleted++;
    }
    if (noteCreated) {
        entry.notes_created++;
        state.totalNotesCreated++;
    }
    if (state.statsHistory.length > 14) state.statsHistory.shift();
    saveAll();
}

const AI = {
    stopWords: ['–∏', '–≤', '–≤–æ', '–Ω–µ', '–Ω–∞', '—è', '—Å', '—Å–æ', '–∫–∞–∫', '–∞', '—Ç–æ', '–≤—Å–µ', '–æ–Ω–∞', '—Ç–∞–∫', '–µ–≥–æ', '–Ω–æ', '–¥–∞', '—Ç—ã', '–∫', '—É', '–∂–µ', '–≤—ã', '–∑–∞', '–±—ã', '–ø–æ', '—Ç–æ–ª—å–∫–æ', '–µ–µ', '–º–Ω–µ', '–±—ã–ª–æ', '–≤–æ—Ç', '–æ—Ç', '–º–µ–Ω—è', '–µ—â–µ', '–Ω–µ—Ç', '–æ', '–∏–∑', '–µ–º—É', '—Ç–µ–ø–µ—Ä—å', '–∫–æ–≥–¥–∞', '–¥–∞–∂–µ', '–Ω—É', '–≤–¥—Ä—É–≥', '–ª–∏', '–µ—Å–ª–∏', '—É–∂–µ', '–∏–ª–∏', '–Ω–∏', '–±—ã—Ç—å', '–±—ã–ª', '–Ω–µ–≥–æ', '–¥–æ', '–≤–∞—Å', '–Ω–∏–±—É–¥—å', '–æ–ø—è—Ç—å', '—É–∂', '–≤–∞–º', '–≤–µ–¥—å', '—Ç–∞–º', '–ø–æ—Ç–æ–º', '—Å–µ–±—è', '–Ω–∏—á–µ–≥–æ', '–µ–π', '–º–æ–∂–µ—Ç', '–æ–Ω–∏', '—Ç—É—Ç', '–≥–¥–µ', '–µ—Å—Ç—å', '–Ω–∞–¥–æ', '–Ω–µ–π', '–¥–ª—è', '–º—ã', '—Ç–µ–±—è', '–∏—Ö', '—á–µ–º', '–±—ã–ª–∞', '—Å–∞–º', '—á—Ç–æ–±', '–±–µ–∑', '–±—É–¥—Ç–æ', '—á–µ–≥–æ', '—Ä–∞–∑', '—Ç–æ–∂–µ', '—Å–µ–±–µ', '–ø–æ–¥', '–±—É–¥–µ—Ç', '–∂', '—Ç–æ–≥–¥–∞', '–∫—Ç–æ', '—ç—Ç–æ—Ç', '—Ç–æ–≥–æ', '–ø–æ—Ç–æ–º—É', '—ç—Ç–æ–≥–æ', '–∫–∞–∫–æ–π', '—Å–æ–≤—Å–µ–º', '–Ω–∏–º', '–∑–¥–µ—Å—å', '—ç—Ç–æ–º', '–æ–¥–∏–Ω', '–ø–æ—á—Ç–∏', '–º–æ–π', '—Ç–µ–º', '—á—Ç–æ–±—ã', '–Ω–µ–µ', '—Å–µ–π—á–∞—Å', '–±—ã–ª–∏', '–∫—É–¥–∞', '–∑–∞—á–µ–º', '–≤—Å–µ—Ö', '–Ω–∏–∫–æ–≥–¥–∞', '–º–æ–∂–Ω–æ', '–ø—Ä–∏', '–Ω–∞–∫–æ–Ω–µ—Ü', '–¥–≤–∞', '–æ–±', '–¥—Ä—É–≥–æ–π', '—Ö–æ—Ç—å', '–ø–æ—Å–ª–µ', '–Ω–∞–¥', '–±–æ–ª—å—à–µ', '—Ç–æ—Ç', '—á–µ—Ä–µ–∑', '—ç—Ç–∏', '–Ω–∞—Å', '–ø—Ä–æ', '–≤—Å–µ–≥–æ', '–Ω–∏—Ö', '–∫–∞–∫–∞—è', '–º–Ω–æ–≥–æ', '—Ä–∞–∑–≤–µ', '—Ç—Ä–∏', '—ç—Ç—É', '–º–æ—è', '–≤–ø—Ä–æ—á–µ–º', '—Ö–æ—Ä–æ—à–æ', '—Å–≤–æ—é', '—ç—Ç–æ–π', '–ø–µ—Ä–µ–¥', '–∏–Ω–æ–≥–¥–∞', '–ª—É—á—à–µ', '—á—É—Ç—å', '—Ç–æ–º', '–Ω–µ–ª—å–∑—è', '—Ç–∞–∫–æ–π', '–∏–º', '–±–æ–ª–µ–µ', '–≤—Å–µ–≥–¥–∞', '–∫–æ–Ω–µ—á–Ω–æ', '–≤—Å—é', '–º–µ–∂–¥—É'],

    commonErrors: {
        '–∞—Å–≤–µ—á–∞–Ω–∏–µ': '–æ—Å–≤–µ—â–µ–Ω–∏–µ', '–ø—Ä–∞—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å': '–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', '–∫–∞–º–∞–Ω–¥–∞': '–∫–æ–º–∞–Ω–¥–∞',
        '—Ñ—É–Ω–∫—Ü–∏—è–Ω–∞–ª': '—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª', '–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞': '–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', '–≤–æ–±—â–µ': '–≤–æ–æ–±—â–µ',
        '—á—Ç–æ–ª–∏': '—á—Ç–æ –ª–∏', '–Ω–∞–≤–µ—Ä–Ω–æ': '–Ω–∞–≤–µ—Ä–Ω–æ–µ', '–≤–∞—â–µ': '–≤–æ–æ–±—â–µ', '–ø—Ä–∏–¥—Ç–∏': '–ø—Ä–∏–π—Ç–∏',
        '–∑–¥—Ä–∞—Å—Ç–≤—É–π—Ç–µ': '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', '–ø—Ä–∏–π–¥–µ—Ç': '–ø—Ä–∏–¥–µ—Ç', '–∑–¥–µ–ª–∞—Ç—å': '—Å–¥–µ–ª–∞—Ç—å',
        '–∫–æ–º–ø–∞–Ω–∏—è': '–∫–∞–º–ø–∞–Ω–∏—è', '–∏–∑–≤–µ–Ω–∏': '–∏–∑–≤–∏–Ω–∏', '–ø–æ–∂–∞–ª—É—Å—Ç–∞': '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '—à—Ç–æ': '—á—Ç–æ', '–∫–∞–¥–∞': '–∫–æ–≥–¥–∞', '—Ç–æ–∫–∞': '—Ç–æ–ª—å–∫–æ', '—â–∞—Å': '—Å–µ–π—á–∞—Å',
        '—Å–ø–∞—Å–∏–±–æ': '—Å–ø–∞—Å–∏–±–æ', '–ø–∞—Å–∏–±–æ': '—Å–ø–∞—Å–∏–±–æ', '–∫–∞–Ω–µ—à–Ω–æ': '–∫–æ–Ω–µ—á–Ω–æ',
        '—Å–∏–º–ø–æ—Ç–∏—á–Ω–æ': '—Å–∏–º–ø–∞—Ç–∏—á–Ω–æ', '–≤ –æ–±—â–µ–º': '–≤ –æ–±—â–µ–º', '–≤–æ–æ–±—â–µ–º': '–≤ –æ–±—â–µ–º'
    },

    clean: (text) => text.replace(/\s+/g, ' ').trim(),

    fixGrammar: (text) => {
        if (!text || text.length < 3) return text;
        
        let fixed = text;
        
        Object.keys(AI.commonErrors).forEach(error => {
            const regex = new RegExp('\\b' + error + '\\b', 'gi');
            fixed = fixed.replace(regex, (match) => {
                const correction = AI.commonErrors[error.toLowerCase()];
                if (!correction) return match;
                
                if (match[0] === match[0].toUpperCase()) {
                    return correction.charAt(0).toUpperCase() + correction.slice(1);
                }
                return correction;
            });
        });
        
        fixed = fixed.replace(/\s{2,}/g, ' ');
        fixed = fixed.replace(/\s+([,.!?;:])/g, '$1');
        fixed = fixed.replace(/([,.!?;:])([–∞-—è–ê-–Ø—ë–Åa-zA-Z])/g, '$1 $2');
        fixed = fixed.replace(/\.(\s+)([–∞-—è—ë])/g, (match, space, letter) => {
            return '.' + space + letter.toUpperCase();
        });
        
        if (fixed.length > 0) {
            fixed = fixed.charAt(0).toUpperCase() + fixed.slice(1);
        }
        
        fixed = fixed.replace(/\n([–∞-—è—ë])/g, (match, letter) => {
            return '\n' + letter.toUpperCase();
        });
        
        return fixed;
    },

    addContextNotes: (text) => {
        if (!text || text.length < 20) return text;
        
        let enhanced = text;
        const additions = [];
        const lowerText = text.toLowerCase();
        
        const hasProject = lowerText.match(/–ø—Ä–æ–µ–∫—Ç|–∑–∞–¥–∞—á|–ø–ª–∞–Ω–∏—Ä|—Ü–µ–ª/i);
        const hasMeeting = lowerText.match(/–≤—Å—Ç—Ä–µ—á|—Å–æ–±—Ä–∞–Ω–∏–µ|—Å–æ–∑–≤–æ–Ω|–º–∏—Ç–∏–Ω–≥/i);
        const hasStudy = lowerText.match(/–∏–∑—É—á|—É—á–µ–±|–∫—É—Ä—Å|–ª–µ–∫—Ü–∏|—ç–∫–∑–∞–º–µ–Ω/i);
        const hasDeadline = lowerText.match(/—Å—Ä–æ–∫|deadline|–¥–µ–¥–ª–∞–π–Ω|–¥–æ\s+\d|–∫\s+\d/i);
        const hasTime = lowerText.match(/\d{1,2}:\d{2}|\d{1,2}\s+(—á–∞—Å|–º–∏–Ω—É—Ç)/i);
        
        if (hasProject && !lowerText.includes('—ç—Ç–∞–ø') && !lowerText.includes('milestone')) {
            additions.push('\n\nüí° **AI —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç:** –†–∞–∑–±–µ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ —ç—Ç–∞–ø—ã —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (milestones).');
        }
        
        if (hasMeeting && !hasTime) {
            additions.push('\n\n‚è∞ **–ü–æ–¥—Å–∫–∞–∑–∫–∞:** –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.');
        }
        
        if (hasStudy && !lowerText.includes('–ø—Ä–∞–∫—Ç–∏–∫')) {
            additions.push('\n\nüìö **–ú–µ—Ç–æ–¥:** –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.');
        }
        
        if (hasDeadline && !lowerText.includes('–±—É—Ñ–µ—Ä')) {
            additions.push('\n\n‚ö° **–°–æ–≤–µ—Ç:** –î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±—É—Ñ–µ—Ä (20-30%) –Ω–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏.');
        }
        
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        const avgLength = sentences.reduce((sum, s) => sum + s.split(' ').length, 0) / sentences.length;
        
        if (avgLength > 25) {
            additions.push('\n\n‚úçÔ∏è **–°—Ç–∏–ª—å:** –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–±–∏–≤–∫—É –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.');
        }
        
        return enhanced + additions.join('');
    },

    getWordFrequencies: (text) => {
        if (!text) return {};
        
        const words = text.toLowerCase()
            .replace(/[.,!?;:()¬´¬ª‚Äî‚Äì]/g, '')
            .split(/\s+/)
            .filter(w => w.length > 0);
            
        const freqs = {};
        words.forEach(w => {
            if (w.length > 3 && !AI.stopWords.includes(w)) {
                freqs[w] = (freqs[w] || 0) + 1;
            }
        });
        return freqs;
    },

    scoreSentences: (text) => {
        if (!text) return [];
        
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
        const freqs = AI.getWordFrequencies(text);
        const maxFreq = Math.max(...Object.values(freqs), 1);

        return sentences.map(s => {
            let score = 0;
            const words = s.toLowerCase().split(/\s+/);
            
            words.forEach(w => {
                const cleanW = w.replace(/[^–∞-—è—ëa-z]/gi, '');
                if (freqs[cleanW]) {
                    score += (freqs[cleanW] / maxFreq) * 2;
                }
            });
            
            const keywordPatterns = [
                /(–≤–∞–∂–Ω–æ|—Å—É—Ç—å|–≤—ã–≤–æ–¥|–∏—Ç–∞–∫|–∑–Ω–∞—á–∏—Ç|–ø–æ—ç—Ç–æ–º—É|–∑–∞–ø–æ–º–Ω–∏—Ç—å|–≥–ª–∞–≤–Ω–æ–µ|–æ—Å–Ω–æ–≤–Ω–æ–µ|–∫–ª—é—á–µ–≤–æ–µ|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω)/i,
                /(–≤–æ-–ø–µ—Ä–≤—ã—Ö|–≤–æ-–≤—Ç–æ—Ä—ã—Ö|–≤-—Ç—Ä–µ—Ç—å–∏—Ö|–ø–µ—Ä–≤–æ–µ|–≤—Ç–æ—Ä–æ–µ|—Ç—Ä–µ—Ç—å–µ|–¥–∞–ª–µ–µ|–∑–∞—Ç–µ–º)/i,
                /(–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ|–Ω—É–∂–Ω–æ|—Å–ª–µ–¥—É–µ—Ç|–¥–æ–ª–∂–Ω|–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)/i,
                /(–ø—Ä–æ–±–ª–µ–º–∞|—Ä–µ—à–µ–Ω–∏–µ|–∑–∞–¥–∞—á|—Ü–µ–ª—å|—Ä–µ–∑—É–ª—å—Ç–∞—Ç)/i
            ];
            
            keywordPatterns.forEach(pattern => {
                if (s.match(pattern)) score *= 1.5;
            });
            
            const index = sentences.indexOf(s);
            if (index === 0 || index === sentences.length - 1) {
                score *= 1.3;
            }
            
            const normalizedScore = score / Math.max(words.length, 1);
            
            return { 
                text: s.trim(), 
                score: normalizedScore,
                length: words.length 
            };
        });
    },

    structure: (text) => {
        if (!text || text.length < 10) return text;
        
        let processed = AI.fixGrammar(text);
        
        processed = processed.replace(
            /([–ê-–Ø–Å–∞-—è—ë][–∞-—è—ë]+)\s*[-‚Äì‚Äî]\s*([–∞-—è—ë–ê-–Ø–Å].+?)(?=\.|$)/gm,
            "**$1** ‚Äî $2"
        );
        
        processed = processed.replace(/([.!?])\s+(?=[–ê-–Ø–Å])/g, "$1\n\n");
        processed = processed.replace(/(\n|^)\s*[-‚Ä¢]\s*/g, "\n‚Ä¢ ");
        processed = processed.replace(/(\n|^)\s*(\d+)[.)]\s*/g, "\n$2. ");
        
        processed = processed.replace(
            /(–í–æ-–ø–µ—Ä–≤—ã—Ö|–í–æ-–≤—Ç–æ—Ä—ã—Ö|–í-—Ç—Ä–µ—Ç—å–∏—Ö|–ü–µ—Ä–≤–æ–µ|–í—Ç–æ—Ä–æ–µ|–¢—Ä–µ—Ç—å–µ|–î–∞–ª–µ–µ|–ó–∞—Ç–µ–º|–ù–∞–∫–æ–Ω–µ—Ü),?\s*/gi,
            "\n\nüîπ **$1:** "
        );
        
        processed = processed.replace(
            /(–í–∞–∂–Ω–æ|–í–Ω–∏–º–∞–Ω–∏–µ|–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ|–ó–∞–º–µ—á–∞–Ω–∏–µ|–ò—Ç–æ–≥–æ|–í—ã–≤–æ–¥|–†–µ–∑—É–ª—å—Ç–∞—Ç):\s*/gi,
            "\n\n‚ö†Ô∏è **$1:**\n"
        );
        
        processed = processed.replace(/\n{3,}/g, "\n\n");
        
        return processed.trim();
    },

    extractSummary: (text) => {
        if (!text || text.length < 20) return "–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.";
        
        const scored = AI.scoreSentences(text);
        const count = Math.max(1, Math.min(3, Math.ceil(scored.length * 0.25)));
        
        const topSentences = [...scored]
            .sort((a, b) => b.score - a.score)
            .slice(0, count);
        
        const orderedSentences = topSentences.sort((a, b) => {
            return text.indexOf(a.text) - text.indexOf(b.text);
        });
        
        let result = orderedSentences.map(s => "‚ñ™Ô∏è " + s.text).join('\n\n');
        
        const wordCount = text.split(/\s+/).length;
        const readTime = Math.ceil(wordCount / 200);
        
        return `üìå **–ì–õ–ê–í–ù–ê–Ø –ú–´–°–õ–¨:**\n\n${result}\n\n---\nüìä –°–ª–æ–≤: ${wordCount} | ‚è±Ô∏è –ß—Ç–µ–Ω–∏–µ: ~${readTime} –º–∏–Ω`;
    },

    findTasks: (text) => {
        if (!text || text.length < 10) return "\n\n‚úÖ –ó–∞–¥–∞—á –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ";
        
        const actionVerbs = [
            '—Å–¥–µ–ª–∞—Ç—å', '–∫—É–ø–∏—Ç—å', '–ø—Ä–æ—á–∏—Ç–∞—Ç—å', '–Ω–∞–ø–∏—Å–∞—Ç—å', '–æ—Ç–ø—Ä–∞–≤–∏—Ç—å', 
            '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–Ω–∞–π—Ç–∏', '–∏–∑—É—á–∏—Ç—å', '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å', '–≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è',
            '–≤—ã–ø–æ–ª–Ω–∏—Ç—å', '—Å–æ–∑–¥–∞—Ç—å', '—Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å', '–ø—Ä–æ–≤–µ—Ä–∏—Ç—å', '–∑–∞–≤–µ—Ä—à–∏—Ç—å',
            '–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å', '—Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å', '–æ–±—Å—É–¥–∏—Ç—å', '—Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å', '—É—Ç–≤–µ—Ä–¥–∏—Ç—å',
            '–¥–æ–¥–µ–ª–∞—Ç—å', '–∏—Å–ø—Ä–∞–≤–∏—Ç—å', '–æ–±–Ω–æ–≤–∏—Ç—å', '–¥–æ–±–∞–≤–∏—Ç—å', '—É–¥–∞–ª–∏—Ç—å',
            '—Å–≤—è–∑–∞—Ç—å—Å—è', '—É—Ç–æ—á–Ω–∏—Ç—å', '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å', '–æ–ø–ª–∞—Ç–∏—Ç—å'
        ];
        
        const sentences = text.match(/[^.!?]+[.!?]+/g) || text.split(/\n+/);
        const tasks = [];
        
        sentences.forEach(s => {
            const lower = s.toLowerCase();
            const hasActionVerb = actionVerbs.some(v => lower.includes(v));
            
            const taskPatterns = [
                /–Ω–∞–¥–æ\s+/i,
                /–Ω—É–∂–Ω–æ\s+/i,
                /–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ\s+/i,
                /—Å–ª–µ–¥—É–µ—Ç\s+/i,
                /^[-‚Ä¢]\s*/,
                /^\d+[.)]\s*/,
                /todo:/i,
                /–∑–∞–¥–∞—á–∞:/i
            ];
            
            const hasTaskPattern = taskPatterns.some(p => lower.match(p));
            
            if (hasActionVerb || hasTaskPattern) {
                let task = s.trim();
                task = task.replace(/^[-‚Ä¢]\s*/, '').replace(/^\d+[.)]\s*/, '');
                
                if (task.length > 10 && task.length < 120) {
                    let priority = '';
                    if (lower.match(/—Å—Ä–æ—á–Ω–æ|–≤–∞–∂–Ω–æ|–∞—Å–∞–ø|asap|!!/)) {
                        priority = ' üî¥ –í—ã—Å–æ–∫–∏–π';
                    } else if (lower.match(/–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ|–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏/)) {
                        priority = ' üü° –ù–∏–∑–∫–∏–π';
                    }
                    
                    tasks.push(`‚òê ${task}${priority}`);
                }
            }
        });
        
        if (tasks.length === 0) {
            return "\n\n‚úÖ –ó–∞–¥–∞—á –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è (—Å–¥–µ–ª–∞—Ç—å, –∫—É–ø–∏—Ç—å, –Ω–∞–ø–∏—Å–∞—Ç—å –∏ —Ç.–¥.)";
        }
        
        return `\n\n‚úÖ **–û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò (${tasks.length}):**\n\n` + tasks.join('\n');
    },

    simplifyText: (text) => {
        if (!text || text.length < 20) return text;
        
        let simplified = text;
        
        const replacements = {
            '–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è': '—Å–µ–π—á–∞—Å',
            '–≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è': '—Å–∫–æ—Ä–æ',
            '–≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏': '–µ—Å–ª–∏',
            '–ø–æ –ø—Ä–∏—á–∏–Ω–µ —Ç–æ–≥–æ —á—Ç–æ': '–ø–æ—Ç–æ–º—É —á—Ç–æ',
            '–≤ —Å–≤—è–∑–∏ —Å —Ç–µ–º —á—Ç–æ': '—Ç–∞–∫ –∫–∞–∫',
            '–¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã': '—á—Ç–æ–±—ã',
            '–≤ —Ç–µ—á–µ–Ω–∏–µ': '–∑–∞',
            '–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º': '—á–µ—Ä–µ–∑',
            '–æ—Å—É—â–µ—Å—Ç–≤–∏—Ç—å': '—Å–¥–µ–ª–∞—Ç—å',
            '—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å': '–≤—ã–ø–æ–ª–Ω–∏—Ç—å',
            '–ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å': '–ø–æ–∫–∞–∑–∞—Ç—å',
            '–∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å': '–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å',
            '–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å': '—É–ª—É—á—à–∏—Ç—å',
            '–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å': '–∏–∑–º–µ–Ω–∏—Ç—å'
        };
        
        Object.keys(replacements).forEach(complex => {
            const regex = new RegExp('\\b' + complex + '\\b', 'gi');
            simplified = simplified.replace(regex, replacements[complex]);
        });
        
        simplified = simplified.replace(/([^.!?]{100,}?)([,;])\s+/g, '$1.$2 ');
        
        return AI.fixGrammar(simplified);
    },

    expandText: (text) => {
        if (!text || text.length < 10) return text;
        
        let expanded = text;
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
        const lowerText = text.toLowerCase();
        const expansions = [];
        
        if (lowerText.includes('–ø—Ä–æ–µ–∫—Ç') && sentences.length < 3) {
            expansions.push('–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.');
        }
        
        if (lowerText.includes('–∑–∞–¥–∞—á') && !lowerText.includes('–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç')) {
            expansions.push('–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á –ø–æ –º–∞—Ç—Ä–∏—Ü–µ –≤–∞–∂–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏.');
        }
        
        if (lowerText.match(/—É—á–µ–±|–∏–∑—É—á/) && !lowerText.includes('–º–µ—Ç–æ–¥')) {
            expansions.push('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è: –∫–æ–Ω—Å–ø–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.');
        }
        
        if (expansions.length > 0) {
            expanded = text + '\n\n**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**\n' + expansions.map(e => '‚Ä¢ ' + e).join('\n');
        }
        
        return expanded;
    },

    getDetailedInsights: (lastNote) => {
        if (!lastNote || lastNote.length < 20) {
            return {
                mood: 'ü§î',
                summary: 'Livi –∂–¥–µ—Ç —Ç–≤–æ–∏—Ö –º—ã—Å–ª–µ–π...',
                topics: [],
                suggestions: ['–ù–∞—á–Ω–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏–¥–µ–∏ –≥–æ–ª–æ—Å–æ–º', '–ò—Å–ø–æ–ª—å–∑—É–π AI –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è']
            };
        }

        const freqs = AI.getWordFrequencies(lastNote);
        const topWords = Object.entries(freqs)
            .sort((a,b)=>b[1]-a[1])
            .slice(0, 5)
            .map(x=>x[0]);

        const scored = AI.scoreSentences(lastNote);
        const topSentence = scored.sort((a,b) => b.score - a.score)[0];

        let mood = 'üí≠';
        if (lastNote.match(/—Ö–æ—Ä–æ—à–æ|–æ—Ç–ª–∏—á–Ω–æ|—Å—É–ø–µ—Ä|–∫–ª–∞—Å—Å|–∫—Ä—É—Ç–æ|–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ|–≤–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ/i)) mood = 'üòä';
        else if (lastNote.match(/–ø–ª–æ—Ö–æ|—Å–ª–æ–∂–Ω–æ|—Ç—Ä—É–¥–Ω–æ|–ø—Ä–æ–±–ª–µ–º–∞|—Ç—è–∂–µ–ª–æ|—Å–ª–æ–∂–Ω–æ—Å—Ç—å/i)) mood = 'üòü';
        else if (lastNote.match(/–∑–∞–¥–∞—á|–¥–µ–ª–∞|—Ä–∞–±–æ—Ç–∞|–ø—Ä–æ–µ–∫—Ç|deadline/i)) mood = 'üíº';
        else if (lastNote.match(/—É—á–µ–±|–∏–∑—É—á–∏|–∫—É—Ä—Å|–ª–µ–∫—Ü–∏—è|—ç–∫–∑–∞–º–µ–Ω/i)) mood = 'üìö';
        else if (lastNote.match(/—Å–ø–æ—Ä—Ç|—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞|–∑–¥–æ—Ä–æ–≤—å–µ|—Ñ–∏—Ç–Ω–µ—Å/i)) mood = 'üí™';

        let category = '–û–±—â–µ–µ';
        if (lastNote.match(/—Ä–∞–±–æ—Ç–∞|–ø—Ä–æ–µ–∫—Ç|–∑–∞–¥–∞—á|–¥–µ–ª–∞|meeting|–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è/i)) category = '–†–∞–±–æ—Ç–∞';
        else if (lastNote.match(/—É—á–µ–±|–∏–∑—É—á–∏|–∫—É—Ä—Å|–ª–µ–∫—Ü–∏—è|–∫–æ–Ω—Å–ø–µ–∫—Ç|—ç–∫–∑–∞–º–µ–Ω/i)) category = '–û–±—É—á–µ–Ω–∏–µ';
        else if (lastNote.match(/–∑–¥–æ—Ä–æ–≤—å–µ|—Å–ø–æ—Ä—Ç|—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞|–ø–∏—Ç–∞–Ω–∏–µ|—Å–æ–Ω/i)) category = '–ó–¥–æ—Ä–æ–≤—å–µ';
        else if (lastNote.match(/–∏–¥–µ—è|–ø–ª–∞–Ω|–º—ã—Å–ª|–∫–æ–Ω—Ü–µ–ø—Ü–∏—è|—Å—Ç—Ä–∞—Ç–µ–≥–∏—è/i)) category = '–ò–¥–µ–∏';

        const suggestions = [];
        if (topWords.includes('–ø—Ä–æ–µ–∫—Ç') || topWords.includes('–∑–∞–¥–∞—á')) {
            suggestions.push('–°–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ —ç—Ç–æ–π –∑–∞–º–µ—Ç–∫–∏');
        }
        if (lastNote.length > 300) {
            suggestions.push('–ò—Å–ø–æ–ª—å–∑—É–π AI –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ');
        }
        if (!lastNote.match(/[0-9]{1,2}\.[0-9]{1,2}|–∑–∞–≤—Ç—Ä–∞|—Å–µ–≥–æ–¥–Ω—è|—á–µ—Ä–µ–∑|–¥–æ/)) {
            suggestions.push('–î–æ–±–∞–≤—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–ª—è –∑–∞–¥–∞—á');
        }
        if (lastNote.length > 500) {
            suggestions.push('–†–∞–∑–±–µ–π –∑–∞–º–µ—Ç–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π');
        }

        return {
            mood: mood,
            summary: topSentence ? topSentence.text.slice(0, 120) + '...' : '–ê–Ω–∞–ª–∏–∑ –∑–∞–º–µ—Ç–∫–∏',
            topics: topWords.slice(0, 3),
            category: category,
            suggestions: suggestions.length > 0 ? suggestions : ['–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!']
        };
    },

    getTip: (text) => {
        if (!text || text.length < 20) return "Livi –∂–¥–µ—Ç —Ç–≤–æ–∏—Ö –º—ã—Å–ª–µ–π...";
        const insights = AI.getDetailedInsights(text);
        return insights.summary;
    }
};

const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            const wasCompleted = task.completed;
            task.completed = !task.completed;
            const delta = task.completed ? task.points : -task.points;
            state.totalPoints += delta;
            updateHistory(delta, task.completed, false);
            
            if (task.completed && task.promiseLevel && task.deadline) {
                const now = new Date();
                const deadline = new Date(task.deadline);
                if (now <= deadline) {
                    task.lastPromiseResult = 'ok';
                    updateLiviMood(true, task.promiseLevel);
                }
            }
            
            if(task.completed && tg) tg.HapticFeedback.notificationOccurred('success');
            saveAll();
            render();
        }
    },
    completeChallenge: () => {
        if (!state.dailyChallenge.completed) {
            state.dailyChallenge.completed = true;
            state.totalPoints += state.dailyChallenge.reward;
            state.totalFire += 1;
            updateHistory(state.dailyChallenge.reward, false, false);
            if(tg) tg.HapticFeedback.notificationOccurred('success');
            saveAll();
            render();
        }
    },
    openTaskModal: () => {
        console.log('Opening task modal');
        document.getElementById('taskTitleInput').value = '';
        document.getElementById('taskDeadlineInput').value = '';
        document.getElementById('taskPrioritySelect').value = 'med';
        document.getElementById('taskPromiseLevelSelect').value = '';
        document.getElementById('promiseWarning').style.display = 'none';
        document.getElementById('taskModalTitle').innerText = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
        document.getElementById('taskModal').classList.add('open');
    },
    closeTaskModal: () => {
        console.log('Closing task modal');
        document.getElementById('taskModal').classList.remove('open');
    },
    saveTask: () => {
        const title = document.getElementById('taskTitleInput').value.trim();
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
            return;
        }
        
        const priority = document.getElementById('taskPrioritySelect').value;
        const deadline = document.getElementById('taskDeadlineInput').value || null;
        const promiseLevel = document.getElementById('taskPromiseLevelSelect').value || null;
        
        console.log('Creating task:', { title, priority, deadline, promiseLevel });
        
        state.tasks.push({
            id: Date.now(),
            title,
            completed: false,
            type: 'task',
            points: priority === 'high' ? 20 : (priority === 'med' ? 15 : 10),
            priority: priority,
            tag: '–û–±—â–µ–µ',
            deadline: deadline,
            promiseLevel: promiseLevel,
            failedCount: 0,
            lastPromiseResult: null
        });
        
        if (tg) tg.HapticFeedback.notificationOccurred('success');
        saveAll();
        actions.closeTaskModal();
        render();
    },
    addTask: () => {
        console.log('Add task button clicked');
        actions.openTaskModal();
    },
    deleteTask: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveAll();
            render();
        }
    },
    equip: (id) => {
        const item = ITEMS.find(i => i.id === id);
        if (item) {
            const slot = item.special ? 'special' : item.type;
            state.equipped[slot] = state.equipped[slot] === id ? null : id;
            if(item.special) state.hasStreakInsurance = !!state.equipped.special;
            saveAll();
            render();
        }
    },
    openChest: (type, cost) => {
        if (state.totalPoints >= cost) {
            state.totalPoints -= cost;
            updateHistory(-cost, false, false);
            startRoulette(type);
        } else alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
    },
    startRecording: () => {
        currentTranscript = "";
        lastFinalTranscript = "";
        lastUiUpdate = 0;
        if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
            alert("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Android.");
            return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => { 
            isRecording = true; 
            if(tg) tg.HapticFeedback.impactOccurred('light');
            render(); 
        };
        
        recognition.onresult = (event) => {
            let interimText = "";

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                const text = result[0].transcript.trim();

                if (result.isFinal) {
                    currentTranscript = appendWithoutDup(currentTranscript, text);
                } else {
                    interimText += text + " ";
                }
            }

            const now = Date.now();
            if (now - lastUiUpdate > 100) {
                const el = document.getElementById('liveTranscript');
                if (el) {
                    const fullText = (currentTranscript + " " + interimText).trim();
                    el.innerText = fullText || "–°–ª—É—à–∞—é...";
                }
                lastUiUpdate = now;
            }
        };

        recognition.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
            if (event.error === 'no-speech') {
                recognition.stop();
                setTimeout(() => {
                    if (isRecording) recognition.start();
                }, 500);
            }
        };

        recognition.onend = () => {
            if (isRecording) {
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:', e);
                    }
                }, 300);
            }
        };
        
        recognition.start();
    },
    stopRecording: () => {
        isRecording = false;
        if(recognition) recognition.stop();
        if (currentTranscript.length > 0) {
            const cleanText = AI.clean(currentTranscript);
            const structuredText = AI.structure(cleanText);
            const enhancedText = AI.addContextNotes(structuredText);
            
            const newNote = {
                id: Date.now(),
                date: new Date().toLocaleString('ru-RU'),
                title: '–ó–∞–º–µ—Ç–∫–∞ ' + new Date().toLocaleTimeString('ru-RU').slice(0,5),
                text: enhancedText
            };
            state.notes.unshift(newNote);
            updateHistory(0, false, true);
            currentTranscript = "";
            if(tg) tg.HapticFeedback.notificationOccurred('success');
            saveAll();
        }
        render();
    },
    openNote: (id) => {
        const note = state.notes.find(n => n.id === id);
        if (!note) return;
        editingNoteId = id;
        document.getElementById('modalTitle').innerText = note.title;
        document.getElementById('modalText').value = note.text;
        document.getElementById('noteModal').classList.add('open');
    },
    saveAndCloseNote: () => {
        const text = document.getElementById('modalText').value;
        const note = state.notes.find(n => n.id === editingNoteId);
        if (note) { 
            note.text = text; 
            saveAll(); 
        }
        actions.closeNote(); 
        render();
    },
    closeNote: () => { 
        document.getElementById('noteModal').classList.remove('open'); 
        editingNoteId = null; 
    },
    deleteNote: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?")) {
            state.notes = state.notes.filter(n => n.id !== id);
            saveAll(); 
            render();
        }
    },
    enhanceNote: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 5) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏');
            return;
        }
        f.value = "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏ —É–ª—É—á—à–∞—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É...";
        setTimeout(() => {
            try {
                f.value = AI.structure(AI.clean(original));
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞');
            }
        }, 600);
        if(tg) tg.HapticFeedback.impactOccurred('light');
    },
    addSummary: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 30) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–π –º—ã—Å–ª–∏ (–º–∏–Ω–∏–º—É–º 30 —Å–∏–º–≤–æ–ª–æ–≤)');
            return;
        }
        f.value = "‚è≥ –ò–∑–≤–ª–µ–∫–∞—é –≥–ª–∞–≤–Ω—É—é –º—ã—Å–ª—å...";
        setTimeout(() => {
            try {
                const summary = AI.extractSummary(original);
                f.value = summary + "\n\n" + "‚ïê".repeat(40) + "\n\n**–ü–û–õ–ù–´–ô –¢–ï–ö–°–¢:**\n\n" + original;
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞');
            }
        }, 700);
    },
    extractTasks: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 15) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–¥–∞—á');
            return;
        }
        f.value = "‚è≥ –ò—â—É –∑–∞–¥–∞—á–∏ –≤ —Ç–µ–∫—Å—Ç–µ...";
        setTimeout(() => {
            try {
                f.value = original + AI.findTasks(original);
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞–¥–∞—á');
            }
        }, 600);
    },
    fixGrammar: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 5) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
            return;
        }
        f.value = "‚è≥ –ò—Å–ø—Ä–∞–≤–ª—è—é –æ—à–∏–±–∫–∏...";
        setTimeout(() => {
            try {
                f.value = AI.fixGrammar(original);
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
            }
        }, 500);
        if(tg) tg.HapticFeedback.impactOccurred('light');
    },
    addNotes: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 20) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫');
            return;
        }
        f.value = "‚è≥ –î–æ–±–∞–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏...";
        setTimeout(() => {
            try {
                f.value = AI.addContextNotes(original);
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫');
            }
        }, 600);
    },
    simplifyText: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 20) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è');
            return;
        }
        f.value = "‚è≥ –£–ø—Ä–æ—â–∞—é —Ç–µ–∫—Å—Ç...";
        setTimeout(() => {
            try {
                f.value = AI.simplifyText(original);
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è');
            }
        }, 600);
    },
    expandText: () => {
        const f = document.getElementById('modalText');
        const original = f.value;
        if (!original || original.length < 15) {
            alert('–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
            return;
        }
        f.value = "‚è≥ –†–∞—Å—à–∏—Ä—è—é —Ç–µ–∫—Å—Ç...";
        setTimeout(() => {
            try {
                f.value = AI.expandText(original);
                if(tg) tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                f.value = original;
                alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
            }
        }, 600);
    },
    openProfile: () => { 
        state.activeTab = 'profile'; 
        saveAll();
        render(); 
    },
    copyReferral: () => {
        const refLink = `https://t.me/livi_app_bot?start=ref${userId}`;
        navigator.clipboard.writeText(refLink).then(() => {
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
            if(tg) tg.HapticFeedback.notificationOccurred('success');
        });
    },
    switchStatsTab: (tab) => {
        state.statsTab = tab;
        render();
    },
    clearLiviChat: () => {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π Livi?')) {
            state.liviChatHistory = [];
            saveAll();
            render();
        }
    }
};

function setupEventListeners() {
    const promiseLevelSelect = document.getElementById('taskPromiseLevelSelect');
    if (promiseLevelSelect) {
        promiseLevelSelect.addEventListener('change', function() {
            const warning = document.getElementById('promiseWarning');
            if (this.value) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        });
    }
}

function renderHeader() {
    const moodClass = getLiviMoodClass();
    const moodEmoji = moodClass === 'angry' ? 'üò†' : (moodClass === 'sad' ? 'üòî' : '');
    
    return `<div class="header">
        <div class="header-title">livi ${moodEmoji}</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:var(--gold)">${getIcon('star')} ${state.totalPoints}</div>
            <div class="stat-badge" style="color:#ff6b81">${getIcon('spark')} ${state.totalFire}</div>
            <div class="profile-btn" onclick="actions.openProfile()">
                <img src="${state.avatar || 'https://via.placeholder.com/40?text=üë§'}" alt="Profile">
            </div>
        </div>
    </div>`;
}

function renderLiviChat() {
    if (!state.liviChatHistory || state.liviChatHistory.length === 0) return '';
    
    const recentMessages = state.liviChatHistory.slice(0, 3);
    
    return `
    <div class="livi-chat-section scale-in">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
            <div style="font-size:14px; font-weight:800; color:var(--danger); display:flex; align-items:center; gap:8px">
                ${getIcon('message')}
                <span>–°–û–û–ë–©–ï–ù–ò–Ø LIVI</span>
            </div>
            <div onclick="actions.clearLiviChat()" style="font-size:10px; color:#666; cursor:pointer; padding:5px">–û—á–∏—Å—Ç–∏—Ç—å</div>
        </div>
        ${recentMessages.map(msg => {
            const msgClass = msg.type === 'angry' || msg.type === 'furious' ? '' : (msg.type === 'cold' ? 'cold' : 'warning');
            const time = new Date(msg.timestamp).toLocaleString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            return `
            <div class="livi-message ${msgClass}">
                <div class="livi-message-time">${time}</div>
                <div class="livi-message-text">${msg.text.replace(/\n/g, '<br>')}</div>
            </div>`;
        }).join('')}
        
        <div class="mood-indicator">
            <div class="mood-bar mood-trust">
                <div class="mood-bar-label">–î–æ–≤–µ—Ä–∏–µ</div>
                <div class="mood-bar-fill"><div class="mood-bar-value" style="width:${(state.liviMood.trust * 100)}%"></div></div>
            </div>
            <div class="mood-bar mood-patience">
                <div class="mood-bar-label">–¢–µ—Ä–ø–µ–Ω–∏–µ</div>
                <div class="mood-bar-fill"><div class="mood-bar-value" style="width:${(state.liviMood.patience * 100)}%"></div></div>
            </div>
            <div class="mood-bar mood-anger">
                <div class="mood-bar-label">–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ</div>
                <div class="mood-bar-fill"><div class="mood-bar-value" style="width:${(state.liviMood.anger * 100)}%"></div></div>
            </div>
        </div>
    </div>`;
}

function renderHome() {
    const done = state.tasks.filter(t => t.completed).length;
    const h = ITEMS.find(i => i.id === state.equipped.head);
    const f = ITEMS.find(i => i.id === state.equipped.face);
    const b = ITEMS.find(i => i.id === state.equipped.body);
    const s = ITEMS.find(i => i.id === state.equipped.special);

    const lastNote = state.notes.length > 0 ? state.notes[0].text : "";
    const insights = AI.getDetailedInsights(lastNote);

    const weekData = state.statsHistory.slice(-7);
    const weekTasksCompleted = weekData.reduce((sum, d) => sum + (d.tasks_completed || 0), 0);
    const weekPointsEarned = weekData.reduce((sum, d) => sum + (d.points || 0), 0);
    const weekNotesCreated = weekData.reduce((sum, d) => sum + (d.notes_created || 0), 0);

    const tasksProgress = Math.min(100, (weekTasksCompleted / state.weeklyGoals.tasks) * 100);
    const pointsProgress = Math.min(100, (weekPointsEarned / state.weeklyGoals.points) * 100);
    const notesProgress = Math.min(100, (weekNotesCreated / state.weeklyGoals.notes) * 100);

    const moodClass = getLiviMoodClass();

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="livi-container">
                <div class="livi-bg-glow ${moodClass}"></div>
                <div class="livi-body ${moodClass}">
                    ${h ? `<div class="${h.css}" style="${h.style || ''}"></div>` : ''}
                    <div class="livi-antenna ant-l ${moodClass}"></div>
                    <div class="livi-antenna ant-r ${moodClass}"></div>
                    <div class="livi-face">
                        <div class="eye eye-l ${moodClass}"></div>
                        <div class="eye eye-r ${moodClass}"></div>
                        ${f ? `<div class="${f.css}"><div class="g-lens"></div><div class="g-lens"></div><div class="g-bridge"></div></div>` : ''}
                        <div class="mouth ${moodClass}"></div>
                    </div>
                    ${s ? `<div class="${s.css}">${s.icon}</div>` : ''}
                </div>
                ${b ? `<div style="position:relative;width:0;height:0;top:-10px"><div class="${b.css}"></div></div>` : ''}
                <div style="margin-top:20px;font-weight:700; font-size: 18px">–ü—Ä–∏–≤–µ—Ç, ${state.nick}!</div>
                ${state.hasStreakInsurance ? '<div style="font-size:12px;color:var(--gold);margin-top:5px">üõ°Ô∏è –°—Ç—Ä–∏–∫ –∑–∞—â–∏—â—ë–Ω</div>' : ''}
            </div>

            ${renderLiviChat()}

            <div class="stats-grid scale-in">
                <div class="stat-card">
                    <div class="stat-value">${done}/${state.tasks.length}</div>
                    <div class="stat-label">–ó–∞–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${state.streak}</div>
                    <div class="stat-label">–°—Ç—Ä–∏–∫ –¥–Ω–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${state.totalTasksCompleted}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${state.notes.length}</div>
                    <div class="stat-label">–ó–∞–º–µ—Ç–æ–∫</div>
                </div>
            </div>

            <div class="section scale-in" style="animation-delay: 0.1s">
                <div class="section-header">
                    <span>üìä –ù–µ–¥–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏</span>
                    <span style="color:var(--accent); font-weight:700">${Math.round((tasksProgress + pointsProgress + notesProgress) / 3)}%</span>
                </div>
                <div style="margin-bottom:12px">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px">
                        <span>–ó–∞–¥–∞—á–∏: ${weekTasksCompleted}/${state.weeklyGoals.tasks}</span>
                        <span style="color:var(--accent)">${Math.round(tasksProgress)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${tasksProgress}%"></div>
                    </div>
                </div>
                <div style="margin-bottom:12px">
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px">
                        <span>–û—á–∫–∏: ${weekPointsEarned}/${state.weeklyGoals.points}</span>
                        <span style="color:var(--gold)">${Math.round(pointsProgress)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${pointsProgress}%; background:linear-gradient(90deg, var(--gold), #E5C08A)"></div>
                    </div>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px">
                        <span>–ó–∞–º–µ—Ç–∫–∏: ${weekNotesCreated}/${state.weeklyGoals.notes}</span>
                        <span style="color:var(--epic)">${Math.round(notesProgress)}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width:${notesProgress}%; background:linear-gradient(90deg, var(--epic), #E07A8F)"></div>
                    </div>
                </div>
            </div>

            <div class="section scale-in" style="padding-bottom: 10px; animation-delay: 0.2s">
                <div class="section-header">
                    <span>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
                    <span style="color:var(--accent)">14 –¥–Ω–µ–π</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="activityChartCanvas"></canvas>
                </div>
            </div>

            <div class="ai-insights scale-in" style="animation-delay: 0.3s">
                <div style="font-size:14px; font-weight:800; color:var(--accent); margin-bottom:15px; display:flex; align-items:center; gap:8px">
                    <span>ü§ñ</span>
                    <span>AI –ê–ù–ê–õ–ò–ó</span>
                </div>
                
                <div class="insight-item">
                    <div class="insight-icon">${insights.mood}</div>
                    <div style="flex:1">
                        <div class="insight-title">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div class="insight-text">${insights.summary}</div>
                    </div>
                </div>

                ${insights.topics.length > 0 ? `
                <div class="insight-item">
                    <div class="insight-icon">üè∑Ô∏è</div>
                    <div style="flex:1">
                        <div class="insight-title">–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã</div>
                        <div class="insight-text">${insights.topics.join(', ')}</div>
                    </div>
                </div>` : ''}

                <div class="insight-item">
                    <div class="insight-icon">üìÇ</div>
                    <div style="flex:1">
                        <div class="insight-title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div class="insight-text">${insights.category}</div>
                    </div>
                </div>

                ${insights.suggestions.length > 0 ? `
                <div class="insight-item" style="margin-bottom:0">
                    <div class="insight-icon">üí°</div>
                    <div style="flex:1">
                        <div class="insight-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                        <div class="insight-text">${insights.suggestions.join(' ‚Ä¢ ')}</div>
                    </div>
                </div>` : ''}
            </div>

            <div class="grid-2" style="margin-top:15px">
                 <div class="section scale-in" style="margin:0; animation-delay: 0.4s">
                    <div class="section-header">
                        <span style="font-size:11px">–¢–∏–ø—ã –∑–∞–¥–∞—á</span>
                    </div>
                    <div class="chart-wrapper-small">
                        <canvas id="taskDistributionChart"></canvas>
                    </div>
                 </div>
                 <div class="section scale-in" style="margin:0; animation-delay: 0.5s">
                    <div class="section-header">
                        <span style="font-size:11px">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</span>
                    </div>
                    <div class="chart-wrapper-small">
                        <canvas id="priorityChart"></canvas>
                    </div>
                 </div>
            </div>

        </div>
    </div>`;
}

function renderEducation() {
    const notesList = state.notes.map(n => `
        <div class="note-card" onclick="actions.openNote(${n.id})">
            <div class="note-date">
                <span>${n.date}</span>
                <span onclick="event.stopPropagation(); actions.deleteNote(${n.id})" style="color:#666; padding:5px">‚úï</span>
            </div>
            <div class="note-title">${n.title}</div>
            <div class="note-preview">${n.text.slice(0, 60)}...</div>
        </div>
    `).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800; text-align: center">–£–ú–ù–´–ô –ö–û–ù–°–ü–ï–ö–¢ 2.0</h2>
            <div class="section" style="text-align:center;">
                <div style="font-size:13px;color:#aaa;margin-bottom:15px; line-height: 1.4;">
                    –ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω. –Ø —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é –º—ã—Å–ª–∏,<br>–≤—ã–¥–µ–ª—é –≥–ª–∞–≤–Ω–æ–µ –∏ –Ω–∞–π–¥—É –∑–∞–¥–∞—á–∏.
                </div>
                <div style="background: #111; padding: 15px; border-radius: 12px; min-height: 80px; margin-bottom: 20px; text-align: left; font-size: 14px; color: #ccc; border: 1px solid #333; line-height:1.5" id="liveTranscript">
                    ${currentTranscript || (isRecording ? "–°–ª—É—à–∞—é..." : "–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...")}
                </div>
                <button class="mic-btn ${isRecording ? 'recording' : ''}" onclick="${isRecording ? 'actions.stopRecording()' : 'actions.startRecording()'}">
                    ${isRecording ? '<div class="voice-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>' : getIcon('mic')}
                </button>
            </div>
            <h3 style="margin:25px 0 10px;font-weight:700; padding-left: 5px; color:#666; font-size:12px; text-transform:uppercase; letter-spacing:0.5px">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (${state.notes.length})</h3>
            ${notesList || '<div style="text-align:center;color:#555;padding:30px; font-style: italic;">–ü—É—Å—Ç–æ<br><span style="font-size:12px">–ù–∞—á–Ω–∏ —Å –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏</span></div>'}
        </div>
    </div>`;
}

function renderTasks() {
    const list = state.tasks.map(t => {
        const deadlineStatus = getDeadlineStatus(t.deadline);
        const promiseBadge = t.promiseLevel ? `<span class="promise-badge promise-${t.promiseLevel}">${t.promiseLevel === 'soft' ? 'üü¢' : (t.promiseLevel === 'normal' ? 'üü°' : 'üî¥')} –û–±–µ—â–∞–Ω–∏–µ</span>` : '';
        
        return `
        <div class="section" style="padding:15px;margin-bottom:10px;opacity:${t.completed ? 0.6 : 1}; border-left: 4px solid ${t.priority === 'high' ? 'var(--danger)' : t.priority === 'med' ? 'var(--warning)' : 'var(--success)'}">
            <div style="display:flex;align-items:flex-start;">
                <div style="width:24px;height:24px;border:2px solid var(--primary);border-radius:8px;margin-right:12px;display:flex;align-items:center;justify-content:center;background:${t.completed ? 'var(--primary)' : 'transparent'}; transition:background 0.2s; flex-shrink:0; cursor:pointer; margin-top:2px" onclick="actions.toggleTask(${t.id})">
                    ${t.completed ? '<svg width="14" height="14" stroke="white" fill="none"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                </div>
                <div style="flex:1">
                    <div style="font-weight:600; font-size:15px; text-decoration:${t.completed ? 'line-through' : 'none'}; color:${t.completed?'#777':'#eee'}">${t.title}</div>

                    <div style="display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; align-items:center">
                        <span style="font-size:10px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; color:#aaa">${t.tag || '–û–±—â–µ–µ'}</span>
                        <span style="font-size:10px; color:#666; display:flex; align-items:center">
                            <span class="priority-dot p-${t.priority||'low'}"></span> ${t.points} pts
                        </span>
                        ${promiseBadge}
                        ${t.failedCount > 0 ? `<span style="font-size:10px; color:var(--danger)">‚ö†Ô∏è –°—Ä—ã–≤–æ–≤: ${t.failedCount}</span>` : ''}
                    </div>
                    
                    ${deadlineStatus ? `
                    <div class="deadline-indicator ${deadlineStatus.class}">
                        ${getIcon('clock')} ${deadlineStatus.text} ${t.deadline ? '‚Ä¢ ' + new Date(t.deadline).toLocaleString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : ''}
                    </div>` : ''}
                </div>
                <div onclick="actions.deleteTask(${t.id})" style="color:#444; padding:8px; margin-left:10px; cursor:pointer">${getIcon('trash')}</div>
            </div>
        </div>
    `}).join('');

    const challenge = state.dailyChallenge;
    const overdueCount = state.tasks.filter(t => !t.completed && t.deadline && new Date(t.deadline) < new Date()).length;
    
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800">–ó–ê–î–ê–ß–ò</h2>

            ${overdueCount > 0 ? `
            <div class="section" style="background:linear-gradient(135deg, rgba(255,71,87,0.1) 0%, rgba(0,0,0,0) 100%); border-color:rgba(255,71,87,0.3); margin-bottom:15px">
                <div style="display:flex; align-items:center; gap:10px">
                    <div style="font-size:24px">‚ö†Ô∏è</div>
                    <div>
                        <div style="font-weight:700; color:var(--danger)">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –∑–∞–¥–∞—á: ${overdueCount}</div>
                        <div style="font-size:12px; color:#888">Livi —Å–ª–µ–¥–∏—Ç –∑–∞ —Ç–≤–æ–∏–º–∏ –æ–±–µ—â–∞–Ω–∏—è–º–∏</div>
                    </div>
                </div>
            </div>` : ''}

            <div class="section challenge-card" onclick="actions.completeChallenge()" style="cursor:pointer">
                <div class="challenge-header">
                    <div style="color:var(--gold); font-weight:800; font-size:12px; letter-spacing:1px">–ß–ï–õ–õ–ï–ù–î–ñ –î–ù–Ø</div>
                    <div style="color:var(--gold); font-weight:bold">+${challenge.reward} pts</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px">
                    <div style="font-size:28px; filter: grayscale(${challenge.completed?1:0}); transition:filter .3s">üî•</div>
                    <div style="flex:1">
                        <div style="font-size:18px; font-weight:700; text-decoration: ${challenge.completed?'line-through':''}">${challenge.title}</div>
                        <div style="font-size:12px; color:#aaa; margin-top:4px">${challenge.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∑–∞–≤—Ç—Ä–∞' : '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å'}</div>
                    </div>
                    ${challenge.completed ? '<div style="background:var(--success); color:black; padding:6px 10px; border-radius:10px; font-weight:bold; font-size:12px">‚úì DONE</div>' : ''}
                </div>
            </div>

            <h3 style="margin:25px 0 10px;font-weight:700; padding-left: 5px; color:#666; font-size:12px; text-transform:uppercase; letter-spacing:0.5px">–ú–æ–∏ –∑–∞–¥–∞—á–∏ (${state.tasks.length})</h3>
            <div style="margin-top:15px">
                ${list || '<div style="text-align:center;color:#555;padding:40px; font-style: italic;">–ù–µ—Ç –∑–∞–¥–∞—á<br><span style="font-size:12px">–ù–∞–∂–º–∏ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å</span></div>'}
            </div>
        </div>
        <button class="add-btn" onclick="actions.addTask()">+</button>
    </div>`;
}

function renderShop() {
    const inv = state.inventory.map(id => {
        const i = ITEMS.find(x => x.id === id);
        const eq = Object.values(state.equipped).includes(id);
        const color = i.special ? '#FFA500' : (i.rarity === 'legendary' ? 'var(--epic)' : i.rarity === 'rare' ? 'var(--gold)' : 'var(--primary)');
        return `<div class="section" style="padding:15px 10px;margin:0;display:flex;flex-direction:column;align-items:center; border-color:${eq ? color : 'var(--glass-border)'}; box-shadow:${eq?'0 0 15px '+color+'40':'none'}; transition:all .3s; cursor:pointer" onclick="actions.equip('${id}')">
            <div style="font-size:42px;margin-bottom:10px; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5))">${i.icon}</div>
            <div style="font-size:11px;color:#aaa;text-align:center;font-weight:600">${i.name}</div>
            ${eq ? `<div style="width:6px;height:6px;background:${color};border-radius:50%;margin-top:8px;box-shadow:0 0 8px ${color}"></div>` : ''}
        </div>`;
    }).join('');
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div style="text-align:center;margin-bottom:25px">
                <div style="font-size:12px;color:#888; letter-spacing:1px; margin-bottom:5px; text-transform:uppercase">–ë–∞–ª–∞–Ω—Å</div>
                <div style="font-size:42px;font-weight:900;color:var(--gold); text-shadow: 0 0 20px rgba(212,175,122,0.3)">${state.totalPoints}</div>
                <div style="font-size:11px;color:#666; margin-top:5px">–æ—á–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ</div>
            </div>
            <div class="chest-wrapper">
                <div class="chest-card chest-common" onclick="actions.openChest('common', 150)">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-weight:800;font-size:18px;">–ë–∞–∑–æ–≤—ã–π —è—â–∏–∫</div>
                            <div style="font-size:12px;opacity:0.6;margin-top:5px">–û–±—ã—á–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
                        </div>
                        <div style="font-size:16px;color:#bbb;font-weight:700">150 pts</div>
                    </div>
                </div>
                <div class="chest-card chest-rare" onclick="actions.openChest('rare', 300)">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-weight:800;font-size:18px;color:var(--gold)">–†–µ–¥–∫–∏–π —è—â–∏–∫ ‚≠ê</div>
                            <div style="font-size:12px;opacity:0.7;margin-top:5px; color:var(--gold)">–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —à–∞–Ω—Å –ª–µ–≥–µ–Ω–¥–∞—Ä–∫–∏</div>
                        </div>
                        <div style="font-size:16px;color:var(--gold);font-weight:700">300 pts</div>
                    </div>
                </div>
            </div>
            <h3 style="margin:25px 0 15px;font-weight:700; padding-left: 5px; color:#666; font-size:12px; text-transform:uppercase; letter-spacing:0.5px">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (${state.inventory.length})</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px">
                ${inv || '<div style="grid-column:1/-1;text-align:center;color:#444;padding:40px; font-style:italic">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç<br><span style="font-size:12px">–û—Ç–∫—Ä–æ–π —è—â–∏–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</span></div>'}
            </div>
        </div>
    </div>`;
}

function renderProfile() {
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content" style="text-align:center">
            <h2 style="margin-bottom:30px;font-weight:800">–ü–†–û–§–ò–õ–¨</h2>
            <div class="profile-btn" style="width:100px;height:100px;margin:0 auto 20px; border-width:3px">
                <img src="${state.avatar || 'https://via.placeholder.com/100?text=üë§'}" alt="Avatar">
            </div>
            <div style="font-size:28px;font-weight:800;margin-bottom:5px">${state.nick}</div>
            <div style="font-size:14px;color:#888;margin-bottom:30px">–£—Ä–æ–≤–µ–Ω—å: ${Math.floor(state.totalPoints / 100)} ‚Ä¢ –ù–æ–≤–∏—á–æ–∫</div>

            <div class="stats-grid" style="margin-bottom:20px">
                <div class="stat-card">
                    <div class="stat-value" style="font-size:24px">${state.totalTasksCompleted}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="font-size:24px">${state.totalNotesCreated}</div>
                    <div class="stat-label">–ó–∞–º–µ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="font-size:24px">${state.inventory.length}</div>
                    <div class="stat-label">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="font-size:24px">${state.referralCount}</div>
                    <div class="stat-label">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
                </div>
            </div>

            <div class="section" style="margin-top:20px; text-align:left">
                <div style="font-weight:bold;margin-bottom:10px; color:var(--accent); font-size:16px">üéÅ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</div>
                <div style="font-size:13px; color:#999; margin-bottom:15px; line-height:1.5">–ü–æ–ª—É—á–∏ <b style="color:var(--gold)">500 –æ—á–∫–æ–≤</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—Å—è –ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ.</div>
                <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;margin:10px 0;font-family:monospace;font-size:11px;color:#fff;word-break:break-all;border:1px dashed #444">https://t.me/livi_app_bot?start=ref${userId}</div>
                <button class="btn btn-primary" onclick="actions.copyReferral()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            <div style="margin-top:20px; font-size:12px; color:#444">User ID: ${userId}</div>
        </div>
    </div>`;
}

function initCharts() {
    const ctxActivity = document.getElementById('activityChartCanvas');
    if (ctxActivity) {
        if (activityChart) activityChart.destroy();

        const labels = state.statsHistory.map(h => {
             const d = new Date(h.date);
             return `${d.getDate()}.${d.getMonth()+1}`;
        });
        const dataPoints = state.statsHistory.map(h => h.points || 0);

        activityChart = new Chart(ctxActivity, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '–û—á–∫–∏',
                    data: dataPoints,
                    borderColor: '#A8C4C6',
                    backgroundColor: (context) => {
                        const ctx = context.chart.ctx;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                        gradient.addColorStop(0, 'rgba(168, 196, 198, 0.3)');
                        gradient.addColorStop(1, 'rgba(168, 196, 198, 0)');
                        return gradient;
                    },
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#A8C4C6',
                    pointBorderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        padding: 12,
                        titleColor: '#A8C4C6',
                        bodyColor: '#fff',
                        borderColor: '#A8C4C6',
                        borderWidth: 1,
                        displayColors: false,
                        callbacks: {
                            title: (items) => {
                                const idx = items[0].dataIndex;
                                const date = state.statsHistory[idx].date;
                                return new Date(date).toLocaleDateString('ru-RU');
                            },
                            label: (item) => {
                                return `–û—á–∫–∏: ${item.parsed.y}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false, drawBorder: false }, 
                        ticks: { color: '#666', font:{size:11, weight: 'bold'} } 
                    },
                    y: { 
                        display: true,
                        grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                        ticks: { color: '#666', font:{size:10} }
                    }
                },
                animation: { duration: 1500, easing: 'easeOutQuart' }
            }
        });
    }

    const ctxTask = document.getElementById('taskDistributionChart');
    if (ctxTask) {
        if (taskChart) taskChart.destroy();

        const habitCount = state.tasks.filter(t => t.type === 'habit').length;
        const taskCount = state.tasks.filter(t => t.type === 'task').length;

        taskChart = new Chart(ctxTask, {
            type: 'doughnut',
            data: {
                labels: ['–ü—Ä–∏–≤—ã—á–∫–∏', '–ó–∞–¥–∞—á–∏'],
                datasets: [{
                    data: [habitCount, taskCount],
                    backgroundColor: ['#D4AF7A', '#8B9A9C'],
                    borderWidth: 0,
                    hoverOffset: 8,
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#999',
                            font: { size: 10 },
                            padding: 8,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        padding: 10,
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                },
                cutout: '65%',
                animation: { 
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000
                }
            }
        });
    }

    const ctxPriority = document.getElementById('priorityChart');
    if (ctxPriority) {
        if (priorityChart) priorityChart.destroy();

        const highCount = state.tasks.filter(t => t.priority === 'high').length;
        const medCount = state.tasks.filter(t => t.priority === 'med').length;
        const lowCount = state.tasks.filter(t => t.priority === 'low').length;

        priorityChart = new Chart(ctxPriority, {
            type: 'doughnut',
            data: {
                labels: ['–í—ã—Å–æ–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–ù–∏–∑–∫–∏–π'],
                datasets: [{
                    data: [highCount, medCount, lowCount],
                    backgroundColor: ['#ff4757', '#ffa502', '#2ed573'],
                    borderWidth: 0,
                    hoverOffset: 8,
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#999',
                            font: { size: 10 },
                            padding: 8,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        padding: 10,
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                },
                cutout: '65%',
                animation: { 
                    animateScale: true,
                    animateRotate: true,
                    duration: 1000
                }
            }
        });
    }
}

function render() {
    let html = '';
    if (state.activeTab === 'home') html = renderHome();
    else if (state.activeTab === 'tasks') html = renderTasks();
    else if (state.activeTab === 'education') html = renderEducation();
    else if (state.activeTab === 'shop') html = renderShop();
    else if (state.activeTab === 'profile') html = renderProfile();

    document.getElementById('app').innerHTML = html + `
    <div class="bottom-nav">
        <button class="nav-item ${state.activeTab==='home'?'active':''}" onclick="state.activeTab='home';saveAll();render()">${getIcon('home')}<span style="font-size:10px;margin-top:2px">–ì–ª–∞–≤–Ω–∞—è</span></button>
        <button class="nav-item ${state.activeTab==='tasks'?'active':''}" onclick="state.activeTab='tasks';saveAll();render()">${getIcon('check')}<span style="font-size:10px;margin-top:2px">–ó–∞–¥–∞—á–∏</span></button>
        <button class="nav-item ${state.activeTab==='education'?'active':''}" onclick="state.activeTab='education';saveAll();render()">${getIcon('book')}<span style="font-size:10px;margin-top:2px">–ö–æ–Ω—Å–ø–µ–∫—Ç</span></button>
        <button class="nav-item ${state.activeTab==='shop'?'active':''}" onclick="state.activeTab='shop';saveAll();render()">${getIcon('shop')}<span style="font-size:10px;margin-top:2px">–ú–∞–≥–∞–∑–∏–Ω</span></button>
    </div>`;

    if(state.activeTab === 'home') {
        setTimeout(initCharts, 100);
    }
    
    setTimeout(setupEventListeners, 100);
}

function startRoulette(type) {
    const modal = document.getElementById('rouletteModal');
    modal.classList.remove('hidden');
    const strip = document.getElementById('rouletteStrip');
    strip.innerHTML = ''; 
    strip.style.transition = 'none'; 
    strip.style.transform = 'translateX(0px)';

    let pool = type === 'common' ? ITEMS.filter(i => i.rarity !== 'legendary') : ITEMS;
    let winner = pool[Math.floor(Math.random() * pool.length)];
    if(type === 'rare' && Math.random() > 0.7) {
        const legendaries = ITEMS.filter(i => i.rarity === 'legendary');
        if (legendaries.length > 0) winner = legendaries[Math.floor(Math.random() * legendaries.length)];
    }

    for (let i = 0; i < 60; i++) {
        const item = i === 50 ? winner : pool[Math.floor(Math.random() * pool.length)];
        const el = document.createElement('div');
        el.className = `r-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:40px">${item.icon}</div><div style="font-size:10px;color:#888;margin-top:5px">${item.name}</div>`;
        strip.appendChild(el);
    }

    setTimeout(() => {
        const offset = (document.querySelector('.roulette-window').offsetWidth / 2) - 64;
        strip.style.transition = 'transform 6s cubic-bezier(0.1, 0.9, 0.2, 1)';
        strip.style.transform = `translateX(-${(50 * 128) - offset}px)`;
        setTimeout(() => {
            if(tg) tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winMessage').style.opacity = '1';
            if (!state.inventory.includes(winner.id)) { 
                state.inventory.push(winner.id); 
                saveAll(); 
            }
        }, 6200);
    }, 100);
}

function closeRoulette() { 
    document.getElementById('rouletteModal').classList.add('hidden'); 
    document.getElementById('winMessage').style.opacity = '0';
    render(); 
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM loaded, initializing app');
    initStars();
    await loadState();
    render();
    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('fade-out');
    }, 800);
});
</script>
</body>
</html>

