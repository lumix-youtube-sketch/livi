<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi - –≥—Ä—É–ø–ø–æ–≤–æ–π –æ–≥–æ–Ω—ë–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #A8C4C6;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #0F0F0F;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.08);
    --glass-highlight: rgba(255,255,255,0.15);
    --danger: #ff4757;
    --success: #2ed573;
    --warning: #ffa502;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#000;
    color:#e0e0e0;
    max-width:428px;
    margin:0 auto;
    overflow-x:hidden;
    -webkit-tap-highlight-color:transparent;
    padding-bottom:100px;
    min-height:100vh;
    position: relative;
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideInLeft{from{transform:translateX(-20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes twinkle {0%, 100% {opacity: 0.2; transform: scale(1);} 50% {opacity: 0.8; transform: scale(1.5);}}
@keyframes scaleIn {from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes shake {0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.slide-in-left{animation:slideInLeft .5s ease-out}
.scale-in{animation:scaleIn .3s ease-out}
.hidden{display:none!important}
.shake{animation:shake 0.3s ease-in-out}

.loading-screen{position:fixed;inset:0;background:#050505;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(15,15,15,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid var(--glass-border); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); transition:transform .2s}
.stat-badge:active{transform:scale(0.95)}
.profile-btn{width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid var(--primary);cursor:pointer;box-shadow:0 0 15px rgba(139,154,156,0.3);transition:transform .2s}
.profile-btn:active{transform:scale(0.95)}
.profile-btn img{width:100%;height:100%;object-fit:cover}

.livi-container{display:flex;flex-direction:column;align-items:center;padding:30px 0;position:relative; z-index: 5;}
.livi-bg-glow {position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 220px; background: radial-gradient(circle, rgba(139,154,156,0.15) 0%, rgba(0,0,0,0) 70%); z-index: 1; pointer-events: none;}
.livi-bg-glow.angry {background: radial-gradient(circle, rgba(255,71,87,0.2) 0%, rgba(0,0,0,0) 70%);}
.livi-bg-glow.sad {background: radial-gradient(circle, rgba(100,100,150,0.2) 0%, rgba(0,0,0,0) 70%);}
.livi-bg-glow.happy {background: radial-gradient(circle, rgba(46,213,115,0.2) 0%, rgba(0,0,0,0) 70%);}
.livi-body{
    width:120px;height:120px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #3a3a3a, #1a1a1a);
    border:2px solid rgba(139,154,156,0.5);
    position:relative;
    box-shadow:0 15px 40px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.8);
    animation:float 6s ease-in-out infinite;
    z-index:5;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.livi-body.angry{border-color:rgba(255,71,87,0.6);box-shadow:0 15px 40px rgba(255,71,87,0.2), inset 0 0 20px rgba(0,0,0,0.8)}
.livi-body.sad{border-color:rgba(100,100,150,0.6)}
.livi-body.happy{border-color:rgba(46,213,115,0.6);box-shadow:0 15px 40px rgba(46,213,115,0.2), inset 0 0 20px rgba(0,0,0,0.8)}
.livi-antenna{position:absolute;width:3px;height:30px;background:var(--primary);border-radius:4px;z-index:1; opacity: 0.8}
.livi-antenna::after{content:'';position:absolute;top:-6px;left:-2px;width:7px;height:7px;background:var(--accent);border-radius:50%;box-shadow:0 0 8px var(--primary)}
.livi-antenna.angry{background:var(--danger)}
.livi-antenna.angry::after{background:var(--danger);box-shadow:0 0 8px var(--danger)}
.livi-antenna.happy{background:var(--success)}
.livi-antenna.happy::after{background:var(--success);box-shadow:0 0 8px var(--success)}
.ant-l{top:-20px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-20px;right:25px;transform:rotate(20deg)}
.livi-face{position:absolute;inset:0;z-index:10}
.eye{position:absolute;top:45%;width:12px;height:16px;background:white;border-radius:50%;animation:blink 4s infinite; box-shadow: 0 0 10px rgba(255,255,255,0.5);transition:all 0.3s}
.eye.angry{background:#ff4757;height:10px;border-radius:2px;transform:rotate(-10deg)}
.eye.angry.eye-r{transform:rotate(10deg)}
.eye.sad{height:10px;background:#aaa}
.eye.happy{height:18px;border-radius:50% 50% 0 0}
.eye-l{left:32px} .eye-r{right:32px}
.mouth{position:absolute;bottom:32px;left:50%;transform:translateX(-50%);width:20px;height:10px;border-bottom:2px solid white;border-radius:0 0 15px 15px;transition:all 0.3s}
.mouth.angry{border-bottom:none;border-top:2px solid #ff4757;border-radius:15px 15px 0 0;height:8px}
.mouth.sad{border-bottom:2px solid #aaa;border-radius:0;height:2px;width:15px}
.mouth.happy{border-bottom:3px solid #2ed573;border-radius:0 0 20px 20px;width:30px;height:15px}

.content{padding:20px}
.section {
    background: linear-gradient(160deg, rgba(30,30,30,0.6) 0%, rgba(10,10,10,0.8) 100%);
    border: 1px solid var(--glass-border);
    border-top: 1px solid var(--glass-highlight);
    border-radius: 24px;
    padding: 20px;
    margin-bottom: 15px;
    backdrop-filter: blur(15px);
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
}
.section:active { transform: scale(0.99); }
.section::before {
    content: ''; position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0; mix-blend-mode: overlay;
}
.section > * { position: relative; z-index: 1; }

.section-header {
    font-size: 12px;
    color: #888;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:white; box-shadow: 0 4px 15px rgba(139,154,156,0.3)}
.btn-primary:active{transform:scale(0.97)}
.btn-danger{background:linear-gradient(135deg,#ff4757,#ff6b81);color:white}
.btn-success{background:linear-gradient(135deg,#2ed573,#7bed9f);color:white}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888}
.btn-small{padding:8px 12px;font-size:12px;border-radius:10px}

.add-btn {position: fixed;bottom: 90px;right: 20px;width: 60px;height: 60px;border-radius: 30px;background: linear-gradient(135deg, var(--primary), var(--accent));color: white;font-size: 32px;border: none;box-shadow: 0 4px 20px rgba(139,154,156,0.5);z-index: 80;display: flex;align-items: center;justify-content: center;cursor: pointer;transition: transform 0.2s;}
.add-btn:active {transform: scale(0.95);}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(10,10,10,0.95);backdrop-filter:blur(20px);border-top:1px solid #222;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;border:none;background:none;color:#555;transition:all .2s;cursor:pointer}
.nav-item.active{color:var(--primary)}
.nav-item.active svg {filter: drop-shadow(0 0 8px var(--primary));}
.nav-item:active{transform:scale(0.9)}

.modal {position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateY(100%);}
.modal.open {transform: translateY(0);}
.modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
.modal-title {font-weight: 800; font-size: 20px;}
.modal-close {padding: 10px; cursor: pointer; color: #666;}

.input {background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; color: #fff; font-size: 16px; width: 100%; margin-bottom: 15px; outline: none; font-family: inherit;}
.input:focus {border-color: var(--primary);}
.input::placeholder {color: #666;}

.group-card {
    background: linear-gradient(135deg, rgba(139,154,156,0.1) 0%, rgba(0,0,0,0.3) 100%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.3s;
}
.group-card:active {transform: scale(0.98);}
.group-card.c-tier {border-left: 4px solid var(--primary);}
.group-card.p-tier {border-left: 4px solid var(--gold); box-shadow: 0 0 20px rgba(212,175,122,0.1);}

.member-avatar {width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); overflow: hidden;}
.member-avatar img {width: 100%; height: 100%; object-fit: cover;}

.trust-bar {width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px;}
.trust-fill {height: 100%; transition: width 0.3s;}
.trust-high {background: linear-gradient(90deg, var(--success), #7bed9f);}
.trust-mid {background: linear-gradient(90deg, var(--warning), #ffa502);}
.trust-low {background: linear-gradient(90deg, var(--danger), #ff6b81);}

.particle-container {position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;}
.particle {position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; opacity: 0; animation: twinkle var(--duration) ease-in-out infinite; animation-delay: var(--delay);}

.ai-insights {
    background: linear-gradient(135deg, rgba(139,154,156,0.08) 0%, rgba(212,175,122,0.05) 100%);
    border: 1px solid rgba(139,154,156,0.2);
    border-radius: 20px;
    padding: 18px;
    margin-top: 15px;
}
.insight-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}
.insight-icon {font-size: 24px; flex-shrink: 0;}
.insight-text {flex: 1; font-size: 13px; line-height: 1.5; color: #ccc;}
.insight-title {font-weight: 700; color: var(--accent); margin-bottom: 4px; font-size: 14px;}

.task-item {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.task-checkbox {
    width: 24px;
    height: 24px;
    border: 2px solid var(--primary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.2s;
}
.task-checkbox.checked {background: var(--primary);}

.photo-grid {display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;}
.photo-item {aspect-ratio: 1; border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.05); cursor: pointer;}
.photo-item img {width: 100%; height: 100%; object-fit: cover;}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div class="particle-container" id="stars"></div>

<div id="app"></div>

<script>
let tg = null;
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.expand();
    tg.ready();
    tg.setHeaderColor('#000000');
    tg.setBackgroundColor('#000000');
    tg.enableClosingConfirmation();
}

const userId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'local_user_' + Math.random().toString(36).substr(2, 9);
const firstName = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.first_name || 'User') : '–î—Ä—É–≥';
const photoUrl = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.photo_url || '') : '';

const AVAILABLE_TASKS = [
    { id: 't1', name: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', icon: 'üí™', category: 'health' },
    { id: 't2', name: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', icon: 'üßò', category: 'health' },
    { id: 't3', name: '–ß—Ç–µ–Ω–∏–µ', icon: 'üìö', category: 'learning' },
    { id: 't4', name: '–ò–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞', icon: 'üó£Ô∏è', category: 'learning' },
    { id: 't5', name: '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', icon: 'üíª', category: 'work' },
    { id: 't6', name: '–†–∏—Å–æ–≤–∞–Ω–∏–µ', icon: 'üé®', category: 'creative' },
    { id: 't7', name: '–ú—É–∑—ã–∫–∞', icon: 'üéµ', category: 'creative' },
    { id: 't8', name: '–†–∞–Ω–Ω–∏–π –ø–æ–¥—ä—ë–º', icon: 'üåÖ', category: 'health' },
    { id: 't9', name: '–ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ', icon: 'ü•ó', category: 'health' },
    { id: 't10', name: '–ù–µ –∫—É—Ä–∏—Ç—å', icon: 'üö≠', category: 'health' },
    { id: 't11', name: '–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç', icon: '‚úçÔ∏è', category: 'work' },
    { id: 't12', name: '–ü—Ä–æ–≥—É–ª–∫–∞', icon: 'üö∂', category: 'health' }
];

const defaultState = {
    user: {
        id: userId,
        name: firstName,
        avatar: photoUrl,
        totalFire: 0,
        stars: 0
    },
    livi: {
        mood: 'neutral',
        trust: 1,
        streak: 1,
        fire: 0,
        lastVisit: new Date().toISOString().split('T')[0]
    },
    groups: [],
    ui: {
        tab: 'home',
        modal: null,
        modalData: {}
    },
    analytics: {
        history: []
    },
    ai: {
        lastRecommendations: [],
        insights: {}
    }
};

let state = JSON.parse(JSON.stringify(defaultState));
let charts = {};

const Storage = {
    save: async (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            if (tg && tg.CloudStorage) {
                await new Promise((resolve) => {
                    tg.CloudStorage.setItem(key, JSON.stringify(data), () => resolve());
                });
            }
        } catch (e) { 
            console.error("Save failed", e); 
        }
    },
    
    load: async (key) => {
        try {
            if (tg && tg.CloudStorage) {
                const cloudData = await new Promise((resolve) => {
                    tg.CloudStorage.getItem(key, (err, val) => {
                        resolve(val || null);
                    });
                });
                
                if (cloudData) {
                    const parsed = JSON.parse(cloudData);
                    localStorage.setItem(key, cloudData);
                    return parsed;
                }
            }
            
            const local = localStorage.getItem(key);
            return local ? JSON.parse(local) : null;
        } catch (e) { 
            console.error("Load failed:", e);
            return null; 
        }
    }
};

const AI = {
    analyzeMood: () => {
        const totalFire = state.user.totalFire;
        const trust = state.livi.trust;
        const streak = state.livi.streak;
        
        if (trust < 0.3 || streak < 3) return 'sad';
        if (trust > 0.8 && streak > 7 && totalFire > 100) return 'happy';
        if (trust < 0.5) return 'angry';
        return 'neutral';
    },
    
    getRecommendations: () => {
        const recommendations = [];
        const groups = state.groups;
        
        if (groups.length === 0) {
            recommendations.push({
                icon: 'üë•',
                title: '–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É',
                text: '–ù–∞—á–Ω–∏ —Å –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã C-tier. –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –Ω–∞—á–Ω–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–º–µ—Å—Ç–µ.'
            });
        }
        
        const activeGroups = groups.filter(g => {
            const lastActivity = g.history[g.history.length - 1];
            if (!lastActivity) return false;
            const daysSince = (Date.now() - new Date(lastActivity.date).getTime()) / (1000 * 60 * 60 * 24);
            return daysSince < 2;
        });
        
        if (activeGroups.length < groups.length) {
            recommendations.push({
                icon: '‚ö†Ô∏è',
                title: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã',
                text: `–£ —Ç–µ–±—è ${groups.length - activeGroups.length} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø. –í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.`
            });
        }
        
        const lowTrustGroups = groups.filter(g => {
            const members = g.members || [];
            return members.some(m => m.trust < 0.4);
        });
        
        if (lowTrustGroups.length > 0) {
            recommendations.push({
                icon: 'üîç',
                title: '–ù–∏–∑–∫–∏–π trust',
                text: '–í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –µ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Å –Ω–∏–∑–∫–∏–º trust. –ü—Ä–æ–≤–µ—Ä—å –∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑—É–π "–°–æ–º–Ω–µ–≤–∞—é—Å—å".'
            });
        }
        
        const publicGroups = groups.filter(g => g.tier === 'p');
        if (publicGroups.length === 0 && state.user.stars >= 75) {
            recommendations.push({
                icon: '‚≠ê',
                title: '–°–æ–∑–¥–∞–π –ø—É–±–ª–∏—á–Ω—É—é –≥—Ä—É–ø–ø—É',
                text: '–£ —Ç–µ–±—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è P-tier –≥—Ä—É–ø–ø—ã. –£—á–∞—Å—Ç–≤—É–π –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–π –¥—Ä—É–≥–∏—Ö!'
            });
        }
        
        if (state.livi.streak > 30) {
            recommendations.push({
                icon: 'üî•',
                title: '–ù–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–π —Å—Ç—Ä–∏–∫!',
                text: `${state.livi.streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥! –¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏. –ü—Ä–æ–¥–æ–ª–∂–∞–π –¥–µ—Ä–∂–∞—Ç—å –ø–ª–∞–Ω–∫—É.`
            });
        }
        
        return recommendations;
    },
    
    calculateGroupScore: (group) => {
        const fire = group.totalFire || 0;
        const trust = group.members.reduce((sum, m) => sum + m.trust, 0) / group.members.length;
        const age = (Date.now() - new Date(group.createdAt).getTime()) / (1000 * 60 * 60 * 24);
        return Math.round(fire * trust * Math.log10(Math.max(age, 1) + 1));
    },
    
    detectSuspicious: (group) => {
        const history = group.history || [];
        if (history.length < 3) return false;
        
        const recentCompletions = history.slice(-5);
        const times = recentCompletions
            .filter(h => h.completedAt)
            .map(h => new Date(h.completedAt).getHours());
        
        if (times.length >= 3) {
            const uniqueTimes = new Set(times);
            if (uniqueTimes.size === 1) return true;
        }
        
        return false;
    }
};

const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
    trophy: '<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"/>',
    user: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
    plus: '<line x1="12" y‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
    fire: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
    clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
    camera: '<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>',
    alert: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>'
};
const getIcon = (n) => `<svg viewBox="0 0 24 24">${icons[n]}</svg>`;

function initStars() {
    const container = document.getElementById('stars');
    const count = 50;
    for(let i=0; i<count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
        p.style.setProperty('--delay', (Math.random() * 5) + 's');
        p.style.opacity = Math.random() * 0.5 + 0.1;
        container.appendChild(p);
    }
}

async function loadState() {
    const savedState = await Storage.load(`livi_group_${userId}`);
    if (savedState) {
        state = { ...defaultState, ...savedState };
    }
    checkDailyReset();
}

async function saveState() {
    await Storage.save(`livi_group_${userId}`, state);
}

function checkDailyReset() {
    const today = new Date().toISOString().split('T')[0];
    if (state.livi.lastVisit !== today) {
        const hadActivity = state.groups.some(g => {
            const lastHistory = g.history[g.history.length - 1];
            if (!lastHistory) return false;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return lastHistory.date === yesterday.toISOString().split('T')[0];
        });
        
        if (hadActivity) {
            state.livi.streak++;
        } else {
            state.livi.streak = 1;
        }
        
        state.livi.lastVisit = today;
        saveState();
    }
}

function getLiviMoodClass() {
    const mood = AI.analyzeMood();
    state.livi.mood = mood;
    return mood;
}

const actions = {
    setTab: (tab) => {
        state.ui.tab = tab;
        render();
    },
    
    openModal: (modal, data = {}) => {
        state.ui.modal = modal;
        state.ui.modalData = data;
        render();
    },
    
    closeModal: () => {
        state.ui.modal = null;
        state.ui.modalData = {};
        render();
    },
    
    createGroup: () => {
        const name = document.getElementById('groupName')?.value.trim();
        const tier = document.getElementById('groupTier')?.value;
        const taskIds = Array.from(document.querySelectorAll('.task-select:checked')).map(cb => cb.value);
        
        if (!name || taskIds.length === 0) {
            if (tg) tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        if (tier === 'p' && state.user.stars < 75) {
            if (tg) tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–π –≥—Ä—É–ø–ø—ã');
            return;
        }
        
        if (tier === 'p') {
            state.user.stars -= 75;
            if (tg && tg.openInvoice) {
                tg.openInvoice(`https://t.me/$invoice?start=group_create_${Date.now()}`);
            }
        }
        
        const newGroup = {
            id: Date.now(),
            name,
            tier,
            createdAt: new Date().toISOString(),
            members: [{
                id: state.user.id,
                name: state.user.name,
                avatar: state.user.avatar,
                trust: 1,
                contribution: 0
            }],
            tasks: taskIds.map(id => ({
                taskId: id,
                frequency: 'daily'
            })),
            totalFire: 0,
            history: [],
            isPublic: tier === 'p'
        };
        
        state.groups.push(newGroup);
        saveState();
        actions.closeModal();
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    },
    
    openGroup: (groupId) => {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;
        actions.openModal('groupDetail', { group });
    },
    
    completeTask: (groupId, taskId) => {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;
        
        const today = new Date().toISOString().split('T')[0];
        const alreadyCompleted = group.history.some(h => 
            h.date === today && h.taskId === taskId && h.userId === state.user.id
        );
        
        if (alreadyCompleted) {
            if (tg) tg.showAlert('–£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è');
            return;
        }
        
        if (group.tier === 'p') {
            actions.openModal('photoCapture', { groupId, taskId });
        } else {
            actions.submitCompletion(groupId, taskId, null);
        }
    },
    
    submitCompletion: (groupId, taskId, photoUrl) => {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;
        
        const member = group.members.find(m => m.id === state.user.id);
        if (!member) return;
        
        const fireGain = Math.round(10 * member.trust);
        
        group.history.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            userId: state.user.id,
            taskId: taskId,
            completedAt: new Date().toISOString(),
            photo: photoUrl,
            fire: fireGain
        });
        
        group.totalFire += fireGain;
        state.user.totalFire += fireGain;
        state.livi.fire += fireGain;
        member.contribution += fireGain;
        
        if (photoUrl) {
            member.trust = Math.min(1, member.trust + 0.05);
        }
        
        saveState();
        actions.closeModal();
        if (tg) tg.HapticFeedback.notificationOccurred('success');
        render();
    },
    
    capturePhoto: (groupId, taskId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                actions.submitCompletion(groupId, taskId, event.target.result);
            };
            reader.readAsDataURL(file);
        };
        
        input.click();
    },
    
    doubtMember: (groupId, memberId) => {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;
        
        const member = group.members.find(m => m.id === memberId);
        if (!member) return;
        
        member.trust = Math.max(0, member.trust - 0.1);
        
        saveState();
        if (tg) tg.HapticFeedback.notificationOccurred('warning');
        render();
    },
    
    inviteMember: (groupId) => {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;
        
        const inviteLink = `https://t.me/livi_app_bot?start=join_${groupId}`;
        
        if (tg && tg.openTelegramLink) {
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –≥—Ä—É–ø–ø–µ "${group.name}" –≤ Livi!`)}`);
        } else {
            navigator.clipboard.writeText(inviteLink).then(() => {
                if (tg) tg.showAlert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            });
        }
    }
};

function renderHeader() {
    const moodClass = getLiviMoodClass();
    const moodEmoji = moodClass === 'angry' ? 'üò†' : (moodClass === 'sad' ? 'üòî' : moodClass === 'happy' ? 'üòä' : '');
    
    return `<div class="header">
        <div class="header-title">livi ${moodEmoji}</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:#ff6b81">${getIcon('fire')} ${state.livi.fire}</div>
            <div class="stat-badge" style="color:var(--gold)">${getIcon('star')} ${state.user.stars}</div>
            <div class="profile-btn" onclick="actions.setTab('profile')">
                <img src="${state.user.avatar || 'https://via.placeholder.com/40?text=üë§'}" alt="Profile">
            </div>
        </div>
    </div>`;
}

function renderHome() {
    const moodClass = getLiviMoodClass();
    const recommendations = AI.getRecommendations();
    
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="livi-container">
                <div class="livi-bg-glow ${moodClass}"></div>
                <div class="livi-body ${moodClass}">
                    <div class="livi-antenna ant-l ${moodClass}"></div>
                    <div class="livi-antenna ant-r ${moodClass}"></div>
                    <div class="livi-face">
                        <div class="eye eye-l ${moodClass}"></div>
                        <div class="eye eye-r ${moodClass}"></div>
                        <div class="mouth ${moodClass}"></div>
                    </div>
                </div>
                <div style="margin-top:20px;font-weight:700; font-size: 18px">–ü—Ä–∏–≤–µ—Ç, ${state.user.name}!</div>
                <div style="font-size:14px;color:#888;margin-top:5px">–°—Ç—Ä–∏–∫: ${state.livi.streak} –¥–Ω–µ–π üî•</div>
            </div>

            <div class="section scale-in">
                <div class="section-header">
                    <span>üìä –°–µ–≥–æ–¥–Ω—è</span>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                    <div style="text-align:center">
                        <div style="font-size:28px;font-weight:900;color:var(--accent)">${state.groups.length}</div>
                        <div style="font-size:11px;color:#888;margin-top:5px">–ì—Ä—É–ø–ø</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:28px;font-weight:900;color:var(--gold)">${state.user.totalFire}</div>
                        <div style="font-size:11px;color:#888;margin-top:5px">–û–≥–æ–Ω—ë–∫</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:28px;font-weight:900;color:#ff6b81">${state.livi.streak}</div>
                        <div style="font-size:11px;color:#888;margin-top:5px">–°—Ç—Ä–∏–∫</div>
                    </div>
                </div>
            </div>

            ${recommendations.length > 0 ? `
            <div class="ai-insights scale-in" style="animation-delay: 0.1s">
                <div style="font-size:14px; font-weight:800; color:var(--accent); margin-bottom:15px; display:flex; align-items:center; gap:8px">
                    <span>ü§ñ</span>
                    <span>AI –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò</span>
                </div>
                ${recommendations.map(rec => `
                <div class="insight-item">
                    <div class="insight-icon">${rec.icon}</div>
                    <div style="flex:1">
                        <div class="insight-title">${rec.title}</div>
                        <div class="insight-text">${rec.text}</div>
                    </div>
                </div>
                `).join('')}
            </div>
            ` : ''}

            ${state.groups.length > 0 ? `
            <h3 style="margin:25px 0 10px;font-weight:700; padding-left: 5px; color:#666; font-size:12px; text-transform:uppercase; letter-spacing:0.5px">–ú–æ–∏ –≥—Ä—É–ø–ø—ã (${state.groups.length})</h3>
            ${state.groups.map(group => {
                const lastActivity = group.history[group.history.length - 1];
                const daysSince = lastActivity ? Math.floor((Date.now() - new Date(lastActivity.date).getTime()) / (1000 * 60 * 60 * 24)) : 999;
                const isActive = daysSince < 2;
                
                return `
                <div class="group-card ${group.tier}-tier scale-in" onclick="actions.openGroup(${group.id})">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <div>
                            <div style="font-weight:800;font-size:16px">${group.name}</div>
                            <div style="font-size:11px;color:#888;margin-top:3px">${group.tier === 'p' ? '‚≠ê –ü—É–±–ª–∏—á–Ω–∞—è' : 'üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è'} ‚Ä¢ ${group.members.length} —á–µ–ª.</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:20px;font-weight:900;color:var(--gold)">${group.totalFire}</div>
                            <div style="font-size:10px;color:#666">–æ–≥–æ–Ω—å–∫–∞</div>
                        </div>
                    </div>
                    ${!isActive ? '<div style="color:var(--warning);font-size:11px;margin-top:8px">‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ 1 –¥–Ω—è</div>' : ''}
                </div>
                `;
            }).join('')}
            ` : `
            <div style="text-align:center;padding:60px 20px;color:#555">
                <div style="font-size:48px;margin-bottom:15px">üë•</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px">–ù–µ—Ç –≥—Ä—É–ø–ø</div>
                <div style="font-size:13px;line-height:1.5">–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É –∏ –Ω–∞—á–Ω–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–∑—å—è–º–∏</div>
            </div>
            `}
        </div>
        <button class="add-btn" onclick="actions.openModal('createGroup')">+</button>
    </div>`;
}

function renderTasks() {
    const today = new Date().toISOString().split('T')[0];
    
    const todayTasks = [];
    state.groups.forEach(group => {
        group.tasks.forEach(gt => {
            const task = AVAILABLE_TASKS.find(t => t.id === gt.taskId);
            if (!task) return;
            
            const completed = group.history.some(h => 
                h.date === today && h.taskId === gt.taskId && h.userId === state.user.id
            );
            
            todayTasks.push({
                groupId: group.id,
                groupName: group.name,
                task,
                completed
            });
        });
    });
    
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800">–ó–ê–î–ê–ß–ò –°–ï–ì–û–î–ù–Ø</h2>
            
            ${todayTasks.length > 0 ? `
            <div class="section">
                <div class="section-header">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span style="color:var(--accent);font-weight:700">${todayTasks.filter(t => t.completed).length}/${todayTasks.length}</span>
                </div>
                <div class="trust-bar">
                    <div class="trust-fill trust-high" style="width:${(todayTasks.filter(t => t.completed).length / todayTasks.length) * 100}%"></div>
                </div>
            </div>
            
            ${todayTasks.map(item => `
            <div class="task-item" onclick="actions.completeTask(${item.groupId}, '${item.task.id}')" style="opacity:${item.completed ? 0.6 : 1}">
                <div class="task-checkbox ${item.completed ? 'checked' : ''}">
                    ${item.completed ? '<svg width="14" height="14" stroke="white" fill="none"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                </div>
                <div style="flex:1">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                        <span style="font-size:20px">${item.task.icon}</span>
                        <span style="font-weight:600;font-size:15px">${item.task.name}</span>
                    </div>
                    <div style="font-size:11px;color:#888">${item.groupName}</div>
                </div>
            </div>
            `).join('')}
            ` : `
            <div style="text-align:center;padding:60px 20px;color:#555">
                <div style="font-size:48px;margin-bottom:15px">‚úÖ</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px">–ù–µ—Ç –∑–∞–¥–∞—á</div>
                <div style="font-size:13px;line-height:1.5">–°–æ–∑–¥–∞–π –≥—Ä—É–ø–ø—É –∏ –¥–æ–±–∞–≤—å –∑–∞–¥–∞—á–∏</div>
            </div>
            `}
        </div>
    </div>`;
}

function renderRanking() {
    const publicGroups = state.groups.filter(g => g.tier === 'p');
    const rankedGroups = publicGroups
        .map(g => ({ ...g, score: AI.calculateGroupScore(g) }))
        .sort((a, b) => b.score - a.score);
    
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800">–†–ï–ô–¢–ò–ù–ì</h2>
            
            <div class="section">
                <div style="text-align:center;padding:10px 0">
                    <div style="font-size:11px;color:#888;margin-bottom:5px">–ü—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø</div>
                    <div style="font-size:32px;font-weight:900;color:var(--gold)">${publicGroups.length}</div>
                </div>
            </div>
            
            ${rankedGroups.length > 0 ? rankedGroups.map((group, index) => `
            <div class="group-card p-tier" onclick="actions.openGroup(${group.id})">
                <div style="display:flex;gap:15px;align-items:center">
                    <div style="font-size:28px;font-weight:900;color:${index === 0 ? 'var(--gold)' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#666'};min-width:40px;text-align:center">
                        ${index + 1}
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:800;font-size:16px;margin-bottom:5px">${group.name}</div>
                        <div style="display:flex;gap:15px;font-size:11px;color:#888">
                            <span>üî• ${group.totalFire}</span>
                            <span>üë• ${group.members.length}</span>
                            <span>üìä ${group.score}</span>
                        </div>
                    </div>
                </div>
            </div>
            `).join('') : `
            <div style="text-align:center;padding:60px 20px;color:#555">
                <div style="font-size:48px;margin-bottom:15px">üèÜ</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
                <div style="font-size:13px;line-height:1.5">–°–æ–∑–¥–∞–π –ø—É–±–ª–∏—á–Ω—É—é –≥—Ä—É–ø–ø—É –∏ —É—á–∞—Å—Ç–≤—É–π –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!</div>
            </div>
            `}
        </div>
    </div>`;
}

function renderProfile() {
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content" style="text-align:center">
            <h2 style="margin-bottom:30px;font-weight:800">–ü–†–û–§–ò–õ–¨</h2>
            <div class="profile-btn" style="width:100px;height:100px;margin:0 auto 20px; border-width:3px">
                <img src="${state.user.avatar || 'https://via.placeholder.com/100?text=üë§'}" alt="Avatar">
            </div>
            <div style="font-size:28px;font-weight:800;margin-bottom:5px">${state.user.name}</div>
            <div style="font-size:14px;color:#888;margin-bottom:30px">Trust: ${(state.livi.trust * 100).toFixed(0)}%</div>

            <div class="section" style="text-align:left">
                <div class="section-header"><span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></div>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px">
                    <div>
                        <div style="font-size:24px;font-weight:900;color:var(--gold)">${state.user.totalFire}</div>
                        <div style="font-size:11px;color:#888;margin-top:3px">–í—Å–µ–≥–æ –æ–≥–æ–Ω—å–∫–∞</div>
                    </div>
                    <div>
                        <div style="font-size:24px;font-weight:900;color:var(--accent)">${state.groups.length}</div>
                        <div style="font-size:11px;color:#888;margin-top:3px">–ì—Ä—É–ø–ø</div>
                    </div>
                    <div>
                        <div style="font-size:24px;font-weight:900;color:#ff6b81">${state.livi.streak}</div>
                        <div style="font-size:11px;color:#888;margin-top:3px">–°—Ç—Ä–∏–∫ –¥–Ω–µ–π</div>
                    </div>
                    <div>
                        <div style="font-size:24px;font-weight:900;color:var(--success)">${state.user.stars}</div>
                        <div style="font-size:11px;color:#888;margin-top:3px">–ó–≤—ë–∑–¥</div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

function renderCreateGroupModal() {
    return `
    <div class="modal open">
        <div class="modal-header">
            <div class="modal-title" style="color:var(--accent)">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</div>
            <div class="modal-close" onclick="actions.closeModal()">‚úï</div>
        </div>
        
        <input type="text" id="groupName" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." maxlength="50">
        
        <div style="margin-bottom:15px">
            <label style="font-size:12px;color:#888;display:block;margin-bottom:8px">–¢–∏–ø –≥—Ä—É–ø–ø—ã</label>
            <select id="groupTier" class="input" style="margin-bottom:0">
                <option value="c">üîí C-tier (–ü—Ä–∏–≤–∞—Ç–Ω–∞—è, –±–µ–∑ —Ñ–æ—Ç–æ)</option>
                <option value="p">‚≠ê P-tier (–ü—É–±–ª–∏—á–Ω–∞—è, —Å —Ñ–æ—Ç–æ, 75 ‚≠ê)</option>
            </select>
        </div>
        
        <div style="margin-bottom:15px">
            <label style="font-size:12px;color:#888;display:block;margin-bottom:12px">–í—ã–±–µ—Ä–∏ –∑–∞–¥–∞—á–∏</label>
            <div style="max-height:300px;overflow-y:auto">
                ${AVAILABLE_TASKS.map(task => `
                <label style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:12px;margin-bottom:8px;cursor:pointer">
                    <input type="checkbox" class="task-select" value="${task.id}" style="width:20px;height:20px">
                    <span style="font-size:24px">${task.icon}</span>
                    <span style="flex:1;font-size:14px">${task.name}</span>
                </label>
                `).join('')}
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="actions.createGroup()" style="margin-top:auto">–°–û–ó–î–ê–¢–¨ –ì–†–£–ü–ü–£</button>
    </div>`;
}

function renderGroupDetailModal() {
    const group = state.ui.modalData.group;
    if (!group) return '';
    
    const today = new Date().toISOString().split('T')[0];
    const todayHistory = group.history.filter(h => h.date === today);
    
    const avgTrust = group.members.reduce((sum, m) => sum + m.trust, 0) / group.members.length;
    
    return `
    <div class="modal open">
        <div class="modal-header">
            <div class="modal-title" style="color:var(--gold)">${group.name}</div>
            <div class="modal-close" onclick="actions.closeModal()">‚úï</div>
        </div>
        
        <div class="section" style="margin-bottom:15px">
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--gold)">${group.totalFire}</div>
                    <div style="font-size:10px;color:#888;margin-top:3px">–û–≥–æ–Ω—ë–∫</div>
                </div>
                <div>
                    <div style="font-size:24px;font-weight:900;color:var(--accent)">${group.members.length}</div>
                    <div style="font-size:10px;color:#888;margin-top:3px">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
                <div>
                    <div style="font-size:24px;font-weight:900;color:${avgTrust > 0.7 ? 'var(--success)' : avgTrust > 0.4 ? 'var(--warning)' : 'var(--danger)'}">${(avgTrust * 100).toFixed(0)}%</div>
                    <div style="font-size:10px;color:#888;margin-top:3px">Trust</div>
                </div>
            </div>
        </div>
        
        <h3 style="font-size:12px;color:#888;text-transform:uppercase;margin-bottom:10px;letter-spacing:0.5px">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
        ${group.members.map(member => `
        <div style="background:rgba(255,255,255,0.02);border-radius:12px;padding:12px;margin-bottom:10px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <div class="member-avatar">
                    <img src="${member.avatar || 'https://via.placeholder.com/40?text=üë§'}" alt="${member.name}">
                </div>
                <div style="flex:1">
                    <div style="font-weight:700;font-size:14px">${member.name}</div>
<div style="font-size:11px;color:#888">–í–∫–ª–∞–¥: ${member.contribution} üî•</div>
                </div>
                ${member.id !== state.user.id ? `
                <button class="btn-small btn-danger" onclick="actions.doubtMember(${group.id}, '${member.id}')" style="padding:6px 10px">
                    ${getIcon('alert')}
                </button>
                ` : ''}
            </div>
            <div class="trust-bar">
                <div class="trust-fill ${member.trust > 0.7 ? 'trust-high' : member.trust > 0.4 ? 'trust-mid' : 'trust-low'}" style="width:${member.trust * 100}%"></div>
            </div>
        </div>
        `).join('')}
        
        <h3 style="font-size:12px;color:#888;text-transform:uppercase;margin:20px 0 10px;letter-spacing:0.5px">–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        ${group.tasks.map(gt => {
            const task = AVAILABLE_TASKS.find(t => t.id === gt.taskId);
            if (!task) return '';
            
            const completed = todayHistory.some(h => h.taskId === gt.taskId && h.userId === state.user.id);
            
            return `
            <div class="task-item" onclick="actions.completeTask(${group.id}, '${task.id}')" style="opacity:${completed ? 0.6 : 1}">
                <div class="task-checkbox ${completed ? 'checked' : ''}">
                    ${completed ? '<svg width="14" height="14" stroke="white" fill="none"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                </div>
                <div style="flex:1">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="font-size:20px">${task.icon}</span>
                        <span style="font-weight:600;font-size:15px">${task.name}</span>
                    </div>
                </div>
            </div>
            `;
        }).join('')}
        
        ${group.tier === 'p' && todayHistory.length > 0 ? `
        <h3 style="font-size:12px;color:#888;text-transform:uppercase;margin:20px 0 10px;letter-spacing:0.5px">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Ñ–æ—Ç–æ</h3>
        <div class="photo-grid">
            ${todayHistory.filter(h => h.photo).map(h => `
            <div class="photo-item">
                <img src="${h.photo}" alt="completion">
            </div>
            `).join('')}
        </div>
        ` : ''}
        
        <button class="btn btn-ghost" onclick="actions.inviteMember(${group.id})" style="margin-top:20px">
            ${getIcon('users')} –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞
        </button>
    </div>`;
}

function renderPhotoCaptureModal() {
    const { groupId, taskId } = state.ui.modalData;
    
    return `
    <div class="modal open">
        <div class="modal-header">
            <div class="modal-title" style="color:var(--gold)">–°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ</div>
            <div class="modal-close" onclick="actions.closeModal()">‚úï</div>
        </div>
        
        <div style="text-align:center;padding:40px 20px">
            <div style="font-size:64px;margin-bottom:20px">${getIcon('camera')}</div>
            <div style="font-size:16px;font-weight:700;margin-bottom:10px;color:#fff">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
            <div style="font-size:13px;color:#888;line-height:1.5;margin-bottom:30px">
                –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ñ–æ—Ç–æ-–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
            </div>
            <button class="btn btn-primary" onclick="actions.capturePhoto(${groupId}, '${taskId}')">
                ${getIcon('camera')} –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
            </button>
        </div>
    </div>`;
}

function render() {
    let html = '';
    
    if (state.ui.tab === 'home') html = renderHome();
    else if (state.ui.tab === 'tasks') html = renderTasks();
    else if (state.ui.tab === 'ranking') html = renderRanking();
    else if (state.ui.tab === 'profile') html = renderProfile();
    
    if (state.ui.modal === 'createGroup') html += renderCreateGroupModal();
    else if (state.ui.modal === 'groupDetail') html += renderGroupDetailModal();
    else if (state.ui.modal === 'photoCapture') html += renderPhotoCaptureModal();
    
    html += `
    <div class="bottom-nav">
        <button class="nav-item ${state.ui.tab==='home'?'active':''}" onclick="actions.setTab('home')">
            ${getIcon('home')}
            <span style="font-size:10px;margin-top:2px">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item ${state.ui.tab==='tasks'?'active':''}" onclick="actions.setTab('tasks')">
            ${getIcon('check')}
            <span style="font-size:10px;margin-top:2px">–ó–∞–¥–∞—á–∏</span>
        </button>
        <button class="nav-item ${state.ui.tab==='ranking'?'active':''}" onclick="actions.setTab('ranking')">
            ${getIcon('trophy')}
            <span style="font-size:10px;margin-top:2px">–†–µ–π—Ç–∏–Ω–≥</span>
        </button>
        <button class="nav-item ${state.ui.tab==='profile'?'active':''}" onclick="actions.setTab('profile')">
            ${getIcon('user')}
            <span style="font-size:10px;margin-top:2px">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </div>`;
    
    document.getElementById('app').innerHTML = html;
    
    if (state.ui.tab === 'home' && document.getElementById('activityChart')) {
        initCharts();
    }
}

function initCharts() {
    const ctx = document.getElementById('activityChart');
    if (!ctx) return;
    
    if (charts.activity) charts.activity.destroy();
    
    const last7Days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        
        const dayFire = state.groups.reduce((sum, group) => {
            const dayHistory = group.history.filter(h => h.date === dateStr);
            return sum + dayHistory.reduce((s, h) => s + (h.fire || 0), 0);
        }, 0);
        
        last7Days.push({
            date: `${d.getDate()}.${d.getMonth() + 1}`,
            fire: dayFire
        });
    }
    
    charts.activity = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days.map(d => d.date),
            datasets: [{
                label: '–û–≥–æ–Ω—ë–∫',
                data: last7Days.map(d => d.fire),
                borderColor: '#ff6b81',
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                    gradient.addColorStop(0, 'rgba(255, 107, 129, 0.3)');
                    gradient.addColorStop(1, 'rgba(255, 107, 129, 0)');
                    return gradient;
                },
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#ff6b81',
                pointBorderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    padding: 12,
                    titleColor: '#ff6b81',
                    bodyColor: '#fff',
                    borderColor: '#ff6b81',
                    borderWidth: 1,
                    displayColors: false
                }
            },
            scales: {
                x: { 
                    grid: { display: false, drawBorder: false }, 
                    ticks: { color: '#666', font:{size:11, weight: 'bold'} } 
                },
                y: { 
                    display: true,
                    grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false },
                    ticks: { color: '#666', font:{size:10} }
                }
            },
            animation: { duration: 1500, easing: 'easeOutQuart' }
        }
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('App initializing...');
    initStars();
    await loadState();
    
    const startParam = tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param;
    if (startParam && startParam.startsWith('join_')) {
        const groupId = parseInt(startParam.replace('join_', ''));
        const group = state.groups.find(g => g.id === groupId);
        
        if (group && !group.members.find(m => m.id === state.user.id)) {
            group.members.push({
                id: state.user.id,
                name: state.user.name,
                avatar: state.user.avatar,
                trust: 0.5,
                contribution: 0
            });
            
            await saveState();
            
            if (tg) {
                tg.showAlert(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø—É "${group.name}"!`);
                tg.HapticFeedback.notificationOccurred('success');
            }
        }
    }
    
    render();
    
    setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('fade-out');
    }, 800);
});

setInterval(() => {
    checkDailyReset();
}, 60000);
</script>
</body>
</html>
