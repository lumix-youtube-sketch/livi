<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>livi ‚Äî –æ–≥–æ–Ω—å–∫–∏ (MVP)</title>

<!-- Telegram Web App -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================= ROOT VARIABLES ================= */
:root{
  --primary: #8B9A9C;
  --accent:  #A8C4C6;
  --gold:    #D4AF7A;
  --epic:    #D45D79;
  --bg:      #0B0B0B;
  --glass:   rgba(255,255,255,0.03);
  --glass-border: rgba(255,255,255,0.06);
  --glass-highlight: rgba(255,255,255,0.12);
  --danger:  #ff4757;
  --success: #2ed573;
  --warning: #ffa502;
  --muted:   #888;
}

/* ================= RESET ================= */
*{ box-sizing: border-box; margin:0; padding:0; }
html,body,#app{ height:100%; }
body{
  font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  background: linear-gradient(135deg, #040404 0%, #0b0b0b 100%);
  color: #e6e6e6;
  max-width: 428px;
  margin: 0 auto;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-x: hidden;
  padding-bottom: 120px;
}

/* ================= ANIMATIONS ================= */
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
@keyframes slideUp{ from{transform:translateY(18px);opacity:0} to{transform:none;opacity:1} }
@keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
@keyframes blink{ 0%,90%,100%{transform:scaleY(1)} 95%{transform:scaleY(0.12)} }
@keyframes fireFlicker {
  0%,100%{ transform:scale(1) }
  25%{ transform:scale(1.05) translateY(-2px) }
  50%{ transform:scale(0.95) translateY(1px) }
  75%{ transform:scale(1.02) translateY(-1px) }
}

/* ================= LAYOUT ================= */
.loading-screen{
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background: #030303; z-index:9999; transition: opacity .4s ease;
}
.loading-screen.hide{ opacity:0; pointer-events:none; }

.header{
  padding: 18px 16px;
  display:flex; align-items:center; justify-content:space-between;
  background: rgba(12,12,12,0.6);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--glass-border);
  position: sticky; top:0; z-index:60;
}
.header-title{
  font-size: 26px; font-weight:800;
  background: linear-gradient(135deg,var(--primary), var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.header-stats{ display:flex; gap:10px; align-items:center; }

.stat-badge{
  display:flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:20px; font-weight:700; font-size:13px;
  background: var(--glass); border: 1px solid var(--glass-border);
}
.profile-btn{ width:40px; height:40px; border-radius:50%; overflow:hidden; border:2px solid var(--primary); cursor:pointer; }

/* ================= LIVI ================= */
.livi-container{ display:flex; flex-direction:column; align-items:center; padding:28px 20px 12px; position:relative; z-index:5; }
.livi-bg-glow{ position:absolute; top:48px; left:50%; transform:translateX(-50%); width:240px; height:240px; background: radial-gradient(circle, rgba(168,196,198,0.06) 0%, rgba(0,0,0,0) 70%); z-index:1; pointer-events:none; border-radius:50%; }
.livi-body{
  width:128px; height:128px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #3a3a3a, #131313);
  border:2px solid rgba(139,154,156,0.4); position:relative; box-shadow:0 12px 40px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.6);
  animation: float 5.5s ease-in-out infinite; z-index:5; transition: box-shadow .25s, border-color .25s;
}
.livi-body.angry{ border-color: rgba(255,71,87,0.8); box-shadow:0 12px 40px rgba(255,71,87,0.06); }
.livi-antenna{ position:absolute; width:3px; height:30px; background:var(--primary); border-radius:6px; top:-18px; left: calc(50% - 1.5px); }
.livi-face{ position:absolute; inset:0; display:block; }
.eye{ position:absolute; top:44%; width:12px; height:16px; background:white; border-radius:50%; animation:blink 4s infinite; box-shadow:0 0 8px rgba(255,255,255,0.1); }
.eye-l{ left:34px } .eye-r{ right:34px }
.mouth{ position:absolute; bottom:32px; left:50%; transform:translateX(-50%); width:22px; height:10px; border-bottom:2px solid #fff; border-radius:0 0 12px 12px; transition:all .2s }

/* ================= CONTENT BLOCKS ================= */
.content{ padding: 18px; }
.section{
  background: linear-gradient(180deg, rgba(25,25,25,0.48), rgba(10,10,10,0.6));
  border-radius: 18px; padding:14px; margin-bottom:14px; border:1px solid var(--glass-border);
  backdrop-filter: blur(8px);
}
.section-header{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; }

/* ================= FIRE ICON ================= */
.fire-icon{ width:84px; height:94px; position:relative; cursor:pointer; display:inline-block; }
.flame{ position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:60px; height:78px; background: linear-gradient(to top, #ff6b00, #ff4500, #ffa500); border-radius: 50% 50% 48% 48% / 60% 60% 40% 40%; animation: fireFlicker 1.4s ease-in-out infinite; filter: drop-shadow(0 0 18px rgba(255,107,0,0.6)); }
.flame::before{ content:""; position:absolute; top:18%; left:50%; transform:translateX(-50%); width:34px; height:46px; background: linear-gradient(to top,#fff8b0,#ffd66b); border-radius:50%; animation: fireFlicker .9s ease-in-out infinite reverse }

/* ================= GROUP CARDS / TASK PRESETS ================= */
.group-card{ padding:12px; border-radius:14px; background: linear-gradient(135deg, rgba(255,107,0,0.04), rgba(0,0,0,0.22)); border:1px solid rgba(255,107,0,0.08); margin-bottom:12px; cursor:pointer; }
.task-preset{ padding:12px; border-radius:12px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); margin-bottom:10px; display:flex; gap:12px; align-items:center; cursor:pointer; }

/* ================= MODALS ================= */
.modal{ position:fixed; inset:0; background: rgba(0,0,0,0.95); z-index:3000; display:flex; flex-direction:column; padding:22px; transform: translateY(100%); transition: transform .28s cubic-bezier(.2,.9,.3,1); overflow-y:auto; }
.modal.open{ transform: translateY(0%); }

/* ================= BOTTOM NAV ================= */
.bottom-nav{
  position:fixed; bottom:0; left:0; right:0; max-width:428px; margin:0 auto; display:flex; justify-content:space-around; gap:6px;
  padding:12px 14px calc(12px + env(safe-area-inset-bottom)); background: rgba(10,10,10,0.96); border-top:1px solid rgba(255,255,255,0.03); z-index:100;
}
.nav-item{ flex:1; display:flex; flex-direction:column; align-items:center; gap:6px; color:#6d6d6d; font-size:12px; cursor:pointer; }
.nav-item.active{ color: var(--primary); }

/* ================= UTILS ================= */
.photo-upload{ width:100%; height:180px; border-radius:12px; border:2px dashed rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; background: rgba(255,255,255,0.01); }
.photo-preview img{ width:100%; height:100%; object-fit:cover; border-radius:12px; }

.small{ font-size:12px; color:var(--muted); }
.btn{ padding:12px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:700; }
.btn-primary{ background: linear-gradient(135deg,var(--primary),var(--accent)); color:#fff; box-shadow: 0 6px 18px rgba(139,154,156,0.12); }
.btn-ghost{ background: transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }

/* responsive tweaks */
@media (max-width:420px){
  .livi-body{ width:110px; height:110px; }
  .livi-bg-glow{ width:180px; height:180px; top:44px; }
}
</style>
</head>

<body>
  <!-- LOADING -->
  <div class="loading-screen" id="loadingScreen">
    <div style="font-weight:900; font-size:56px; background:linear-gradient(135deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">livi</div>
  </div>

  <!-- MAIN APP WRAPPER -->
  <div id="app"></div>

<script>
/* =================================================
   TELEGRAM WEBAPP INIT (ROBUST)
   - –µ—Å–ª–∏ WebApp –µ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º, –∏–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
   - tg.initDataUnsafe –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ id/first_name/photo_url
=================================================*/
const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
if (tg){
  try{
    tg.ready();
    tg.expand(); // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–∞–∑—É —Ä–∞—Å–∫—Ä—ã—Ç—å
    tg.setHeaderColor('#000000');
    tg.setBackgroundColor('#000000');
    tg.enableClosingConfirmation();
  }catch(e){
    console.warn('tg init failed', e);
  }
}

/* =================================================
   USER CONTEXT ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º tg.initDataUnsafe –±–µ–∑–æ–ø–∞—Å–Ω–æ
=================================================*/
const USER = {
  id: tg?.initDataUnsafe?.user?.id ?? ('local_' + Date.now() + '_' + Math.random().toString(36).slice(2,8)),
  name: tg?.initDataUnsafe?.user?.first_name ?? '–î—Ä—É–≥',
  avatar: tg?.initDataUnsafe?.user?.photo_url ?? ''
};

/* =================================================
   HELPERS
=================================================*/
const isoToday = () => new Date().toISOString().slice(0,10);
const uid = () => (Math.random().toString(36).slice(2) + Date.now().toString(36));
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

/* =================================================
   TASK PRESETS (—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ)
=================================================*/
const TASK_PRESETS = [
  { id:'morning', name:'–£—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–¥—ä—ë–º', icon:'üåÖ', tier:'c', points:1, description:'–í—Å—Ç–∞—Ç—å –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏ –ø–æ–º–µ—Ç–∏—Ç—å' },
  { id:'run', name:'–ü—Ä–æ–±–µ–∂–∫–∞', icon:'üèÉ', tier:'b', points:3, description:'–ö–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–±–µ–∂–∫–∞ –∏–ª–∏ —É—Å–∫–æ—Ä–µ–Ω–Ω–∞—è —Ö–æ–¥—å–±–∞' },
  { id:'workout', name:'–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', icon:'üí™', tier:'b', points:3, description:'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: 20+ –º–∏–Ω—É—Ç' },
  { id:'study', name:'–£—á—ë–±–∞', icon:'üìö', tier:'a', points:5, description:'–§–æ–∫—É—Å 45+ –º–∏–Ω—É—Ç –Ω–∞ –∑–∞–¥–∞—á–µ' },
  { id:'reading', name:'–ß—Ç–µ–Ω–∏–µ', icon:'üìñ', tier:'c', points:1, description:'–ü—Ä–æ—á–∏—Ç–∞—Ç—å 15+ –º–∏–Ω—É—Ç' },
  { id:'project', name:'–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º', icon:'üíº', tier:'a', points:5, description:'–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è' },
  { id:'meditation', name:'–ú–µ–¥–∏—Ç–∞—Ü–∏—è', icon:'üßò', tier:'c', points:1, description:'10+ –º–∏–Ω—É—Ç –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏–ª–∏ –¥—ã—Ö–∞–Ω–∏—è' }
];

/* =================================================
   STORAGE: localStorage + Telegram Cloud (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
   - –∫–ª—é—á "livi_state_v1"
   - –≤—Å–µ–≥–¥–∞ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –≤ JSON, handle errors gracefully
=================================================*/
const Storage = {
  key: 'livi_state_v1',
  async save(state){
    try{
      const raw = JSON.stringify(state);
      localStorage.setItem(this.key, raw);
      if (tg?.CloudStorage && typeof tg.CloudStorage.setItem === 'function'){
        await new Promise(resolve => tg.CloudStorage.setItem(this.key, raw, ()=>resolve()));
      }
    }catch(e){ console.error('Save error', e); }
  },
  async load(){
    try{
      if (tg?.CloudStorage && typeof tg.CloudStorage.getItem === 'function'){
        const cloud = await new Promise(resolve => tg.CloudStorage.getItem(this.key, (err, val) => resolve(val || null)));
        if (cloud){
          localStorage.setItem(this.key, cloud);
          return JSON.parse(cloud);
        }
      }
      const local = localStorage.getItem(this.key);
      return local ? JSON.parse(local) : null;
    }catch(e){
      console.warn('Load error', e);
      return null;
    }
  }
};

/* =================================================
   DEFAULT STATE (—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å)
=================================================*/
const DEFAULT_STATE = {
  meta: { version:1, createdAt: new Date().toISOString(), lastOpen: new Date().toISOString() },

  user: {
    id: USER.id,
    name: USER.name,
    avatar: USER.avatar
  },

  ui: {
    tab: 'home', // home, tasks, ranking, profile
    modals: { createGroup:false, fireDetail:false, completeTask:false },
    viewportWidth: Math.min(window.innerWidth, 428)
  },

  livi: {
    totalPoints: 0,
    totalFire: 0,
    streak: 0,
    mood: { anger: 0.05, trust: 1.0, patience: 1.0 }
  },

  groups: [
    /* –ø—Ä–∏–º–µ—Ä
    {
      id: 'g_123',
      name: '–£—Ç—Ä–µ–Ω–Ω—è—è –≥—Ä—É–ø–ø–∞',
      tier: 'c' | 'p',
      isPublic: false,
      isPaid: false,
      tasks: ['morning', 'reading'],
      members: [ { userId, nick, avatar, contributionPoints, doubtCount } ],
      fire: 10,
      dailyActivity: [ { date:'2025-12-31', completions:[ { userId, taskId, timestamp, photo, doubts:[] } ] } ],
      createdAt: ISO
    }
    */
  ],

  activityLog: { /* date -> { groupId -> {completions:[], stats: {}} } */ }
};

/* in-memory state */
let state = structuredClone(DEFAULT_STATE);

/* =================================================
   LOAD / SAVE STATE ON BOOT
=================================================*/
async function loadState(){
  const s = await Storage.load();
  if (s && s.meta?.version === DEFAULT_STATE.meta.version){
    // merge carefully to keep new fields
    state = deepMerge(structuredClone(DEFAULT_STATE), s);
  } else {
    state = structuredClone(DEFAULT_STATE);
  }
  state.meta.lastOpen = new Date().toISOString();
  await Storage.save(state);
}

async function saveState(){
  state.meta.lastOpen = new Date().toISOString();
  await Storage.save(state);
}

/* =================================================
   DEEP MERGE (keeps default fields if missing)
=================================================*/
function deepMerge(defaults, incoming){
  for (const k in incoming){
    if (incoming[k] === null || typeof incoming[k] !== 'object' || Array.isArray(incoming[k])){
      defaults[k] = incoming[k];
    } else {
      if (!defaults[k]) defaults[k] = {};
      defaults[k] = deepMerge(defaults[k], incoming[k]);
    }
  }
  return defaults;
}

/* =================================================
   CORE LOGIC FUNCTIONS (–æ–≥–æ–Ω—ë–∫, trust, points)
   –ü—Ä–∏–≤–µ–¥–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ, —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ —Ñ–æ—Ä–º—É–ª—ã
=================================================*/

/**
 * calculateFirePoints(group)
 * - —É—á–∏—Ç—ã–≤–∞–µ—Ç: —á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Å–∫–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–∏–≤—à–∏—Ö —Å–µ–≥–æ–¥–Ω—è,
 *   —à—Ç—Ä–∞—Ñ –∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –±–æ–Ω—É—Å –∑–∞ 100% completion
 */
function calculateFirePoints(group){
  const today = isoToday();
  const todayActivity = (group.dailyActivity || []).find(a => a.date === today);
  const totalMembers = (group.members || []).length || 1;
  const active = todayActivity ? (todayActivity.completions?.length || 0) : 0;

  // –±–∞–∑–æ–≤—ã–π –æ–≥–æ–Ω—ë–∫
  const base = group.fire ?? 10;

  // –ø—Ä–∞–≤–∏–ª–∞
  let delta = 0;
  if (active === totalMembers) delta = 12;         // –≤—Å–µ —Å–¥–µ–ª–∞–ª–∏ ‚Äî –±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å
  else if (active >= Math.ceil(totalMembers * 0.7)) delta = 6; // –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ
  else if (active > 0) delta = 2;                  // –∫—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞–ª ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –ø–ª—é—Å
  else delta = -6;                                 // –Ω–∏–∫—Ç–æ ‚Äî –º–∏–Ω—É—Å

  // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç
  const newFire = clamp(base + delta, 0, 9999);
  return Math.round(newFire);
}

/**
 * calculateTrustScore(member, group)
 * - –±–∞–∑–æ–≤—ã–π trust –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞:
 *   - —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è ‚Äî –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)
 *   - –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ (–ø–ª—é—Å –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö)
 *   - —á–∏—Å–ª–æ —Ä–µ–ø–æ—Ä—Ç–æ–≤/—Å–æ–º–Ω–µ–Ω–∏–π (–º–∏–Ω—É—Å)
 */
function calculateTrustScore(member, group){
  let score = 1.0;

  const activities = group.dailyActivity || [];
  const completions = activities.flatMap(a => a.completions || []).filter(c => c.userId === member.userId);

  // –µ—Å–ª–∏ –º–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π ‚Äî —Å—á–∏—Ç–∞–µ–º —Ö—Ä–æ–Ω–∏–∫—É
  if (completions.length > 8){
    const hours = completions.map(c => new Date(c.timestamp).getHours());
    const variance = Math.max(...hours) - Math.min(...hours);
    if (variance < 1) score *= 0.75; // –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    else if (variance < 4) score *= 0.9;
  }

  // —Ñ–æ—Ç–æ –¥–ª—è P-tier —É—Å–∏–ª–∏–≤–∞–µ—Ç trust
  if (group.tier === 'p'){
    const hasPhoto = completions.some(c => !!c.photo);
    if (!hasPhoto) score *= 0.85;
    else score *= 1.05;
  }

  // —Ä–µ–ø–æ—Ä—Ç—ã/—Å–æ–º–Ω–µ–Ω–∏—è —Å–Ω–∏–∂–∞—é—Ç
  if (member.doubtCount){
    score *= Math.max(0.4, 1 - member.doubtCount * 0.06);
  }

  return clamp(score, 0, 2);
}

/**
 * calculateGroupTrustScore(group)
 * - –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç trust –ø–æ —á–ª–µ–Ω–∞–º
 */
function calculateGroupTrustScore(group){
  if (!group.members || group.members.length === 0) return 0.5;
  const arr = group.members.map(m => calculateTrustScore(m, group));
  const avg = arr.reduce((s,v) => s+v, 0) / arr.length;
  return clamp(avg, 0, 2);
}

/* =================================================
   UI: render placeholders ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ render'—ã –±—É–¥—É—Ç –≤ —á–∞—Å—Ç–∏ 2/3
   –ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
=================================================*/
function setTab(tab){
  state.ui.tab = tab;
  saveState();
  render();
}

function openModal(name){ state.ui.modals[name] = true; render(); }
function closeModal(name){ state.ui.modals[name] = false; render(); }

/* =================================================
   BOOT
=================================================*/
(async function boot(){
  await loadState();
  // small delay to show loader
  setTimeout(()=> {
    document.getElementById('loadingScreen')?.classList.add('hide');
    render(); // render defined in next chunk ‚Äî but kept call to begin UI
  }, 450);
})();

/* =================================================
   NOTE:
   ‚Äî UI/render functions, event handlers, modals, chart init,
     photo upload, completeTask logic –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏
     –ø—Ä–∏–¥—É—Ç –≤ –ß–ê–°–¢–ò 2‚Äì4. –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî –ù–ï —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ: —Ç—É—Ç
     —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –º–æ–¥–µ–ª—å, —Å—Ç–∏–ª–∏ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.
=================================================*/
</script>

</body>
</html>
<script>
/* =================================================
   SVG ICONS
=================================================*/
const ICONS = {
  home:`<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
  fire:`<svg viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.07-2.14-.22-4.05 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.15.43-2.29 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`,
  trophy:`<svg viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
  user:`<svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>`
};

/* =================================================
   HEADER
=================================================*/
function renderHeader(){
  return `
  <div class="header">
    <div class="header-title">livi</div>
    <div class="header-stats">
      <div class="stat-badge">üî• ${state.livi.totalFire}</div>
      <div class="profile-btn" onclick="setTab('profile')">
        <img src="${state.user.avatar || 'https://via.placeholder.com/40'}" />
      </div>
    </div>
  </div>`;
}

/* =================================================
   HOME (LIVI SCREEN)
=================================================*/
function renderHome(){
  const mood = state.livi.mood;
  const moodClass = mood.anger > 0.6 ? 'angry' : '';

  const myGroups = state.groups.filter(g =>
    g.members.some(m => m.userId === state.user.id)
  );

  return `
  ${renderHeader()}
  <div class="content slide-up">

    <div class="livi-container">
      <div class="livi-bg-glow"></div>
      <div class="livi-body ${moodClass}">
        <div class="livi-antenna"></div>
        <div class="livi-face">
          <div class="eye eye-l"></div>
          <div class="eye eye-r"></div>
          <div class="mouth"></div>
        </div>
      </div>
      <div style="margin-top:14px;font-weight:700;font-size:18px">
        –ü—Ä–∏–≤–µ—Ç, ${state.user.name}
      </div>
      <div class="small">
        –û–≥–æ–Ω—ë–∫: ${state.livi.totalFire} ‚Ä¢ –°—Ç—Ä–∏–∫: ${state.livi.streak}
      </div>
    </div>

    <h2 style="text-align:center;margin:20px 0;font-weight:800">
      –ú–û–ò –û–ì–û–ù–¨–ö–ò
    </h2>

    ${
      myGroups.length
        ? myGroups.map(renderGroupCard).join('')
        : `<div class="section" style="text-align:center;color:#666">
             –ü–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø<br><span class="small">–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é</span>
           </div>`
    }

    <button class="btn btn-primary" style="width:100%;margin-top:16px"
      onclick="openModal('createGroup')">
      ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
    </button>

  </div>`;
}

/* =================================================
   GROUP CARD
=================================================*/
function renderGroupCard(group){
  const fire = calculateFirePoints(group);
  return `
  <div class="group-card" onclick="openFireDetail('${group.id}')">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="fire-icon" style="transform:scale(.6)">
        <div class="flame"></div>
      </div>
      <div style="flex:1">
        <div style="font-weight:700">${group.name}</div>
        <div class="small">
          üî• ${fire} ‚Ä¢ üë• ${group.members.length}
          ${group.tier==='p'?'‚Ä¢ ‚≠ê –ø—É–±–ª–∏—á–Ω–∞—è':''}
        </div>
      </div>
    </div>
  </div>`;
}

/* =================================================
   TASKS TAB
=================================================*/
function renderTasks(){
  const myGroups = state.groups.filter(g =>
    g.members.some(m => m.userId === state.user.id)
  );

  return `
  ${renderHeader()}
  <div class="content slide-up">
    <h2 style="text-align:center;margin-bottom:20px;font-weight:800">
      –ó–ê–î–ê–ù–ò–Ø
    </h2>

    ${
      myGroups.map(group => `
        <div class="section">
          <div class="section-header">
            <span>${group.name}</span>
            <span>üî• ${group.fire}</span>
          </div>
          ${
            group.tasks.map(taskId => {
              const t = TASK_PRESETS.find(x => x.id === taskId);
              return `
                <div class="task-preset"
                  onclick="openCompleteTask('${group.id}','${taskId}')">
                  <div style="font-size:26px">${t.icon}</div>
                  <div>
                    <div style="font-weight:600">${t.name}</div>
                    <div class="small">${t.description}</div>
                  </div>
                </div>`;
            }).join('')
          }
        </div>
      `).join('')
    }
  </div>`;
}

/* =================================================
   BOTTOM NAV
=================================================*/
function renderNav(){
  return `
  <div class="bottom-nav">
    <div class="nav-item ${state.ui.tab==='home'?'active':''}"
      onclick="setTab('home')">
      ${ICONS.home}<span>–ì–ª–∞–≤–Ω–∞—è</span>
    </div>
    <div class="nav-item ${state.ui.tab==='tasks'?'active':''}"
      onclick="setTab('tasks')">
      ${ICONS.fire}<span>–ó–∞–¥–∞–Ω–∏—è</span>
    </div>
    <div class="nav-item ${state.ui.tab==='ranking'?'active':''}"
      onclick="setTab('ranking')">
      ${ICONS.trophy}<span>–†–µ–π—Ç–∏–Ω–≥</span>
    </div>
    <div class="nav-item ${state.ui.tab==='profile'?'active':''}"
      onclick="setTab('profile')">
      ${ICONS.user}<span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </div>
  </div>`;
}

/* =================================================
   MAIN RENDER
=================================================*/
function render(){
  let html = '';
  if (state.ui.tab === 'home') html = renderHome();
  else if (state.ui.tab === 'tasks') html = renderTasks();
  else html = `<div class="content">${renderHeader()}<div class="section">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div></div>`;

  document.getElementById('app').innerHTML = html + renderNav();
}

/* =================================================
   GROUP CREATION (MODAL DATA)
=================================================*/
function createGroup(name, tier, tasks){
  const group = {
    id: uid(),
    name,
    tier,
    isPublic: tier === 'p',
    isPaid: tier === 'p' ? false : true,
    tasks,
    members: [{
      userId: state.user.id,
      nick: state.user.name,
      avatar: state.user.avatar,
      contributionPoints: 0,
      doubtCount: 0
    }],
    fire: 10,
    dailyActivity: [],
    createdAt: new Date().toISOString()
  };
  state.groups.push(group);
  saveState();
  setTab('home');
}

/* =================================================
   PLACEHOLDERS (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —á–∞—Å—Ç–∏ 3)
=================================================*/
function openFireDetail(id){ state.ui.modals.fireDetail = id; alert('–î–µ—Ç–∞–ª–∏ –æ–≥–æ–Ω—å–∫–∞ ‚Äî —á–∞—Å—Ç—å 3'); }
function openCompleteTask(g,t){ state.ui.modals.completeTask = {g,t}; alert('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —á–∞—Å—Ç—å 3'); }

/* =================================================
   INITIAL RENDER
=================================================*/
render();
</script>
<script>
/* =================================================
   MODALS UI
=================================================*/
function renderModals(){
  return `
  ${renderCreateGroupModal()}
  ${renderFireDetailModal()}
  ${renderCompleteTaskModal()}
  `;
}

/* ================= CREATE GROUP MODAL ================= */
function renderCreateGroupModal(){
  if(!state.ui.modals.createGroup) return '';
  return `
  <div class="modal open">
    <div class="section">
      <div class="section-header">
        <span>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</span>
        <span style="cursor:pointer" onclick="closeModal('createGroup')">‚úï</span>
      </div>

      <input id="cg-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"
        style="width:100%;padding:14px;border-radius:12px;
        background:#111;color:#fff;border:1px solid #222;margin-bottom:12px"/>

      <div class="small" style="margin-bottom:8px">–¢–∏–ø –≥—Ä—É–ø–ø—ã</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="section" onclick="selectGroupTier('c')" id="tier-c">üü¢ C-TIER</div>
        <div class="section" onclick="selectGroupTier('p')" id="tier-p">‚≠ê P-TIER (75‚≠ê)</div>
      </div>

      <div class="small" style="margin-bottom:8px">–ó–∞–¥–∞–Ω–∏—è</div>
      ${TASK_PRESETS.map(t=>`
        <div class="task-preset" onclick="toggleGroupTask('${t.id}')">
          <div>${t.icon}</div><div>${t.name}</div>
        </div>
      `).join('')}

      <button class="btn btn-primary" style="width:100%;margin-top:12px"
        onclick="submitCreateGroup()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>`;
}

let createGroupDraft = { tier:'c', tasks:[] };

function selectGroupTier(t){
  createGroupDraft.tier = t;
}
function toggleGroupTask(id){
  const i = createGroupDraft.tasks.indexOf(id);
  if(i>=0) createGroupDraft.tasks.splice(i,1);
  else createGroupDraft.tasks.push(id);
}
function submitCreateGroup(){
  const name = document.getElementById('cg-name').value.trim();
  if(!name || !createGroupDraft.tasks.length) return alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë');
  createGroup(name, createGroupDraft.tier, createGroupDraft.tasks);
  closeModal('createGroup');
}

/* ================= FIRE DETAIL MODAL ================= */
function renderFireDetailModal(){
  const id = state.ui.modals.fireDetail;
  if(!id) return '';
  const g = state.groups.find(x=>x.id===id);
  if(!g) return '';

  return `
  <div class="modal open">
    <div class="section">
      <div class="section-header">
        <span>${g.name}</span>
        <span style="cursor:pointer" onclick="closeModal('fireDetail')">‚úï</span>
      </div>

      <div style="text-align:center;margin:16px 0">
        <div class="fire-icon"><div class="flame"></div></div>
        <div style="font-size:32px;font-weight:900">üî• ${g.fire}</div>
      </div>

      <div class="small">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
      ${g.members.map(m=>{
        const trust = calculateTrustScore(m,g);
        return `
        <div class="section" style="display:flex;justify-content:space-between">
          <span>${m.nick}</span>
          <span class="small">Trust ${(trust*100).toFixed(0)}%</span>
        </div>`;
      }).join('')}

      <div class="small" style="margin-top:10px">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      ${(g.dailyActivity||[]).slice(-3).reverse().map(a=>`
        <div class="section">
          <div>${a.date}</div>
          <div class="small">${a.completions.length} –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π</div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

/* ================= COMPLETE TASK MODAL ================= */
function renderCompleteTaskModal(){
  const d = state.ui.modals.completeTask;
  if(!d) return '';
  const g = state.groups.find(x=>x.id===d.g);
  const t = TASK_PRESETS.find(x=>x.id===d.t);
  if(!g||!t) return '';

  return `
  <div class="modal open">
    <div class="section">
      <div class="section-header">
        <span>${t.name}</span>
        <span style="cursor:pointer" onclick="closeModal('completeTask')">‚úï</span>
      </div>

      ${g.tier==='p'?`
      <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
        üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
      </div>
      <input id="photoInput" type="file" accept="image/*" style="display:none"
        onchange="handlePhoto(event)"/>
      <div id="photoPreview"></div>
      `:`<div class="section">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>`}

      <button class="btn btn-primary" style="width:100%;margin-top:12px"
        onclick="completeTask('${g.id}','${t.id}')">–ì–æ—Ç–æ–≤–æ</button>
    </div>
  </div>`;
}

let uploadedPhoto = null;
function handlePhoto(e){
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ev=>{
    uploadedPhoto = ev.target.result;
    document.getElementById('photoPreview').innerHTML =
      `<img src="${uploadedPhoto}" style="width:100%;border-radius:12px"/>`;
  };
  r.readAsDataURL(file);
}

/* =================================================
   COMPLETE TASK CORE LOGIC
=================================================*/
function completeTask(groupId, taskId){
  const g = state.groups.find(x=>x.id===groupId);
  if(!g) return;

  const today = isoToday();
  let day = g.dailyActivity.find(d=>d.date===today);
  if(!day){
    day = { date:today, completions:[] };
    g.dailyActivity.push(day);
  }

  if(day.completions.find(c=>c.userId===state.user.id && c.taskId===taskId)){
    alert('–£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
    return;
  }

  if(g.tier==='p' && !uploadedPhoto){
    alert('–ù—É–∂–Ω–æ —Ñ–æ—Ç–æ');
    return;
  }

  const completion = {
    userId: state.user.id,
    taskId,
    timestamp: new Date().toISOString(),
    photo: uploadedPhoto,
    doubts:[]
  };
  day.completions.push(completion);

  // –≤–∫–ª–∞–¥ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —Å —É—á–µ—Ç–æ–º trust
  const m = g.members.find(m=>m.userId===state.user.id);
  const trust = calculateTrustScore(m,g);
  m.contributionPoints += trust;

  // –ø–µ—Ä–µ—Å—á–µ—Ç –æ–≥–Ω—è
  g.fire = calculateFirePoints(g);

  // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ livi
  state.livi.totalFire += trust;
  state.livi.streak += 1;

  uploadedPhoto = null;
  closeModal('completeTask');
  saveState();
  render();
}

/* =================================================
   DOUBT SYSTEM (ANTI-ABUSE)
=================================================*/
function addDoubt(groupId, date, index){
  const g = state.groups.find(x=>x.id===groupId);
  const day = g.dailyActivity.find(d=>d.date===date);
  const c = day.completions[index];
  if(c.doubts.includes(state.user.id)) return;

  c.doubts.push(state.user.id);
  const member = g.members.find(m=>m.userId===c.userId);
  member.doubtCount += 1;

  saveState();
}

/* =================================================
   DAY CLOSURE (AUTO)
=================================================*/
function closePreviousDays(){
  const today = isoToday();
  state.groups.forEach(g=>{
    const last = g.dailyActivity.at(-1);
    if(last && last.date !== today){
      g.fire = calculateFirePoints(g);
    }
  });
}
closePreviousDays();

/* =================================================
   PATCH RENDER HOOK
=================================================*/
const _render = render;
render = function(){
  _render();
  document.getElementById('app').insertAdjacentHTML('beforeend', renderModals());
};
</script>
<script>
/* =================================================
   RANKING (–ß–ï–°–¢–ù–´–ô)
=================================================*/
function normalizedAgeDays(group){
  const days = Math.max(1, (Date.now() - new Date(group.createdAt)) / 86400000);
  // –º—è–≥–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —Ä–æ—Å—Ç –µ—Å—Ç—å, –Ω–æ –±–µ–∑ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö
  return Math.log(days + 1);
}

function groupScore(group){
  const fire = calculateFirePoints(group);
  const trust = calculateGroupTrustScore(group);
  const age = normalizedAgeDays(group);
  return fire * trust * age;
}

function renderRanking(){
  const publicGroups = state.groups.filter(g => g.tier === 'p' && g.isPublic !== false);
  const sorted = [...publicGroups].sort((a,b)=> groupScore(b)-groupScore(a));

  return `
  ${renderHeader()}
  <div class="content slide-up">
    <h2 style="text-align:center;margin-bottom:16px;font-weight:800">üèÜ –†–ï–ô–¢–ò–ù–ì</h2>
    ${
      sorted.length ? sorted.map((g,i)=>`
        <div class="section" onclick="openFireDetail('${g.id}')">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="font-weight:900;font-size:20px;width:28px;text-align:center">
              ${i+1}
            </div>
            <div style="flex:1">
              <div style="font-weight:700">${g.name}</div>
              <div class="small">
                üî• ${calculateFirePoints(g)}
                ‚Ä¢ üë• ${g.members.length}
                ‚Ä¢ Trust ${(calculateGroupTrustScore(g)*100).toFixed(0)}%
              </div>
            </div>
            <div class="fire-icon" style="transform:scale(.4)">
              <div class="flame"></div>
            </div>
          </div>
        </div>
      `).join('')
      :
      `<div class="section" style="text-align:center;color:#666">
         –ù–µ—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø<br>
         <span class="small">–°–æ–∑–¥–∞–π P-tier –∑–∞ 75‚≠ê</span>
       </div>`
    }
  </div>`;
}

/* =================================================
   ANALYTICS (CHART.JS)
=================================================*/
function renderAnalytics(group){
  const days = (group.dailyActivity||[]).slice(-7);
  const labels = days.map(d=>d.date.slice(5));
  const values = days.map(d=>d.completions.length);

  return `
    <canvas id="chart-${group.id}" height="180"></canvas>
    <script>
      (function(){
        const ctx = document.getElementById('chart-${group.id}');
        if(!ctx) return;
        new Chart(ctx,{
          type:'bar',
          data:{
            labels:${JSON.stringify(labels)},
            datasets:[{
              data:${JSON.stringify(values)},
              backgroundColor:'rgba(255,107,0,.6)',
              borderColor:'#ff6b00',
              borderWidth:1
            }]
          },
          options:{
            plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{color:'#888'}},
              y:{ticks:{color:'#888'},beginAtZero:true}
            }
          }
        });
      })();
    </script>
  `;
}

/* =================================================
   FIRE DETAIL ‚Äî ADD ANALYTICS + DOUBT UI
=================================================*/
const _renderFireDetailModal = renderFireDetailModal;
renderFireDetailModal = function(){
  const id = state.ui.modals.fireDetail;
  if(!id) return '';
  const g = state.groups.find(x=>x.id===id);
  if(!g) return '';

  const base = _renderFireDetailModal();
  const doubtsUI = (g.dailyActivity||[]).slice(-1).map(day =>
    day.completions.map((c,idx)=>`
      <div class="section">
        <div class="small">
          ${c.userId===state.user.id?'–í—ã':'–£—á–∞—Å—Ç–Ω–∏–∫'} ‚Ä¢ ${new Date(c.timestamp).toLocaleTimeString()}
        </div>
        ${c.photo?`<img src="${c.photo}" style="width:100%;border-radius:10px;margin:6px 0"/>`:''}
        <button class="btn btn-ghost small"
          onclick="addDoubt('${g.id}','${day.date}',${idx})">
          üëÅ –°–æ–º–Ω–µ–≤–∞—é—Å—å (${c.doubts.length})
        </button>
      </div>
    `).join('')
  ).join('');

  return base.replace('</div></div>', `
      <div class="small" style="margin-top:12px">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      ${renderAnalytics(g)}
      <div class="small" style="margin-top:12px">üëÅ –ü—Ä–æ–≤–µ—Ä–∫–∞</div>
      ${doubtsUI}
    </div></div>
  `);
};

/* =================================================
   TELEGRAM STARS ‚Äî 75 ‚≠ê
=================================================*/
const STARS_RECEIVER_ID = 1792666312;

function payForPublicGroup(groupId){
  if(!tg || !tg.openInvoice){
    alert('–û–ø–ª–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ –∫–∞–∫ –ø—Ä–∏–≤–∞—Ç–Ω–∞—è.');
    return;
  }

  // ‚ö†Ô∏è MVP-—Ä–µ–∂–∏–º: —Ä–µ–∞–ª—å–Ω—ã–π invoice –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º
  // –ó–¥–µ—Å—å ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞
  const invoiceLink = `https://t.me/+stars?to=${STARS_RECEIVER_ID}&amount=75`;

  tg.openInvoice(invoiceLink, status=>{
    if(status==='paid'){
      const g = state.groups.find(x=>x.id===groupId);
      if(g){
        g.isPaid = true;
        g.isPublic = true;
        saveState();
        render();
      }
    }else{
      alert('–ü–ª–∞—Ç—ë–∂ –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω');
    }
  });
}

/* =================================================
   LIVI MOOD (–†–ï–ê–õ–¨–ù–´–ï –†–ï–ê–ö–¶–ò–ò)
=================================================*/
function updateLiviMood(){
  const allGroups = state.groups;
  if(!allGroups.length) return;

  let totalFire = 0;
  let totalTrust = 0;
  let failures = 0;

  allGroups.forEach(g=>{
    totalFire += calculateFirePoints(g);
    totalTrust += calculateGroupTrustScore(g);
    const last = g.dailyActivity?.at(-1);
    if(last && last.completions.length===0) failures++;
  });

  const avgTrust = totalTrust / allGroups.length;

  state.livi.totalFire = Math.round(totalFire);
  state.livi.mood.trust = clamp(avgTrust,0,1);
  state.livi.mood.anger = clamp(failures / allGroups.length,0,1);
  state.livi.mood.patience = clamp(1 - state.livi.mood.anger,0,1);
}

/* =================================================
   FINAL RENDER PATCH
=================================================*/
const __render = render;
render = function(){
  updateLiviMood();
  let html='';
  if(state.ui.tab==='ranking') html = renderRanking();
  else if(state.ui.tab==='profile'){
    html = `
      ${renderHeader()}
      <div class="content slide-up">
        <div class="section" style="text-align:center">
          <img src="${state.user.avatar||'https://via.placeholder.com/80'}"
            style="width:80px;height:80px;border-radius:50%;margin-bottom:10px"/>
          <div style="font-weight:800;font-size:20px">${state.user.name}</div>
          <div class="small">üî• ${state.livi.totalFire}</div>
        </div>
        <div class="section">
          <div class="small">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ Livi</div>
          <div>Trust ${(state.livi.mood.trust*100).toFixed(0)}%</div>
          <div>Anger ${(state.livi.mood.anger*100).toFixed(0)}%</div>
        </div>
      </div>`;
  } else {
    html = __render();
  }

  document.getElementById('app').innerHTML = html + renderNav() + renderModals();
};

/* =================================================
   SAVE ON UNLOAD
=================================================*/
window.addEventListener('beforeunload', saveState);
</script>
