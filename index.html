<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
    --primary: #8B9A9C;
    --accent: #A8C4C6;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #0F0F0F;
    --glass: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.08);
    --glass-highlight: rgba(255,255,255,0.15);
    --danger: #ff4757;
    --success: #2ed573;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:#000;
    color:#e0e0e0;
    max-width:428px;
    margin:0 auto;
    overflow-x:hidden;
    -webkit-tap-highlight-color:transparent;
    padding-bottom:100px;
    min-height:100vh;
    position: relative;
}

/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes pulse-red {
    0% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);}
    70% {box-shadow: 0 0 0 20px rgba(255, 71, 87, 0);}
    100% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);}
}
@keyframes wave {0%,100%{height:10px}50%{height:30px}}
@keyframes twinkle {0%,100%{opacity:0.2;transform:scale(1)}50%{opacity:0.8;transform:scale(1.5)}}
@keyframes shimmer {0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes slideInRight {from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes growBar {from{transform:scaleY(0);transform-origin:bottom}to{transform:scaleY(1);transform-origin:bottom}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.hidden{display:none!important}

/* UI Elements */
.loading-screen{
    position:fixed;
    inset:0;
    background:#050505;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
    transition:opacity .5s
}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{
    font-size:64px;
    font-weight:800;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    letter-spacing:-2px
}

.header{
    padding:20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:rgba(15,15,15,0.6);
    backdrop-filter:blur(20px);
    border-bottom:1px solid rgba(255,255,255,0.05);
    position:sticky;
    top:0;
    z-index:50
}
.header-title{
    font-size:28px;
    font-weight:800;
    background:linear-gradient(135deg,var(--primary),var(--accent));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent
}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{
    display:flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    border-radius:20px;
    font-weight:700;
    font-size:14px;
    background:var(--glass);
    border:1px solid var(--glass-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
}
.profile-btn{
    width:40px;
    height:40px;
    border-radius:50%;
    overflow:hidden;
    border:2px solid var(--primary);
    cursor:pointer;
    box-shadow:0 0 15px rgba(139,154,156,0.3)
}
.profile-btn img{width:100%;height:100%;object-fit:cover}

/* Livi Character */
.livi-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:30px 0;
    position:relative;
    z-index:5
}
.livi-bg-glow{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:220px;
    height:220px;
    background:radial-gradient(circle,rgba(139,154,156,0.15) 0%,rgba(0,0,0,0) 70%);
    z-index:1;
    pointer-events:none
}
.livi-body{
    width:120px;
    height:120px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #3a3a3a, #1a1a1a);
    border:2px solid rgba(139,154,156,0.5);
    position:relative;
    box-shadow:0 15px 40px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.8);
    animation:float 6s ease-in-out infinite;
    z-index:5
}
.livi-antenna{
    position:absolute;
    width:3px;
    height:30px;
    background:var(--primary);
    border-radius:4px;
    z-index:1;
    opacity:0.8
}
.livi-antenna::after{
    content:'';
    position:absolute;
    top:-6px;
    left:-2px;
    width:7px;
    height:7px;
    background:var(--accent);
    border-radius:50%;
    box-shadow:0 0 8px var(--primary)
}
.ant-l{top:-20px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-20px;right:25px;transform:rotate(20deg)}
.livi-face{position:absolute;inset:0;z-index:10}
.eye{
    position:absolute;
    top:45%;
    width:12px;
    height:16px;
    background:white;
    border-radius:50%;
    animation:blink 4s infinite;
    box-shadow:0 0 10px rgba(255,255,255,0.5)
}
.eye-l{left:32px}
.eye-r{right:32px}
.mouth{
    position:absolute;
    bottom:32px;
    left:50%;
    transform:translateX(-50%);
    width:20px;
    height:10px;
    border-bottom:2px solid white;
    border-radius:0 0 15px 15px
}

/* SVG */
svg{
    width:24px;
    height:24px;
    fill:none;
    stroke:currentColor;
    stroke-width:2;
    stroke-linecap:round;
    stroke-linejoin:round
}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div class="particle-container" id="stars"></div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:10px; color:#fff; font-weight:800; letter-spacing:1px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div class="roulette-window">
        <div class="r-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .5s">
        <div style="font-size:14px; color:#888; text-transform:uppercase; letter-spacing:1px">–í—ã –ø–æ–ª—É—á–∏–ª–∏</div>
        <div id="winItemName" style="font-size:32px; font-weight:800; color:var(--gold); margin:10px 0; text-shadow:0 0 20px rgba(212,175,122,0.3)">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" style="width:200px; margin:0 auto" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="noteModal" class="note-modal">
    <div class="note-header">
        <div style="font-weight: 800; font-size: 20px; color: var(--gold)" id="modalTitle">–ó–∞–º–µ—Ç–∫–∞</div>
        <div onclick="actions.closeNote()" style="padding: 10px; cursor: pointer;">‚úï</div>
    </div>
    <div class="ai-actions">
        <div class="ai-chip" onclick="actions.enhanceNote()">‚ö° AI –°—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
        <div class="ai-chip" onclick="actions.addSummary()">üß† –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å</div>
        <div class="ai-chip" onclick="actions.extractTasks()">‚úÖ –ù–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏</div>
        <div class="ai-chip" onclick="actions.extractKeywords()">üè∑Ô∏è –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</div>
    </div>
    <textarea id="modalText" class="note-textarea" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
    <button class="btn btn-primary" onclick="actions.saveAndCloseNote()" style="margin-top: auto;">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div id="app"></div>

<script>
// --- INITIALIZATION ---
let tg = null;
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.expand();
    tg.ready();
    tg.setHeaderColor('#000000');
    tg.setBackgroundColor('#000000');
    tg.enableClosingConfirmation();
}

const userId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'local_user';
const firstName = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.first_name || 'User') : '–î—Ä—É–≥';
const photoUrl = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.photo_url || '') : '';

// --- PARTICLE SYSTEM ---
function initStars() {
    const container = document.getElementById('stars');
    const count = 50;
    for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
        p.style.setProperty('--delay', (Math.random() * 5) + 's');
        p.style.opacity = Math.random() * 0.5 + 0.1;
        container.appendChild(p);
    }
}

// --- STORAGE ---
const Storage = {
    save: (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            if (tg && tg.CloudStorage && key.includes('stats')) {
                tg.CloudStorage.setItem(key, JSON.stringify(data));
            }
        } catch (e) {
            console.error("Save failed", e);
        }
    },
    load: async (key) => {
        try {
            if (tg && tg.CloudStorage && key.includes('stats')) {
                const cloudData = await new Promise(r =>
                    tg.CloudStorage.getItem(key, (err, val) => r(val))
                );
                if (cloudData) return JSON.parse(cloudData);
            }
            const local = localStorage.getItem(key);
            return local ? JSON.parse(local) : null;
        } catch (e) {
            return null;
        }
    }
};

const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
    spark: '<path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5z"/>',
    book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
    mic: '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>'
};

const getIcon = (n) => `<svg viewBox="0 0 24 24">${icons[n]}</svg>`;

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' },
    { id: 'insurance', name: '–©–∏—Ç —Å—Ç—Ä–∏–∫–∞', type: 'special', rarity: 'rare', icon: 'üõ°Ô∏è', css: 'item-insurance', special: true }
];

const defaultState = {
    activeTab: 'home',
    streak: 1,
    totalPoints: 200,
    lastVisitDate: new Date().toISOString().split('T')[0],
    statsHistory: [],
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10 },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5 }
    ],
    inventory: [],
    equipped: { head: null, face: null, body: null, special: null },
    dailyChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–°–¥–µ–ª–∞—Ç—å 20 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π',
        completed: false,
        reward: 50
    },
    notes: [],
    hasStreakInsurance: false,
    referralCount: 0,
    totalFire: 0,
    nick: firstName,
    avatar: photoUrl
};

let state = { ...defaultState };
let recognition = null;
let isRecording = false;
let currentTranscript = "";
let editingNoteId = null;
async function loadState() {
    const statsData = await Storage.load(`livi_stats_${userId}`);
    if (statsData) state = { ...defaultState, ...statsData };

    const notesData = await Storage.load(`livi_notes_${userId}`);
    if (notesData) state.notes = notesData;

    if (state.statsHistory.length === 0) {
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            state.statsHistory.push({
                date: d.toISOString().split('T')[0],
                points: Math.floor(Math.random() * 50)
            });
        }
    }

    const today = new Date().toISOString().split('T')[0];
    if (state.lastVisitDate !== today) {
        if (!state.statsHistory.find(e => e.date === today)) {
            state.streak = hadActivityYesterday() ? state.streak + 1 : 1;
        }
        state.lastVisitDate = today;
        const challenges = [
            '–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –∑–∞–¥–∞—á–∏',
            '–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤',
            '–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ª–µ–∫—Ü–∏—é',
            '–°–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç',
            '–ü—Ä–æ–π—Ç–∏ 5000 —à–∞–≥–æ–≤'
        ];
        state.dailyChallenge = {
            date: today,
            title: challenges[Math.floor(Math.random() * challenges.length)],
            completed: false,
            reward: 50
        };
        state.tasks.forEach(t => {
            if (t.type === 'habit') t.completed = false;
        });
        saveAll();
    }
}

function saveAll() {
    const statsToSave = { ...state };
    delete statsToSave.notes;
    Storage.save(`livi_stats_${userId}`, statsToSave);
    Storage.save(`livi_notes_${userId}`, state.notes);
}

function hadActivityYesterday() {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    const y = d.toISOString().split('T')[0];
    return !!state.statsHistory.find(e => e.date === y);
}

function updateHistory(pointsDelta) {
    const today = new Date().toISOString().split('T')[0];
    let entry = state.statsHistory.find(e => e.date === today);
    if (!entry) {
        entry = { date: today, points: 0 };
        state.statsHistory.push(entry);
    }
    entry.points += pointsDelta;
    if (state.statsHistory.length > 7) state.statsHistory.shift();
    saveAll();
}

// --- ENHANCED AI LOGIC ---
const AI = {
    clean: (text) => text.replace(/\s+/g, ' ').trim(),

    structure: (text) => {
        let processed = text;

        processed = processed.replace(
            /([–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9]+)\s*[-‚Äì‚Äî]\s*([^.!?]+[.!?])/g,
            "**$1** ‚Äî $2"
        );

        processed = processed.replace(
            /([.!?])\s+(?=[–ê-–Ø–ÅA-Z])/g,
            "$1\n\n"
        );

        processed = processed.replace(/\n\s*[-‚Ä¢]\s*/g, "\n‚Ä¢ ");
        processed = processed.replace(/\n\s*(\d+)[.)]\s*/g, "\n$1. ");

        const importantWords = [
            '–≤–∞–∂–Ω–æ',
            '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ',
            '—Å–ª–µ–¥—É–µ—Ç',
            '–∫–ª—é—á–µ–≤–æ–π',
            '–æ—Å–Ω–æ–≤–Ω–æ–π',
            '–≥–ª–∞–≤–Ω—ã–π'
        ];

        importantWords.forEach(word => {
            const regex = new RegExp(`(${word}[–∞-—è—ë]*)`, 'gi');
            processed = processed.replace(regex, '**$1**');
        });

        processed = processed.replace(
            /(\d{1,2}[./]\d{1,2}[./]\d{2,4})/g,
            "**$1**"
        );

        return processed;
    },

    extractSummary: (text) => {
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];

        const signalWords = [
            '–≤–∞–∂–Ω–æ','—Å—É—Ç—å','–≤—ã–≤–æ–¥','–ø–æ—ç—Ç–æ–º—É','–∏—Ç–∞–∫','–∑–∞–ø–æ–º–Ω–∏—Ç—å',
            '—Å–ª–µ–¥—É–µ—Ç','–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ','–≥–ª–∞–≤–Ω–æ–µ','–æ—Å–Ω–æ–≤–Ω–æ–µ','–∫–ª—é—á–µ–≤–æ–µ',
            '—Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º','–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ','–≤ –∏—Ç–æ–≥–µ','–∑–∞–∫–ª—é—á–µ–Ω–∏–µ'
        ];

        let keySentences = [];

        if (sentences[0]) keySentences.push(sentences[0].trim());

        sentences.forEach((s, idx) => {
            if (idx === 0) return;
            const lowerS = s.toLowerCase();
            if (signalWords.some(word => lowerS.includes(word))) {
                keySentences.push(s.trim());
            }
        });

        if (keySentences.length < 3 && sentences.length > 1) {
            const lastSentence = sentences[sentences.length - 1].trim();
            if (!keySentences.includes(lastSentence)) {
                keySentences.push(lastSentence);
            }
        }

        keySentences = keySentences.slice(0, 4);

        return "üìå –ì–õ–ê–í–ù–ê–Ø –ú–´–°–õ–¨:\n" +
            keySentences.join(' ') +
            (keySentences.length < sentences.length ? "..." : "");
    },

    findTasks: (text) => {
        const actionVerbs = [
            '—Å–¥–µ–ª–∞—Ç—å','–≤—ã–ø–æ–ª–Ω–∏—Ç—å','–Ω–∞–ø–∏—Å–∞—Ç—å','–ø—Ä–æ—á–∏—Ç–∞—Ç—å','–∏–∑—É—á–∏—Ç—å',
            '–∫—É–ø–∏—Ç—å','–æ—Ç–ø—Ä–∞–≤–∏—Ç—å','–ø–æ–∑–≤–æ–Ω–∏—Ç—å','—Å–≤—è–∑–∞—Ç—å—Å—è','–Ω–∞–π—Ç–∏',
            '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å','—Å–æ–∑–¥–∞—Ç—å','—Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å','–ø—Ä–æ–≤–µ—Ä–∏—Ç—å','–∑–∞–≤–µ—Ä—à–∏—Ç—å',
            '–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å','—Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å','–∑–∞–ø–∏—Å–∞—Ç—å—Å—è','–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'
        ];

        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        let tasks = [];

        sentences.forEach(s => {
            const lowerS = s.toLowerCase();
            const hasAction = actionVerbs.some(v => lowerS.includes(v));
            const hasNeed = /–Ω—É–∂–Ω–æ|–Ω–∞–¥–æ|–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ|—Å–ª–µ–¥—É–µ—Ç|—Ç—Ä–µ–±—É–µ—Ç—Å—è/.test(lowerS);

            if (hasAction || hasNeed) {
                tasks.push("‚Ä¢ " + s.trim());
            }
        });

        return tasks.length > 0
            ? "\n\nüìã –ó–ê–î–ê–ß–ò –ò–ó –¢–ï–ö–°–¢–ê:\n" + tasks.join('\n')
            : "";
    },

    extractKeywords: (text) => {
        const words = text.toLowerCase()
            .replace(/[^\w–∞-—è—ë\s]/gi, ' ')
            .split(/\s+/)
            .filter(w => w.length > 4);

        const freq = {};
        words.forEach(w => freq[w] = (freq[w] || 0) + 1);

        const stopWords = [
            '–∫–æ—Ç–æ—Ä—ã–π','–º–æ–∂–µ—Ç','–±–æ–ª–µ–µ','–æ—á–µ–Ω—å','—Ç–∞–∫–∂–µ',
            '—Ç–æ–ª—å–∫–æ','—á–µ—Ä–µ–∑','–º–µ–∂–¥—É','–ø–æ—Å–ª–µ','–ø–µ—Ä–µ–¥'
        ];

        return Object.entries(freq)
            .filter(([word]) => !stopWords.includes(word))
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([word]) => word);
    },

    getTip: (text) => {
        if (text.length < 20) return "üí° Livi —Å–ª—É—à–∞–µ—Ç...";

        const lower = text.toLowerCase();

        if (/\d+\s*[+\-*/=]\s*\d+|—Ñ–æ—Ä–º—É–ª–∞|—É—Ä–∞–≤–Ω–µ–Ω–∏–µ|—Ç–µ–æ—Ä–µ–º–∞/.test(lower)) {
            return "üí° –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞? –ü–æ–ø—Ä–æ–±—É–π —Ä–µ—à–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.";
        }

        if (/\d{4}|–≤–µ–∫|—ç–ø–æ—Ö–∞|–ø–µ—Ä–∏–æ–¥/.test(text)) {
            return "üí° –°–æ–∑–¥–∞–π –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é —Å–æ–±—ã—Ç–∏–π.";
        }

        if ((text.match(/[-‚Äì‚Äî]/g) || []).length > 2) {
            return "üí° –ú–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ä—Ç–æ—á–∫–∏.";
        }

        if ((text.match(/\n/g) || []).length > 5) {
            return "üí° –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ.";
        }

        if ((text.match(/\?/g) || []).length > 2) {
            return "üí° –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.";
        }

        if (text.length > 500) {
            return "üí° –†–∞–∑–¥–µ–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–∞ –±–ª–æ–∫–∏ –ø–æ 15‚Äì20 –º–∏–Ω—É—Ç.";
        }

        return "üí° –ü–µ—Ä–µ—á–∏—Ç–∞–π —ç—Ç–æ –∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º.";
    }
};

// --- ACTIONS ---
const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (!task) return;

        task.completed = !task.completed;
        const delta = task.completed ? task.points : -task.points;
        state.totalPoints += delta;
        updateHistory(delta);

        if (task.completed && tg) {
            tg.HapticFeedback.notificationOccurred('success');
        }

        saveAll();
        render();
    },

    completeChallenge: () => {
        if (state.dailyChallenge.completed) return;

        state.dailyChallenge.completed = true;
        state.totalPoints += state.dailyChallenge.reward;
        state.totalFire += 1;
        updateHistory(state.dailyChallenge.reward);

        if (tg) tg.HapticFeedback.notificationOccurred('success');

        saveAll();
        render();
    },

    addTask: () => {
        const title = prompt("–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?");
        if (!title) return;

        state.tasks.push({
            id: Date.now(),
            title,
            completed: false,
            type: 'task',
            points: 15
        });

        saveAll();
        render();
    },

    deleteTask: (id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;

        state.tasks = state.tasks.filter(t => t.id !== id);
        saveAll();
        render();
    },

    equip: (id) => {
        const item = ITEMS.find(i => i.id === id);
        if (!item) return;

        const slot = item.special ? 'special' : item.type;
        state.equipped[slot] = state.equipped[slot] === id ? null : id;

        if (item.special) {
            state.hasStreakInsurance = !!state.equipped.special;
        }

        saveAll();
        render();
    },

    openChest: (type, cost) => {
        if (state.totalPoints < cost) {
            alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
            return;
        }

        state.totalPoints -= cost;
        updateHistory(-cost);
        startRoulette(type);
    },

    openProfile: () => {
        state.activeTab = 'profile';
        render();
    },

    copyReferral: () => {
        const refLink = `https://t.me/livi_app_bot?start=ref${userId}`;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(refLink).then(() => {
                alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!");
                if (tg) tg.HapticFeedback.notificationOccurred('success');
            });
        } else {
            alert(refLink);
        }
    }
};
// --- RENDERERS ---
function renderHeader() {
    return `<div class="header">
        <div class="header-title">livi</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:var(--gold)">
                ${getIcon('star')} ${state.totalPoints}
            </div>
            <div class="stat-badge" style="color:#ff6b81">
                ${getIcon('spark')} ${state.totalFire}
            </div>
            <div class="profile-btn" onclick="actions.openProfile()">
                <img src="${state.avatar || 'https://via.placeholder.com/40?text=üë§'}" alt="Profile">
            </div>
        </div>
    </div>`;
}

function renderHome() {
    const done = state.tasks.filter(t => t.completed).length;
    const total = state.tasks.length;
    const completionPercent = total > 0 ? Math.round((done / total) * 100) : 0;
    const progressDeg = (completionPercent / 100) * 360;

    const h = ITEMS.find(i => i.id === state.equipped.head);
    const f = ITEMS.find(i => i.id === state.equipped.face);
    const b = ITEMS.find(i => i.id === state.equipped.body);
    const s = ITEMS.find(i => i.id === state.equipped.special);

    const maxVal = Math.max(...state.statsHistory.map(h => h.points), 50);
    const days = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
    const today = new Date().toISOString().split('T')[0];

    const chartHtml = state.statsHistory.map(hs => {
        const height = Math.max((hs.points / maxVal) * 80, 10);
        const isToday = hs.date === today;
        const dayName = days[new Date(hs.date).getDay()];

        return `<div class="chart-col">
            <div class="chart-value">${hs.points} pts</div>
            <div class="chart-bar ${isToday ? 'active' : ''}" style="height:${height}px"></div>
            <div class="chart-day">${dayName}</div>
        </div>`;
    }).join('');

    const streakPercent = Math.min((state.streak / 7) * 100, 100);
    const lastNote = state.notes.length > 0 ? state.notes[0].text : "";
    const aiTip = AI.getTip(lastNote);

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="livi-container">
                <div class="livi-bg-glow"></div>
                <div class="livi-body">
                    ${h ? `<div class="${h.css}" style="${h.style || ''}"></div>` : ''}
                    <div class="livi-antenna ant-l"></div>
                    <div class="livi-antenna ant-r"></div>
                    <div class="livi-face">
                        <div class="eye eye-l"></div>
                        <div class="eye eye-r"></div>
                        ${f ? `<div class="${f.css}">
                            <div class="g-lens"></div>
                            <div class="g-lens"></div>
                            <div class="g-bridge"></div>
                        </div>` : ''}
                        <div class="mouth"></div>
                    </div>
                    ${s ? `<div class="${s.css}">${s.icon}</div>` : ''}
                </div>
                ${b ? `<div style="position:relative;width:0;height:0;top:-10px">
                    <div class="${b.css}"></div>
                </div>` : ''}
                <div style="margin-top:20px;font-weight:700;font-size:18px">
                    –ü—Ä–∏–≤–µ—Ç, ${state.nick}!
                </div>
            </div>

            <div class="grid-2">
                <div class="section" style="margin:0;padding:15px;display:flex;flex-direction:column;align-items:center">
                    <div class="pie-chart" style="--progress-deg:${progressDeg}deg;">
                        <div class="pie-center">
                            <div class="pie-percentage">${completionPercent}%</div>
                            <div class="pie-label">–ó–∞–¥–∞—á–∏</div>
                        </div>
                    </div>
                    <div style="font-size:13px;color:#888;margin-top:10px">
                        ${done} –∏–∑ ${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                    </div>
                </div>

                <div class="section" style="margin:0;text-align:center">
                    <div style="font-size:36px;font-weight:900;color:var(--gold)">
                        ${state.streak}
                    </div>
                    <div style="font-size:12px;color:#888;text-transform:uppercase">
                        –î–Ω–µ–π –ø–æ–¥—Ä—è–¥
                    </div>
                    <div class="streak-progress">
                        <div class="streak-fill" style="width:${streakPercent}%"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div style="font-size:12px;color:#888">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                    <div style="font-size:11px;color:var(--gold)">
                        –í—Å–µ–≥–æ: ${state.statsHistory.reduce((a,b)=>a+b.points,0)} pts
                    </div>
                </div>
                <div class="chart-container">${chartHtml}</div>
            </div>

            <div class="section" style="display:flex;gap:12px;align-items:center">
                <div style="font-size:28px">ü§ñ</div>
                <div style="font-size:13px;line-height:1.5;color:#ccc">
                    <b style="color:var(--accent)">Livi –¥—É–º–∞–µ—Ç:</b><br>${aiTip}
                </div>
            </div>
        </div>
    </div>`;
}

function renderEducation() {
    const notesList = state.notes.map(n => {
        const tagsHtml = n.keywords && n.keywords.length
            ? `<div class="note-tags">
                ${n.keywords.map(k => `<span class="note-tag">#${k}</span>`).join('')}
               </div>`
            : '';

        return `
        <div class="note-card" onclick="actions.openNote(${n.id})">
            <div class="note-date">
                <span>${n.date}</span>
                <span onclick="event.stopPropagation(); actions.deleteNote(${n.id})" style="color:#666">‚úï</span>
            </div>
            <div class="note-title">${n.title}</div>
            <div class="note-preview">${n.text.replace(/[*#]/g,'').slice(0,80)}...</div>
            ${tagsHtml}
        </div>`;
    }).join('');

    const transcriptDisplay = currentTranscript || (isRecording ? "–ì–æ–≤–æ—Ä–∏—Ç–µ..." : "–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...");

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800;text-align:center">
                –£–ú–ù–´–ô –ö–û–ù–°–ü–ï–ö–¢
            </h2>

            <div class="section" style="text-align:center">
                <div class="transcript-box">
                    <div class="transcript-text" id="liveTranscript">${transcriptDisplay}</div>
                    <div class="processing-indicator" id="processingIndicator">
                        <div class="processing-dot"></div>
                        <span>AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç...</span>
                    </div>
                </div>

                <button class="mic-btn ${isRecording ? 'recording' : ''}"
                    onclick="${isRecording ? 'actions.stopRecording()' : 'actions.startRecording()'}">
                    ${isRecording
                        ? '<div class="voice-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>'
                        : getIcon('mic')}
                </button>
            </div>

            <h3 style="margin:25px 0 10px;font-size:12px;color:#666;text-transform:uppercase">
                –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            </h3>
            ${notesList || '<div style="text-align:center;color:#555">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>'}
        </div>
    </div>`;
}

function renderTasks() {
    const list = state.tasks.map(t => `
        <div class="section" style="display:flex;align-items:center;opacity:${t.completed ? 0.6 : 1}">
            <div style="width:24px;height:24px;border:2px solid var(--primary);
                border-radius:8px;margin-right:12px;
                background:${t.completed ? 'var(--primary)' : 'transparent'}"
                onclick="actions.toggleTask(${t.id})">
            </div>
            <div style="flex:1">
                <div style="font-weight:600">${t.title}</div>
                <div style="font-size:11px;color:#666">${t.points} pts</div>
            </div>
            <div onclick="actions.deleteTask(${t.id})" style="cursor:pointer;color:#444">
                ${getIcon('trash')}
            </div>
        </div>
    `).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800">–ó–ê–î–ê–ß–ò</h2>
            ${list || '<div style="text-align:center;color:#555">–ù–µ—Ç –∑–∞–¥–∞—á</div>'}
        </div>
        <button class="add-btn" onclick="actions.addTask()">+</button>
    </div>`;
}

function renderShop() {
    const inv = state.inventory.map(id => {
        const i = ITEMS.find(x => x.id === id);
        const eq = Object.values(state.equipped).includes(id);
        const color = i.special
            ? '#FFA500'
            : i.rarity === 'legendary'
                ? 'var(--epic)'
                : i.rarity === 'rare'
                    ? 'var(--gold)'
                    : 'var(--primary)';

        return `
        <div class="section" style="padding:15px;text-align:center;
            border-color:${eq ? color : 'var(--glass-border)'}"
            onclick="actions.equip('${id}')">
            <div style="font-size:42px">${i.icon}</div>
            <div style="font-size:11px;color:#aaa">${i.name}</div>
        </div>`;
    }).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:48px;font-weight:900;color:var(--gold)">
                    ${state.totalPoints}
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                ${inv || '<div style="grid-column:1/-1;text-align:center;color:#444">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>'}
            </div>
        </div>
    </div>`;
}

function renderProfile() {
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content" style="text-align:center">
            <div class="profile-btn" style="width:100px;height:100px;margin:0 auto 20px">
                <img src="${state.avatar || 'https://via.placeholder.com/100?text=üë§'}">
            </div>
            <div style="font-size:28px;font-weight:800">${state.nick}</div>
            <div style="font-size:11px;color:#444;margin-top:10px">
                ID: ${userId}
            </div>
        </div>
    </div>`;
}
function render() {
    let html = '';

    if (state.activeTab === 'home') html = renderHome();
    else if (state.activeTab === 'tasks') html = renderTasks();
    else if (state.activeTab === 'education') html = renderEducation();
    else if (state.activeTab === 'shop') html = renderShop();
    else if (state.activeTab === 'profile') html = renderProfile();

    document.getElementById('app').innerHTML = html + `
    <div class="bottom-nav">
        <button class="nav-item ${state.activeTab==='home'?'active':''}"
            onclick="state.activeTab='home';saveAll();render()">
            ${getIcon('home')}
        </button>
        <button class="nav-item ${state.activeTab==='tasks'?'active':''}"
            onclick="state.activeTab='tasks';saveAll();render()">
            ${getIcon('check')}
        </button>
        <button class="nav-item ${state.activeTab==='education'?'active':''}"
            onclick="state.activeTab='education';saveAll();render()">
            ${getIcon('book')}
        </button>
        <button class="nav-item ${state.activeTab==='shop'?'active':''}"
            onclick="state.activeTab='shop';saveAll();render()">
            ${getIcon('shop')}
        </button>
    </div>`;
}

// --- ROULETTE LOGIC ---
function startRoulette(type) {
    const modal = document.getElementById('rouletteModal');
    modal.classList.remove('hidden');

    const strip = document.getElementById('rouletteStrip');
    strip.innerHTML = '';
    strip.style.transition = 'none';
    strip.style.transform = 'translateX(0px)';

    let pool = type === 'common'
        ? ITEMS.filter(i => i.rarity !== 'legendary')
        : ITEMS;

    let winner = pool[Math.floor(Math.random() * pool.length)];
    if (type === 'rare' && Math.random() > 0.7) {
        winner = ITEMS.find(i => i.rarity === 'legendary') || winner;
    }

    for (let i = 0; i < 60; i++) {
        const item = i === 50 ? winner : pool[Math.floor(Math.random() * pool.length)];
        const el = document.createElement('div');
        el.className = `r-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:40px">${item.icon}</div>`;
        strip.appendChild(el);
    }

    setTimeout(() => {
        const offset =
            (document.querySelector('.roulette-window').offsetWidth / 2) - 64;

        strip.style.transition = 'transform 6s cubic-bezier(0.1, 0.9, 0.2, 1)';
        strip.style.transform =
            `translateX(-${(50 * 128) - offset}px)`;

        setTimeout(() => {
            if (tg) tg.HapticFeedback.notificationOccurred('success');

            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winMessage').style.opacity = '1';

            if (!state.inventory.includes(winner.id)) {
                state.inventory.push(winner.id);
                saveAll();
            }
        }, 6200);
    }, 100);
}

function closeRoulette() {
    document.getElementById('rouletteModal').classList.add('hidden');
    document.getElementById('winMessage').style.opacity = '0';
    render();
}

// --- START ---
document.addEventListener('DOMContentLoaded', async () => {
    initStars();
    await loadState();
    render();
    document.getElementById('loadingScreen').classList.add('fade-out');
});
</script>
</body>
</html>
