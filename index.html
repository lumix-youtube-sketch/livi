<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livi OS Ultimate</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #A8C4C6;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #050505;
    --card-bg: rgba(20, 20, 20, 0.6);
    --glass: rgba(255, 255, 255, 0.03);
    --border: rgba(255, 255, 255, 0.08);
    --success: #2ed573;
    --danger: #ff4757;
    --easing: cubic-bezier(0.23, 1, 0.32, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: #e0e0e0;
    max-width: 440px;
    margin: 0 auto;
    padding-bottom: 110px;
    min-height: 100vh;
    overflow-x: hidden;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
@keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 122, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(212, 175, 122, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 122, 0); } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
@keyframes dash { from { stroke-dashoffset: 100; } to { stroke-dashoffset: 0; } }

.fade-in { animation: fadeIn 0.6s var(--easing) forwards; opacity: 0; }
.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.hidden { display: none !important; }

/* --- UI COMPONENTS --- */
.header {
    position: sticky; top: 0; z-index: 50;
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px;
    background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
}

.brand { font-size: 24px; font-weight: 800; letter-spacing: -1px; background: linear-gradient(135deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

.stat-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 20px;
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    font-size: 13px; font-weight: 700; color: var(--gold);
}

/* CHARACTER */
.char-wrapper { position: relative; height: 180px; display: flex; justify-content: center; align-items: center; margin: 20px 0; }
.char-glow { position: absolute; width: 200px; height: 200px; background: radial-gradient(circle, rgba(139,154,156,0.15) 0%, transparent 70%); animation: float 6s ease-in-out infinite alternate; }

.livi-core {
    width: 120px; height: 120px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #444, #111);
    border: 2px solid rgba(255,255,255,0.1);
    position: relative; z-index: 2;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    animation: float 4s ease-in-out infinite;
}

.livi-face { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; }
.eye { width: 10px; height: 14px; background: #fff; border-radius: 10px; margin: 0 18px; animation: blink 3s infinite; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
@keyframes blink { 0%, 96%, 100% { transform: scaleY(1); } 98% { transform: scaleY(0.1); } }

/* ITEMS CSS */
.item-cap { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 80px; height: 35px; background: #D4AF7A; border-radius: 20px 20px 0 0; z-index: 10; box-shadow: inset 0 2px 5px rgba(255,255,255,0.2); }
.item-crown { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 40px; z-index: 10; filter: drop-shadow(0 0 10px gold); }
.item-glasses { position: absolute; top: 45px; width: 70px; display: flex; justify-content: space-between; z-index: 5; }
.glass-lens { width: 30px; height: 20px; background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 4px; }
.item-bowtie { position: absolute; bottom: -10px; font-size: 24px; z-index: 5; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }

/* CARDS & SECTIONS */
.card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 20px;
    margin: 0 16px 16px;
    position: relative;
    overflow: hidden;
}

.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 16px; margin-bottom: 16px; }

/* CHARTS */
.chart-container { height: 100px; width: 100%; display: flex; align-items: flex-end; gap: 4px; padding-top: 10px; }
.bar { flex: 1; background: var(--border); border-radius: 4px 4px 2px 2px; transition: height 1s var(--easing), background 0.3s; position: relative; }
.bar.active { background: linear-gradient(to top, var(--primary), var(--accent)); box-shadow: 0 0 15px rgba(139,154,156,0.3); }

.ring-chart { width: 70px; height: 70px; transform: rotate(-90deg); }
.ring-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 6; }
.ring-val { fill: none; stroke: var(--success); stroke-width: 6; stroke-linecap: round; stroke-dasharray: 188; stroke-dashoffset: 188; transition: stroke-dashoffset 1s var(--easing); }

/* BUTTONS */
.btn {
    width: 100%; padding: 16px; border-radius: 18px; border: none;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: linear-gradient(135deg, var(--primary), #5a6b6d); color: white; box-shadow: 0 4px 15px rgba(139,154,156,0.2); }
.btn-gold { background: linear-gradient(135deg, var(--gold), #b88a4d); color: #111; }

.mic-btn {
    width: 72px; height: 72px; border-radius: 50%;
    background: #111; border: 1px solid #333;
    display: flex; align-items: center; justify-content: center;
    margin: 20px auto; cursor: pointer;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transition: all 0.3s;
}
.mic-btn.active { border-color: var(--danger); background: rgba(255, 71, 87, 0.1); animation: pulse-red 1.5s infinite; }
@keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255,71,87,0.4); } 70% { box-shadow: 0 0 0 15px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }

/* SHOP */
.chest {
    padding: 20px; border-radius: 20px; position: relative; overflow: hidden;
    background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
    border: 1px solid rgba(255,255,255,0.05);
    transition: transform 0.2s;
}
.chest:active { transform: scale(0.98); }
.chest.rare { border-color: var(--gold); background: linear-gradient(145deg, #251d10, #0a0a0a); }
.chest-glow { position: absolute; inset: 0; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent); animation: shimmer 3s infinite; }

/* MODALS */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }

.roulette-track { display: flex; gap: 8px; margin: 40px 0; overflow: hidden; position: relative; mask-image: linear-gradient(90deg, transparent, #000 20%, #000 80%, transparent); }
.roulette-strip { display: flex; gap: 12px; transition: transform 0s; will-change: transform; }
.r-item { width: 100px; height: 100px; background: #151515; border: 1px solid #333; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; flex-shrink: 0; }
.r-item.legendary { border-color: var(--epic); box-shadow: inset 0 0 20px rgba(212,93,121,0.2); }

.bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(10,10,10,0.9); backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex; justify-content: space-around;
    padding: 12px 0 24px; z-index: 90;
}
.nav-btn { background: none; border: none; color: #555; font-size: 24px; padding: 10px; transition: color 0.3s, transform 0.2s; }
.nav-btn.active { color: var(--primary); transform: translateY(-2px); text-shadow: 0 0 15px rgba(139,154,156,0.4); }

</style>
</head>
<body>

<div class="header">
    <div class="brand">Livi OS</div>
    <div class="stat-pill" id="headerPoints">‚≠ê 0</div>
</div>

<div id="app"></div>

<div id="rouletteModal" class="modal-overlay" style="justify-content: center; align-items: center;">
    <h2 style="color:white; font-weight:900; letter-spacing:2px; margin-bottom:20px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div style="width:100%; position:relative;">
        <div style="position:absolute; left:50%; top:-10px; bottom:-10px; width:4px; background:var(--gold); z-index:10; transform:translateX(-2px); border-radius:2px; box-shadow: 0 0 10px var(--gold);"></div>
        <div class="roulette-track">
            <div class="roulette-strip" id="rouletteStrip"></div>
        </div>
    </div>
    <div id="winDisplay" style="text-align:center; opacity:0; transition:opacity 0.5s; margin-top:30px">
        <div style="color:#888; font-size:12px; letter-spacing:2px; margin-bottom:10px">–í–´ –ü–û–õ–£–ß–ò–õ–ò</div>
        <div id="winName" style="font-size:32px; font-weight:800; color:var(--gold); text-shadow:0 0 20px rgba(212,175,122,0.4)">–ü–†–ï–î–ú–ï–¢</div>
        <button class="btn btn-gold" style="width:200px; margin:20px auto 0;" onclick="UI.closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="noteModal" class="modal-overlay" style="background:#000;">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px">
        <h2 style="font-weight:800">–ó–∞–º–µ—Ç–∫–∞</h2>
        <div onclick="UI.closeNote()" style="padding:10px; cursor:pointer">‚úï</div>
    </div>
    <textarea id="noteInput" style="flex:1; background:#111; border:none; border-radius:12px; padding:15px; color:#eee; font-size:16px; resize:none; margin-bottom:20px; line-height:1.6" placeholder="–ì–æ–≤–æ—Ä–∏—Ç–µ –∏–ª–∏ –ø–∏—à–∏—Ç–µ..."></textarea>
    <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-bottom:10px">
        <button onclick="AI.summarize()" style="padding:8px 16px; background:#1a1a1a; border:1px solid #333; border-radius:20px; color:var(--accent); white-space:nowrap">‚ú® –ì–ª–∞–≤–Ω–∞—è –º—ã—Å–ª—å</button>
        <button onclick="AI.extractTasks()" style="padding:8px 16px; background:#1a1a1a; border:1px solid #333; border-radius:20px; color:var(--success); white-space:nowrap">‚úÖ –ù–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏</button>
        <button onclick="AI.format()" style="padding:8px 16px; background:#1a1a1a; border:1px solid #333; border-radius:20px; color:var(--gold); white-space:nowrap">üìù –§–æ—Ä–º–∞—Ç</button>
    </div>
    <button class="btn btn-primary" onclick="Core.saveNote()">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div class="bottom-nav">
    <button class="nav-btn" data-tab="home" onclick="UI.switchTab('home')">üè†</button>
    <button class="nav-btn" data-tab="tasks" onclick="UI.switchTab('tasks')">‚úÖ</button>
    <button class="nav-btn" data-tab="edu" onclick="UI.switchTab('edu')">üéôÔ∏è</button>
    <button class="nav-btn" data-tab="shop" onclick="UI.switchTab('shop')">üíé</button>
</div>

<script>
// --- CONFIG & STATE ---
const TG = window.Telegram?.WebApp;
if (TG) { TG.expand(); TG.ready(); TG.setHeaderColor('#050505'); }

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_bow', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glass', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses', html:'<div class="glass-lens"></div><div style="width:10px"></div><div class="glass-lens"></div>' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown', text:'üëë' },
    { id: 'l_mono', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-glasses', style:'justify-content:flex-end', html:'<div class="glass-lens" style="border-radius:50%; width:24px; height:24px; border-color:gold"></div>' }
];

const State = {
    user: { 
        name: TG?.initDataUnsafe?.user?.first_name || '–°—Ç—Ä–∞–Ω–Ω–∏–∫',
        points: 250,
        xp: 0 
    },
    inventory: [],
    equipped: { head: null, face: null, body: null },
    tasks: [
        { id: 1, text: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Livi OS', done: true, xp: 50 },
        { id: 2, text: '–ó–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—É—é –º—ã—Å–ª—å', done: false, xp: 100 }
    ],
    notes: [],
    history: [10, 25, 40, 30, 60, 20, 80], // Fake history for visual
    activeTab: 'home',
    recording: false
};

// --- CORE SYSTEM ---
const Core = {
    init: () => {
        const saved = localStorage.getItem('livi_v2');
        if (saved) {
            const parsed = JSON.parse(saved);
            State.user = parsed.user;
            State.inventory = parsed.inventory;
            State.equipped = parsed.equipped;
            State.tasks = parsed.tasks;
            State.notes = parsed.notes;
        }
        UI.render();
    },
    
    save: () => localStorage.setItem('livi_v2', JSON.stringify(State)),

    addPoints: (amount) => {
        State.user.points += amount;
        const el = document.getElementById('headerPoints');
        el.style.transform = 'scale(1.2)';
        el.style.color = '#fff';
        setTimeout(() => { el.style.transform = 'scale(1)'; el.style.color = 'var(--gold)'; }, 200);
        UI.updateHeader();
        Core.save();
    },

    toggleTask: (id) => {
        const t = State.tasks.find(x => x.id === id);
        if (t) {
            t.done = !t.done;
            if (t.done) {
                Core.addPoints(t.xp);
                if(TG) TG.HapticFeedback.notificationOccurred('success');
            }
            Core.save();
            UI.render();
        }
    },

    saveNote: () => {
        const text = document.getElementById('noteInput').value.trim();
        if (text) {
            State.notes.unshift({
                id: Date.now(),
                text: text,
                date: new Date().toLocaleDateString('ru-RU', {day:'numeric', month:'short'})
            });
            document.getElementById('noteInput').value = '';
            UI.closeNote();
            Core.save();
            UI.render();
        }
    }
};

// --- ADVANCED AI ENGINE ---
const AI = {
    // TF-IDF like scoring for summary
    summarize: () => {
        const el = document.getElementById('noteInput');
        const text = el.value;
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
        
        // Key markers
        const markers = ['–≤–∞–∂–Ω–æ', '—Å—É—Ç—å', '–ø–æ—ç—Ç–æ–º—É', '–≤—ã–≤–æ–¥', '–Ω–∞–¥–æ', '–∏—Ç–∞–∫'];
        let bestScore = -1;
        let bestSentence = sentences[0];

        sentences.forEach(s => {
            let score = 0;
            markers.forEach(m => { if(s.toLowerCase().includes(m)) score += 5; });
            if (s.length > 20 && s.length < 150) score += 2; // Optimal length
            if (score > bestScore) { bestScore = score; bestSentence = s; }
        });

        el.value = `üìå –ì–õ–ê–í–ù–û–ï: ${bestSentence.trim()}\n\n${text}`;
    },

    extractTasks: () => {
        const el = document.getElementById('noteInput');
        const verbs = ['—Å–¥–µ–ª–∞—Ç—å', '–∫—É–ø–∏—Ç—å', '–Ω–∞–ø–∏—Å–∞—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–æ—Ç–ø—Ä–∞–≤–∏—Ç—å', '–Ω–∞–π—Ç–∏', '–∏–∑—É—á–∏—Ç—å'];
        const lines = el.value.split(/[.!?\n]/);
        const tasks = [];

        lines.forEach(line => {
            if (verbs.some(v => line.toLowerCase().includes(v))) {
                tasks.push(`‚óªÔ∏è ${line.trim()}`);
            }
        });

        if (tasks.length) {
            el.value += `\n\nüìù –ó–ê–î–ê–ß–ò:\n${tasks.join('\n')}`;
        } else {
            alert('–Ø–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è.');
        }
    },

    format: () => {
        const el = document.getElementById('noteInput');
        let txt = el.value;
        // Auto-capitalize & spacing
        txt = txt.replace(/\s+/g, ' ');
        txt = txt.replace(/([.!?])\s*([–∞-—è—ë])/gi, (m, p1, p2) => `${p1} ${p2.toUpperCase()}`);
        // Lists
        txt = txt.replace(/(\d+)\./g, '\n$1.'); 
        txt = txt.replace(/\s-\s/g, '\n‚Ä¢ ');
        el.value = txt.trim();
    }
};

// --- UI RENDERER ---
const UI = {
    switchTab: (tab) => {
        State.activeTab = tab;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-btn[data-tab="${tab}"]`).classList.add('active');
        UI.render();
    },

    updateHeader: () => {
        document.getElementById('headerPoints').innerText = `‚≠ê ${State.user.points}`;
    },

    render: () => {
        UI.updateHeader();
        const app = document.getElementById('app');
        app.innerHTML = '';

        if (State.activeTab === 'home') UI.renderHome(app);
        if (State.activeTab === 'tasks') UI.renderTasks(app);
        if (State.activeTab === 'edu') UI.renderEdu(app);
        if (State.activeTab === 'shop') UI.renderShop(app);
    },

    renderHome: (root) => {
        const done = State.tasks.filter(t=>t.done).length;
        const total = State.tasks.length;
        const pct = Math.round((done/total)*100) || 0;
        const stroke = 188 - (188 * pct / 100);

        // Character Logic
        const h = ITEMS.find(i=>i.id===State.equipped.head);
        const f = ITEMS.find(i=>i.id===State.equipped.face);
        const b = ITEMS.find(i=>i.id===State.equipped.body);

        root.innerHTML = `
        <div class="fade-in">
            <div class="char-wrapper">
                <div class="char-glow"></div>
                <div class="livi-core">
                    ${h ? `<div class="${h.css}">${h.text||''}</div>` : ''}
                    <div class="livi-face">
                        <div class="eye"></div><div class="eye"></div>
                    </div>
                    ${f ? `<div class="${f.css}" style="${f.style||''}">${f.html||''}</div>` : ''}
                    ${b ? `<div class="${b.css}">${b.icon}</div>` : ''}
                </div>
            </div>

            <div class="grid-2">
                <div class="card" style="margin:0; display:flex; align-items:center; gap:15px">
                    <svg class="ring-chart" viewBox="0 0 70 70">
                        <circle class="ring-bg" cx="35" cy="35" r="30"></circle>
                        <circle class="ring-val" cx="35" cy="35" r="30" style="stroke-dashoffset:${stroke}"></circle>
                    </svg>
                    <div>
                        <div style="font-weight:800; font-size:20px">${pct}%</div>
                        <div style="font-size:12px; color:#888">–ü–†–û–î–£–ö–¢–ò–í–ù–û–°–¢–¨</div>
                    </div>
                </div>
                <div class="card" style="margin:0; padding:15px; display:flex; flex-direction:column; justify-content:center">
                    <div style="font-size:12px; color:#888; margin-bottom:5px">–°–¢–†–ò–ö –î–ù–Ø</div>
                    <div style="font-size:24px; font-weight:800; color:var(--primary)">üî• 3</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:#888">
                    <span>–ê–ö–¢–ò–í–ù–û–°–¢–¨ (7 –î–ù–ï–ô)</span>
                    <span>+120 XP</span>
                </div>
                <div class="chart-container">
                    ${State.history.map((h, i) => 
                        `<div class="bar delay-${i%3}" style="height:${h}%"></div>`
                    ).join('')}
                </div>
            </div>
        </div>`;
        
        // Trigger animations
        setTimeout(() => document.querySelectorAll('.bar').forEach(b => b.classList.add('active')), 100);
    },

    renderTasks: (root) => {
        const html = State.tasks.map(t => `
            <div class="card fade-in" style="display:flex; align-items:center; gap:15px; margin-bottom:10px; opacity:${t.done?0.5:1}">
                <div onclick="Core.toggleTask(${t.id})" style="min-width:24px; height:24px; border:2px solid var(--primary); border-radius:8px; display:flex; align-items:center; justify-content:center; background:${t.done?'var(--primary)':'transparent'}">
                    ${t.done ? '<svg width="14" height="14" stroke="white" stroke-width="3" viewBox="0 0 24 24" fill="none"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                </div>
                <div style="flex:1">
                    <div style="font-weight:600; text-decoration:${t.done?'line-through':''}">${t.text}</div>
                    <div style="font-size:11px; color:var(--gold)">+${t.xp} XP</div>
                </div>
            </div>
        `).join('');
        root.innerHTML = `<div style="padding:0 16px"><h2 style="margin:10px 0 20px; font-weight:800">–ó–∞–¥–∞—á–∏</h2>${html}</div>`;
    },

    renderEdu: (root) => {
        const notesHtml = State.notes.map(n => `
            <div class="card" onclick="window.editNote=${n.id}; UI.openNoteEdit(${n.id})" style="margin-bottom:10px">
                <div style="font-size:10px; color:#666; margin-bottom:5px">${n.date}</div>
                <div style="color:#ddd; font-size:14px; line-height:1.4">${n.text.slice(0, 80)}${n.text.length>80?'...':''}</div>
            </div>
        `).join('');

        root.innerHTML = `
        <div class="fade-in" style="padding:0 16px; text-align:center">
            <div class="card" style="margin:20px 0; background:linear-gradient(180deg, rgba(20,20,20,0.8), transparent)">
                <div id="waveCanvas" style="height:40px; display:flex; align-items:center; justify-content:center; gap:4px; opacity:0.5">
                    ${Array(10).fill('<div style="width:3px; height:4px; background:var(--primary); border-radius:2px; transition:height 0.1s"></div>').join('')}
                </div>
                <button class="mic-btn" id="micButton" onclick="Logic.toggleRecord()">
                    <svg width="24" height="24" stroke="white" stroke-width="2" fill="none"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </button>
                <div style="font-size:13px; color:#666; margin-top:15px">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏–ª–∏ <span style="color:var(--primary); cursor:pointer" onclick="UI.openNoteEmpty()">–≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç</span></div>
            </div>
            <div style="text-align:left">
                <h3 style="margin-bottom:15px; font-size:14px; letter-spacing:1px; color:#666">–ó–ê–ú–ï–¢–ö–ò</h3>
                ${notesHtml}
            </div>
        </div>`;
    },

    renderShop: (root) => {
        const inv = State.inventory.map(id => {
            const it = ITEMS.find(x => x.id === id);
            const isEq = Object.values(State.equipped).includes(id);
            return `<div onclick="Logic.equip('${id}')" style="background:#111; border:1px solid ${isEq?'var(--gold)':'#333'}; padding:10px; border-radius:12px; text-align:center; position:relative">
                <div style="font-size:32px">${it.icon}</div>
                ${isEq ? '<div style="position:absolute; top:5px; right:5px; width:6px; height:6px; background:var(--gold); border-radius:50%"></div>' : ''}
            </div>`;
        }).join('');

        root.innerHTML = `
        <div class="fade-in" style="padding:0 16px">
            <div class="grid-2" style="padding:0; margin-top:20px">
                <div class="chest" onclick="Logic.openBox('common', 100)">
                    <div class="chest-glow"></div>
                    <div style="font-weight:800; font-size:18px; margin-bottom:5px">–û–±—ã—á–Ω—ã–π</div>
                    <div style="font-size:12px; color:#888">–¶–µ–Ω–∞: 100 ‚≠ê</div>
                </div>
                <div class="chest rare" onclick="Logic.openBox('rare', 300)">
                    <div class="chest-glow"></div>
                    <div style="font-weight:800; font-size:18px; color:var(--gold); margin-bottom:5px">–≠–ª–∏—Ç–Ω—ã–π</div>
                    <div style="font-size:12px; color:rgba(212,175,122,0.7)">–¶–µ–Ω–∞: 300 ‚≠ê</div>
                </div>
            </div>
            <div style="background:#1a1a1a; padding:15px; border-radius:16px; margin-top:20px">
                <div style="font-size:12px; color:#666; margin-bottom:10px">–ò–ù–í–ï–ù–¢–ê–†–¨</div>
                <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px">
                    ${inv || '<div style="color:#444; font-size:12px; grid-column:1/-1">–ü—É—Å—Ç–æ...</div>'}
                </div>
            </div>
        </div>`;
    },

    openNoteEmpty: () => {
        document.getElementById('noteInput').value = '';
        document.getElementById('noteModal').classList.add('open');
    },
    openNoteEdit: (id) => {
        const n = State.notes.find(x=>x.id===id);
        if(n) {
            document.getElementById('noteInput').value = n.text;
            document.getElementById('noteModal').classList.add('open');
        }
    },
    closeNote: () => document.getElementById('noteModal').classList.remove('open'),
    closeRoulette: () => {
        document.getElementById('rouletteModal').classList.remove('open');
        document.getElementById('winDisplay').style.opacity = '0';
        UI.render();
    }
};

// --- BUSINESS LOGIC ---
const Logic = {
    toggleRecord: () => {
        State.recording = !State.recording;
        const btn = document.getElementById('micButton');
        const waves = document.getElementById('waveCanvas').children;
        
        if (State.recording) {
            btn.classList.add('active');
            if (TG) TG.HapticFeedback.impactOccurred('medium');
            
            // Speech API Init
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ru-RU';
            recognition.start();
            
            // Fake visualizer
            window.visInterval = setInterval(() => {
                Array.from(waves).forEach(w => {
                    w.style.height = Math.random() > 0.5 ? (Math.random() * 30 + 5) + 'px' : '4px';
                });
            }, 100);

            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                State.recording = false;
                clearInterval(window.visInterval);
                btn.classList.remove('active');
                document.getElementById('noteInput').value = transcript;
                document.getElementById('noteModal').classList.add('open');
            };
        } else {
            btn.classList.remove('active');
            clearInterval(window.visInterval);
        }
    },

    openBox: (type, cost) => {
        if (State.user.points < cost) return alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!');
        State.user.points -= cost;
        UI.updateHeader();
        
        // Setup Roulette
        const modal = document.getElementById('rouletteModal');
        const strip = document.getElementById('rouletteStrip');
        modal.classList.add('open');
        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0)';
        strip.innerHTML = '';

        // Generate Items Pool (weighted)
        const pool = [];
        const legendaryChance = type === 'rare' ? 0.3 : 0.05;
        
        for(let i=0; i<50; i++) {
            const isLeg = Math.random() < legendaryChance;
            const item = ITEMS.filter(x => isLeg ? x.rarity === 'legendary' : x.rarity !== 'legendary')[0] 
                         || ITEMS[0]; // Fallback
            pool.push(item);
        }
        
        // Render Strip
        pool.forEach(item => {
            const div = document.createElement('div');
            div.className = `r-item ${item.rarity}`;
            div.innerText = item.icon;
            strip.appendChild(div);
        });

        // Spin
        const winIndex = 35; // Fixed win position for visual control
        const winner = pool[winIndex];
        const cardWidth = 112; // 100px width + 12px gap
        const offset = (winIndex * cardWidth) - (window.innerWidth/2) + (cardWidth/2);

        setTimeout(() => {
            strip.style.transition = 'transform 4s cubic-bezier(0.1, 0.9, 0.2, 1)';
            strip.style.transform = `translateX(-${offset}px)`;
            
            // Haptic Feedback Simulation during spin
            let i = 0;
            const clicker = setInterval(() => {
                i++;
                if(i > 30) clearInterval(clicker);
                if(TG) TG.HapticFeedback.selectionChanged();
            }, 100);
        }, 100);

        setTimeout(() => {
            if(TG) TG.HapticFeedback.notificationOccurred('success');
            document.getElementById('winName').innerText = winner.name;
            document.getElementById('winDisplay').style.opacity = '1';
            
            if (!State.inventory.includes(winner.id)) {
                State.inventory.push(winner.id);
                Core.save();
            }
        }, 4200);
    },

    equip: (id) => {
        const item = ITEMS.find(x => x.id === id);
        const current = State.equipped[item.type];
        State.equipped[item.type] = current === id ? null : id;
        Core.save();
        UI.render();
    }
};

// Start
window.onload = Core.init;

</script>
</body>
</html>
