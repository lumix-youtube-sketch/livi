<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>livi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: white;
            max-width: 428px;
            margin: 0 auto;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* ================= SIMPLIFIED ANIMATIONS ================= */
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes gentleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0; }
        }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        
        .card-hover {
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        
        .card-hover:active {
            transform: scale(0.98);
        }

        .hidden { display: none !important; }

        /* ================= LOADING SCREEN ================= */
        
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-screen.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; visibility: hidden; }
        }

        .loading-logo {
            font-size: 64px;
            font-weight: bold;
            color: #8B9A9C;
            margin-bottom: 24px;
        }

        /* ================= UI COMPONENTS ================= */

        .onboarding-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .onboarding-box {
            width: 100%;
            max-width: 400px;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo-title {
            font-size: 48px;
            font-weight: bold;
            color: #8B9A9C;
            margin-bottom: 12px;
        }

        .logo-subtitle {
            font-size: 18px;
            color: #999;
        }

        .card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 32px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #999;
            margin-bottom: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 16px;
            background-color: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus {
            border-color: #8B9A9C;
        }

        textarea {
            min-height: 128px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 18px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B9A9C 0%, #9CB3B5 100%);
            color: white;
        }

        .btn-secondary {
            background-color: #0a0a0a;
            color: #8B9A9C;
            border: 1px solid #2a2a2a;
        }

        .btn:disabled {
            background-color: #2a2a2a;
            color: #666;
            cursor: not-allowed;
        }

        .progress-bar-container {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .progress-bar {
            height: 4px;
            flex: 1;
            border-radius: 2px;
            background-color: #2a2a2a;
        }

        .progress-bar.active {
            background-color: #8B9A9C;
        }

        .goal-button {
            width: 100%;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .goal-button.selected {
            background-color: rgba(139, 154, 156, 0.2);
            border-color: rgba(139, 154, 156, 0.4);
        }

        .goal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background-color: rgba(139, 154, 156, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .goal-content {
            flex: 1;
        }

        .goal-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: white;
        }

        .goal-desc {
            font-size: 14px;
            color: #666;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #2a2a2a;
            padding: 16px 20px 0 20px; /* Adjusted padding */
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.15s;
            border: none; /* Reset border */
            color: inherit; /* Reset color */
        }

        .stat-badge:active {
            transform: scale(0.95);
        }

        .tabs {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 0px;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab.active {
            color: white;
            border-bottom-color: #8B9A9C;
        }

        .content {
            padding: 24px 20px;
            padding-bottom: 100px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .section {
            background-color: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .habit-card {
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            background-color: #0a0a0a;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .habit-card:active {
            transform: scale(0.95);
        }

        .habit-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: #0a0a0a;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox.checked {
            background-color: #8B9A9C;
            border-color: #8B9A9C;
        }

        .task-title {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .task-points {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 8px;
            background-color: rgba(139, 154, 156, 0.25);
            color: #8B9A9C;
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            width: 100%;
            max-width: 428px;
            background-color: #0f0f0f;
            border-top: 1px solid #2a2a2a;
            border-radius: 24px 24px 0 0;
            padding: 32px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-handle {
            width: 48px;
            height: 4px;
            background-color: #2a2a2a;
            border-radius: 2px;
            margin: 0 auto 24px;
        }

        /* ================= LIVI CHARACTER WITH FACE ================= */
        
        .livi-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 0;
        }

        .livi-circle {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: gentleFloat 4s ease-in-out infinite;
        }

        .livi-face {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .livi-eyes {
            position: absolute;
            top: 35%;
            width: 60%;
            display: flex;
            justify-content: space-around;
        }

        .livi-eye {
            width: 10px;
            height: 10px;
            background-color: white;
            border-radius: 50%;
            animation: blink 5s infinite;
        }

        .livi-mouth {
            position: absolute;
            bottom: 35%;
            width: 30%;
            height: 3px;
            background-color: white;
            border-radius: 2px;
        }

        .livi-mouth.happy {
            border-radius: 0 0 20px 20px;
            height: 15px;
            background: transparent;
            border: 3px solid white;
            border-top: none;
        }

        .livi-mouth.sad {
            border-radius: 20px 20px 0 0;
            height: 15px;
            background: transparent;
            border: 3px solid white;
            border-bottom: none;
        }

        .livi-speech {
            margin-top: 16px;
            padding: 12px 20px;
            background-color: #0a0a0a;
            border-radius: 16px;
            font-size: 14px;
            text-align: center;
            max-width: 280px;
            animation: fadeIn 0.5s ease-out;
        }

        /* ================= NEW INTERACTIVE CHARTS & SVG ================= */
        
        .chart-container {
            position: relative;
            background-color: #0a0a0a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            height: 220px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è SVG */
        }

        .chart-tooltip {
            position: absolute;
            background: #2a2a2a;
            border: 1px solid #8B9A9C;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: white;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            transform: translate(-50%, -130%);
            white-space: nowrap;
            z-index: 10;
        }
        
        .chart-tooltip.visible {
            opacity: 1;
        }

        .chart-dot {
            cursor: pointer;
            transition: r 0.2s;
        }
        
        .chart-dot:hover {
            r: 6;
        }

        /* Radar Chart styles */
        .radar-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .radar-axis { stroke: #333; stroke-width: 1; }
        .radar-web { fill: none; stroke: #333; stroke-width: 1; }
        .radar-area { fill: rgba(139, 154, 156, 0.4); stroke: #8B9A9C; stroke-width: 2; }
        .radar-label { font-size: 12px; fill: #999; }
        
        /* ================= CHALLENGE CARD UPDATED ================= */
        
        /* –¢–µ–º–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è —á–µ–ª–ª–µ–Ω–¥–∂–∞, —á—Ç–æ–±—ã —Å–ª–∏–≤–∞–ª—Å—è —Å —Ñ–æ–Ω–æ–º */
        .challenge-card {
            background-color: #0f0f0f; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ */
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: bold;
        }

        .challenge-badge {
            padding: 4px 12px;
            background-color: rgba(212, 175, 122, 0.2);
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: #D4AF7A;
        }

        .challenge-description {
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }

        .challenge-progress {
            margin-bottom: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        .progress-track {
            height: 8px;
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #D4AF7A 0%, #FFD700 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .delete-btn {
            padding: 8px;
            background-color: rgba(255, 68, 68, 0.2);
            border-radius: 8px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .delete-btn:active {
            opacity: 0.7;
        }

        svg {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">livi</div>
    </div>

    <div id="app"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const colors = {
            primary: '#8B9A9C',
            secondary: '#B8A8C7',
            accent1: '#9CB3B5',
            accent2: '#A8B5C7',
            accent3: '#A5BDA1',
            warning: '#D4AF7A',
        };

        const dailyChallenges = [
            { title: '10 –æ—Ç–∂–∏–º–∞–Ω–∏–π', description: '–°–¥–µ–ª–∞–π 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π', target: 10, unit: '—Ä–∞–∑', category: '–°–ø–æ—Ä—Ç', icon: 'üí™' },
            { title: '–°—Ç–∞–∫–∞–Ω –≤–æ–¥—ã', description: '–ù–∞—á–Ω–∏ —É—Ç—Ä–æ —Å–æ —Å—Ç–∞–∫–∞–Ω–∞ –≤–æ–¥—ã', target: 1, unit: '—Å—Ç–∞–∫–∞–Ω', category: '–ó–¥–æ—Ä–æ–≤—å–µ', icon: 'üíß' },
            { title: '–ß—Ç–µ–Ω–∏–µ 5 —Å—Ç—Ä', description: '–ü—Ä–æ—á–∏—Ç–∞–π –Ω–µ–º–Ω–æ–≥–æ –∏–∑ –ª—é–±–∏–º–æ–π –∫–Ω–∏–≥–∏', target: 5, unit: '—Å—Ç—Ä', category: '–û–±—É—á–µ–Ω–∏–µ', icon: 'üìö' },
            { title: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è 5 –º–∏–Ω', description: '–ü—Ä–æ—Å—Ç–æ –ø–æ—Å–∏–¥–∏ –≤ —Ç–∏—à–∏–Ω–µ', target: 5, unit: '–º–∏–Ω', category: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å', icon: 'üßò' },
            { title: '–ü—Ä–æ–≥—É–ª–∫–∞', description: '–ü—Ä–æ–π–¥–∏—Å—å —Ö–æ—Ç—è –±—ã 15 –º–∏–Ω—É—Ç', target: 15, unit: '–º–∏–Ω', category: '–°–ø–æ—Ä—Ç', icon: 'üö∂' }
        ];

        const getInitialState = () => ({
            hasCompletedOnboarding: false,
            onboardingStep: 0,
            activeTab: 'home',
            showRankModal: false,
            selectedHabit: null,
            newTask: '',
            userGoals: {
                health: false,
                learning: false,
                productivity: false,
                mindfulness: false,
                sleep: false,
                social: false
            },
            userInfo: {
                name: '',
                wakeUpTime: '07:00',
                sleepTime: '23:00',
                mainGoal: ''
            },
            tasks: [],
            habits: [],
            streak: 0,
            totalPoints: 0,
            lastActiveDate: new Date().toDateString(),
            dailyChallenge: null,
            challengeProgress: 0,
            
            // –ù–û–í–û–ï: –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
            history: {} // Format: { "YYYY-MM-DD": { tasksCompleted: 5, habitsCompleted: 2, score: 70 } }
        });

        let state = getInitialState();
        const tg = window.Telegram?.WebApp || { expand: () => {}, ready: () => {}, CloudStorage: null };
        tg.expand();
        tg.ready();

        async function loadState() {
            try {
                // –î–ª—è –¥–µ–º–æ/—Ç–µ—Å—Ç–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage –µ—Å–ª–∏ –Ω–µ—Ç –æ–±–ª–∞–∫–∞
                const local = localStorage.getItem('livi_state');
                if (local) {
                    state = { ...getInitialState(), ...JSON.parse(local) };
                }

                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.getItem('livi_state', (error, value) => {
                            if (!error && value) {
                                try {
                                    const loaded = JSON.parse(value);
                                    state = { ...state, ...loaded }; // Merge
                                } catch (e) {}
                            }
                            resolve();
                        });
                    });
                }
            } catch (e) {}
        }

        async function saveState() {
            try {
                localStorage.setItem('livi_state', JSON.stringify(state)); // Backup
                if (tg.CloudStorage) {
                    return new Promise((resolve) => {
                        tg.CloudStorage.setItem('livi_state', JSON.stringify(state), () => resolve());
                    });
                }
            } catch (e) {}
        }

        // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–ê–õ–¨–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function updateDailyStats() {
            const key = getTodayKey();
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const completedHabits = state.habits.filter(h => h.completed).length;
            const totalItems = (state.tasks.length || 1) + (state.habits.length || 1);
            
            // –†–∞—Å—á–µ—Ç —Å—á–µ—Ç–∞ –¥–Ω—è (0-100)
            const score = Math.min(100, Math.round(((completedTasks + completedHabits) / totalItems) * 100));

            state.history[key] = {
                tasks: completedTasks,
                habits: completedHabits,
                score: score,
                date: key
            };
            saveState();
        }

        function getLast7DaysData() {
            const days = [];
            const result = [];
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('ru-RU', { weekday: 'short' });
                
                const dayData = state.history[key] || { score: 0, tasks: 0, habits: 0 };
                result.push({
                    day: dayName,
                    val: dayData.score,
                    raw: dayData
                });
            }
            return result;
        }

        // --- CORE LOGIC ---

        function getDailyChallenge() {
            const today = new Date().toDateString();
            if (!state.dailyChallenge || state.dailyChallenge.date !== today) {
                const dayIndex = Math.floor(Date.now() / 86400000) % dailyChallenges.length;
                state.dailyChallenge = {
                    ...dailyChallenges[dayIndex],
                    date: today,
                    completed: false
                };
                state.challengeProgress = 0;
                saveState();
            }
            return state.dailyChallenge;
        }

        function updateStreak() {
            const today = new Date().toDateString();
            if (state.lastActiveDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (state.lastActiveDate === yesterday.toDateString()) {
                    state.streak++;
                } else {
                    // Reset streak if missed more than 1 day? Or allow freeze?
                    // For now simple logic:
                    if (state.lastActiveDate !== today) { 
                        // Just logged in today
                    }
                }
                state.lastActiveDate = today;
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –µ—Å–ª–∏ –Ω–µ—Ç
                updateDailyStats(); 
                saveState();
            }
        }

        function createSvg(name, color = 'currentColor') {
            const icons = {
                arrowRight: '<line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>',
                heart: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
                book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
                target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
                brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/>',
                moon: '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
                coffee: '<path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>',
                sunrise: '<path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                sparkles: '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>',
                flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
                star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
                clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                award: '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>',
                trendingUp: '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
            };
            return `<svg width="24" height="24" viewBox="0 0 24 24" style="color: ${color}">${icons[name]}</svg>`;
        }

        function getLiviState(energy, completion, habits) {
            const avgScore = (energy + completion + (habits / 4 * 100)) / 3;
            if (avgScore >= 85) return { size: 120, color: colors.primary, innerSize: 80, label: '–ü—Ä–æ—Ü–≤–µ—Ç–∞—é—â–∏–π', mood: 'happy', phrase: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ! üåü' };
            if (avgScore >= 70) return { size: 110, color: colors.primary, innerSize: 75, label: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π', mood: 'happy', phrase: '–•–æ—Ä–æ—à–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å! –ü—Ä–æ–¥–æ–ª–∂–∞–π! üí™' };
            if (avgScore >= 50) return { size: 100, color: colors.primary, innerSize: 70, label: '–§–æ—Ä–º–∏—Ä—É—é—â–∏–π—Å—è', mood: 'neutral', phrase: '–¢—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏! üå±' };
            return { size: 90, color: '#666', innerSize: 60, label: '–ó–∞—Ä–æ–∂–¥–∞—é—â–∏–π—Å—è', mood: 'sad', phrase: '–ù–∞—á–Ω–∏ —Å –º–∞–ª–æ–≥–æ, –≤—Å–µ –ø–æ–ª—É—á–∏—Ç—Å—è! üåü' };
        }

        function getRank(streakDays) {
            if (streakDays >= 100) return { title: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', level: 6, color: '#FFD700', min: 100 };
            if (streakDays >= 50) return { title: '–ú–∞—Å—Ç–µ—Ä', icon: '‚≠ê', level: 5, color: colors.warning, min: 50 };
            if (streakDays >= 30) return { title: '–ü—Ä–æ—Ñ–∏', icon: 'üî•', level: 4, color: colors.accent3, min: 30 };
            if (streakDays >= 14) return { title: '–≠–Ω—Ç—É–∑–∏–∞—Å—Ç', icon: 'üí™', level: 3, color: colors.primary, min: 14 };
            if (streakDays >= 7) return { title: '–°—Ç–∞—Ä—Ç–µ—Ä', icon: 'üå±', level: 2, color: colors.accent2, min: 7 };
            return { title: '–ù–æ–≤–∏—á–æ–∫', icon: 'üåü', level: 1, color: colors.secondary, min: 0 };
        }

        function generateAIAnalysis() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const totalTasks = state.tasks.length || 1;
            const completionRate = (completedTasks / totalTasks) * 100;
            const activeHabits = state.habits.filter(h => h.completed).length;
            const totalHabits = state.habits.length || 1;
            const habitRate = (activeHabits / totalHabits) * 100;
            const avgEnergy = (completionRate + habitRate) / 2;

            return {
                completionRate: Math.round(completionRate),
                avgEnergy: Math.round(avgEnergy),
                activeHabits,
                habitRate: Math.round(habitRate)
            };
        }

        // --- NEW SVG CHARTS ---

        function renderRealInteractiveChart(data) {
            // data format: [{day: '–ü–ù', val: 50, raw: {...}}, ...]
            const height = 150;
            const width = 100; // viewBox units
            const padding = 20;
            const chartHeight = height - padding * 2;
            
            // X step
            const xStep = width / (data.length - 1);
            
            // Generate Path
            let pathD = `M 0 ${height - padding - (data[0].val / 100 * chartHeight)}`;
            data.forEach((d, i) => {
                const x = i * xStep;
                const y = height - padding - (d.val / 100 * chartHeight);
                pathD += ` L ${x} ${y}`;
            });
            
            // Generate Area
            const areaD = pathD + ` L ${width} ${height} L 0 ${height} Z`;
            
            // Generate Dots & Tooltips
            let dotsHtml = '';
            data.forEach((d, i) => {
                const x = i * xStep;
                const y = height - padding - (d.val / 100 * chartHeight);
                const tooltipText = `${d.day}: ${d.val}% (–ó–∞–¥–∞—á–∏: ${d.raw.tasks})`;
                
                dotsHtml += `
                    <g onclick="showTooltip(this, '${tooltipText}')">
                        <circle cx="${x}" cy="${y}" r="3" fill="#1a1a1a" stroke="#8B9A9C" stroke-width="2" class="chart-dot"/>
                        <rect x="${x - 5}" y="0" width="10" height="${height}" fill="transparent" />
                    </g>
                `;
            });

            return `
                <div class="chart-container">
                    <div class="chart-title">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)</div>
                    <div id="chartTooltip" class="chart-tooltip"></div>
                    <svg viewBox="0 0 100 ${height}" preserveAspectRatio="none" style="width: 100%; height: 160px; overflow: visible;">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#8B9A9C" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="#8B9A9C" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        <path d="${areaD}" fill="url(#chartGradient)" />
                        <path d="${pathD}" stroke="#8B9A9C" stroke-width="1.5" fill="none" />
                        ${dotsHtml}
                    </svg>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 10px; color: #666;">
                        ${data.map(d => `<span>${d.day}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function renderRadarChart(stats) {
            // Stats: { tasks: 0-100, habits: 0-100, energy: 0-100 }
            const size = 200;
            const center = size / 2;
            const radius = 80;
            
            const metrics = [
                { label: '–ó–∞–¥–∞—á–∏', val: stats.completionRate },
                { label: '–ü—Ä–∏–≤—ã—á–∫–∏', val: stats.habitRate },
                { label: '–¢–æ–Ω—É—Å', val: stats.avgEnergy } // Streak-like metric
            ];
            
            // Calculate coords
            const points = metrics.map((m, i) => {
                const angle = (Math.PI * 2 * i) / metrics.length - Math.PI / 2;
                const r = (m.val / 100) * radius;
                return [
                    center + r * Math.cos(angle),
                    center + r * Math.sin(angle)
                ];
            }).map(p => p.join(',')).join(' ');

            // Background Web
            let web = '';
            [0.3, 0.6, 1].forEach(scale => {
                const webPoints = metrics.map((m, i) => {
                    const angle = (Math.PI * 2 * i) / metrics.length - Math.PI / 2;
                    const r = radius * scale;
                    return [center + r * Math.cos(angle), center + r * Math.sin(angle)].join(',');
                }).join(' ');
                web += `<polygon points="${webPoints}" class="radar-web" stroke-opacity="${scale === 1 ? 1 : 0.3}"/>`;
            });
            
            // Axis lines
            let axes = metrics.map((m, i) => {
                const angle = (Math.PI * 2 * i) / metrics.length - Math.PI / 2;
                const x = center + radius * Math.cos(angle);
                const y = center + radius * Math.sin(angle);
                return `<line x1="${center}" y1="${center}" x2="${x}" y2="${y}" class="radar-axis" stroke-opacity="0.3"/>`;
            }).join('');
            
            // Labels
            let labels = metrics.map((m, i) => {
                 const angle = (Math.PI * 2 * i) / metrics.length - Math.PI / 2;
                 const x = center + (radius + 20) * Math.cos(angle);
                 const y = center + (radius + 15) * Math.sin(angle);
                 return `<text x="${x}" y="${y}" text-anchor="middle" class="radar-label" fill="#ccc">${m.label}</text>`;
            }).join('');

            return `
                <div class="radar-container">
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                        ${web}
                        ${axes}
                        <polygon points="${points}" class="radar-area"/>
                        ${labels}
                        <circle cx="${center}" cy="${center}" r="3" fill="#8B9A9C"/>
                    </svg>
                </div>
            `;
        }

        // --- RENDER HELPERS ---

        function renderLiviWithFace(liviState) {
            const mouthClass = liviState.mood === 'happy' ? 'happy' : 
                              liviState.mood === 'sad' ? 'sad' : '';
            
            return `
                <div class="livi-character">
                    <div class="livi-circle" style="width: ${liviState.size}px; height: ${liviState.size}px; background-color: ${liviState.color}20; border: 2px solid ${liviState.color};">
                        <div style="width: ${liviState.innerSize}px; height: ${liviState.innerSize}px; background-color: ${liviState.color}40; border: 1px solid ${liviState.color}; border-radius: 50%;"></div>
                        <div class="livi-face">
                            <div class="livi-eyes">
                                <div class="livi-eye"></div>
                                <div class="livi-eye"></div>
                            </div>
                            <div class="livi-mouth ${mouthClass}"></div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; font-size: 18px; font-weight: bold; color: ${liviState.color};">${liviState.label}</div>
                    <div class="livi-speech">${liviState.phrase}</div>
                </div>
            `;
        }

        // –ß–ï–õ–õ–ï–ù–î–ñ –í –û–¢–î–ï–õ–¨–ù–û–ô –í–ö–õ–ê–î–ö–ï (–¢–ï–ú–ù–´–ô –°–¢–ò–õ–¨)
        function renderDailyChallengeTab() {
            const challenge = getDailyChallenge();
            const progress = (state.challengeProgress / challenge.target) * 100;
            
            return `
                <div class="section">
                     <h2 class="section-title">–ß–µ–ª–ª–µ–¥–∂ –¥–Ω—è</h2>
                     <p style="color: #999; margin-bottom: 20px;">–í—ã–ø–æ–ª–Ω—è–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å—Ç—Ä–∏–∫ –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ –æ—á–∫–æ–≤.</p>

                    <div class="challenge-card">
                        <div class="challenge-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 32px; background: rgba(255,255,255,0.05); width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">${challenge.icon}</div>
                                <div>
                                    <div class="challenge-title">${challenge.title}</div>
                                    <div class="challenge-badge" style="margin-top: 4px; display: inline-block;">+50 –±–∞–ª–ª–æ–≤</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="challenge-description" style="margin-top: 12px; font-size: 16px;">${challenge.description}</div>
                        
                        <div class="challenge-progress" style="margin-top: 20px;">
                            <div class="progress-label">
                                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span><strong>${state.challengeProgress}</strong> / ${challenge.target} ${challenge.unit}</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%;"></div>
                            </div>
                        </div>
                        ${!challenge.completed ? `
                            <button class="btn btn-primary" id="completeChallenge" style="margin-top: 24px;">
                                ${progress >= 100 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂ üéâ' : '–í–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å'}
                            </button>
                        ` : `
                            <div style="text-align: center; padding: 12px; background-color: rgba(165, 189, 161, 0.2); border-radius: 12px; margin-top: 24px;">
                                <strong style="color: ${colors.accent3};">‚úì –ß–µ–ª–ª–µ–Ω–¥–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω!</strong>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.hasCompletedOnboarding) {
                app.innerHTML = renderOnboarding();
                attachOnboardingListeners();
                return;
            }

            updateStreak();
            updateDailyStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ
            app.innerHTML = renderMain();
            attachMainListeners();
        }

        // (Onboarding function stays exactly the same as in your code - omitted for brevity in thought, but included in output)
        function renderOnboarding() {
             // ... existing onboarding code ...
             // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–æ–º–Ω—ã–π –∫—É—Å–æ–∫, —è –∏—Å–ø–æ–ª—å–∑—É—é —Ç–æ—Ç –∂–µ –∫–æ–¥
             const steps = [
                {
                    title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ livi! üëã',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏',
                    content: `
                        <div style="text-align: center;">
                            <p style="font-size: 18px; color: #999; margin-bottom: 24px;">
                                –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ–ø—ã—Ç
                            </p>
                            <button class="btn btn-primary" id="startOnboarding">
                                –ù–∞—á–∞—Ç—å ${createSvg('arrowRight', 'white')}
                            </button>
                        </div>
                    `
                },
                {
                    title: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?',
                    subtitle: '–î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è',
                    content: `
                        <div>
                            <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="${state.userInfo.name}" style="margin-bottom: 24px;">
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à–∏ —Ü–µ–ª–∏',
                    subtitle: '–í—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞–¥ —á–µ–º —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å',
                    content: `
                        <div>
                            ${[
                                { key: 'health', icon: 'heart', label: '–ó–¥–æ—Ä–æ–≤—å–µ', desc: '–°–ø–æ—Ä—Ç, –ø–∏—Ç–∞–Ω–∏–µ, —Å–æ–Ω' },
                                { key: 'learning', icon: 'book', label: '–û–±—É—á–µ–Ω–∏–µ', desc: '–ß—Ç–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, –Ω–∞–≤—ã–∫–∏' },
                                { key: 'productivity', icon: 'target', label: '–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', desc: '–ó–∞–¥–∞—á–∏, –ø—Ä–æ–µ–∫—Ç—ã, —Ä–∞–±–æ—Ç–∞' },
                                { key: 'mindfulness', icon: 'brain', label: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å', desc: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è, –¥—ã—Ö–∞–Ω–∏–µ' },
                                { key: 'sleep', icon: 'moon', label: '–°–æ–Ω', desc: '–†–µ–∂–∏–º, –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞' },
                                { key: 'social', icon: 'coffee', label: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å', desc: '–î—Ä—É–∑—å—è, —Ö–æ–±–±–∏' }
                            ].map(goal => `
                                <button class="goal-button ${state.userGoals[goal.key] ? 'selected' : ''}" data-goal="${goal.key}">
                                    <div class="goal-icon">${createSvg(goal.icon, colors.primary)}</div>
                                    <div class="goal-content">
                                        <div class="goal-title">${goal.label}</div>
                                        <div class="goal-desc">${goal.desc}</div>
                                    </div>
                                    ${state.userGoals[goal.key] ? createSvg('check', colors.primary) : ''}
                                </button>
                            `).join('')}
                            <button class="btn btn-primary" id="nextStep" style="margin-top: 24px;" ${!Object.values(state.userGoals).some(v => v) ? 'disabled' : ''}>
                                –î–∞–ª–µ–µ
                            </button>
                        </div>
                    `
                },
                {
                    title: '–í–∞—à —Ä–µ–∂–∏–º',
                    subtitle: '–ö–æ–≥–¥–∞ –≤—ã –æ–±—ã—á–Ω–æ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç–µ—Å—å –∏ –ª–æ–∂–∏—Ç–µ—Å—å —Å–ø–∞—Ç—å?',
                    content: `
                        <div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('sunrise', colors.warning)} –í—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
                                </label>
                                <input type="time" id="wakeUpTime" value="${state.userInfo.wakeUpTime}">
                            </div>
                            <div style="margin-bottom: 24px;">
                                <label class="form-label">
                                    ${createSvg('moon', colors.secondary)} –í—Ä–µ–º—è —Å–Ω–∞
                                </label>
                                <input type="time" id="sleepTime" value="${state.userInfo.sleepTime}">
                            </div>
                            <button class="btn btn-primary" id="nextStep">–î–∞–ª–µ–µ</button>
                        </div>
                    `
                },
                {
                    title: '–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥!',
                    subtitle: '–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü?',
                    content: `
                        <div>
                            <textarea id="mainGoal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∏—Ç–∞—Ç—å 30 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –ø—Ä–æ–±–µ–∂–∞—Ç—å 5–∫–º, –≤—ã—É—á–∏—Ç—å 500 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤...">${state.userInfo.mainGoal}</textarea>
                            <button class="btn btn-primary" id="completeOnboarding" style="margin-top: 24px;">
                                –ù–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ ${createSvg('sparkles', 'white')}
                            </button>
                        </div>
                    `
                }
            ];

            const currentStep = steps[state.onboardingStep];

            return `
                <div class="onboarding-container slide-up">
                    <div class="onboarding-box">
                        ${state.onboardingStep === 0 ? `
                            <div class="logo-section">
                                <h1 class="logo-title">livi</h1>
                                <p class="logo-subtitle">–í–∞—à –ø—É—Ç—å –∫ –ª—É—á—à–µ–π –≤–µ—Ä—Å–∏–∏ —Å–µ–±—è</p>
                            </div>
                        ` : `
                            <div class="progress-bar-container">
                                ${steps.slice(1).map((_, i) => `
                                    <div class="progress-bar ${i < state.onboardingStep ? 'active' : ''}"></div>
                                `).join('')}
                            </div>
                        `}
                        <div class="card">
                            <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 8px; color: white;">${currentStep.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 32px;">${currentStep.subtitle}</p>
                            ${currentStep.content}
                        </div>
                        ${state.onboardingStep > 0 ? `
                            <button id="prevStep" style="margin-top: 16px; width: 100%; padding: 12px; background: none; border: none; color: #666; cursor: pointer; font-weight: 500;">
                                –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Listeners for onboarding
        function attachOnboardingListeners() {
            const startBtn = document.getElementById('startOnboarding');
            const nextBtn = document.getElementById('nextStep');
            const prevBtn = document.getElementById('prevStep');
            const completeBtn = document.getElementById('completeOnboarding');
            const goalButtons = document.querySelectorAll('[data-goal]');
            const userName = document.getElementById('userName');

            if (startBtn) startBtn.addEventListener('click', () => { state.onboardingStep = 1; render(); });
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (state.onboardingStep === 1 && userName) state.userInfo.name = userName.value.trim();
                    if (state.onboardingStep === 3) {
                        state.userInfo.wakeUpTime = document.getElementById('wakeUpTime').value;
                        state.userInfo.sleepTime = document.getElementById('sleepTime').value;
                    }
                    state.onboardingStep++;
                    render();
                });
            }
            if (prevBtn) prevBtn.addEventListener('click', () => { state.onboardingStep--; render(); });
            if (completeBtn) {
                completeBtn.addEventListener('click', async () => {
                    state.userInfo.mainGoal = document.getElementById('mainGoal').value.trim();
                    state.hasCompletedOnboarding = true;
                    state.streak = 1;
                    state.lastActiveDate = new Date().toDateString();
                    
                    const habitsByGoal = {
                        health: { name: '–ó–∞—Ä—è–¥–∫–∞', color: colors.accent3 },
                        learning: { name: '–ß—Ç–µ–Ω–∏–µ', color: colors.accent2 },
                        productivity: { name: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', color: colors.primary },
                        mindfulness: { name: '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', color: colors.secondary },
                        sleep: { name: '–°–æ–Ω 8 —á–∞—Å–æ–≤', color: colors.accent1 },
                        social: { name: '–û–±—â–µ–Ω–∏–µ', color: colors.warning }
                    };
                    
                    state.habits = Object.entries(state.userGoals)
                        .filter(([_, selected]) => selected)
                        .map(([goal], index) => ({
                            id: Date.now() + index,
                            name: habitsByGoal[goal].name,
                            color: habitsByGoal[goal].color,
                            streak: 0,
                            completed: false,
                            lastCompletedDate: null
                        }));
                    
                    await saveState();
                    render();
                });
            }
            goalButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const goal = btn.dataset.goal;
                    state.userGoals[goal] = !state.userGoals[goal];
                    render();
                });
            });
        }

        function renderMain() {
            const completedTasks = state.tasks.filter(t => t.completed).length;
            const currentRank = getRank(state.streak);
            const aiAnalysis = generateAIAnalysis();

            // –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ "–ß–µ–ª–ª–µ–Ω–¥–∂"
            return `
                <div class="header">
                    <div class="header-top">
                        <div class="header-title">livi</div>
                        <div class="header-stats">
                            <button class="stat-badge" style="background-color: rgba(212, 175, 122, 0.2);" id="showRank">
                                ${createSvg('flame', colors.warning)}
                                <span>${state.streak}</span>
                            </button>
                            <button class="stat-badge" style="background-color: rgba(139, 154, 156, 0.2);">
                                ${createSvg('star', colors.primary)}
                                <span>${state.totalPoints}</span>
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        ${['home', 'tasks', 'challenge', 'analysis'].map(tab => `
                            <div class="tab ${state.activeTab === tab ? 'active' : ''}" data-tab="${tab}">
                                ${tab === 'home' ? '–ì–ª–∞–≤–Ω–∞—è' : tab === 'tasks' ? '–ó–∞–¥–∞—á–∏' : tab === 'challenge' ? '–ß–µ–ª–ª–µ–Ω–¥–∂' : '–ê–Ω–∞–ª–∏–∑'}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="content">
                    <div id="tabContent">${renderTabContent(completedTasks, currentRank, aiAnalysis)}</div>
                </div>
                ${state.showRankModal ? renderRankModal(currentRank) : ''}
            `;
        }

        function renderTabContent(completedTasks, currentRank, aiAnalysis) {
            if (state.activeTab === 'home') {
                const liviState = getLiviState(aiAnalysis.avgEnergy, aiAnalysis.completionRate, aiAnalysis.activeHabits);
                const realChartData = getLast7DaysData();

                return `
                    <div class="section">
                        ${renderLiviWithFace(liviState)}
                    </div>

                    <div class="grid-2">
                        <div class="stat-card card-hover">
                            ${createSvg('target', colors.primary)}
                            <div class="stat-value">${completedTasks}/${state.tasks.length}</div>
                            <div class="stat-label">–ó–∞–¥–∞—á–∏</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('clock', colors.accent3)}
                            <div class="stat-value">${state.habits.filter(h => h.completed).length}/${state.habits.length}</div>
                            <div class="stat-label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('zap', colors.warning)}
                            <div class="stat-value">${aiAnalysis.avgEnergy}%</div>
                            <div class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                        </div>
                        <div class="stat-card card-hover">
                            ${createSvg('award', currentRank.color)}
                            <div class="stat-value">${currentRank.icon}</div>
                            <div class="stat-label">${currentRank.title}</div>
                        </div>
                    </div>

                    <div class="section">
                        ${renderRealInteractiveChart(realChartData)}
                    </div>

                    <div class="section">
                        <h2 class="section-title">–ü—Ä–∏–≤—ã—á–∫–∏</h2>
                        ${state.habits.length > 0 ? `
                            <div class="habit-grid">
                                ${state.habits.map(habit => `
                                    <div class="habit-card card-hover" data-habit="${habit.id}" style="background-color: ${habit.completed ? habit.color + '15' : '#0a0a0a'}; border-color: ${habit.completed ? habit.color + '40' : '#2a2a2a'};">
                                        <div class="habit-icon" style="background-color: ${habit.color}30;">
                                            <div style="font-size: 24px;">${habit.completed ? '‚úì' : '‚óã'}</div>
                                        </div>
                                        <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px;">${habit.name}</div>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            ${createSvg('flame', colors.warning)}
                                            <span style="font-size: 16px; font-weight: bold;">${habit.streak}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üå±</div>
                                <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</p>
                            </div>
                        `}
                    </div>

                    <div class="section">
                        <h2 class="section-title">–°–µ–≥–æ–¥–Ω—è</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.slice(0, 4).map(task => `
                                <div class="task-item">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">+${task.points}</div>
                                </div>
                            `).join('')}
                            ${state.tasks.length > 4 ? `
                                <button class="btn btn-secondary" id="goToTasks" style="margin-top: 16px;">–í—Å–µ –∑–∞–¥–∞—á–∏ ‚Üí</button>
                            ` : ''}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ú®</div>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏!</p>
                                <button class="btn btn-primary" id="goToTasks" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                            </div>
                        `}
                    </div>
                `;
            } else if (state.activeTab === 'challenge') {
                return renderDailyChallengeTab();
            } else if (state.activeTab === 'tasks') {
                return `
                    <div class="section">
                        <h2 class="section-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="newTaskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" value="${state.newTask}" style="flex: 1; padding: 12px 16px;">
                            <button class="btn btn-primary" id="addTask" style="width: auto; padding: 12px 16px;">
                                ${createSvg('plus', 'white')}
                            </button>
                        </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">–í—Å–µ –∑–∞–¥–∞—á–∏</h2>
                        ${state.tasks.length > 0 ? `
                            ${state.tasks.map(task => `
                                <div class="task-item">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" data-task-check="${task.id}">
                                        ${task.completed ? createSvg('check', 'white') : ''}
                                    </div>
                                    <div class="task-title" style="color: ${task.completed ? '#666' : 'white'}; text-decoration: ${task.completed ? 'line-through' : 'none'};">
                                        ${task.title}
                                    </div>
                                    <div class="task-points">${task.category || '–û–±—â–µ–µ'}</div>
                                    <button class="delete-btn" data-delete="${task.id}">
                                        ${createSvg('trash', '#ff4444')}
                                    </button>
                                </div>
                            `).join('')}
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á</p>
                            </div>
                        `}
                    </div>
                `;
            } else if (state.activeTab === 'analysis') {
                return `
                    <div class="section">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                            ${createSvg('brain', colors.primary)}
                            <div>
                                <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">–£–º–Ω—ã–π –ê–Ω–∞–ª–∏–∑</h2>
                                <p style="font-size: 14px; color: #999;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px; text-align: center;">
                            <h3 style="font-size: 16px; margin-bottom: 16px; color: #666;">–ë–∞–ª–∞–Ω—Å –¥–Ω—è</h3>
                            ${renderRadarChart(aiAnalysis)}
                        </div>

                        <div class="grid-2" style="margin-bottom: 24px;">
                            <div style="padding: 20px; border-radius: 12px; background-color: rgba(139, 154, 156, 0.15); text-align: center;">
                                <div style="font-size: 36px; font-weight: bold; margin-bottom: 4px;">${aiAnalysis.completionRate}%</div>
                                <div style="font-size: 12px; font-weight: 500; color: #999;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>
                            </div>
                            <div style="padding: 20px; border-radius: 12px; background-color: rgba(165, 189, 161, 0.15); text-align: center;">
                                <div style="font-size: 36px; font-weight: bold; margin-bottom: 4px;">${aiAnalysis.habitRate}%</div>
                                <div style="font-size: 12px; font-weight: 500; color: #999;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–≤—ã—á–µ–∫</div>
                            </div>
                        </div>

                        ${renderRealInteractiveChart(getLast7DaysData())}

                        ${state.userInfo.mainGoal ? `
                            <div style="padding: 16px; border-radius: 12px; background-color: rgba(212, 175, 122, 0.15); border: 1px solid rgba(212, 175, 122, 0.3); margin-top: 24px;">
                                <p style="font-size: 12px; font-weight: bold; color: ${colors.warning}; margin-bottom: 8px;">üéØ –í–ê–®–ê –ì–õ–ê–í–ù–ê–Ø –¶–ï–õ–¨</p>
                                <p style="font-size: 14px;">${state.userInfo.mainGoal}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // Rank Modal stays same
        function renderRankModal(currentRank) {
            const nextRank = getRank(currentRank.min + 1);
            const progressToNext = currentRank.min === 100 ? 100 : ((state.streak - currentRank.min) / (nextRank.min - currentRank.min)) * 100;

            return `
                <div class="modal fade-in" id="rankModal">
                    <div class="modal-content slide-up" onclick="event.stopPropagation();">
                        <div class="modal-handle"></div>
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">${currentRank.icon}</div>
                            <h2 style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${currentRank.title}</h2>
                            <p style="font-size: 16px; color: #999; margin-bottom: 4px;">–£—Ä–æ–≤–µ–Ω—å ${currentRank.level}</p>
                            <p style="font-size: 14px; color: #666;">–¢–µ–∫—É—â–∏–π —Ä–∞–Ω–≥</p>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 500;">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                                <span style="font-size: 14px; font-weight: bold; color: ${colors.primary};">
                                    ${currentRank.min === 100 ? '–ú–∞–∫—Å–∏–º—É–º' : Math.round(progressToNext) + '%'}
                                </span>
                            </div>
                            <div style="height: 12px; border-radius: 6px; background-color: #2a2a2a;">
                                <div style="height: 100%; border-radius: 6px; background-color: ${colors.primary}; width: ${progressToNext}%; transition: width 0.5s;"></div>
                            </div>
                            ${currentRank.min !== 100 ? `
                                <p style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                    –ï—â—ë ${nextRank.min - state.streak} –¥–Ω–µ–π –¥–æ "${nextRank.title}"
                                </p>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Tooltip logic
        window.showTooltip = function(el, text) {
            const tooltip = document.querySelectorAll('.chart-tooltip');
            tooltip.forEach(t => {
                t.innerText = text;
                // Simple positioning logic relative to the container of the chart
                // For SVG dots it's tricky, we use a simple generic visible toggle
                t.classList.add('visible');
                setTimeout(() => t.classList.remove('visible'), 2000);
            });
        };

        function attachMainListeners() {
            const tabs = document.querySelectorAll('[data-tab]');
            const showRankBtn = document.getElementById('showRank');
            const rankModal = document.getElementById('rankModal');
            const habitCards = document.querySelectorAll('[data-habit]');
            const taskChecks = document.querySelectorAll('[data-task-check]');
            const addTaskBtn = document.getElementById('addTask');
            const newTaskInput = document.getElementById('newTaskInput');
            const deleteButtons = document.querySelectorAll('[data-delete]');
            const goToTasksBtn = document.getElementById('goToTasks');
            const completeChallengeBtn = document.getElementById('completeChallenge');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    state.activeTab = tab.dataset.tab;
                    render();
                });
            });

            if (showRankBtn) {
                showRankBtn.addEventListener('click', () => {
                    state.showRankModal = true;
                    render();
                });
            }

            if (rankModal) {
                rankModal.addEventListener('click', (e) => {
                    if (e.target === rankModal) {
                        state.showRankModal = false;
                        render();
                    }
                });
            }

            habitCards.forEach(card => {
                card.addEventListener('click', async () => {
                    const habitId = parseInt(card.dataset.habit);
                    const habit = state.habits.find(h => h.id === habitId);
                    
                    if (habit) {
                        const today = new Date().toDateString();
                        
                        if (!habit.completed) {
                            habit.completed = true;
                            habit.lastCompletedDate = today;
                            habit.streak++;
                            state.totalPoints += 10;
                        } else {
                            habit.completed = false;
                            if (habit.streak > 0) habit.streak--;
                            state.totalPoints = Math.max(0, state.totalPoints - 10);
                        }
                        
                        updateDailyStats(); // Update chart
                        await saveState();
                        render();
                    }
                });
            });

            taskChecks.forEach(check => {
                check.addEventListener('click', async () => {
                    const taskId = parseInt(check.dataset.taskCheck);
                    const task = state.tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        task.completed = !task.completed;
                        
                        if (task.completed) {
                            state.totalPoints += task.points;
                        } else {
                            state.totalPoints = Math.max(0, state.totalPoints - task.points);
                        }
                        
                        updateDailyStats(); // Update chart
                        await saveState();
                        render();
                    }
                });
            });

            if (addTaskBtn && newTaskInput) {
                const addTask = async () => {
                    const title = newTaskInput.value.trim();
                    if (title) {
                        state.tasks.push({
                            id: Date.now(),
                            title,
                            completed: false,
                            points: 5,
                            category: '–û–±—â–µ–µ',
                            createdAt: new Date().toISOString()
                        });
                        state.newTask = '';
                        updateDailyStats();
                        await saveState();
                        render();
                    }
                };

                addTaskBtn.addEventListener('click', addTask);
                newTaskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addTask();
                });
            }

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const taskId = parseInt(btn.dataset.delete);
                    const task = state.tasks.find(t => t.id === taskId);
                    
                    if (task && task.completed) {
                        state.totalPoints = Math.max(0, state.totalPoints - task.points);
                    }
                    
                    state.tasks = state.tasks.filter(t => t.id !== taskId);
                    updateDailyStats();
                    await saveState();
                    render();
                });
            });

            if (goToTasksBtn) {
                goToTasksBtn.addEventListener('click', () => {
                    state.activeTab = 'tasks';
                    render();
                });
            }

            if (completeChallengeBtn) {
                completeChallengeBtn.addEventListener('click', async () => {
                    const challenge = state.dailyChallenge;
                    if (state.challengeProgress >= challenge.target) {
                        challenge.completed = true;
                        state.totalPoints += 50;
                        await saveState();
                        render();
                    } else {
                        const newProgress = prompt(`–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å (–º–∞–∫—Å–∏–º—É–º ${challenge.target} ${challenge.unit}):`, state.challengeProgress);
                        if (newProgress !== null) {
                            state.challengeProgress = Math.min(parseInt(newProgress) || 0, challenge.target);
                            await saveState();
                            render();
                        }
                    }
                });
            }
        }

        async function resetDailyHabits() {
            const today = new Date().toDateString();
            state.habits.forEach(habit => {
                if (habit.lastCompletedDate !== today) {
                    habit.completed = false;
                }
            });
            await saveState();
        }

        async function init() {
            await loadState();
            await resetDailyHabits();
            getDailyChallenge();
            
            // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–¥–∏–º –∑–∞–ø–∏—Å—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —á—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫ –Ω–µ –±—ã–ª –ø—É—Å—Ç—ã–º
            if (Object.keys(state.history).length === 0) {
                updateDailyStats();
            }
            
            render();
            
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => loadingScreen.remove(), 500);
                }
            }, 1000);
        }

        init();
    </script>
</body>
</html>
