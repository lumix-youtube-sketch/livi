<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #9CB3B5;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #1a1a1a;
    --glass: rgba(255,255,255,0.05);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#050505 100%);color:white;max-width:428px;margin:0 auto;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:100px;min-height:100vh}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.hidden{display:none!important}

.loading-screen{position:fixed;inset:0;background:#1a1a1a;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(20,20,20,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid rgba(255,255,255,0.05)}
.profile-btn{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 15px rgba(139,154,156,0.3)}

.livi-container{display:flex;flex-direction:column;align-items:center;padding:30px 0;position:relative}
.livi-body{
    width:130px;height:130px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #2a2a2a, #111);
    border:3px solid var(--primary);
    position:relative;
    box-shadow:0 10px 40px rgba(0,0,0,0.5);
    animation:float 6s ease-in-out infinite;
    z-index:5;
}
.livi-antenna{position:absolute;width:4px;height:35px;background:var(--primary);border-radius:4px;z-index:1}
.livi-antenna::after{content:'';position:absolute;top:-8px;left:-3px;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--primary)}
.ant-l{top:-25px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-25px;right:25px;transform:rotate(20deg)}

.livi-face{position:absolute;inset:0;z-index:10}
.eye{position:absolute;top:45%;width:14px;height:18px;background:white;border-radius:50%;animation:blink 4s infinite}
.eye-l{left:35px} .eye-r{right:35px}
.mouth{position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:24px;height:12px;border-bottom:3px solid white;border-radius:0 0 15px 15px}

.item-cap {position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:90px;height:35px;background:linear-gradient(to bottom, #D4AF7A, #C09555);border-radius:20px 20px 0 0;z-index:20;box-shadow:inset 0 2px 5px rgba(255,255,255,0.2)}
.item-cap::before {content:'';position:absolute;top:-4px;left:50%;transform:translateX(-50%);width:12px;height:6px;background:#C09555;border-radius:50%}
.item-cap::after {content:'';position:absolute;bottom:0;right:-15px;width:40px;height:10px;background:#b08545;border-radius:0 50px 50px 0;transform:rotate(5deg)}

.item-crown {position:absolute;top:-45px;left:50%;transform:translateX(-50%);width:70px;height:50px;z-index:20;background: linear-gradient(to bottom, #FFD700, #DAA520);clip-path: polygon(0% 100%, 20% 40%, 40% 100%, 60% 20%, 80% 100%, 100% 40%, 100% 100%);filter: drop-shadow(0 0 5px rgba(255,215,0,0.5));}
.item-crown::after {content:'';position:absolute;bottom:5px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:radial-gradient(circle, #ff0000, #800000);border-radius:50%;box-shadow:20px 0 0 #800000, -20px 0 0 #800000}

.item-glasses {position:absolute;top:55px;left:50%;transform:translateX(-50%);width:80px;height:24px;z-index:30;display:flex;justify-content:space-between}
.g-lens {width:36px;height:24px;background:rgba(0,0,0,0.85);border-radius:6px;border:2px solid #555;position:relative;overflow:hidden}
.g-lens::after {content:'';position:absolute;top:0;left:0;width:150%;height:40%;background:rgba(255,255,255,0.15);transform:rotate(25deg) translateY(-5px)}
.g-bridge {position:absolute;top:10px;left:50%;transform:translateX(-50%);width:10px;height:3px;background:#555}

.item-scarf {position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);width:100px;height:35px;z-index:25;background: repeating-linear-gradient(45deg, #D45D79, #D45D79 10px, #C04560 10px, #C04560 20px);border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.3);}

.item-monocle {position:absolute;top:55px;right:38px;width:28px;height:28px;border:2px solid #FFD700;border-radius:50%;background:rgba(255,255,255,0.1);z-index:30}
.item-monocle::before {content:'';position:absolute;bottom:-30px;right:-10px;width:30px;height:30px;border-right:1px solid #FFD700;border-radius:50%}

.item-bowtie {position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:40px;height:20px;z-index:25;background:#D45D79;clip-path:polygon(0 50%, 40% 0, 50% 50%, 40% 100%, 0 50%, 50% 50%, 60% 0, 100% 50%, 60% 100%, 50% 50%)}

.item-insurance {
    position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:60px;height:60px;z-index:20;
    background:radial-gradient(circle, #FFD700, #B8860B);border-radius:50%;border:3px solid #FFA500;
    box-shadow:0 0 20px rgba(255,215,0,0.6);display:flex;align-items:center;justify-content:center;font-size:28px;
}

.chest-wrapper {display:grid;gap:15px;margin-bottom:30px}
.chest-card {position:relative;border-radius:16px;padding:20px;overflow:hidden;cursor:pointer;transition:transform .2s}
.chest-card:active {transform:scale(0.98)}
.chest-common {background:linear-gradient(135deg, #5D4037, #3E2723);border:2px solid #8D6E63}
.chest-rare {background:linear-gradient(135deg, #1e2424, #0f1212);border:2px solid var(--gold);box-shadow:inset 0 0 20px rgba(212,175,122,0.1)}
.chest-legendary {background:linear-gradient(135deg, #2b0a16, #1a050d);border:2px solid var(--epic);animation:pulse-glow 3s infinite}

.roulette-modal {position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.roulette-window {width:100%;height:140px;background:#050505;border-block:2px solid #333;position:relative;overflow:hidden;margin:30px 0}
.roulette-strip {display:flex;height:100%;align-items:center;position:absolute;left:0;will-change:transform}
.r-item {width:120px;height:110px;margin:0 4px;background:#151515;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #333;flex-shrink:0;position:relative}
.r-item.legendary {border-color:var(--epic);box-shadow:inset 0 0 15px rgba(212,93,121,0.2)}
.r-item.rare {border-color:var(--gold)}
.r-marker {position:absolute;top:0;bottom:0;left:50%;width:4px;background:white;z-index:10;transform:translateX(-50%);box-shadow:0 0 10px white}

.content{padding:20px}
.section{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);border-radius:20px;padding:20px;margin-bottom:15px;backdrop-filter:blur(10px)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.btn{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:white}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888}

.add-btn {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 30px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
    font-size: 32px;
    border: none;
    box-shadow: 0 4px 20px rgba(139,154,156,0.5);
    z-index: 80;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s;
}
.add-btn:active {transform: scale(0.95);}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(15,15,15,0.98);backdrop-filter:blur(20px);border-top:1px solid #2a2a2a;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;border:none;background:none;color:#555;transition:color .2s}
.nav-item.active{color:var(--primary)}

.group-progress {height:12px;background:#222;border-radius:6px;overflow:hidden;margin-top:12px}
.group-fill {height:100%;background:linear-gradient(90deg,var(--gold),var(--epic));transition:width .6s}

.referral-section {text-align:center;padding:20px;background:rgba(255,255,255,0.05);border-radius:16px;margin-bottom:20px}
.referral-link {background:#111;padding:12px;border-radius:12px;margin:12px 0;font-family:monospace;font-size:14px;word-break:break-all;color:var(--accent)}
.copy-btn {background:var(--primary);color:white;padding:10px 20px;border-radius:12px;margin-top:8px}

.profile-avatar {width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid var(--primary);margin-bottom:15px}
.profile-nick {font-size:24px;font-weight:800;margin-bottom:10px}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:10px; color:#fff; font-weight:800; letter-spacing:1px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div class="roulette-window">
        <div class="r-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .5s">
        <div style="font-size:14px; color:#888; text-transform:uppercase; letter-spacing:1px">–í—ã –ø–æ–ª—É—á–∏–ª–∏</div>
        <div id="winItemName" style="font-size:32px; font-weight:800; color:var(--gold); margin:10px 0; text-shadow:0 0 20px rgba(212,175,122,0.3)">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" style="width:200px; margin:0 auto" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="app"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand(); tg.ready(); tg.setHeaderColor('#141414'); tg.setBackgroundColor('#141414');

const userId = tg.initDataUnsafe.user?.id || 'local';
const username = tg.initDataUnsafe.user?.username || '';
const firstName = tg.initDataUnsafe.user?.first_name || 'User';
const photoUrl = tg.initDataUnsafe.user?.photo_url || '';

const CloudStorage = tg.CloudStorage;

const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><circle cx="16" cy="7" r="4"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
    shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
    fire: '<path d="M8 22s3-8 3-13c0-3-2-5-5-5 1-3 5-5 5-8 2 4 6 5 8 5 2 0 6-1 8 5 0 3-4 5-5 5-1 4 3 13 3 13H8z"/>',
    user: '<circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>'
};
const getIcon = (n) => `<svg>${icons[n]}</svg>`;

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' },
    { id: 'insurance', name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —Å—Ç—Ä–∏–∫–æ–≤', type: 'special', rarity: 'rare', icon: 'üõ°Ô∏è', css: 'item-insurance', special: true }
];

const defaultState = {
    activeTab: 'home',
    streak: 1,
    totalPoints: 200,
    lastVisitDate: new Date().toISOString().split('T')[0],
    statsHistory: [],
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10 },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5 }
    ],
    inventory: [],
    equipped: { head: null, face: null, body: null, special: null },
    dailyChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–°–¥–µ–ª–∞—Ç—å 20 —à–∞–≥–æ–≤',
        completed: false,
        reward: 50
    },
    groupChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–í—Å–µ –≤–º–µ—Å—Ç–µ: —Å–æ–±—Ä–∞—Ç—å 5000 üî• –∑–∞ –¥–µ–Ω—å',
        current: 0,
        target: 5000,
        personalContributedToday: false
    },
    hasStreakInsurance: false,
    referralCount: 0,
    totalFire: 0,
    nick: username || firstName,
    avatar: photoUrl
};

let state = { ...defaultState };
let isSyncing = false;

async function saveToCloud() {
    if (isSyncing) return;
    isSyncing = true;
    try {
        await CloudStorage.setItem(`livi_state_${userId}`, JSON.stringify(state));

        const today = new Date().toISOString().split('T')[0];
        let total = 0;
        const existing = await CloudStorage.getItem(`group_fire_${today}`);
        if (existing) total = parseInt(existing) || 0;
        if (state.dailyChallenge.completed && !state.groupChallenge.personalContributedToday) {
            total += 1;
        }
        await CloudStorage.setItem(`group_fire_${today}`, total.toString());
    } catch (e) { console.error(e); }
    isSyncing = false;
}

async function loadFromCloud() {
    try {
        const data = await CloudStorage.getItem(`livi_state_${userId}`);
        if (data) state = { ...defaultState, ...JSON.parse(data) };

        const today = new Date().toISOString().split('T')[0];
        const globalFire = await CloudStorage.getItem(`group_fire_${today}`);
        if (globalFire) state.groupChallenge.current = parseInt(globalFire) || 0;

        return true;
    } catch (e) { return false; }
}

function updateHistory(pointsDelta = 0, completedTask = false) {
    const today = new Date().toISOString().split('T')[0];
    let entry = state.statsHistory.find(e => e.date === today);
    if (!entry) {
        entry = { date: today, points: 0, completedTasks: 0 };
        state.statsHistory.push(entry);
    }
    entry.points += pointsDelta;
    if (completedTask) entry.completedTasks += 1;
    state.statsHistory = state.statsHistory.slice(-400);
    saveState();
}

function saveState() {
    localStorage.setItem('livi_v4_pro', JSON.stringify(state));
    saveToCloud();
}

function hadActivityYesterday() {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    const y = d.toISOString().split('T')[0];
    return !!state.statsHistory.find(e => e.date === y && (e.points > 0 || e.completedTasks > 0));
}

async function loadState() {
    const today = new Date().toISOString().split('T')[0];
    await loadFromCloud() || (() => {
        const saved = localStorage.getItem('livi_v4_pro');
        if (saved) state = { ...defaultState, ...JSON.parse(saved) };
    })();

    if (state.lastVisitDate !== today) {
        const yesterdayActive = hadActivityYesterday();
        if (!yesterdayActive && state.hasStreakInsurance) {
            state.hasStreakInsurance = false;
            if (state.equipped.special === 'insurance') state.equipped.special = null;
            tg.showPopup({title:'üõ°Ô∏è', message:'–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —Å–ø–∞—Å–ª–∞ —Å—Ç—Ä–∏–∫!', buttons:[{type:'ok'}]});
        } else if (!yesterdayActive) {
            state.streak = 1;
        } else {
            state.streak += 1;
        }

        state.lastVisitDate = today;
        state.dailyChallenge = {
            date: today,
            title: ['–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –∑–∞–¥–∞—á–∏','–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤','–°–¥–µ–ª–∞—Ç—å 20 —à–∞–≥–æ–≤','–ü—Ä–æ–π—Ç–∏ 5 –∫–º'][Math.floor(Math.random()*4)],
            completed: false,
            reward: 50
        };
        state.groupChallenge.personalContributedToday = false;
        state.tasks.forEach(t => { if (t.type === 'habit') t.completed = false; });
        saveState();
    }

    if (!state.statsHistory.find(e => e.date === today)) {
        state.statsHistory.push({ date: today, points: 0, completedTasks: 0 });
    }
}

const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (!task) return;
        task.completed = !task.completed;
        if (task.completed) state.totalPoints += task.points, updateHistory(task.points, true);
        else state.totalPoints -= task.points, updateHistory(-task.points);
        tg.HapticFeedback.notificationOccurred('success');
        saveState(); render();
    },
    addTask: () => {
        const title = prompt("–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?");
        if (title?.trim()) {
            state.tasks.push({ id: Date.now(), title: title.trim(), completed: false, type: 'task', points: 15 });
            saveState(); render();
        }
    },
    deleteTask: (id) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveState(); render();
        }
    },
    completeChallenge: () => {
        if (state.dailyChallenge.completed) return;
        state.dailyChallenge.completed = true;
        state.totalPoints += state.dailyChallenge.reward;
        state.totalFire += 1;
        updateHistory(state.dailyChallenge.reward);
        if (!state.groupChallenge.personalContributedToday) {
            state.groupChallenge.personalContributedToday = true;
            state.groupChallenge.current += 1;
            saveToCloud();
        }
        tg.HapticFeedback.notificationOccurred('success');
        saveState(); render();
    },
    equip: (id) => {
        const item = ITEMS.find(i => i.id === id);
        if (!item) return;
        if (item.special) {
            state.equipped.special = state.equipped.special === id ? null : id;
            state.hasStreakInsurance = !!state.equipped.special;
        } else {
            state.equipped[item.type] = state.equipped[item.type] === id ? null : id;
        }
        saveState(); render();
    },
    openChest: (type, cost) => {
        if (state.totalPoints < cost) return alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
        state.totalPoints -= cost;
        updateHistory(-cost);
        startRoulette(type);
    },
    openProfile: () => { state.activeTab = 'profile'; render(); },
    saveNick: () => {
        const newNick = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫:", state.nick);
        if (newNick && newNick.trim()) {
            state.nick = newNick.trim();
            saveState();
            render();
        }
    },
    copyReferral: () => {
        const link = `https://t.me/livi_app_bot?start=ref${userId}`;
        navigator.clipboard.writeText(link);
        tg.HapticFeedback.success();
        alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
    },
    shareReferral: () => {
        const link = `https://t.me/livi_app_bot?start=ref${userId}`;
        tg.shareUrl(link, `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ Livi! –ü–æ–ª—É—á–∏ –±–æ–Ω—É—Å—ã –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é: +100 –æ—á–∫–æ–≤ –∏ +5 üî•`);
    }
};

function startRoulette(type) {
    // (–ø–æ–ª–Ω—ã–π –∫–æ–¥ —Ä—É–ª–µ—Ç–∫–∏ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
    // ... (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
}

function closeRoulette() {
    document.getElementById('rouletteModal').classList.add('hidden');
    render();
}

function renderHeader() {
    return `<div class="header">
        <div class="header-title">livi</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:var(--gold)">${getIcon('star')} ${state.totalPoints}</div>
            <div class="stat-badge">${getIcon('fire')} ${state.totalFire}</div>
            ${state.hasStreakInsurance ? `<div class="stat-badge" style="color:#FFA500">${getIcon('shield')} –ó–∞—â–∏—â—ë–Ω</div>` : ''}
            <div class="profile-btn" onclick="actions.openProfile()">${getIcon('user')}</div>
        </div>
    </div>`;
}

function renderProfile() {
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content" style="text-align:center">
            <h2 style="margin-bottom:30px;font-weight:800">–ü–†–û–§–ò–õ–¨</h2>
            <img src="${state.avatar || 'https://via.placeholder.com/100?text=üòä'}" class="profile-avatar" alt="–ê–≤–∞—Ç–∞—Ä">
            <div class="profile-nick">${state.nick || '–ë–µ–∑ –Ω–∏–∫–∞'}</div>
            <button class="btn btn-primary" style="width:80%;margin:20px auto" onclick="actions.saveNick()">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>

            <div class="section">
                <div style="font-weight:bold;margin-bottom:10px">–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
                <div class="referral-link">https://t.me/livi_app_bot?start=ref${userId}</div>
                <button class="btn btn-primary" style="margin:10px 0" onclick="actions.copyReferral()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-ghost" onclick="actions.shareReferral()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
                <div style="margin-top:15px;color:var(--gold)">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: ${state.referralCount} —á–µ–ª–æ–≤–µ–∫</div>
            </div>

            <div class="section">
                <div>üî• –í—Å–µ–≥–æ –æ–≥–æ–Ω—å–∫–æ–≤: ${state.totalFire}</div>
                <div>–°—Ç—Ä–∏–∫: ${state.streak} –¥–Ω–µ–π</div>
                <div>–û—á–∫–æ–≤: ${state.totalPoints}</div>
            </div>
        </div>
    </div>`;
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ render-—Ñ—É–Ω–∫—Ü–∏–∏ (home, tasks, group, shop) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ renderGroupChallenges —Ç–µ–ø–µ—Ä—å –±–µ–∑ —Ñ–µ–π–∫–æ–≤—ã—Ö –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–≤

function renderGroupChallenges() {
    const g = state.groupChallenge;
    const progress = Math.min((g.current / g.target) * 100, 100);

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:20px;font-weight:800">–ì–†–£–ü–ü–û–í–´–ï –ò–°–ü–´–¢–ê–ù–ò–Ø</h2>

            <div class="section" style="padding:25px;text-align:center;border:2px solid var(--epic);background:rgba(212,93,121,0.05)">
                <div style="font-size:44px;margin-bottom:12px">üî•</div>
                <div style="font-weight:900;font-size:20px">${g.title}</div>
                <div style="font-size:32px;font-weight:800;color:var(--gold);margin:12px 0">${g.current} / ${g.target}</div>
                <div class="group-progress"><div class="group-fill" style="width:${progress}%"></div></div>
                <div style="margin-top:12px;color:#aaa">
                    –ö–∞–∂–¥—ã–π, –∫—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Ü–µ–ª—å ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç +1 üî• –≤ –æ–±—â–∏–π —Å—á—ë—Ç—á–∏–∫.<br>
                    –í—Å—ë –ø–æ-—á–µ—Å—Ç–Ω–æ–º—É ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏.
                </div>
            </div>

            <div class="referral-section">
                <div style="font-weight:700">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π ‚Äî –ø–æ–º–æ–≥–∞–π —Å–æ–æ–±—â–µ—Å—Ç–≤—É!</div>
                <button class="btn btn-primary" style="margin-top:15px" onclick="actions.shareReferral()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
            </div>
        </div>
    </div>`;
}

function render() {
    const nav = [
        {id:'home',icon:'home',l:'Home'},
        {id:'tasks',icon:'check',l:'Tasks'},
        {id:'group',icon:'users',l:'Group'},
        {id:'shop',icon:'shop',l:'Shop'}
    ];

    let html = '';
    if (state.activeTab === 'home') html = renderHome();
    else if (state.activeTab === 'tasks') html = renderTasks();
    else if (state.activeTab === 'group') html = renderGroupChallenges();
    else if (state.activeTab === 'shop') html = renderShop();
    else if (state.activeTab === 'profile') html = renderProfile();

    document.getElementById('app').innerHTML = html + `
    <div class="bottom-nav">
        ${nav.map(n=>`<button class="nav-item ${state.activeTab===n.id?'active':''}" onclick="state.activeTab='${n.id}';saveState();render()">${getIcon(n.icon)}<span style="font-size:10px">${n.l}</span></button>`).join('')}
    </div>`;
}

window.onload = async () => {
    await loadState();
    render();
    setTimeout(() => document.getElementById('loadingScreen').classList.add('fade-out'), 1000);

    if (tg.initDataUnsafe.start_param?.startsWith('ref')) {
        const refId = tg.initDataUnsafe.start_param.slice(3);
        if (refId != userId) {
            state.totalPoints += 100;
            state.totalFire += 5;
            saveState();
            tg.showPopup({title:'–ü—Ä–∏–≤–µ—Ç!', message:'–¢—ã –ø—Ä–∏—à—ë–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!\n+100 –æ—á–∫–æ–≤ –∏ +5 üî•', buttons:[{type:'ok'}]});
        }
    }
};
</script>
</body>
</html>
