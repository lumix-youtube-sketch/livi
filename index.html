<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* --- BASE STYLES --- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);color:white;max-width:428px;margin:0 auto;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:90px;min-height:100vh}

/* --- ANIMATIONS --- */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes gentleFloat{0%,100%{transform:translateY(0px) rotate(0deg)}50%{transform:translateY(-8px) rotate(2deg)}}
@keyframes blink{0%,90%,100%{opacity:1}95%{opacity:.3}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shine{0%{background-position:-100%}100%{background-position:200%}}

/* --- UTILITIES --- */
.fade-in{animation:fadeIn .3s ease-out}
.slide-up{animation:slideUp .3s ease-out}
.pulse{animation:pulse 2s infinite}
.hidden{display:none!important}

/* --- LOADING SCREEN --- */
.loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a1a 0%,#0f0f0f 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:bold;background:linear-gradient(135deg,#8B9A9C 0%,#9CB3B5 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

/* --- HEADER --- */
.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,rgba(15,15,15,.95) 0%,rgba(10,10,10,.95) 100%);backdrop-filter:blur(20px);border-bottom:1px solid #2a2a2a;position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:700;background:linear-gradient(135deg,#8B9A9C 0%,#9CB3B5 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:12px}
.stat-badge{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:16px;font-weight:bold;font-size:16px;border:none;background:rgba(255,255,255,0.05);color:white}

/* --- NAVIGATION --- */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(15,15,15,.98);backdrop-filter:blur(20px);border-top:1px solid #2a2a2a;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:4px;cursor:pointer;background:none;border:none;color:#666;position:relative}
.nav-item.active{color:#8B9A9C}
.nav-item.active::before{content:'';position:absolute;top:-13px;width:30px;height:3px;background:#8B9A9C;border-radius:0 0 4px 4px}

/* --- CONTENT --- */
.content{padding:20px}
.section{background:linear-gradient(135deg,rgba(25,25,25,.6) 0%,rgba(10,10,10,.6) 100%);border:1px solid #2a2a2a;border-radius:20px;padding:20px;margin-bottom:20px;backdrop-filter:blur(10px)}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}

/* --- LIVI CHARACTER --- */
.livi-character{display:flex;flex-direction:column;align-items:center;padding:20px 0;position:relative}
.livi-circle{border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;animation:gentleFloat 4s ease-in-out infinite;box-shadow:0 0 30px rgba(139,154,156,.1);background:rgba(139,154,156,0.05);border:3px solid #8B9A9C;width:120px;height:120px}
.livi-antenna{position:absolute;width:4px;height:30px;background:#8B9A9C;border-radius:2px;z-index:1}
.livi-antenna::after{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:#8B9A9C;border-radius:50%}
.livi-antenna.left{top:-20px;left:30px;transform:rotate(-15deg)}
.livi-antenna.right{top:-20px;right:30px;transform:rotate(15deg)}
.livi-face{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:5}
.livi-eyes{position:absolute;top:40%;width:50%;display:flex;justify-content:space-between}
.livi-eye{width:10px;height:10px;background:white;border-radius:50%;animation:blink 5s infinite}
.livi-mouth{position:absolute;bottom:35%;width:20px;height:10px;border-bottom:3px solid white;border-radius:0 0 10px 10px}

/* --- ITEM STYLES ON LIVI (CSS DRAWING) --- */
.item-cap {position:absolute;top:-15px;width:70px;height:25px;background:#D4AF7A;border-radius:15px 15px 0 0;z-index:10;left:50%;transform:translateX(-50%)}
.item-cap::after{content:'';position:absolute;bottom:0;right:-10px;width:30px;height:8px;background:#D4AF7A;border-radius:0 5px 5px 0}
.item-crown {position:absolute;top:-35px;width:60px;height:40px;background:none;z-index:10;left:50%;transform:translateX(-50%);border-bottom:4px solid gold}
.item-crown::before{content:'';position:absolute;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:25px solid gold;left:0}
.item-crown::after{content:'';position:absolute;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:25px solid gold;right:0}
.item-crown span {position:absolute;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:35px solid gold;left:50%;transform:translateX(-50%);top:-5px}

.item-glasses {position:absolute;top:38%;width:70px;height:18px;background:rgba(0,0,0,0.8);z-index:20;left:50%;transform:translateX(-50%);border-radius:4px;border:1px solid #444}
.item-monocle {position:absolute;top:36%;right:28%;width:24px;height:24px;border:2px solid gold;border-radius:50%;z-index:20}
.item-monocle::after {content:'';position:absolute;bottom:-20px;right:-10px;width:2px;height:20px;background:gold;transform:rotate(-45deg)}

.item-scarf {position:absolute;bottom:-10px;width:90px;height:25px;background:#D45D79;border-radius:10px;z-index:15;left:50%;transform:translateX(-50%)}
.item-bowtie {position:absolute;bottom:5px;width:40px;height:20px;background:white;z-index:15;left:50%;transform:translateX(-50%);clip-path: polygon(0% 0%, 100% 0%, 80% 50%, 100% 100%, 0% 100%, 20% 50%);}
.item-goldchain {position:absolute;bottom:10px;width:80px;height:40px;border-radius:50%;border:4px solid gold;border-top:none;z-index:14;left:50%;transform:translateX(-50%)}

/* --- CARDS & BUTTONS --- */
.stat-card{background:rgba(255,255,255,0.03);border:1px solid #2a2a2a;border-radius:20px;padding:16px;text-align:center}
.stat-value{font-size:24px;font-weight:bold;margin:8px 0;background:linear-gradient(135deg,#8B9A9C,#9CB3B5);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:12px;color:#888}

.task-item{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(255,255,255,0.03);border:1px solid #2a2a2a;border-radius:16px;margin-bottom:10px;transition:all .2s}
.task-item.completed{opacity:0.6}
.task-item.completed .task-title{text-decoration:line-through;color:#666}
.checkbox{width:24px;height:24px;border:2px solid #8B9A9C;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.checkbox.checked{background:#8B9A9C}

/* --- CHESTS & ROULETTE --- */
.chest-card {background:linear-gradient(135deg, rgba(40,40,40,0.8), rgba(20,20,20,0.9)); border:1px solid #333; border-radius:16px; padding:15px; display:flex; flex-direction:column; align-items:center; position:relative; overflow:hidden}
.chest-card.common {border-color:#8B9A9C}
.chest-card.rare {border-color:#D4AF7A; box-shadow:0 0 15px rgba(212,175,122,0.1)}
.chest-card.legendary {border-color:#D45D79; box-shadow:0 0 20px rgba(212,93,121,0.2)}
.chest-icon {font-size:40px; margin-bottom:10px; animation: gentleFloat 3s infinite}

.roulette-modal {position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center}
.roulette-window {width:100%; height:120px; background:#111; border-top:2px solid #333; border-bottom:2px solid #333; position:relative; overflow:hidden; margin-bottom:20px}
.roulette-strip {display:flex; height:100%; align-items:center; position:absolute; left:0; will-change:transform}
.roulette-item {width:100px; height:90px; margin:0 5px; background:#222; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; border:1px solid #333; flex-shrink:0}
.roulette-item.legendary {border-color:#D45D79; box-shadow:inset 0 0 10px rgba(212,93,121,0.3)}
.roulette-item.rare {border-color:#D4AF7A}
.roulette-marker {position:absolute; top:0; bottom:0; left:50%; width:4px; background:#D45D79; z-index:10; transform:translateX(-50%)}

.inv-grid {display:grid; grid-template-columns:repeat(3, 1fr); gap:10px}
.inv-item {background:rgba(255,255,255,0.05); border-radius:12px; padding:10px; text-align:center; position:relative; border:1px solid transparent; cursor:pointer}
.inv-item.equipped {border-color:#8B9A9C; background:rgba(139,154,156,0.1)}
.inv-icon {font-size:24px}

.btn{width:100%;padding:14px;border-radius:16px;font-weight:bold;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,#8B9A9C 0%,#9CB3B5 100%);color:white;box-shadow:0 4px 12px rgba(139,154,156,.3)}
.btn-secondary{background:transparent;border:1px solid #2a2a2a;color:#8B9A9C}
.add-btn{position:fixed;bottom:90px;right:20px;width:56px;height:56px;border-radius:50%;background:#8B9A9C;color:white;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 4px 20px rgba(139,154,156,0.4);border:none;z-index:90}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:20px; color:#fff">–û—Ç–∫—Ä—ã–≤–∞–µ–º...</h2>
    <div class="roulette-window">
        <div class="roulette-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center">
        <div style="font-size:18px; color:#888">–¢—ã –ø–æ–ª—É—á–∏–ª:</div>
        <div id="winItemName" style="font-size:28px; font-weight:bold; color:#D4AF7A; margin:10px 0">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" onclick="closeRoulette()">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
</div>

<div id="app"></div>

<script>
// --- TELEGRAM INIT ---
const tg = window.Telegram?.WebApp;
if(tg) {
    tg.expand();
    tg.ready();
    tg.setHeaderColor('#1a1a1a');
    tg.setBackgroundColor('#1a1a1a');
}

// --- CONFIG ---
const colors = { primary: '#8B9A9C', accent: '#9CB3B5', warning: '#D4AF7A', danger: '#D45D79', bg: '#1a1a1a' };

// --- ICONS ---
const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    target: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>',
    flame: '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
    gift: '<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>'
};

function getIcon(name, color = 'currentColor') {
    return `<svg style="color:${color}">${icons[name] || ''}</svg>`;
}

// --- ITEM DATABASE ---
const ITEM_DB = [
    // COMMON
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    // RARE
    { id: 'r_glasses', name: '–û—á–∫–∏', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'r_goldchain', name: '–¶–µ–ø—å', type: 'body', rarity: 'rare', icon: '‚õìÔ∏è', css: 'item-goldchain' },
    // LEGENDARY
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' }
];

// --- STATE ---
const defaultState = {
    activeTab: 'home',
    streak: 1,
    totalPoints: 500, // –î–∞–ª –±–æ–ª—å—à–µ —Å—Ç–∞—Ä—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    lastVisitDate: new Date().toDateString(),
    weeklyStats: [15, 25, 10, 30, 45, 20, 10], 
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10 },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5 }
    ],
    inventory: [], // –°–ø–∏—Å–æ–∫ ID –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    equipped: { head: null, face: null, body: null }, // –ù–∞–¥–µ—Ç—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    dailyChallenge: {
        date: new Date().toDateString(),
        title: '–°–¥–µ–ª–∞—Ç—å 20 —à–∞–≥–æ–≤',
        target: 20,
        completed: false,
        reward: 50
    }
};

let state = { ...defaultState };

function saveState() {
    try { localStorage.setItem('livi_data_v3', JSON.stringify(state)); } catch (e) {}
}

function loadState() {
    try {
        const saved = localStorage.getItem('livi_data_v3');
        if (saved) {
            state = JSON.parse(saved);
            const today = new Date().toDateString();
            if (state.lastVisitDate !== today) {
                state.dailyChallenge = {
                    date: today,
                    title: '–ù–æ–≤—ã–π –≤—ã–∑–æ–≤!', 
                    target: 10,
                    completed: false,
                    reward: 50
                };
                state.tasks.forEach(t => { if(t.type === 'habit') t.completed = false; });
                state.streak += 1;
                state.lastVisitDate = today;
                
                // Shift weekly stats
                state.weeklyStats.shift();
                state.weeklyStats.push(0);
                
                saveState();
            }
        }
    } catch (e) {}
}

// --- ACTIONS ---
const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.completed = !task.completed;
            if(task.completed) {
                state.totalPoints += task.points;
                state.weeklyStats[6] += task.points; // Add to today's stats
                tg?.HapticFeedback?.notificationOccurred('success');
            } else {
                state.totalPoints -= task.points;
                state.weeklyStats[6] -= task.points;
            }
            saveState();
            render();
        }
    },
    addTask: () => {
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:");
        if (title) {
            state.tasks.push({ id: Date.now(), title, completed: false, type: 'task', points: 15 });
            saveState(); render();
        }
    },
    deleteTask: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveState(); render();
        }
    },
    completeChallenge: () => {
        if(!state.dailyChallenge.completed) {
            state.dailyChallenge.completed = true;
            state.totalPoints += state.dailyChallenge.reward;
            state.weeklyStats[6] += state.dailyChallenge.reward;
            tg?.HapticFeedback?.notificationOccurred('success');
            saveState(); render();
        }
    },
    openChest: (type, cost) => {
        if (state.totalPoints < cost) {
            alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
            tg?.HapticFeedback?.notificationOccurred('error');
            return;
        }
        state.totalPoints -= cost;
        saveState();
        startRoulette(type);
    },
    equipItem: (itemId) => {
        const item = ITEM_DB.find(i => i.id === itemId);
        if (!item) return;
        
        // –ï—Å–ª–∏ —É–∂–µ –Ω–∞–¥–µ—Ç–æ - —Å–Ω–∏–º–∞–µ–º
        if (state.equipped[item.type] === itemId) {
            state.equipped[item.type] = null;
        } else {
            state.equipped[item.type] = itemId;
        }
        saveState();
        render();
    },
    sendStars: () => {
        tg?.HapticFeedback?.notificationOccurred('warning');
        tg?.showPopup({
            title: '–£–ø—Å!',
            message: '–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ï–©–ï –í –†–ê–ó–†–ê–ë–û–¢–ö–ï üöß\n–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —ç—Ç–∏–º!',
            buttons: [{type: 'ok'}]
        });
    }
};

// --- ROULETTE LOGIC ---
let isSpinning = false;

function startRoulette(chestType) {
    if(isSpinning) return;
    isSpinning = true;
    
    const modal = document.getElementById('rouletteModal');
    const strip = document.getElementById('rouletteStrip');
    const winMsg = document.getElementById('winMessage');
    
    modal.classList.remove('hidden');
    winMsg.style.opacity = '0';
    strip.style.transition = 'none';
    strip.style.transform = 'translateX(0)';
    strip.innerHTML = '';

    // 1. Determine Winner based on chest type
    let pool = [];
    if (chestType === 'common') pool = ITEM_DB.filter(i => i.rarity === 'common');
    else if (chestType === 'rare') pool = ITEM_DB.filter(i => i.rarity !== 'legendary'); // common + rare
    else pool = ITEM_DB; // all

    // Weighting logic (simplified)
    // Common chest: 90% common, 10% rare
    // Rare chest: 40% common, 55% rare, 5% leg
    // Leg chest: 10% common, 40% rare, 50% leg
    
    let winner;
    const rand = Math.random();
    
    if (chestType === 'common') {
        winner = (rand > 0.9) ? getRandomItem('rare') : getRandomItem('common');
    } else if (chestType === 'rare') {
        if (rand > 0.95) winner = getRandomItem('legendary');
        else if (rand > 0.40) winner = getRandomItem('rare');
        else winner = getRandomItem('common');
    } else {
        if (rand > 0.5) winner = getRandomItem('legendary');
        else if (rand > 0.1) winner = getRandomItem('rare');
        else winner = getRandomItem('common');
    }
    
    // Fallback if null
    if(!winner) winner = ITEM_DB[0];

    // 2. Build Strip (Winner at index 30)
    const itemsCount = 40;
    const winnerIndex = 30;
    const itemWidth = 110; // 100 + 10 margin
    
    for(let i=0; i<itemsCount; i++) {
        let item;
        if (i === winnerIndex) item = winner;
        else item = ITEM_DB[Math.floor(Math.random() * ITEM_DB.length)];
        
        const el = document.createElement('div');
        el.className = `roulette-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:32px">${item.icon}</div><div style="font-size:10px;margin-top:4px">${item.rarity}</div>`;
        strip.appendChild(el);
    }

    // 3. Animate
    setTimeout(() => {
        // Center offset: Window Width / 2 - Item Width / 2
        const centerOffset = (window.innerWidth / 2) - (100 / 2); 
        const targetPos = -(winnerIndex * itemWidth) + centerOffset - 20; // -20 correction
        
        strip.style.transition = 'transform 4s cubic-bezier(0.1, 0.9, 0.2, 1)';
        strip.style.transform = `translateX(${targetPos}px)`;
        
        tg?.HapticFeedback?.selectionChanged(); // Start vibration
        
        setTimeout(() => {
            // FINISH
            tg?.HapticFeedback?.notificationOccurred('success');
            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winItemName').style.color = 
                winner.rarity === 'legendary' ? '#D45D79' : 
                winner.rarity === 'rare' ? '#D4AF7A' : '#fff';
            
            winMsg.style.transition = 'opacity 0.5s';
            winMsg.style.opacity = '1';
            
            // Add to inventory if not exists (or ignore duplicate logic for now)
            if(!state.inventory.includes(winner.id)) {
                state.inventory.push(winner.id);
                saveState();
            } else {
                // Refund for duplicate? Let's just say "Already Owned" in UI later
            }
        }, 4000);
    }, 100);
}

function getRandomItem(rarity) {
    const list = ITEM_DB.filter(i => i.rarity === rarity);
    if(list.length === 0) return ITEM_DB[0];
    return list[Math.floor(Math.random() * list.length)];
}

function closeRoulette() {
    document.getElementById('rouletteModal').classList.add('hidden');
    isSpinning = false;
    render();
}

// --- AI ANALYSIS LOGIC ---
function getAIAnalysis() {
    const avg = state.weeklyStats.reduce((a,b)=>a+b,0) / 7;
    const today = state.weeklyStats[6];
    let trend = "stable";
    if (today > avg * 1.5) trend = "up";
    if (today < avg * 0.5) trend = "down";

    let text = "";
    if (trend === "up") {
        text = "–í–∞—É! –¢–≤–æ—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç. –ò–ò —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—Å—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å—Ä–µ–¥–Ω–µ–π –Ω–µ–¥–µ–ª—å–Ω–æ–π. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å, —Ç—ã –≤ –∑–æ–Ω–µ –ø–æ—Ç–æ–∫–∞! üöÄ";
    } else if (trend === "down") {
        text = "–Ø –∑–∞–º–µ—Ç–∏–ª –Ω–µ–±–æ–ª—å—à–æ–π —Å–ø–∞–¥. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî –≤—Å–µ–º –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ä–∏—Ç–º. ü§ñ";
    } else {
        text = "–¢–≤–æ–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã. –¢—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å —Ö–æ—Ä–æ—à–∏–π —Ç–µ–º–ø. –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É, –∏ –º–æ–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç. üëç";
    }
    
    return { text, trend, avg: Math.round(avg) };
}

// --- RENDER FUNCTIONS ---

function renderHeader() {
    return `
    <div class="header">
        <div class="header-title">livi</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:#D4AF7A">
                ${getIcon('flame', '#D4AF7A')} ${state.streak}
            </div>
            <div class="stat-badge" style="color:#8B9A9C">
                ${getIcon('star', '#8B9A9C')} ${state.totalPoints}
            </div>
        </div>
    </div>`;
}

function renderLivi() {
    // Get Equipped Items CSS
    const headItem = ITEM_DB.find(i => i.id === state.equipped.head);
    const faceItem = ITEM_DB.find(i => i.id === state.equipped.face);
    const bodyItem = ITEM_DB.find(i => i.id === state.equipped.body);

    return `
    <div class="livi-character fade-in">
        <div class="livi-circle">
            ${headItem ? `<div class="${headItem.css}" style="${headItem.style||''}"><span></span></div>` : ''}
            <div class="livi-antenna left"></div>
            <div class="livi-antenna right"></div>
            <div class="livi-face">
                <div class="livi-eyes">
                    <div class="livi-eye"></div>
                    <div class="livi-eye"></div>
                </div>
                ${faceItem ? `<div class="${faceItem.css}"></div>` : ''}
                <div class="livi-mouth"></div>
            </div>
        </div>
        ${bodyItem ? `<div style="position:relative;width:0;height:0;top:-15px"><div class="${bodyItem.css}"></div></div>` : ''}
        <div style="margin-top:24px;font-weight:bold;color:${colors.primary}">–ü—Ä–∏–≤–µ—Ç, –ß–µ–º–ø–∏–æ–Ω!</div>
    </div>`;
}

function renderHome() {
    const tasksTotal = state.tasks.length;
    const tasksDone = state.tasks.filter(t => t.completed).length;
    
    return `
    <div class="slide-up">
        ${renderLivi()}
        
        <div class="grid-2" style="margin-top:10px">
             <div class="stat-card" style="background:rgba(139,154,156,0.1)">
                <div style="font-size:20px;font-weight:bold;color:#fff">${Math.round(tasksDone/Math.max(tasksTotal,1)*100)}%</div>
                <div style="font-size:10px;color:#8B9A9C">–ö–ü–î —Å–µ–≥–æ–¥–Ω—è</div>
             </div>
             <div class="stat-card" style="background:rgba(212,175,122,0.1)">
                <div style="font-size:20px;font-weight:bold;color:#fff">${state.inventory.length}</div>
                <div style="font-size:10px;color:#D4AF7A">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
             </div>
        </div>

        <div class="section">
            <h3 style="margin-bottom:12px;font-size:18px">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è</h3>
            <div class="grid-2" style="margin-bottom:0">
                <div class="stat-card">
                    ${getIcon('check', colors.primary)}
                    <div class="stat-value">${tasksDone}/${tasksTotal}</div>
                    <div class="stat-label">–ó–∞–¥–∞—á–∏</div>
                </div>
                <div class="stat-card">
                    ${getIcon('flame', colors.warning)}
                    <div class="stat-value">${state.streak}</div>
                    <div class="stat-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-secondary" style="margin-bottom:20px; border-color:#D4AF7A; color:#D4AF7A" onclick="actions.sendStars()">
            ${getIcon('star')} –û—Ç–ø—Ä–∞–≤–∏—Ç—å Stars —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º
        </button>

        <div class="section" onclick="state.activeTab='challenges';render()">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:bold;margin-bottom:4px">–ß–µ–ª–ª–µ–Ω–¥–∂ –¥–Ω—è</div>
                    <div style="font-size:12px;color:#999">${state.dailyChallenge.title}</div>
                </div>
                <div class="stat-badge" style="background:#D4AF7A;color:#1a1a1a;font-size:12px">
                    +${state.dailyChallenge.reward}
                </div>
            </div>
        </div>
    </div>`;
}

function renderShop() {
    const invItems = state.inventory.map(id => {
        const item = ITEM_DB.find(i => i.id === id);
        const isEquipped = Object.values(state.equipped).includes(id);
        return `
            <div class="inv-item ${isEquipped ? 'equipped' : ''}" onclick="actions.equipItem('${id}')">
                <div class="inv-icon">${item.icon}</div>
                <div style="font-size:10px;margin-top:4px">${item.name}</div>
                ${isEquipped ? '<div style="position:absolute;top:2px;right:2px;width:6px;height:6px;background:#8B9A9C;border-radius:50%"></div>' : ''}
            </div>
        `;
    }).join('');

    return `
    <div class="slide-up">
        <div style="text-align:center;margin-bottom:20px">
            <div style="color:#888;font-size:14px">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</div>
            <div style="font-size:32px;font-weight:bold;color:${colors.warning}">${state.totalPoints} <span style="font-size:16px">pts</span></div>
        </div>

        <h3 style="margin-bottom:16px;font-weight:bold">–ú–∞–≥–∞–∑–∏–Ω –°—É–Ω–¥—É–∫–æ–≤</h3>
        <div style="display:grid; gap:16px; margin-bottom:30px">
            
            <div class="chest-card common" onclick="actions.openChest('common', 150)">
                <div class="chest-icon">üì¶</div>
                <div style="font-weight:bold">–û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫</div>
                <div style="font-size:12px;color:#888;margin:5px 0">–ö–µ–ø–∫–∏, —à–∞–ø–∫–∏, –±–∞–±–æ—á–∫–∏</div>
                <div style="background:#333; padding:4px 12px; border-radius:12px; font-weight:bold; font-size:14px; margin-top:5px">150 pts</div>
            </div>

            <div class="chest-card rare" onclick="actions.openChest('rare', 300)">
                <div class="chest-icon">üíº</div>
                <div style="font-weight:bold;color:#D4AF7A">–†–µ–¥–∫–∏–π –∫–µ–π—Å</div>
                <div style="font-size:12px;color:#888;margin:5px 0">–û—á–∫–∏, —à–∞—Ä—Ñ—ã, —Ü–µ–ø–∏</div>
                <div style="background:rgba(212,175,122,0.2); color:#D4AF7A; padding:4px 12px; border-radius:12px; font-weight:bold; font-size:14px; margin-top:5px">300 pts</div>
            </div>

            <div class="chest-card legendary" onclick="actions.openChest('legendary', 1000)">
                <div class="chest-icon">üíé</div>
                <div style="font-weight:bold;color:#D45D79">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</div>
                <div style="font-size:12px;color:#888;margin:5px 0">–ö–æ—Ä–æ–Ω—ã, –º–æ–Ω–æ–∫–ª–∏ –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤</div>
                <div style="background:rgba(212,93,121,0.2); color:#D45D79; padding:4px 12px; border-radius:12px; font-weight:bold; font-size:14px; margin-top:5px">1000 pts</div>
            </div>

        </div>

        <h3 style="margin-bottom:16px;font-weight:bold">–¢–≤–æ–π –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        ${invItems ? `<div class="inv-grid">${invItems}</div>` : '<div style="text-align:center;color:#666;padding:20px">–ü—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É–∫!</div>'}
    </div>`;
}

function renderAnalysis() {
    const ai = getAIAnalysis();
    
    // Simple SVG Line Chart Logic
    const points = state.weeklyStats;
    const max = Math.max(...points, 10);
    const width = 100; // viewbox units
    const height = 50;
    const step = width / (points.length - 1);
    
    let polylinePoints = points.map((val, i) => {
        const x = i * step;
        const y = height - ((val / max) * height);
        return `${x},${y}`;
    }).join(' ');

    return `
    <div class="slide-up">
        <h2 style="margin-bottom:20px;font-weight:bold">AI –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ üß†</h2>
        
        <div class="section" style="border-color:${ai.trend === 'up' ? colors.primary : '#333'}">
            <div style="display:flex; gap:12px; align-items:flex-start">
                <div style="font-size:32px">${ai.trend === 'up' ? 'üìà' : ai.trend === 'down' ? 'üìâ' : 'üìä'}</div>
                <div>
                    <div style="font-weight:bold; margin-bottom:6px">–û—Ç—á–µ—Ç Livi AI</div>
                    <div style="font-size:14px; line-height:1.4; color:#ccc">${ai.text}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px">
                <span style="color:#888">–¢—Ä–µ–Ω–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</span>
                <span style="font-weight:bold">–°—Ä: ${ai.avg} pts</span>
            </div>
            <svg viewBox="0 0 100 50" style="width:100%; height:120px; overflow:visible">
                <line x1="0" y1="0" x2="100" y2="0" stroke="#333" stroke-width="0.5" stroke-dasharray="2"/>
                <line x1="0" y1="25" x2="100" y2="25" stroke="#333" stroke-width="0.5" stroke-dasharray="2"/>
                <line x1="0" y1="50" x2="100" y2="50" stroke="#333" stroke-width="0.5" stroke-dasharray="2"/>
                
                <polyline points="${polylinePoints}" fill="none" stroke="${colors.primary}" stroke-width="2" stroke-linecap="round" vector-effect="non-scaling-stroke"/>
                
                ${points.map((val, i) => {
                    const x = i * step;
                    const y = height - ((val / max) * height);
                    return `<circle cx="${x}" cy="${y}" r="2" fill="${colors.accent}"/>`;
                }).join('')}
            </svg>
            <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:10px;color:#666">
                <span>6 –¥–Ω–µ–π –Ω–∞–∑–∞–¥</span>
                <span>–°–µ–≥–æ–¥–Ω—è</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div style="color:#888;font-size:12px;margin-bottom:5px">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</div>
            <div style="font-weight:500;font-size:14px">
                ${ai.trend === 'down' 
                  ? '–ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª–µ–≥–∫—É—é –∑–∞–¥–∞—á—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi" —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Ç—Ä–∏–∫!' 
                  : '–ü–æ–ø—Ä–æ–±—É–π –∫—É–ø–∏—Ç—å –†–µ–¥–∫–∏–π –∫–µ–π—Å, —Ç—ã –∑–∞—Å–ª—É–∂–∏–ª –Ω–∞–≥—Ä–∞–¥—É!'}
            </div>
        </div>
    </div>`;
}

function renderTasksPage() {
    const tasksList = state.tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}">
            <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="actions.toggleTask(${task.id})">
                ${task.completed ? '<svg viewBox="0 0 24 24" width="16" height="16" stroke="white" stroke-width="3" fill="none"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
            </div>
            <div style="flex:1">
                <div class="task-title" style="font-weight:500">${task.title}</div>
                <div style="font-size:11px;color:#666;margin-top:2px">${task.type === 'habit' ? '–ü—Ä–∏–≤—ã—á–∫–∞' : '–ó–∞–¥–∞—á–∞'} ‚Ä¢ ${task.points} –æ—á–∫–æ–≤</div>
            </div>
            <button onclick="actions.deleteTask(${task.id})" style="background:none;border:none;color:#666;padding:4px">
                ${getIcon('trash')}
            </button>
        </div>
    `).join('');

    return `
    <div class="slide-up">
        <h2 style="margin-bottom:20px;font-size:24px;font-weight:bold">–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏</h2>
        ${tasksList.length ? tasksList : '<div style="text-align:center;color:#666;padding:40px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>'}
        <button class="add-btn" onclick="actions.addTask()">+</button>
    </div>`;
}

function renderChallenges() {
    const ch = state.dailyChallenge;
    return `
    <div class="slide-up">
        <div class="section" style="text-align:center;padding:40px 20px;border-color:${colors.warning}">
            <div style="font-size:48px;margin-bottom:16px">üéØ</div>
            <h2 style="margin-bottom:8px;font-size:24px;font-weight:bold">${ch.title}</h2>
            <p style="color:#888;margin-bottom:24px">–í—ã–ø–æ–ª–Ω–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –¥–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è</p>
            
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:24px">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px">
                    <span>–°—Ç–∞—Ç—É—Å</span>
                    <span>${ch.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'}</span>
                </div>
                <div style="height:6px;background:#333;border-radius:3px;overflow:hidden">
                    <div style="height:100%;width:${ch.completed ? 100 : 0}%;background:${colors.warning};transition:width .5s"></div>
                </div>
            </div>

            ${ch.completed 
                ? `<div class="btn" style="background:${colors.accent};color:#1a1a1a">–ó–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</div>`
                : `<button class="btn btn-primary" onclick="actions.completeChallenge()">–ó–∞–≤–µ—Ä—à–∏—Ç—å (+${ch.reward})</button>`
            }
        </div>
    </div>`;
}

function renderNavigation() {
    const tabs = [
        { id: 'home', icon: 'home', label: '–ì–ª–∞–≤–Ω–∞—è' },
        { id: 'challenges', icon: 'target', label: '–¶–µ–ª–∏' },
        { id: 'tasks', icon: 'check', label: '–ó–∞–¥–∞—á–∏' },
        { id: 'shop', icon: 'shop', label: '–®–æ–ø' },
        { id: 'analysis', icon: 'chart', label: '–ê–Ω–∞–ª–∏–∑' }
    ];

    return `
    <div class="bottom-nav">
        ${tabs.map(tab => `
            <button class="nav-item ${state.activeTab === tab.id ? 'active' : ''}" 
                onclick="state.activeTab='${tab.id}';saveState();render()">
                <div class="nav-icon">${getIcon(tab.icon)}</div>
                <div class="nav-label" style="font-size:10px;margin-top:4px">${tab.label}</div>
            </button>
        `).join('')}
    </div>`;
}

function render() {
    const app = document.getElementById('app');
    let contentHtml = '';
    switch(state.activeTab) {
        case 'home': contentHtml = renderHome(); break;
        case 'challenges': contentHtml = renderChallenges(); break;
        case 'tasks': contentHtml = renderTasksPage(); break;
        case 'shop': contentHtml = renderShop(); break;
        case 'analysis': contentHtml = renderAnalysis(); break;
    }

    app.innerHTML = `
        ${renderHeader()}
        <div class="content">
            ${contentHtml}
        </div>
        ${renderNavigation()}
    `;
}

// --- INIT ---
window.onload = () => {
    loadState();
    render();
    setTimeout(() => {
        const screen = document.getElementById('loadingScreen');
        screen.classList.add('fade-out');
        setTimeout(() => screen.remove(), 500);
    }, 800);
};

</script>
</body>
</html>
