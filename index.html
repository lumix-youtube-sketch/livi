<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>livi</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
    --primary: #8B9A9C;
    --accent: #9CB3B5;
    --gold: #D4AF7A;
    --epic: #D45D79;
    --bg: #1a1a1a;
    --glass: rgba(255,255,255,0.05);
    --glass-high: rgba(255,255,255,0.1);
    --danger: #ff4757;
    --success: #2ed573;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#121212 0%,#000000 100%);color:white;max-width:428px;margin:0 auto;overflow-x:hidden;-webkit-tap-highlight-color:transparent;padding-bottom:100px;min-height:100vh}

/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--epic)}50%{box-shadow:0 0 25px var(--epic)}}
@keyframes blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0.1)}}
@keyframes pulse-red {0% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4);} 70% {box-shadow: 0 0 0 20px rgba(255, 71, 87, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 71, 87, 0);}}
@keyframes wave {0%, 100% {height: 10px;} 50% {height: 30px;}}
@keyframes particle {0%{transform:translateY(0);opacity:0} 50%{opacity:0.5} 100%{transform:translateY(-100px);opacity:0}}

.fade-in{animation:fadeIn .4s ease-out}
.slide-up{animation:slideUp .4s ease-out}
.hidden{display:none!important}

/* UI Elements */
.loading-screen{position:fixed;inset:0;background:#1a1a1a;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
.loading-screen.fade-out{opacity:0;pointer-events:none}
.loading-logo{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px}

.header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:rgba(20,20,20,0.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:50}
.header-title{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:10px;align-items:center}
.stat-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-weight:700;font-size:14px;background:var(--glass);border:1px solid rgba(255,255,255,0.05)}
.profile-btn{width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid var(--primary);cursor:pointer;box-shadow:0 0 15px rgba(139,154,156,0.3)}
.profile-btn img{width:100%;height:100%;object-fit:cover}

/* Livi Character (Untouched Logic) */
.livi-container{display:flex;flex-direction:column;align-items:center;padding:40px 0;position:relative; z-index: 5;}
.livi-bg-glow {position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; background: radial-gradient(circle, rgba(139,154,156,0.2) 0%, rgba(0,0,0,0) 70%); z-index: 1; pointer-events: none;}
.livi-body{
    width:130px;height:130px;
    border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #2a2a2a, #111);
    border:3px solid var(--primary);
    position:relative;
    box-shadow:0 10px 40px rgba(0,0,0,0.5);
    animation:float 6s ease-in-out infinite;
    z-index:5;
}
.livi-antenna{position:absolute;width:4px;height:35px;background:var(--primary);border-radius:4px;z-index:1}
.livi-antenna::after{content:'';position:absolute;top:-8px;left:-3px;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--primary)}
.ant-l{top:-25px;left:25px;transform:rotate(-20deg)}
.ant-r{top:-25px;right:25px;transform:rotate(20deg)}
.livi-face{position:absolute;inset:0;z-index:10}
.eye{position:absolute;top:45%;width:14px;height:18px;background:white;border-radius:50%;animation:blink 4s infinite}
.eye-l{left:35px} .eye-r{right:35px}
.mouth{position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:24px;height:12px;border-bottom:3px solid white;border-radius:0 0 15px 15px}

/* Items CSS */
.item-cap {position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:90px;height:35px;background:linear-gradient(to bottom, #D4AF7A, #C09555);border-radius:20px 20px 0 0;z-index:20;box-shadow:inset 0 2px 5px rgba(255,255,255,0.2)}
.item-cap::before {content:'';position:absolute;top:-4px;left:50%;transform:translateX(-50%);width:12px;height:6px;background:#C09555;border-radius:50%}
.item-cap::after {content:'';position:absolute;bottom:0;right:-15px;width:40px;height:10px;background:#b08545;border-radius:0 50px 50px 0;transform:rotate(5deg)}
.item-crown {position:absolute;top:-45px;left:50%;transform:translateX(-50%);width:70px;height:50px;z-index:20;background: linear-gradient(to bottom, #FFD700, #DAA520);clip-path: polygon(0% 100%, 20% 40%, 40% 100%, 60% 20%, 80% 100%, 100% 40%, 100% 100%);filter: drop-shadow(0 0 5px rgba(255,215,0,0.5));}
.item-crown::after {content:'';position:absolute;bottom:5px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:radial-gradient(circle, #ff0000, #800000);border-radius:50%;box-shadow:20px 0 0 #800000, -20px 0 0 #800000}
.item-glasses {position:absolute;top:55px;left:50%;transform:translateX(-50%);width:80px;height:24px;z-index:30;display:flex;justify-content:space-between}
.g-lens {width:36px;height:24px;background:rgba(0,0,0,0.85);border-radius:6px;border:2px solid #555;position:relative;overflow:hidden}
.g-lens::after {content:'';position:absolute;top:0;left:0;width:150%;height:40%;background:rgba(255,255,255,0.15);transform:rotate(25deg) translateY(-5px)}
.g-bridge {position:absolute;top:10px;left:50%;transform:translateX(-50%);width:10px;height:3px;background:#555}
.item-scarf {position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);width:100px;height:35px;z-index:25;background: repeating-linear-gradient(45deg, #D45D79, #D45D79 10px, #C04560 10px, #C04560 20px);border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.item-monocle {position:absolute;top:55px;right:38px;width:28px;height:28px;border:2px solid #FFD700;border-radius:50%;background:rgba(255,255,255,0.1);z-index:30}
.item-monocle::before {content:'';position:absolute;bottom:-30px;right:-10px;width:30px;height:30px;border-right:1px solid #FFD700;border-radius:50%}
.item-bowtie {position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:40px;height:20px;z-index:25;background:#D45D79;clip-path:polygon(0 50%, 40% 0, 50% 50%, 40% 100%, 0 50%, 50% 50%, 60% 0, 100% 50%, 60% 100%, 50% 50%)}
.item-insurance {position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:60px;height:60px;z-index:20;background:radial-gradient(circle, #FFD700, #B8860B);border-radius:50%;border:3px solid #FFA500;box-shadow:0 0 20px rgba(255,215,0,0.6);display:flex;align-items:center;justify-content:center;font-size:28px;}

/* Main Layout */
.content{padding:20px}
.section{background:var(--glass);border:1px solid var(--glass-high);border-radius:24px;padding:20px;margin-bottom:15px;backdrop-filter:blur(10px); position: relative; overflow: hidden;}
.section::before {content:''; position:absolute; inset:0; background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 100%); pointer-events: none;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.btn{width:100%;padding:16px;border-radius:16px;font-weight:700;font-size:16px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:white; box-shadow: 0 4px 15px rgba(139,154,156,0.3)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:#888}
.btn-danger{background:rgba(255, 71, 87, 0.1); border:1px solid var(--danger); color: var(--danger)}

.add-btn {position: fixed;bottom: 90px;right: 20px;width: 60px;height: 60px;border-radius: 30px;background: linear-gradient(135deg, var(--primary), var(--accent));color: white;font-size: 32px;border: none;box-shadow: 0 4px 20px rgba(139,154,156,0.5);z-index: 80;display: flex;align-items: center;justify-content: center;cursor: pointer;transition: transform 0.2s;}
.add-btn:active {transform: scale(0.95);}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;max-width:428px;margin:0 auto;background:rgba(15,15,15,0.98);backdrop-filter:blur(20px);border-top:1px solid #2a2a2a;display:flex;justify-content:space-around;padding:12px 0 calc(12px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;border:none;background:none;color:#555;transition:color .2s}
.nav-item.active{color:var(--primary)}

/* Shop & Items */
.chest-wrapper {display:grid;gap:15px;margin-bottom:30px}
.chest-card {position:relative;border-radius:16px;padding:20px;overflow:hidden;cursor:pointer;transition:transform .2s}
.chest-card:active {transform:scale(0.98)}
.chest-common {background:linear-gradient(135deg, #5D4037, #3E2723);border:2px solid #8D6E63}
.chest-rare {background:linear-gradient(135deg, #1e2424, #0f1212);border:2px solid var(--gold);box-shadow:inset 0 0 20px rgba(212,175,122,0.1)}
.chest-legendary {background:linear-gradient(135deg, #2b0a16, #1a050d);border:2px solid var(--epic);animation:pulse-glow 3s infinite}

.roulette-modal {position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center}
.roulette-window {width:100%;height:140px;background:#050505;border-block:2px solid #333;position:relative;overflow:hidden;margin:30px 0}
.roulette-strip {display:flex;height:100%;align-items:center;position:absolute;left:0;will-change:transform}
.r-item {width:120px;height:110px;margin:0 4px;background:#151515;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #333;flex-shrink:0;position:relative}
.r-item.legendary {border-color:var(--epic);box-shadow:inset 0 0 15px rgba(212,93,121,0.2)}
.r-item.rare {border-color:var(--gold)}
.r-marker {position:absolute;top:0;bottom:0;left:50%;width:4px;background:white;z-index:10;transform:translateX(-50%);box-shadow:0 0 10px white}

/* Education Module & Full Screen Modal */
.mic-btn {width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px solid #555; display: flex; align-items: center; justify-content: center; margin: 30px auto; cursor: pointer; transition: all 0.3s; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
.mic-btn.recording {background: var(--danger); border-color: var(--danger); animation: pulse-red 1.5s infinite;}
.voice-wave {display: flex; gap: 4px; align-items: center; height: 30px;}
.bar {width: 4px; background: white; border-radius: 2px; animation: wave 1s infinite ease-in-out;}
.bar:nth-child(2) {animation-delay: 0.1s; height: 20px}
.bar:nth-child(3) {animation-delay: 0.2s; height: 40px}
.bar:nth-child(4) {animation-delay: 0.3s; height: 25px}
.bar:nth-child(5) {animation-delay: 0.4s; height: 15px}

.note-card {background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: background .2s;}
.note-card:active {background: rgba(255,255,255,0.08);}
.note-date {font-size: 11px; color: #777; margin-bottom: 5px; display: flex; justify-content: space-between;}
.note-title {font-weight: 700; margin-bottom: 5px; color: white; font-size: 16px;}
.note-preview {font-size: 13px; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis}

.note-modal {position: fixed; inset: 0; background: #080808; z-index: 3000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); transform: translateY(100%);}
.note-modal.open {transform: translateY(0);}
.note-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
.note-textarea {flex: 1; background: transparent; border: none; color: #eee; font-size: 16px; line-height: 1.6; resize: none; outline: none; font-family: inherit; padding-bottom: 100px;}
.ai-actions {display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;}
.ai-chip {background: rgba(139,154,156,0.2); padding: 8px 16px; border-radius: 20px; font-size: 12px; color: var(--accent); white-space: nowrap; border: 1px solid rgba(139,154,156,0.3);}

/* Particles */
.particle-container {position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;}
.particle {position: absolute; width: 4px; height: 4px; background: var(--primary); border-radius: 50%; animation: particle 4s infinite;}

svg{width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">livi</div>
</div>

<div class="particle-container">
    <div class="particle" style="left: 10%; top: 80%; animation-delay: 0s"></div>
    <div class="particle" style="left: 80%; top: 70%; animation-delay: 1.5s"></div>
    <div class="particle" style="left: 40%; top: 90%; animation-delay: 2.5s"></div>
    <div class="particle" style="left: 70%; top: 50%; animation-delay: 0.5s"></div>
</div>

<div id="rouletteModal" class="hidden roulette-modal">
    <h2 style="margin-bottom:10px; color:#fff; font-weight:800; letter-spacing:1px">–û–¢–ö–†–´–¢–ò–ï...</h2>
    <div class="roulette-window">
        <div class="r-marker"></div>
        <div class="roulette-strip" id="rouletteStrip"></div>
    </div>
    <div id="winMessage" style="opacity:0; text-align:center; transition:opacity .5s">
        <div style="font-size:14px; color:#888; text-transform:uppercase; letter-spacing:1px">–í—ã –ø–æ–ª—É—á–∏–ª–∏</div>
        <div id="winItemName" style="font-size:32px; font-weight:800; color:var(--gold); margin:10px 0; text-shadow:0 0 20px rgba(212,175,122,0.3)">–ü—Ä–µ–¥–º–µ—Ç</div>
        <button class="btn btn-primary" style="width:200px; margin:0 auto" onclick="closeRoulette()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>
</div>

<div id="noteModal" class="note-modal">
    <div class="note-header">
        <div style="font-weight: 800; font-size: 20px; color: var(--gold)" id="modalTitle">–ó–∞–º–µ—Ç–∫–∞</div>
        <div onclick="actions.closeNote()" style="padding: 10px; cursor: pointer;">‚úï</div>
    </div>
    <div class="ai-actions">
        <div class="ai-chip" onclick="actions.enhanceNote()">ü™Ñ –£–ª—É—á—à–∏—Ç—å (AI)</div>
        <div class="ai-chip" onclick="actions.addSummary()">üìù –î–æ–±–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥—ã</div>
        <div class="ai-chip" onclick="actions.formatList()">üìã –í —Å–ø–∏—Å–æ–∫</div>
    </div>
    <textarea id="modalText" class="note-textarea" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
    <button class="btn btn-primary" onclick="actions.saveAndCloseNote()" style="margin-top: auto;">–°–û–•–†–ê–ù–ò–¢–¨</button>
</div>

<div id="app"></div>

<script>
// --- INITIALIZATION ---
let tg = null;
if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.expand();
    tg.ready();
    tg.setHeaderColor('#121212');
    tg.setBackgroundColor('#121212');
    tg.enableClosingConfirmation(); // Prevent accidental closing
}

const userId = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'local_user';
const firstName = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.first_name || 'User') : 'Friend';
const photoUrl = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? (tg.initDataUnsafe.user.photo_url || '') : '';

// --- STORAGE ENGINE (Dual Layer: Local + Cloud) ---
// Note: We use localStorage for Heavy Data (Notes) and Cloud for Stats
const Storage = {
    save: (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            // Sync critical stats to cloud if available, but don't fail if it doesn't work
            if (tg && tg.CloudStorage && key.includes('stats')) {
                tg.CloudStorage.setItem(key, JSON.stringify(data));
            }
        } catch (e) { console.error("Save failed", e); }
    },
    load: async (key) => {
        try {
            // Try Cloud first for stats
            if (tg && tg.CloudStorage && key.includes('stats')) {
                const cloudData = await new Promise(r => tg.CloudStorage.getItem(key, (err, val) => r(val)));
                if (cloudData) return JSON.parse(cloudData);
            }
            // Fallback to local
            const local = localStorage.getItem(key);
            return local ? JSON.parse(local) : null;
        } catch (e) { return null; }
    }
};

const icons = {
    home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
    check: '<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>',
    shop: '<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/>',
    chart: '<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
    star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
    shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
    fire: '<path d="M8 22s3-8 3-13c0-3-2-5-5-5 1-3 5-5 5-8 2 4 6 5 8 5 2 0 6-1 8 5 0 3-4 5-5 5-1 4 3 13 3 13H8z"/>',
    book: '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
    mic: '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
    edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>'
};
const getIcon = (n) => `<svg viewBox="0 0 24 24">${icons[n]}</svg>`;

const ITEMS = [
    { id: 'c_cap', name: '–ö–µ–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß¢', css: 'item-cap' },
    { id: 'c_beanie', name: '–®–∞–ø–∫–∞', type: 'head', rarity: 'common', icon: 'üß∂', css: 'item-cap', style: 'background:#555' },
    { id: 'c_bowtie', name: '–ë–∞–±–æ—á–∫–∞', type: 'body', rarity: 'common', icon: 'üéÄ', css: 'item-bowtie' },
    { id: 'r_glasses', name: '–†–µ–π–±–∞–Ω—ã', type: 'face', rarity: 'rare', icon: 'üï∂Ô∏è', css: 'item-glasses' },
    { id: 'r_scarf', name: '–®–∞—Ä—Ñ', type: 'body', rarity: 'rare', icon: 'üß£', css: 'item-scarf' },
    { id: 'l_crown', name: '–ö–æ—Ä–æ–Ω–∞', type: 'head', rarity: 'legendary', icon: 'üëë', css: 'item-crown' },
    { id: 'l_monocle', name: '–ú–æ–Ω–æ–∫–ª—å', type: 'face', rarity: 'legendary', icon: 'üßê', css: 'item-monocle' },
    { id: 'insurance', name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ —Å—Ç—Ä–∏–∫–æ–≤', type: 'special', rarity: 'rare', icon: 'üõ°Ô∏è', css: 'item-insurance', special: true }
];

const defaultState = {
    activeTab: 'home',
    streak: 1,
    totalPoints: 200,
    lastVisitDate: new Date().toISOString().split('T')[0],
    statsHistory: [],
    tasks: [
        { id: 1, title: '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É', completed: false, type: 'habit', points: 10 },
        { id: 2, title: '–ó–∞–ø—É—Å—Ç–∏—Ç—å Livi', completed: true, type: 'task', points: 5 }
    ],
    inventory: [],
    equipped: { head: null, face: null, body: null, special: null },
    dailyChallenge: {
        date: new Date().toISOString().split('T')[0],
        title: '–°–¥–µ–ª–∞—Ç—å 20 —à–∞–≥–æ–≤',
        completed: false,
        reward: 50
    },
    notes: [], 
    hasStreakInsurance: false,
    referralCount: 0,
    totalFire: 0,
    nick: firstName,
    avatar: photoUrl
};

let state = { ...defaultState };
let recognition = null;
let isRecording = false;
let currentTranscript = "";
let editingNoteId = null;

// --- STATE MANAGEMENT ---
async function loadState() {
    // 1. Load Main Stats
    const statsData = await Storage.load(`livi_stats_${userId}`);
    if (statsData) {
        state = { ...defaultState, ...statsData };
    }

    // 2. Load Notes (Separate Key for safety)
    const notesData = await Storage.load(`livi_notes_${userId}`);
    if (notesData) {
        state.notes = notesData;
    }

    // 3. Daily Updates
    const today = new Date().toISOString().split('T')[0];
    if (state.lastVisitDate !== today) {
        if (!state.statsHistory.find(e => e.date === today)) {
             state.streak = hadActivityYesterday() ? state.streak + 1 : 1;
        }
        state.lastVisitDate = today;
        const challenges = ['–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –∑–∞–¥–∞—á–∏','–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤','–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ª–µ–∫—Ü–∏—é','–°–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç'];
        state.dailyChallenge = {
            date: today,
            title: challenges[Math.floor(Math.random() * challenges.length)],
            completed: false,
            reward: 50
        };
        state.tasks.forEach(t => { if (t.type === 'habit') t.completed = false; });
        saveAll();
    }
}

function saveAll() {
    // Split saving to avoid limits
    const statsToSave = { ...state };
    delete statsToSave.notes; // Don't save notes in stats
    
    Storage.save(`livi_stats_${userId}`, statsToSave);
    Storage.save(`livi_notes_${userId}`, state.notes);
}

function hadActivityYesterday() {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    const y = d.toISOString().split('T')[0];
    return !!state.statsHistory.find(e => e.date === y);
}

function updateHistory(pointsDelta) {
    const today = new Date().toISOString().split('T')[0];
    if (!state.statsHistory) state.statsHistory = [];
    let entry = state.statsHistory.find(e => e.date === today);
    if (!entry) {
        entry = { date: today, points: 0, completedTasks: 0 };
        state.statsHistory.push(entry);
    }
    entry.points += pointsDelta;
    saveAll();
}

// --- AI LOGIC (Simulated Client-Side Processing) ---
function aiProcessText(text) {
    if (!text || text.length < 10) return text;

    // 1. Structure Paragraphs (heuristic: split by periods if long)
    let processed = text.replace(/([.!?])\s*(?=[–ê-–Ø])/g, "$1\n\n");
    
    // 2. Identify Keywords & Topics
    const keywords = ['–≤–∞–∂–Ω–æ', '–æ–¥–Ω–∞–∫–æ', '–Ω–∞–ø—Ä–∏–º–µ—Ä', '–≤–æ-–ø–µ—Ä–≤—ã—Ö', '–∑–∞–∫–ª—é—á–µ–Ω–∏–µ', '–∏—Ç–∞–∫'];
    keywords.forEach(kw => {
        const re = new RegExp(`(${kw})`, 'gi');
        processed = processed.replace(re, "\nüîπ $1");
    });

    // 3. Generate a "Tips" section based on content
    let tip = "";
    if (text.includes("–º–∞—Ç–µ–º–∞—Ç") || text.includes("—á–∏—Å–ª–∞")) tip = "\n\nüí° –°–æ–≤–µ—Ç Livi: –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.";
    else if (text.includes("–∏—Å—Ç–æ—Ä") || text.includes("–≥–æ–¥")) tip = "\n\nüí° –°–æ–≤–µ—Ç Livi: –°–æ—Å—Ç–∞–≤—å —Ç–∞–π–º–ª–∞–π–Ω —Å–æ–±—ã—Ç–∏–π.";
    else tip = "\n\nüí° –°–æ–≤–µ—Ç Livi: –ü–µ—Ä–µ—á–∏—Ç–∞–π —ç—Ç–æ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.";

    return processed + tip;
}

// --- ACTIONS ---
const actions = {
    toggleTask: (id) => {
        const task = state.tasks.find(t => t.id === id);
        if (task) {
            task.completed = !task.completed;
            state.totalPoints += task.completed ? task.points : -task.points;
            updateHistory(task.completed ? task.points : -task.points);
            if(task.completed && tg) tg.HapticFeedback.notificationOccurred('success');
            saveAll();
            render();
        }
    },
    addTask: () => {
        const title = prompt("–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?");
        if (title) {
            state.tasks.push({ id: Date.now(), title, completed: false, type: 'task', points: 15 });
            saveAll();
            render();
        }
    },
    deleteTask: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveAll();
            render();
        }
    },
    equip: (id) => {
        const item = ITEMS.find(i => i.id === id);
        if (item) {
            const slot = item.special ? 'special' : item.type;
            state.equipped[slot] = state.equipped[slot] === id ? null : id;
            if(item.special) state.hasStreakInsurance = !!state.equipped.special;
            saveAll();
            render();
        }
    },
    openChest: (type, cost) => {
        if (state.totalPoints >= cost) {
            state.totalPoints -= cost;
            updateHistory(-cost);
            startRoulette(type);
        } else alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤!");
    },
    
    // Education Actions
    startRecording: () => {
        if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
            alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ Android/Chrome)");
            return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = true;
        recognition.interimResults = true; // Record every word live

        recognition.onstart = () => { isRecording = true; render(); };
        recognition.onresult = (event) => {
            let interim = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) currentTranscript += event.results[i][0].transcript + " ";
                else interim += event.results[i][0].transcript;
            }
            const el = document.getElementById('liveTranscript');
            if(el) el.innerText = (currentTranscript + interim) || "–°–ª—É—à–∞—é...";
        };
        recognition.onend = () => { if(isRecording) recognition.start(); else render(); };
        recognition.start();
    },
    stopRecording: () => {
        isRecording = false;
        if(recognition) recognition.stop();
        
        if (currentTranscript.length > 0) {
            // Auto-save logic
            const newNote = {
                id: Date.now(),
                date: new Date().toLocaleString('ru-RU'),
                title: '–ó–∞–º–µ—Ç–∫–∞ ' + new Date().toLocaleTimeString().slice(0,5),
                text: aiProcessText(currentTranscript) // Auto structure on save
            };
            state.notes.unshift(newNote);
            currentTranscript = "";
            saveAll();
        }
        render();
    },
    
    // Full Screen Note Logic
    openNote: (id) => {
        const note = state.notes.find(n => n.id === id);
        if (!note) return;
        editingNoteId = id;
        document.getElementById('modalTitle').innerText = note.title;
        document.getElementById('modalText').value = note.text;
        document.getElementById('noteModal').classList.add('open');
    },
    saveAndCloseNote: () => {
        const text = document.getElementById('modalText').value;
        const note = state.notes.find(n => n.id === editingNoteId);
        if (note) {
            note.text = text;
            saveAll();
        }
        actions.closeNote();
        render();
    },
    closeNote: () => {
        document.getElementById('noteModal').classList.remove('open');
        editingNoteId = null;
    },
    deleteNote: (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç?")) {
            state.notes = state.notes.filter(n => n.id !== id);
            saveAll();
            render();
        }
    },
    enhanceNote: () => {
        const field = document.getElementById('modalText');
        // Simulate "AI Rephrase"
        let text = field.value;
        text = text.replace(/\s+/g, ' ').trim(); // Remove excess whitespace
        text = text.replace(/([.!?])\s*/g, "$1\n\n"); // Fix paragraphs
        text = "‚ú® –£–õ–£–ß–®–ï–ù–û AI:\n\n" + text;
        field.value = text;
        if(tg) tg.HapticFeedback.notificationOccurred('success');
    },
    addSummary: () => {
        const field = document.getElementById('modalText');
        const sentences = field.value.split(/[.!?]/);
        if (sentences.length > 2) {
             field.value = "üìå –ì–õ–ê–í–ù–û–ï: " + sentences[0] + ".\n\n" + field.value;
        }
    },
    formatList: () => {
        const field = document.getElementById('modalText');
        // Simple heuristic: turn newlines into list items
        let text = field.value;
        text = text.replace(/\n(?!\s*‚Ä¢)/g, "\n‚Ä¢ ");
        field.value = text;
    },
    
    openProfile: () => { state.activeTab = 'profile'; render(); },
    copyReferral: () => {
        const link = `https://t.me/livi_app_bot?start=ref${userId}`;
        navigator.clipboard.writeText(link).then(() => alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"));
    }
};

// --- RENDERERS ---
function renderHeader() {
    return `<div class="header">
        <div class="header-title">livi</div>
        <div class="header-stats">
            <div class="stat-badge" style="color:var(--gold)">${getIcon('star')} ${state.totalPoints}</div>
            <div class="stat-badge">${getIcon('fire')} ${state.totalFire}</div>
            <div class="profile-btn" onclick="actions.openProfile()">
                <img src="${state.avatar || 'https://via.placeholder.com/40?text=üë§'}" alt="Profile">
            </div>
        </div>
    </div>`;
}

function renderHome() {
    const done = state.tasks.filter(t => t.completed).length;
    const h = ITEMS.find(i => i.id === state.equipped.head);
    const f = ITEMS.find(i => i.id === state.equipped.face);
    const b = ITEMS.find(i => i.id === state.equipped.body);
    const s = ITEMS.find(i => i.id === state.equipped.special);

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div class="livi-container">
                <div class="livi-bg-glow"></div>
                <div class="livi-body">
                    ${h ? `<div class="${h.css}" style="${h.style || ''}"></div>` : ''}
                    <div class="livi-antenna ant-l"></div>
                    <div class="livi-antenna ant-r"></div>
                    <div class="livi-face">
                        <div class="eye eye-l"></div>
                        <div class="eye eye-r"></div>
                        ${f ? `<div class="${f.css}"><div class="g-lens"></div><div class="g-lens"></div><div class="g-bridge"></div></div>` : ''}
                        <div class="mouth"></div>
                    </div>
                    ${s ? `<div class="${s.css}">${s.icon}</div>` : ''}
                </div>
                ${b ? `<div style="position:relative;width:0;height:0;top:-10px"><div class="${b.css}"></div></div>` : ''}
                <div style="margin-top:20px;font-weight:700; font-size: 18px">–ü—Ä–∏–≤–µ—Ç, ${state.nick}!</div>
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px">–í—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º.</div>
            </div>

            <div class="grid-2">
                <div class="section" style="margin:0;text-align:center">
                    <div style="font-size:24px;font-weight:800;color:var(--primary)">${done}/${state.tasks.length}</div>
                    <div style="font-size:12px;color:#888">–ó–∞–¥–∞—á–∏</div>
                </div>
                <div class="section" style="margin:0;text-align:center">
                    <div style="font-size:24px;font-weight:800;color:var(--gold)">${state.streak}</div>
                    <div style="font-size:12px;color:#888">–°—Ç—Ä–∏–∫</div>
                </div>
            </div>
            
             <div class="section" style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                 <div>
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 2px;">–¶–µ–ª—å –¥–Ω—è</div>
                    <div style="font-size: 12px; color: #888">${state.dailyChallenge.title}</div>
                 </div>
                 <div style="font-size: 20px">${state.dailyChallenge.completed ? '‚úÖ' : 'üéØ'}</div>
             </div>
        </div>
    </div>`;
}

function renderEducation() {
    const notesList = state.notes.map(n => `
        <div class="note-card" onclick="actions.openNote(${n.id})">
            <div class="note-date">
                <span>${n.date}</span>
                <span onclick="event.stopPropagation(); actions.deleteNote(${n.id})" style="color:#666">‚úï</span>
            </div>
            <div class="note-title">${n.title}</div>
            <div class="note-preview">${n.text.slice(0, 60)}...</div>
        </div>
    `).join('');

    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:15px;font-weight:800; text-align: center">–£–ú–ù–´–ô –ö–û–ù–°–ü–ï–ö–¢</h2>
            
            <div class="section" style="text-align:center; position: relative;">
                <div style="font-size:13px;color:#aaa;margin-bottom:15px; line-height: 1.4;">
                    –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —è –∑–∞–ø–∏—à—É <b>–∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ</b>,<br>—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É—é –∏ —Å–æ—Ö—Ä–∞–Ω—é –Ω–∞–≤—Å–µ–≥–¥–∞.
                </div>

                <div style="background: #111; padding: 15px; border-radius: 12px; min-height: 80px; margin-bottom: 20px; text-align: left; font-size: 14px; color: #ccc; border: 1px solid #333;" id="liveTranscript">
                    ${currentTranscript || (isRecording ? "–°–ª—É—à–∞—é..." : "–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç...")}
                </div>

                <button class="mic-btn ${isRecording ? 'recording' : ''}" onclick="${isRecording ? 'actions.stopRecording()' : 'actions.startRecording()'}">
                    ${isRecording ? '<div class="voice-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>' : getIcon('mic')}
                </button>
            </div>

            <h3 style="margin:25px 0 10px;font-weight:700; padding-left: 5px">–ú–û–ò –ó–ê–ü–ò–°–ò</h3>
            ${notesList || '<div style="text-align:center;color:#555;padding:20px; font-style: italic;">–ü—É—Å—Ç–æ. –ù–∞—á–Ω–∏ –∑–∞–ø–∏—Å—å!</div>'}
        </div>
    </div>`;
}

function renderTasks() {
    const list = state.tasks.map(t => `
        <div class="section" style="display:flex;align-items:center;padding:15px;margin-bottom:10px;opacity:${t.completed ? 0.5 : 1}">
            <div style="width:24px;height:24px;border:2px solid var(--primary);border-radius:6px;margin-right:12px;display:flex;align-items:center;justify-content:center;background:${t.completed ? 'var(--primary)' : 'transparent'}" onclick="actions.toggleTask(${t.id})">
                ${t.completed ? '<svg width="14" height="14" stroke="white"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
            </div>
            <div style="flex:1">
                <div style="font-weight:500;text-decoration:${t.completed ? 'line-through' : 'none'}">${t.title}</div>
                <div style="font-size:11px;color:#666">${t.points} pts</div>
            </div>
            <div onclick="actions.deleteTask(${t.id})" style="color:#666">${getIcon('trash')}</div>
        </div>
    `).join('');
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <h2 style="margin-bottom:20px;font-weight:800">–ó–ê–î–ê–ß–ò</h2>
            ${list}
        </div>
        <button class="add-btn" onclick="actions.addTask()">+</button>
    </div>`;
}

function renderShop() {
    const inv = state.inventory.map(id => {
        const i = ITEMS.find(x => x.id === id);
        const eq = Object.values(state.equipped).includes(id);
        const color = i.special ? '#FFA500' : (i.rarity === 'legendary' ? 'var(--epic)' : i.rarity === 'rare' ? 'var(--gold)' : 'var(--primary)');
        return `<div class="section" style="padding:10px;margin:0;display:flex;flex-direction:column;align-items:center;border-color:${eq ? color : 'transparent'}" onclick="actions.equip('${id}')">
            <div style="font-size:36px;margin-bottom:6px">${i.icon}</div>
            <div style="font-size:11px;color:#888;text-align:center">${i.name}</div>
            ${eq ? `<div style="width:6px;height:6px;background:${color};border-radius:50%;margin-top:6px"></div>` : ''}
        </div>`;
    }).join('');
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:12px;color:#888">–ë–ê–õ–ê–ù–°</div>
                <div style="font-size:36px;font-weight:900;color:var(--gold)">${state.totalPoints}</div>
            </div>
            <div class="chest-wrapper">
                <div class="chest-card chest-common" onclick="actions.openChest('common', 150)">
                    <div style="font-weight:800;font-size:18px;margin-bottom:4px">–ë–∞–∑–æ–≤—ã–π</div>
                    <div style="font-size:12px;opacity:0.7;">150 pts</div>
                </div>
                <div class="chest-card chest-rare" onclick="actions.openChest('rare', 300)">
                    <div style="font-weight:800;font-size:18px;margin-bottom:4px;color:var(--gold)">–†–µ–¥–∫–∏–π</div>
                    <div style="font-size:12px;opacity:0.7;">300 pts</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:20px">
                ${inv || '<div style="grid-column:1/-1;text-align:center;color:#444;">–ü—É—Å—Ç–æ</div>'}
            </div>
        </div>
    </div>`;
}

function renderProfile() {
    return `
    <div class="slide-up">
        ${renderHeader()}
        <div class="content" style="text-align:center">
            <h2 style="margin-bottom:30px;font-weight:800">–ü–†–û–§–ò–õ–¨</h2>
            <div class="profile-btn" style="width:80px;height:80px;margin:0 auto 20px">
                <img src="${state.avatar || 'https://via.placeholder.com/80?text=üòä'}" alt="Avatar">
            </div>
            <div style="font-size:28px;font-weight:800;margin-bottom:20px">${state.nick}</div>
            
            <div class="section" style="margin-top:30px">
                <div style="font-weight:bold;margin-bottom:10px">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
                <div style="background:#111;padding:12px;border-radius:12px;margin:12px 0;font-family:monospace;font-size:12px;color:var(--accent);word-break:break-all">https://t.me/livi_app_bot?start=ref${userId}</div>
                <button class="btn btn-primary" onclick="actions.copyReferral()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>`;
}

function render() {
    let html = '';
    if (state.activeTab === 'home') html = renderHome();
    else if (state.activeTab === 'tasks') html = renderTasks();
    else if (state.activeTab === 'education') html = renderEducation();
    else if (state.activeTab === 'shop') html = renderShop();
    else if (state.activeTab === 'profile') html = renderProfile();

    document.getElementById('app').innerHTML = html + `
    <div class="bottom-nav">
        <button class="nav-item ${state.activeTab==='home'?'active':''}" onclick="state.activeTab='home';saveAll();render()">${getIcon('home')}</button>
        <button class="nav-item ${state.activeTab==='tasks'?'active':''}" onclick="state.activeTab='tasks';saveAll();render()">${getIcon('check')}</button>
        <button class="nav-item ${state.activeTab==='education'?'active':''}" onclick="state.activeTab='education';saveAll();render()">${getIcon('book')}</button>
        <button class="nav-item ${state.activeTab==='shop'?'active':''}" onclick="state.activeTab='shop';saveAll();render()">${getIcon('shop')}</button>
    </div>`;
}

// --- ROULETTE LOGIC ---
function startRoulette(type) {
    const modal = document.getElementById('rouletteModal');
    modal.classList.remove('hidden');
    const strip = document.getElementById('rouletteStrip');
    strip.innerHTML = ''; strip.style.transition = 'none'; strip.style.transform = 'translateX(0px)';
    
    let pool = type === 'common' ? ITEMS.filter(i => i.rarity !== 'legendary') : ITEMS;
    let winner = pool[Math.floor(Math.random() * pool.length)];
    if(type === 'rare' && Math.random() > 0.7) winner = ITEMS.find(i=>i.rarity === 'legendary') || winner;

    for (let i = 0; i < 60; i++) {
        const item = i === 50 ? winner : pool[Math.floor(Math.random() * pool.length)];
        const el = document.createElement('div');
        el.className = `r-item ${item.rarity}`;
        el.innerHTML = `<div style="font-size:40px">${item.icon}</div>`;
        strip.appendChild(el);
    }

    setTimeout(() => {
        const offset = (document.querySelector('.roulette-window').offsetWidth / 2) - 64;
        strip.style.transition = 'transform 6s cubic-bezier(0.1, 0.9, 0.2, 1)';
        strip.style.transform = `translateX(-${(50 * 128) - offset}px)`;
        setTimeout(() => {
            if(tg) tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('winItemName').innerText = winner.name;
            document.getElementById('winMessage').style.opacity = '1';
            if (!state.inventory.includes(winner.id)) { state.inventory.push(winner.id); saveAll(); }
        }, 6200);
    }, 100);
}
function closeRoulette() { document.getElementById('rouletteModal').classList.add('hidden'); render(); }

// --- BOOT ---
document.addEventListener('DOMContentLoaded', async () => {
    await loadState();
    render();
    document.getElementById('loadingScreen').classList.add('fade-out');
});
</script>
</body>
</html>
